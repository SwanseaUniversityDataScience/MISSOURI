/* Main dataset PEDW Episodes
 * Date period 2010-01-01 to 2020-12-31
 * Only finished episodes included
 * Only ALFs with 1,4,39 and not null status code
 * Only people with a Welsh residence i.e. WDSD WELSH_ADDRESS = 1 at time of admission
 * Age inclusion 30 to 100 inclusive
 * Only first MI and first stroke event are included - first admission date with an agreed MI or stroke ICD-10 code
 * ICD-10 codes for MI and stroke */



CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MISS_PRE');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF_WALES');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF_WALES_AGE');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MISS');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MISS_DIAG_LINK');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_STROKE_DISTINCT');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_STROKE');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT_PRE');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MI_DISTINCT');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MI');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT_PRE');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_STROKE_HEALTH_DATA');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_MI_HEALTH_DATA');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_SPELLS_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_SPELLS_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_DIAG_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_DIAG_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_HYPERTENSION_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_HYPERTENSION_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_HYPERTENSION_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_HYPERTENSION_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_ASPIRIN_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_ASPIRIN_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_ASPIRIN_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_ASPIRIN_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_ANTIHYPERTENSIVES_EXCBETA_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_ANTIHYPERTENSIVES_EXCBETA_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_ANTIHYPERTENSIVES_EXCBETA_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_ANTIHYPERTENSIVES_EXCBETA_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_RENAL_DISEASE_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_RENAL_DISEASE_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_RENAL_DISEASE_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_RENAL_DISEASE_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_COPD_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_COPD_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_COPD_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_COPD_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_OTHER_ISCHAEMIC_HD_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_OTHER_ISCHAEMIC_HD_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_OTHER_ISCHAEMIC_HD_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_OTHER_ISCHAEMIC_HD_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_ATRIAL_FIBRILLATION_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_ATRIAL_FIBRILLATION_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_ATRIAL_FIBRILLATION_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_ATRIAL_FIBRILLATION_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_PERIPHERAL_VD_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_PERIPHERAL_VD_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_PERIPHERAL_VD_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_PERIPHERAL_VD_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_ANGINA_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_ANGINA_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_ANGINA_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_ANGINA_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_TRANSIENT_ISCHAEMIC_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_TRANSIENT_ISCHAEMIC_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_TRANSIENT_ISCHAEMIC_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_TRANSIENT_ISCHAEMIC_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_HEART_FAILURE_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_HEART_FAILURE_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_HEART_FAILURE_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_HEART_FAILURE_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_LIPID_LOWERING_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_LIPID_LOWERING_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_LIPID_LOWERING_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_LIPID_LOWERING_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_BETABLOCKERS_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_BETABLOCKERS_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_BETABLOCKERS_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_BETABLOCKERS_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_DIABETES_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_DIABETES_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_DIABETES_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_DIABETES_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_ASTHMA_MI');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_ASTHMA_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_GP_EVENT_ASTHMA_STROKE');

CALL FNC.DROP_IF_EXISTS ('SESSION.V2_ALL_COHORT_FIRST_ASTHMA_MI');


/* create prepration tables keeping episode numbers for consort*/

 CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MISS_PRE AS
	(SELECT	sp.ALF_PE,
			sp.ALF_STS_CD,
			sp.GNDR_CD,
			sp.PROV_UNIT_CD,
			sp.SPELL_NUM_PE,
			sp.ADMIS_DT,
			sp.ADMIS_YR,
			ep.OPER_CD_123,
			ep.OPER_CD, 
			ep.EPI_NUM,
			ep.FINISHED_EPI_FLG,
			ep.AGE_EPI_STR_YR,
			ep.ETH_GRP_DERIVED_CD,
			ep.ETH_GRP_DERIVED_DESC
		FROM	SAIL0972V.PEDW_SPELL_20211101 AS sp, 
				SAIL0972V.PEDW_EPISODE_20211101 AS ep) WITH NO DATA;

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MISS_PRE
	ADD COLUMN FIRST_EPI_STR_DT DATE
	ADD COLUMN FIRST_EPI_STR_YR VARCHAR(4)
	ADD COLUMN FIRST_EPI_END_DT DATE
	ADD COLUMN FIRST_EPI_END_YR VARCHAR(4)
	ADD COLUMN PRIMARY_DIAG_123 VARCHAR(6)
	ADD COLUMN PRIMARY_DIAG_1234 VARCHAR(6)
	ADD	COLUMN SPELL_ID VARCHAR(14)
	ADD COLUMN EPI_ID VARCHAR(16)
	ADD COLUMN WELSH_ADDRESS INTEGER
	ADD COLUMN ADDRESS_START DATE
	ADD COLUMN ADDRESS_END DATE
	ADD COLUMN WOB DATE
	ADD COLUMN WIMD_2019_QUINTILE INTEGER
	ADD COLUMN WIMD_2019_QUINTILE_DESC VARCHAR(50)
	;

INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MISS_PRE
			(ALF_PE, 
			ALF_STS_CD,
			GNDR_CD,
			PROV_UNIT_CD, 
			SPELL_NUM_PE,
			ADMIS_DT,
			ADMIS_YR,
			PRIMARY_DIAG_123,
			PRIMARY_DIAG_1234,
			OPER_CD_123,
			OPER_CD,
			FIRST_EPI_STR_DT,
			FIRST_EPI_STR_YR,
			FIRST_EPI_END_DT, 
			FIRST_EPI_END_YR,
			EPI_NUM,
			FINISHED_EPI_FLG,
			AGE_EPI_STR_YR,
			ETH_GRP_DERIVED_CD,
			ETH_GRP_DERIVED_DESC,
			SPELL_ID,
			EPI_ID,
			WELSH_ADDRESS,
			ADDRESS_START,
			ADDRESS_END,
			WOB,
			WIMD_2019_QUINTILE,
			WIMD_2019_QUINTILE_DESC)
		SELECT	sp.ALF_PE, 
				sp.ALF_STS_CD,
				sp.GNDR_CD,
				sp.PROV_UNIT_CD, 
				sp.SPELL_NUM_PE,
				sp.ADMIS_DT,
				sp.ADMIS_YR,
				ep.DIAG_CD_123,
				ep.DIAG_CD_1234,
				ep.OPER_CD_123,
				ep.OPER_CD, 
				ep.EPI_STR_DT,
				ep.EPI_STR_YR,
				ep.EPI_END_DT, 
				ep.EPI_END_YR,
				ep.EPI_NUM,
				ep.FINISHED_EPI_FLG,
				ep.AGE_EPI_STR_YR,
				ep.ETH_GRP_DERIVED_CD,
				ep.ETH_GRP_DERIVED_DESC,
				ep.PROV_UNIT_CD||ep.SPELL_NUM_PE,
				ep.PROV_UNIT_CD||ep.SPELL_NUM_PE||ep.EPI_NUM,
				wdsd.WELSH_ADDRESS,
				wdsd.START_DATE,
				wdsd.END_DATE,
				per.WOB,
				lsoa.WIMD_2019_QUINTILE,
				lsoa.WIMD_2019_QUINTILE_DESC
		FROM SAIL0972V.PEDW_EPISODE_20211101 ep
			LEFT JOIN SAIL0972V.PEDW_SPELL_20211101 sp
				ON ep.PROV_UNIT_CD||ep.SPELL_NUM_PE = sp.PROV_UNIT_CD||sp.SPELL_NUM_PE --link PEDW EPI and SPELL on prov unit cd and spell num--
			LEFT JOIN SAIL0972V.WDSD_CLEAN_ADD_WALES_20210502 AS wdsd
					ON sp.ALF_PE = wdsd.ALF_PE
					AND ep.EPI_STR_DT BETWEEN wdsd.START_DATE AND wdsd.END_DATE
			LEFT JOIN SAIL0972V.WDSD_AR_PERS_20210502 AS per
					ON sp.ALF_PE = per.ALF_PE
			LEFT JOIN SAIL0972V.WDSD_CLEAN_ADD_GEOG_CHAR_LSOA2011_20210502 AS lsoa
					ON sp.ALF_PE = lsoa.ALF_PE
					AND ep.EPI_STR_DT BETWEEN lsoa.START_DATE AND lsoa.END_DATE;
				
DELETE FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_PRE AS pre
	WHERE pre.FINISHED_EPI_FLG = '0';

CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF AS
	(SELECT	*
		FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_PRE) WITH NO DATA;
	
INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF
	(SELECT pre.* FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_PRE AS pre
	WHERE (pre.ALF_STS_CD IS NOT NULL
			AND pre.ALF_STS_CD IN ('1', '4', '39'))
		AND pre.FIRST_EPI_STR_DT BETWEEN '2010-01-01' AND '2020-12-31');
	
CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF_WALES AS
	(SELECT	*
		FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF) WITH NO DATA;
	
INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF_WALES
	(SELECT opcs.* FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF AS opcs
	WHERE opcs.WELSH_ADDRESS = '1');

CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF_WALES_AGE AS
	(SELECT	*
		FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF_WALES) WITH NO DATA;
	
INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF_WALES_AGE
	(SELECT WALES.* FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF_WALES AS WALES
	WHERE WALES.AGE_EPI_STR_YR BETWEEN 30 AND 100);

CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MISS AS
	(SELECT	*
		FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF_WALES_AGE) WITH NO DATA;
	
INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MISS
	(SELECT eps.* 
	FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_ALF_WALES_AGE AS eps
		LEFT JOIN SAIL0972V.ADDE_DEATHS_20210428 AS dd
			ON eps.ALF_PE = dd.ALF_PE 
			WHERE eps.FIRST_EPI_STR_DT <= dd.DEATH_DT
			OR dd.DEATH_DT IS NULL);
		
CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MISS_DIAG_LINK AS
	(SELECT *
		FROM SAILW0972V.V2_VB_PEDW_EPS_MISS) WITH NO DATA;
		
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MISS_DIAG_LINK
	ADD COLUMN DIAG_CD_123 VARCHAR(6)
	ADD COLUMN DIAG_CD_1234 VARCHAR(6)
	ADD COLUMN DIAG_NUM INTEGER
	;

INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MISS_DIAG_LINK
			(ALF_PE, 
			ALF_STS_CD,
			GNDR_CD,
			PROV_UNIT_CD, 
			SPELL_NUM_PE,
			ADMIS_DT,
			ADMIS_YR,
			PRIMARY_DIAG_123,
			PRIMARY_DIAG_1234,
			OPER_CD_123,
			OPER_CD,
			FIRST_EPI_STR_DT,
			FIRST_EPI_STR_YR,
			FIRST_EPI_END_DT, 
			FIRST_EPI_END_YR,
			EPI_NUM,
			FINISHED_EPI_FLG,
			AGE_EPI_STR_YR,
			ETH_GRP_DERIVED_CD,
			ETH_GRP_DERIVED_DESC,
			SPELL_ID,
			EPI_ID,
			WELSH_ADDRESS,
			ADDRESS_START,
			ADDRESS_END,
			WOB,
			WIMD_2019_QUINTILE,
			WIMD_2019_QUINTILE_DESC,
			DIAG_CD_123,
			DIAG_CD_1234,
			DIAG_NUM)
		SELECT	ep.ALF_PE, 
				ep.ALF_STS_CD,
				ep.GNDR_CD,
				ep.PROV_UNIT_CD, 
				ep.SPELL_NUM_PE,
				ep.ADMIS_DT,
				ep.ADMIS_YR,
				ep.PRIMARY_DIAG_123,
				ep.PRIMARY_DIAG_1234,
				ep.OPER_CD_123,
				ep.OPER_CD, 
				ep.FIRST_EPI_STR_DT,
				ep.FIRST_EPI_STR_YR,
				ep.FIRST_EPI_END_DT, 
				ep.FIRST_EPI_END_YR,
				ep.EPI_NUM,
				ep.FINISHED_EPI_FLG,
				ep.AGE_EPI_STR_YR,
				ep.ETH_GRP_DERIVED_CD,
				ep.ETH_GRP_DERIVED_DESC,
				ep.SPELL_ID,
				ep.EPI_ID,
				ep.WELSH_ADDRESS,
				ep.ADDRESS_START,
				ep.ADDRESS_END,
				ep.WOB,
				ep.WIMD_2019_QUINTILE,
				ep.WIMD_2019_QUINTILE_DESC,
				diag.DIAG_CD_123,
				diag.DIAG_CD_1234,
				diag.DIAG_NUM
		FROM SAILW0972V.V2_VB_PEDW_EPS_MISS ep
			JOIN SAIL0972V.PEDW_DIAG_20211101 diag
				ON ep.EPI_ID = diag.PROV_UNIT_CD||diag.SPELL_NUM_PE||diag.EPI_NUM;

CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE AS
	(SELECT *
		FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_DIAG_LINK) WITH NO DATA;
	
INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE
	(SELECT eps.* 
	FROM SAILW0972V.V2_VB_PEDW_EPS_MISS_DIAG_LINK AS eps
		JOIN SAILW0972V.VB_ICD_MI_STROKE AS icd
			ON eps.DIAG_CD_1234 = icd.ICD10_CD
			AND icd.ICD10_CD IS NOT NULL);

		
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE
	ADD COLUMN EVENT_TYPE VARCHAR(6);

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE AS eps
	USING SAILW0972V.VB_ICD_MI_STROKE AS icd
		ON eps.DIAG_CD_1234 = icd.ICD10_CD
			WHEN MATCHED THEN
				UPDATE
				SET eps.EVENT_TYPE = icd.CATEGORY
			;	
		
/* Stroke First Event */
		
CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_DISTINCT AS
	(SELECT ep.ALF_PE,
			ep.FIRST_EPI_STR_DT
		FROM SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE AS ep) WITH NO DATA;
	
INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_DISTINCT
			(ALF_PE,
			FIRST_EPI_STR_DT)
		SELECT	ep.ALF_PE, 
				ep.FIRST_EPI_STR_DT
		FROM SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE ep
		WHERE ep.EVENT_TYPE = 'STROKE'
			GROUP BY ep.ALF_PE,
					ep.FIRST_EPI_STR_DT;
	
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_DISTINCT
ADD COLUMN EVENT_NUM INTEGER;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_DISTINCT
SET EVENT_NUM=ROW_NUMBER() OVER(PARTITION BY ALF_PE ORDER BY FIRST_EPI_STR_DT);

CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE AS (
	SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE) WITH NO DATA;

INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE
	SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE
		WHERE EVENT_TYPE = 'STROKE';

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE
	ADD COLUMN EVENT_NUM INTEGER
	ADD COLUMN SEASON VARCHAR(10)
	ADD COLUMN AGE_BAND VARCHAR(10);

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE AS eps
	USING SAILW0972V.V2_VB_PEDW_EPS_STROKE_DISTINCT AS dist
		ON eps.FIRST_EPI_STR_DT = dist.FIRST_EPI_STR_DT
		AND eps.ALF_PE = dist.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.EVENT_NUM = dist.EVENT_NUM
			;
		
/* add season field */
		
UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE AS eps
	SET eps.SEASON = CASE WHEN MONTH(eps.FIRST_EPI_STR_DT) IN('3','4','5') THEN 'SPRING'
						WHEN MONTH(eps.FIRST_EPI_STR_DT) IN('6','7','8') THEN 'SUMMER'
						WHEN MONTH(eps.FIRST_EPI_STR_DT) IN('9','10','11') THEN 'AUTUMN'
					ELSE 'WINTER'
						END;
													
/* Add age band field*/					
					
UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE AS eps
	SET eps.AGE_BAND = CASE WHEN AGE_EPI_STR_YR BETWEEN 30 AND 39 THEN '30-39'
						WHEN AGE_EPI_STR_YR BETWEEN 40 AND 49 THEN '40-49'
						WHEN AGE_EPI_STR_YR BETWEEN 50 AND 59 THEN '50-59'
						WHEN AGE_EPI_STR_YR BETWEEN 60 AND 69 THEN '60-69'
						WHEN AGE_EPI_STR_YR BETWEEN 70 AND 79 THEN '70-79'
						WHEN AGE_EPI_STR_YR BETWEEN 80 AND 89 THEN '80-89'
						WHEN AGE_EPI_STR_YR BETWEEN 90 AND 100 THEN '90-100'
						END;
				
CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT_PRE AS
	(SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE) WITH NO DATA;

INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT_PRE
	(SELECT eps.* FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE AS eps
	WHERE eps.EVENT_TYPE = 'STROKE'
	AND eps.EVENT_NUM = '1');
					
/*remove duplicates where first event has multiple episodes, diagnosis codes or provider codes starting on the same day*/

CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS
	(SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE) WITH NO DATA;

INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	(SELECT eps.* FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE AS eps
	WHERE eps.EVENT_TYPE = 'STROKE'
	AND eps.EVENT_NUM = '1');

SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ORDER BY ALF_PE, FIRST_EPI_STR_DT, EPI_NUM;
	
delete FROM 
	(SELECT ROWNUMBER()	OVER(PARTITION BY	ALF_PE, FIRST_EPI_STR_DT
										ORDER BY FIRST_EPI_END_DT) AS rn
									FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT) AS mqo
			WHERE rn > 1;
			
/* MI First Event*/
	
CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_DISTINCT AS
	(SELECT ep.ALF_PE,
			ep.FIRST_EPI_STR_DT
		FROM SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE AS ep) WITH NO DATA;
	
INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MI_DISTINCT
			(ALF_PE,
			FIRST_EPI_STR_DT)
		SELECT	ep.ALF_PE, 
				ep.FIRST_EPI_STR_DT
		FROM SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE ep
		WHERE ep.EVENT_TYPE = 'MI'
			GROUP BY ep.ALF_PE,
					ep.FIRST_EPI_STR_DT;
	
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_DISTINCT
ADD COLUMN EVENT_NUM INTEGER;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_DISTINCT
SET EVENT_NUM=ROW_NUMBER() OVER(PARTITION BY ALF_PE ORDER BY FIRST_EPI_STR_DT);

CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MI AS (
	SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE) WITH NO DATA;

INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MI
	SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_MI_STROKE
		WHERE EVENT_TYPE = 'MI';

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI
	ADD COLUMN EVENT_NUM INTEGER
	ADD COLUMN SEASON VARCHAR(10)
	ADD COLUMN AGE_BAND VARCHAR(10);

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI AS eps
	USING SAILW0972V.V2_VB_PEDW_EPS_MI_DISTINCT AS dist
		ON eps.FIRST_EPI_STR_DT = dist.FIRST_EPI_STR_DT
		AND eps.ALF_PE = dist.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.EVENT_NUM = dist.EVENT_NUM
			;
		
/* add season field */
		
UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI AS eps
	SET eps.SEASON = CASE WHEN MONTH(eps.FIRST_EPI_STR_DT) IN('3','4','5') THEN 'SPRING'
						WHEN MONTH(eps.FIRST_EPI_STR_DT) IN('6','7','8') THEN 'SUMMER'
						WHEN MONTH(eps.FIRST_EPI_STR_DT) IN('9','10','11') THEN 'AUTUMN'
					ELSE 'WINTER'
						END;
													
/* Add age band field*/					
					
UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI AS eps
	SET eps.AGE_BAND = CASE WHEN AGE_EPI_STR_YR BETWEEN 30 AND 39 THEN '30-39'
						WHEN AGE_EPI_STR_YR BETWEEN 40 AND 49 THEN '40-49'
						WHEN AGE_EPI_STR_YR BETWEEN 50 AND 59 THEN '50-59'
						WHEN AGE_EPI_STR_YR BETWEEN 60 AND 69 THEN '60-69'
						WHEN AGE_EPI_STR_YR BETWEEN 70 AND 79 THEN '70-79'
						WHEN AGE_EPI_STR_YR BETWEEN 80 AND 89 THEN '80-89'
						WHEN AGE_EPI_STR_YR BETWEEN 90 AND 100 THEN '90-100'
						END;
				
CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT_PRE AS
	(SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_MI) WITH NO DATA;

INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT_PRE
	(SELECT eps.* FROM SAILW0972V.V2_VB_PEDW_EPS_MI AS eps
	WHERE eps.EVENT_TYPE = 'MI'
	AND eps.EVENT_NUM = '1');
					
/*remove duplicates where first event has multiple episodes, diagnosis codes or provider codes starting on the same day*/

CREATE TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS
	(SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_MI) WITH NO DATA;

INSERT INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	(SELECT eps.* FROM SAILW0972V.V2_VB_PEDW_EPS_MI AS eps
	WHERE eps.EVENT_TYPE = 'MI'
	AND eps.EVENT_NUM = '1');

SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ORDER BY ALF_PE, FIRST_EPI_STR_DT, EPI_NUM;
	
delete FROM 
	(SELECT ROWNUMBER()	OVER(PARTITION BY	ALF_PE, FIRST_EPI_STR_DT
										ORDER BY FIRST_EPI_END_DT) AS rn
									FROM SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT) AS mqo
			WHERE rn > 1;
	

/*time in cohort calcs*/
/*create blank table*/
	
CREATE TABLE SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT AS
	(SELECT *
		FROM SAIL0972V.WDSD_AR_PERS_20210502) WITH NO DATA;
	
/*populate with wdsd data*/
	
INSERT INTO SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT 
	(SELECT wdsd.*
		FROM SAIL0972V.WDSD_AR_PERS_20210502 AS wdsd);
	
delete FROM SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT AS age
	WHERE age.DOD < '2010-01-01';
	
/*add start, end date and duration in cohort columns*/

ALTER TABLE SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT
	ADD COLUMN AGE_START_DATE DATE
	ADD COLUMN AGE_END_DATE DATE
	ADD COLUMN DAYS_IN_COHORT INTEGER;

/*populate start date with the latest date out of date reached 30 and 2010-01-01*/
	
UPDATE SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT AS yic
	SET yic.AGE_START_DATE = CASE WHEN yic.WOB + 30 years > '2010-01-01'
			THEN yic.WOB + 30 YEARS
	ELSE '2010-01-01'
		END;
	
	
/*delete records for individuals not reaching 30 until after the date range*/	
	
delete FROM SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT AS yic
	WHERE yic.AGE_START_DATE > '2020-12-31';
	
/*populate end date with earliest date out of date of death, age of 100 reached and 2020-12-31*/
	
UPDATE SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT AS yic
	SET yic.AGE_END_DATE = CASE WHEN yic.DOD < '2010-01-01'
			THEN '2010-01-01'
	WHEN yic.DOD < '2020-12-31'
			THEN yic.DOD
	WHEN yic.WOB + 100 YEARS BETWEEN '2010-01-01' AND '2020-12-31'
			THEN yic.WOB + 100 YEARS
	ELSE '2020-12-31'
		END;
	
/*calculate days in cohort based on Welsh address*/

UPDATE SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT AS yic
	SET yic.DAYS_IN_COHORT = CASE WHEN DAYS(yic.AGE_END_DATE) - DAYS(yic.AGE_START_DATE)>=0
			THEN DAYS(yic.AGE_END_DATE) - DAYS(yic.AGE_START_DATE)
	ELSE '0'
		END;
	
/*create table for address time in Wales*/
	
CREATE TABLE SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT AS
	(SELECT *
		FROM SAIL0972V.WDSD_CLEAN_ADD_WALES_20210502) WITH NO DATA;
	
/*populate with wdsd data*/
	
INSERT INTO SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT 
	(SELECT wdsd.*
		FROM SAIL0972V.WDSD_CLEAN_ADD_WALES_20210502 AS wdsd);
	
/*delete records outside the date range*/
	
delete FROM SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT AS yic
	WHERE yic.START_DATE > '2020-12-31';
	
delete FROM SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT AS yic
	WHERE yic.END_DATE < '2010-01-01';

/*delete records outside for address outside Wales*/

delete FROM SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT AS yic
	WHERE yic.WELSH_ADDRESS = '0';
	
/*add start, end date and duration in cohort columns*/

ALTER TABLE SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT
	ADD COLUMN WALES_START_DATE DATE
	ADD COLUMN WALES_END_DATE DATE
	ADD COLUMN DAYS_IN_COHORT INTEGER;

/*populate start date with the latest date out of address start date and 2010-01-01*/
	
UPDATE SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT AS yic
	SET yic.WALES_START_DATE = CASE WHEN yic.START_DATE > '2010-01-01'
			THEN yic.START_DATE
	ELSE '2010-01-01'
		END;

/*populate end date with earliest date out of address end date and 2020-12-31*/
	
UPDATE SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT AS yic
	SET yic.WALES_END_DATE = CASE WHEN yic.END_DATE < '2010-01-01'
			THEN '2010-01-01'
	WHEN yic.END_DATE < '2020-12-31'
			THEN yic.END_DATE
	ELSE '2020-12-31'
		END;
		
/*calculate time in days for each address row*/
	
UPDATE SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT AS yic
	SET yic.DAYS_IN_COHORT = CASE WHEN DAYS(yic.WALES_END_DATE) - DAYS(yic.WALES_START_DATE) >=0
			THEN DAYS(yic.WALES_END_DATE) - DAYS(yic.WALES_START_DATE)
	ELSE '0'
		END;
	
/* check for errors ALFs with DAYS_IN_COHORT greater than the date range of 4017 days*/
		
SELECT eps.ALF_PE, SUM(eps.DAYS_IN_COHORT) AS TOT_DAYS
	FROM SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT AS eps
		GROUP BY eps.ALF_PE
				HAVING SUM(eps.DAYS_IN_COHORT) > 4017
			;
		
/*create combined time in cohort table*/
			
CREATE TABLE SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS
	(SELECT	age.ALF_PE,
			age.AGE_START_DATE,
			age.AGE_END_DATE,
			res.WALES_START_DATE,
			res.WALES_END_DATE
		FROM	SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT AS age, 
				SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT AS res) WITH NO DATA;
				
INSERT INTO SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT
			(ALF_PE,
			AGE_START_DATE,
			AGE_END_DATE,
			WALES_START_DATE,
			WALES_END_DATE)
		SELECT	res.ALF_PE,
				age.AGE_START_DATE,
				age.AGE_END_DATE,
				res.WALES_START_DATE,
				res.WALES_END_DATE
		FROM SAILW0972V.V2_VB_WDSD_WALES_IN_COHORT AS res
			LEFT JOIN SAILW0972V.V2_VB_WDSD_AGE_IN_COHORT AS age
				ON res.ALF_PE = age.ALF_PE;
				
ALTER TABLE SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT
	ADD COLUMN LATEST_START DATE
	ADD COLUMN EARLIEST_END DATE
	ADD COLUMN DAYS_IN_COHORT INTEGER;

UPDATE SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS ic
	SET ic.LATEST_START = CASE WHEN ic.AGE_START_DATE > ic.WALES_START_DATE
			THEN ic.AGE_START_DATE
	ELSE ic.WALES_START_DATE
		END;
	
UPDATE SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS ic
	SET ic.EARLIEST_END = CASE WHEN ic.AGE_END_DATE < ic.WALES_END_DATE
			THEN ic.AGE_END_DATE
	ELSE ic.WALES_END_DATE
		END;
	
UPDATE SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS ic
	SET ic.DAYS_IN_COHORT = CASE WHEN DAYS(ic.EARLIEST_END) - DAYS(ic.LATEST_START) >=0
			THEN DAYS(ic.EARLIEST_END) - DAYS(ic.LATEST_START)
	ELSE '0'
		END;
	
	
--Check for and delete rows where ALF_PE, LATEST_START and EARLIEST_END match

delete FROM
	(SELECT ROWNUMBER()	OVER(PARTITION BY ALF_PE, LATEST_START, EARLIEST_END ORDER BY EARLIEST_END) AS rn
			FROM SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT) AS mqo
			WHERE rn > 1;
		
--Check for and delete rows where LATEST_START is after EARLIEST_END

delete FROM SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT
			WHERE LATEST_START > EARLIEST_END;
	
--add row number column

ALTER TABLE SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT
ADD COLUMN ROW_NUM INTEGER;

UPDATE SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT
	SET ROW_NUM = ROWNUMBER() OVER(PARTITION BY ALF_PE ORDER BY EARLIEST_END);

--delete all but first period of inclusion

delete FROM SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT
	WHERE ROW_NUM <> '1';
	
/* check for errors with days greater than the number of days n date range (4017)*/	
	
SELECT ic.ALF_PE, sum(ic.DAYS_IN_COHORT) AS tot_days 
	FROM SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS ic
	GROUP BY ic.ALF_PE
	HAVING sum(ic.DAYS_IN_COHORT) > 4017;


--add inclusion start and end dates to MI cohort

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN INC_STR_DT DATE
	ADD COLUMN INC_END_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS eps
	USING SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS ic
		ON eps.ALF_PE = ic.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.INC_STR_DT = ic.LATEST_START
			;
		
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS eps
	USING SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS ic
		ON eps.ALF_PE = ic.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.INC_END_DT = ic.EARLIEST_END
			;
		
--add inclusion start and end dates to stroke cohort

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN INC_STR_DT DATE
	ADD COLUMN INC_END_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS eps
	USING SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS ic
		ON eps.ALF_PE = ic.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.INC_STR_DT = ic.LATEST_START
			;
		
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS eps
	USING SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS ic
		ON eps.ALF_PE = ic.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.INC_END_DT = ic.EARLIEST_END
			;

/* add days in cohort to stroke table */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN DAYS_IN_COHORT INTEGER;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS eps
	USING SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS ic
		ON eps.ALF_PE = ic.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.DAYS_IN_COHORT = ic.DAYS_IN_COHORT
			;
		
--delete rows from stroke cohort where event is outside first period of study inclusion

delete FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	WHERE FIRST_EPI_STR_DT NOT BETWEEN INC_STR_DT AND INC_END_DT;

/* add days in cohort to MI table */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN DAYS_IN_COHORT INTEGER;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS eps
	USING SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS ic
		ON eps.ALF_PE = ic.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.DAYS_IN_COHORT = ic.DAYS_IN_COHORT
			;
		
--delete rows from MI cohort where event is outside first period of study inclusion

delete FROM SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	WHERE FIRST_EPI_STR_DT NOT BETWEEN INC_STR_DT AND INC_END_DT;

---------------------------------------------------------------------------------------------------------------------
		
/* Identify start of health data */
		
/* create cleansed GP event date by excluding events with a start date prior to week of birth */
/* note that this does not include the first WLGP event date due to concerns about the accuracy of this field
 * Therefore first health data is based on WLGP registration and PEDW events only 
 */		

		
CREATE TABLE SAILW0972V.V2_VB_MI_HEALTH_DATA (
	ALF_PE VARCHAR(50),
	FIRST_GP_REG DATE,
	FIRST_PEDW_SPELL DATE);

INSERT INTO SAILW0972V.V2_VB_MI_HEALTH_DATA(
	ALF_PE,
	FIRST_GP_REG,
	FIRST_PEDW_SPELL)
	SELECT
		MI.ALF_PE,
		MIN(reg.START_DATE),
		MIN(sp.ADMIS_DT)
			FROM SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS MI
				LEFT JOIN SAIL0972V.WLGP_CLEAN_GP_REG_MEDIAN_20220301 AS reg
					ON MI.ALF_PE = reg.ALF_PE
				LEFT JOIN SAIL0972V.PEDW_SPELL_20211101 AS sp
					ON MI.ALF_PE = sp.ALF_PE
	GROUP BY MI.ALF_PE;

/*Replace NULLs with future date */

UPDATE SAILW0972V.V2_VB_MI_HEALTH_DATA AS MI
	SET MI.FIRST_GP_REG = '2099-01-01'
		WHERE MI.FIRST_GP_REG IS NULL;

UPDATE SAILW0972V.V2_VB_MI_HEALTH_DATA AS MI
	SET MI.FIRST_PEDW_SPELL = '2099-01-01'
		WHERE MI.FIRST_PEDW_SPELL IS NULL;
	
/* Add column for the first of the health dates and populate with min date */

ALTER TABLE SAILW0972V.V2_VB_MI_HEALTH_DATA
	ADD COLUMN FIRST_HEALTH_DT DATE;

UPDATE SAILW0972V.V2_VB_MI_HEALTH_DATA AS MI
	SET MI.FIRST_HEALTH_DT = CASE WHEN MI.FIRST_GP_REG < MI.FIRST_PEDW_SPELL THEN MI.FIRST_GP_REG
							ELSE MI.FIRST_PEDW_SPELL
						END;
					
/* calculate health data period prior to start of study 2010-01-01 */
					
ALTER TABLE SAILW0972V.V2_VB_MI_HEALTH_DATA
	ADD COLUMN HEALTH_DATA_YRS_STUDY_ST INTEGER;

UPDATE SAILW0972V.V2_VB_MI_HEALTH_DATA AS MI
	SET MI.HEALTH_DATA_YRS_STUDY_ST = YEAR('2010-01-01' - MI.FIRST_HEALTH_DT)
	;

SELECT * FROM SAILW0972V.V2_VB_MI_HEALTH_DATA;
	

/* Produce first health date for stroke table */

CREATE TABLE SAILW0972V.V2_VB_STROKE_HEALTH_DATA (
	ALF_PE VARCHAR(50),
	FIRST_GP_REG DATE,
	FIRST_PEDW_SPELL DATE);

INSERT INTO SAILW0972V.V2_VB_STROKE_HEALTH_DATA(
	ALF_PE,
	FIRST_GP_REG,
	FIRST_PEDW_SPELL)
	SELECT
		ST.ALF_PE,
		MIN(reg.START_DATE),
		MIN(sp.ADMIS_DT)
			FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS ST
				LEFT JOIN SAIL0972V.WLGP_CLEAN_GP_REG_MEDIAN_20220301 AS reg
					ON ST.ALF_PE = reg.ALF_PE
				LEFT JOIN SAIL0972V.PEDW_SPELL_20211101 AS sp
					ON ST.ALF_PE = sp.ALF_PE
	GROUP BY ST.ALF_PE;

/*Replace NULLs with future date */

UPDATE SAILW0972V.V2_VB_STROKE_HEALTH_DATA AS ST
	SET ST.FIRST_GP_REG = '2099-01-01'
		WHERE ST.FIRST_GP_REG IS NULL;

UPDATE SAILW0972V.V2_VB_STROKE_HEALTH_DATA AS ST
	SET ST.FIRST_PEDW_SPELL = '2099-01-01'
		WHERE ST.FIRST_PEDW_SPELL IS NULL;
	
/* Add column for the first of the health dates and populate with min date */

ALTER TABLE SAILW0972V.V2_VB_STROKE_HEALTH_DATA
	ADD COLUMN FIRST_HEALTH_DT DATE;

UPDATE SAILW0972V.V2_VB_STROKE_HEALTH_DATA AS ST
	SET ST.FIRST_HEALTH_DT = CASE WHEN ST.FIRST_GP_REG < ST.FIRST_PEDW_SPELL THEN ST.FIRST_GP_REG
							ELSE ST.FIRST_PEDW_SPELL
						END;
					
/* calculate health data period prior to start of study 2010-01-01 */
					
ALTER TABLE SAILW0972V.V2_VB_STROKE_HEALTH_DATA
	ADD COLUMN HEALTH_DATA_YRS_STUDY_ST INTEGER;

UPDATE SAILW0972V.V2_VB_STROKE_HEALTH_DATA AS ST
	SET ST.HEALTH_DATA_YRS_STUDY_ST = YEAR('2010-01-01' - ST.FIRST_HEALTH_DT)
	;

/* insert first health date and health data yrs from study start into first stroke event tables */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN HEALTH_DATA_YRS_STUDY_ST INTEGER
	ADD COLUMN FIRST_HEALTH_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS eps
	USING SAILW0972V.V2_VB_STROKE_HEALTH_DATA AS hd
		ON eps.ALF_PE = hd.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.HEALTH_DATA_YRS_STUDY_ST = hd.HEALTH_DATA_YRS_STUDY_ST
			;
		
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS eps
	USING SAILW0972V.V2_VB_STROKE_HEALTH_DATA AS hd
		ON eps.ALF_PE = hd.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.FIRST_HEALTH_DT = hd.FIRST_HEALTH_DT
			;
		
/* calculate years between first health data date and first event */
		
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN HEALTH_DATA_YRS_FIRST_EVT INTEGER;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS eps
	SET eps.HEALTH_DATA_YRS_FIRST_EVT = YEAR(eps.FIRST_EPI_STR_DT - eps.FIRST_HEALTH_DT)
	;


/* insert first health date and health data yrs from study start into first MI event tables */
		
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN HEALTH_DATA_YRS_STUDY_ST INTEGER
	ADD COLUMN FIRST_HEALTH_DT DATE;
	
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS eps
	USING SAILW0972V.V2_VB_MI_HEALTH_DATA AS hd
		ON eps.ALF_PE = hd.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.HEALTH_DATA_YRS_STUDY_ST = hd.HEALTH_DATA_YRS_STUDY_ST
			;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS eps
	USING SAILW0972V.V2_VB_MI_HEALTH_DATA AS hd
		ON eps.ALF_PE = hd.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET eps.FIRST_HEALTH_DT = hd.FIRST_HEALTH_DT
			;

/* calculate years between first health data date and first event */
		
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN HEALTH_DATA_YRS_FIRST_EVT INTEGER;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS eps
	SET eps.HEALTH_DATA_YRS_FIRST_EVT = YEAR(eps.FIRST_EPI_STR_DT - eps.FIRST_HEALTH_DT)
	;

/* Identify previous events within the PEDW dataset */

/* Link MI cohort ALFs to all PEDW spells */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_SPELLS_MI AS (
	SELECT	fe.ALF_PE, 
			sp.PROV_UNIT_CD,
			sp.SPELL_NUM_PE
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.PEDW_SPELL_20211101 AS sp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_SPELLS_MI
	SELECT	fe.ALF_PE, 
			sp.PROV_UNIT_CD,
			sp.SPELL_NUM_PE
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.PEDW_SPELL_20211101 AS sp
			WHERE 	fe.ALF_PE = sp.ALF_PE
			;

Commit;


/* Link all MI cohort spells to PEDW episode and diag tables to identify any episodes with MI ICD-10 codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_DIAG_MI AS (
	SELECT	sp.ALF_PE, 
			sp.PROV_UNIT_CD,
			sp.SPELL_NUM_PE,
			ep.EPI_NUM,
			ep.EPI_STR_DT,
			di.DIAG_CD
		FROM	SESSION.V2_ALL_COHORT_SPELLS_MI AS sp,
				SAIL0972V.PEDW_EPISODE_20211101 AS ep,
				SAIL0972V.PEDW_DIAG_20211101 AS di)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_DIAG_MI
	SELECT	sp.ALF_PE, 
			sp.PROV_UNIT_CD,
			sp.SPELL_NUM_PE,
			ep.EPI_NUM,
			ep.EPI_STR_DT,
			di.DIAG_CD
		FROM	SESSION.V2_ALL_COHORT_SPELLS_MI AS sp,
				SAIL0972V.PEDW_EPISODE_20211101 AS ep,
				SAIL0972V.PEDW_DIAG_20211101 AS di
			WHERE 	sp.PROV_UNIT_CD||sp.SPELL_NUM_PE = ep.PROV_UNIT_CD||ep.SPELL_NUM_PE
			AND 	ep.PROV_UNIT_CD||ep.SPELL_NUM_PE||ep.EPI_NUM = di.PROV_UNIT_CD||di.SPELL_NUM_PE||di.EPI_NUM
			AND		ep.EPI_STR_DT < '2010-01-01'
			AND 	di.DIAG_CD IN (	'I213',
									'I211',
									'I212',
									'I228',
									'I210',
									'I214',
									'I221',
									'I229',
									'I219',
									'I220')
;


Commit;

/* Identify first episode start date for any episode with a recorded ICD-10 code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_MI AS (
	SELECT	di.ALF_PE, 
			di.EPI_STR_DT
		FROM SESSION.V2_ALL_COHORT_DIAG_MI AS di)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_MI
	SELECT	di.ALF_PE,
			MIN(di.EPI_STR_DT)
		FROM SESSION.V2_ALL_COHORT_DIAG_MI AS di
	GROUP BY di.ALF_PE
;

Commit;

/* Update the MI cohort table with a true false indicator of whether there was an MI event prior to the study period and the date of the first episode start */
		
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN PREVIOUS_EVENT VARCHAR(5)
	ADD COLUMN PREVIOUS_EVENT_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_MI AS mi
		ON fe.ALF_PE = mi.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.PREVIOUS_EVENT_DT = mi.EPI_STR_DT
			;
		
UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET PREVIOUS_EVENT = TRUE
		WHERE PREVIOUS_EVENT_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET PREVIOUS_EVENT = FALSE
		WHERE PREVIOUS_EVENT_DT IS NULL;

/* Link Stroke cohort ALFs to all PEDW spells */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_SPELLS_STROKE AS (
	SELECT	fe.ALF_PE, 
			sp.PROV_UNIT_CD,
			sp.SPELL_NUM_PE
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.PEDW_SPELL_20211101 AS sp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_SPELLS_STROKE
	SELECT	fe.ALF_PE, 
			sp.PROV_UNIT_CD,
			sp.SPELL_NUM_PE
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.PEDW_SPELL_20211101 AS sp
			WHERE 	fe.ALF_PE = sp.ALF_PE
			;

Commit;

/* Link all Stroke cohort spells to PEDW episode and diag tables to identify any episodes with MI ICD-10 codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_DIAG_STROKE AS (
	SELECT	sp.ALF_PE, 
			sp.PROV_UNIT_CD,
			sp.SPELL_NUM_PE,
			ep.EPI_NUM,
			ep.EPI_STR_DT,
			di.DIAG_CD
		FROM	SESSION.V2_ALL_COHORT_SPELLS_STROKE AS sp,
				SAIL0972V.PEDW_EPISODE_20211101 AS ep,
				SAIL0972V.PEDW_DIAG_20211101 AS di)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_DIAG_STROKE
	SELECT	sp.ALF_PE, 
			sp.PROV_UNIT_CD,
			sp.SPELL_NUM_PE,
			ep.EPI_NUM,
			ep.EPI_STR_DT,
			di.DIAG_CD
		FROM	SESSION.V2_ALL_COHORT_SPELLS_STROKE AS sp,
				SAIL0972V.PEDW_EPISODE_20211101 AS ep,
				SAIL0972V.PEDW_DIAG_20211101 AS di
			WHERE 	sp.PROV_UNIT_CD||sp.SPELL_NUM_PE = ep.PROV_UNIT_CD||ep.SPELL_NUM_PE
			AND 	ep.PROV_UNIT_CD||ep.SPELL_NUM_PE||ep.EPI_NUM = di.PROV_UNIT_CD||di.SPELL_NUM_PE||di.EPI_NUM
			AND		ep.EPI_STR_DT < '2010-01-01'
			AND 	di.DIAG_CD IN (	'I602',
									'I605',
									'I613',
									'I615',
									'I616',
									'I619',
									'I603',
									'I607',
									'I610',
									'I612',
									'I618',
									'I629',
									'I631',
									'I64X',
									'I601',
									'I609',
									'I611',
									'I635',
									'I636',
									'I604',
									'I606',
									'I630',
									'I634',
									'I600',
									'I608',
									'I614',
									'I632',
									'I633',
									'I638',
									'I639')
;

Commit;

/* Identify first episode start date for any episode with a recorded stroke ICD-10 code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_STROKE AS (
	SELECT	di.ALF_PE, 
			di.EPI_STR_DT
		FROM SESSION.V2_ALL_COHORT_DIAG_STROKE AS di)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_STROKE
	SELECT	di.ALF_PE,
			MIN(di.EPI_STR_DT)
		FROM SESSION.V2_ALL_COHORT_DIAG_STROKE AS di
	GROUP BY di.ALF_PE
;

Commit;

/* Update the Stroke cohort table with a true false indicator of whether there was an MI event prior to the study period and the date of the first episode start */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN PREVIOUS_EVENT VARCHAR(5)
	ADD COLUMN PREVIOUS_EVENT_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_STROKE AS st
		ON fe.ALF_PE = st.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.PREVIOUS_EVENT_DT = st.EPI_STR_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET PREVIOUS_EVENT = TRUE
		WHERE PREVIOUS_EVENT_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET PREVIOUS_EVENT = FALSE
		WHERE PREVIOUS_EVENT_DT IS NULL;


	
/* Add age at first event date column to Stroke and MI cohort tables*/
	
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN AGE_AT_PREVIOUS_EVENT INTEGER;


UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET AGE_AT_PREVIOUS_EVENT = YEAR(PREVIOUS_EVENT_DT - WOB)
	;

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN AGE_AT_PREVIOUS_EVENT INTEGER;


UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET AGE_AT_PREVIOUS_EVENT = YEAR(PREVIOUS_EVENT_DT - WOB)
	;


/* update with welsh resi */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN WELSH_RESI_PREVIOUS_EVENT VARCHAR(5);

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	SET fe.WELSH_RESI_PREVIOUS_EVENT = (
				SELECT DISTINCT wales.WELSH_ADDRESS
					FROM SAIL0972V.WDSD_CLEAN_ADD_WALES_20210502 AS wales
						INNER JOIN SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
						ON wales.ALF_PE = SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT.ALF_PE
						AND fe.PREVIOUS_EVENT_DT BETWEEN wales.START_DATE AND wales.END_DATE
						AND wales.ALF_PE = fe.ALF_PE);
					
/* update MI cohort table with welsh residence at time of first event */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN WELSH_RESI_PREVIOUS_EVENT VARCHAR(5);

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	SET fe.WELSH_RESI_PREVIOUS_EVENT = (
				SELECT DISTINCT wales.WELSH_ADDRESS
					FROM SAIL0972V.WDSD_CLEAN_ADD_WALES_20210502 AS wales
						INNER JOIN SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
						ON wales.ALF_PE = SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT.ALF_PE
						AND fe.PREVIOUS_EVENT_DT BETWEEN wales.START_DATE AND wales.END_DATE
						AND wales.ALF_PE = fe.ALF_PE);
					
-----------------------------------------------------------------------------------------------------------------------------------------------------------------
	
/* EFI */
					
--Please cite: 
-- External validation of the electronic Frailty Index using the population of Wales within the Secure Anonymised Information Linkage Databank
-- J Hollinghurst et al
-- Age and Ageing
--DOI https://doi.org/10.1093/ageing/afz110
-- AND
-- Development and validation of an electronic Frailty Index using routine primary care electronic health record data
--Clegg et al
--Age and Ageing
--DOI https://doi.org/10.1093/ageing/afw039
	
CREATE OR REPLACE ALIAS SAILW0972V.V2_GPDATA 
FOR SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301;

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_MI_COHORT_EFI');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_cohort_with_dummy_date');

CREATE TABLE SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS (SELECT ALF_PE,  FIRST_EPI_STR_DT AS event_dt FROM SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT) WITH no DATA ;

INSERT INTO SAILW0972V.V2_COHORT_WITH_DUMMY_DATE 
SELECT ALF_PE ,  FIRST_EPI_STR_DT AS event_dt FROM SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT ;

--drop table SAILW0972V.V2_VB_MI_COHORT_EFI_DEF1

 CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF1 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF1(
		SELECT
			ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD = '39F..'
			AND EVENT_VAL < 19)
			OR (EVENT_CD IN ( '13O5.',
			'13V8.',
			'13VC.',
			'8F6..',
			'9EB5.' ) )
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF2 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF2 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '423..'
			AND EVENT_VAL BETWEEN 0 AND 12.5)
			OR (EVENT_CD = '423..'
			AND EVENT_VAL BETWEEN 25 AND 125)
			--need to take in to account a change in magnitude of measurement
			OR (EVENT_CD IN ( '145..',
			'1451.',
			'1452.',
			'1453.',
			'1454.',
			'2C23.',
			'42R41',
			'42T2.',
			'66E5.',
			'7Q090',
			'7Q091',
			'B9370',
			'B9371',
			'B9372',
			'B9373',
			'B937X',
			'BBmA.',
			'BBmB.',
			'BBmL.',
			'ByuHC',
			'C2620',
			'C2621',
			'D0...',
			'D00..',
			'D000.',
			'D001.',
			'D00y.',
			'D00y1',
			'D00yz',
			'D00z.',
			'D00z0',
			'D00z1',
			'D00z2',
			'D00zz',
			'D01..',
			'D010.',
			'D011.',
			'D0110',
			'D0111',
			'D011X',
			'D011z',
			'D012.',
			'D0121',
			'D0122',
			'D0123',
			'D0124',
			'D0125',
			'D012z',
			'D013.',
			'D0130',
			'D013z',
			'D014.',
			'D0140',
			'D014z',
			'D01y.',
			'D01yy',
			'D01yz',
			'D01z.',
			'D01z0',
			'D0y..',
			'D0z..',
			'D1...',
			'D104.',
			'D1040',
			'D1047',
			'D104z',
			'D106.',
			'D1060',
			'D1061',
			'D1062',
			'D106z',
			'D11..',
			'D110.',
			'D1100',
			'D1101',
			'D1102',
			'D1103',
			'D1104',
			'D110z',
			'D111.',
			'D1110',
			'D1111',
			'D1112',
			'D1114',
			'D1115',
			'D111y',
			'D111z',
			'D112z',
			'D11z.',
			'D1y..',
			'D1z..',
			'D2...',
			'D20..',
			'D200.',
			'D2000',
			'D2002',
			'D200y',
			'D200z',
			'D201.',
			'D2010',
			'D2011',
			'D2012',
			'D2013',
			'D2014',
			'D2017',
			'D201z',
			'D204.',
			'D20z.',
			'D21..',
			'D210.',
			'D2101',
			'D2103',
			'D2104',
			'D210z',
			'D211.',
			'D212.',
			'D2120',
			'D213.',
			'D214.',
			'D215.',
			'D2150',
			'D21y.',
			'D21yy',
			'D21yz',
			'D21z.',
			'D2y..',
			'D2z..',
			'Dyu0.',
			'Dyu00',
			'Dyu01',
			'Dyu02',
			'Dyu03',
			'Dyu04',
			'Dyu05',
			'Dyu06',
			'Dyu1.',
			'Dyu15',
			'Dyu16',
			'Dyu17',
			'Dyu2.',
			'Dyu21',
			'Dyu22',
			'Dyu23',
			'Dyu24',
			'J6141' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF3 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF3 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14G..',
			'14G1.',
			'14G2.',
			'52A31',
			'52A71',
			'66H..',
			'N0504',
			'7K3..',
			'7K30.',
			'7K32.',
			'7K6Z3',
			'7K6Z7',
			'7K6ZK',
			'C340.',
			'C34z.',
			'N023.',
			'N0310',
			'N04..',
			'N040.',
			'N0400',
			'N0401',
			'N0402',
			'N0404',
			'N0405',
			'N0407',
			'N0408',
			'N0409',
			'N040A',
			'N040B',
			'N040C',
			'N040D',
			'N040F',
			'N040G',
			'N040H',
			'N040J',
			'N040K',
			'N040L',
			'N040M',
			'N040P',
			'N040S',
			'N040T',
			'N047.',
			'N04X.',
			'N05..',
			'N050.',
			'N0502',
			'N0504',
			'N0506',
			'N0535',
			'N0536',
			'N05z1',
			'N05z4',
			'N05z5',
			'N05z6',
			'N05z9',
			'N05zJ',
			'N05zL',
			'N06z.',
			'N06z5',
			'N06z6',
			'N06zz',
			'N11..',
			'N11D.',
			'Nyu10',
			'Nyu11',
			'Nyu12',
			'Nyu1G' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF4 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF4 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '38DE.')
			OR (EVENT_CD IN ( '14AN.',
			'2432.',
			'3272.',
			'3273.',
			'662S.',
			'6A9..',
			'7936A',
			'9Os1.',
			'9hF0.',
			'9hF1.',
			'G573.',
			'G5730',
			'G5731',
			'G5732',
			'G5733',
			'G5734',
			'G5735',
			'G573z' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF5 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF5 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14A7.',
			'14AB.',
			'14AK.',
			'662M.',
			'662e.',
			'662o.',
			'7P242',
			'8HBJ.',
			'8HHM.',
			'8HTQ.',
			'9N0p.',
			'9N4X.',
			'9Om1.',
			'9Om2.',
			'9Om3.',
			'9Om4.',
			'9h21.',
			'9h22.',
			'F4236',
			'G6...',
			'G61..',
			'G621.',
			'G622.',
			'G631.',
			'G634.',
			'G64..',
			'G640.',
			'G65..',
			'G65y.',
			'G65z.',
			'G65z1',
			'G65zz',
			'G66..',
			'G663.',
			'G664.',
			'G667.',
			'G670.',
			'G6711',
			'G682.',
			'G68X.',
			'Gyu6.',
			'Gyu6B',
			'Gyu6C',
			'S62..',
			'S620.',
			'S622.',
			'S627.',
			'S628.',
			'S629.',
			'S6290' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF6 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF6 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '46W..'
			AND EVENT_VAL > 30)
			OR (EVENT_CD = '46TC.'
			AND EVENT_VAL > 30)
			OR (EVENT_CD = '46N7.'
			AND EVENT_VAL > 45)
			OR (EVENT_CD = '46N4.'
			AND EVENT_VAL > 30)
			OR (EVENT_CD = '46N..'
			AND EVENT_VAL > 150)
			OR (EVENT_CD = '451F.'
			AND EVENT_VAL < 60)
			OR (EVENT_CD IN ( '1Z1..',
			'1Z12.',
			'1Z13.',
			'1Z14.',
			'1Z15.',
			'1Z16.',
			'1Z1B.',
			'1Z1C.',
			'1Z1D.',
			'1Z1E.',
			'1Z1F.',
			'1Z1G.',
			'1Z1H.',
			'1Z1J.',
			'1Z1K.',
			'1Z1L.',
			'4677.',
			'6AA..',
			'9hE0.',
			'9hE1.',
			'C104.',
			'C104y',
			'C104z',
			'C1080',
			'C108D',
			'C1090',
			'C1093',
			'C109C',
			'C10E0',
			'C10ED',
			'C10EK',
			'C10EL',
			'C10F0',
			'C10F3',
			'C10FC',
			'C10FL',
			'C10FM',
			'Cyu23',
			'K05..',
			'K050.',
			'PD13.',
			'R110.' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF7 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF7 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '2BBR.',
			'2BBS.',
			'2BBT.',
			'2G5L.',
			'42W3.',
			'42c..',
			'66A..',
			'66A4.',
			'66A5.',
			'66AD.',
			'66AH0',
			'66AJ.',
			'66AR.',
			'66AS.',
			'66AU.',
			'66AZ.',
			'66Ab.',
			'66Ac.',
			'66Ai.',
			'66Aq.',
			'68A7.',
			'8A17.',
			'8BL2.',
			'8CR2.',
			'8H7f.',
			'8HBG.',
			'8HBH.',
			'8Hl1.',
			'9NND.',
			'9OL1.',
			'9OLD.',
			'9h4..',
			'9h41.',
			'9h42.',
			'C10..',
			'C100.',
			'C1000',
			'C1001',
			'C100z',
			'C101.',
			'C1010',
			'C1011',
			'C101y',
			'C101z',
			'C102.',
			'C102z',
			'C103.',
			'C1030',
			'C1031',
			'C103y',
			'C104.',
			'C104y',
			'C104z',
			'C105.',
			'C105y',
			'C105z',
			'C106.',
			'C1061',
			'C106y',
			'C106z',
			'C107.',
			'C107z',
			'C108.',
			'C1080',
			'C1081',
			'C1082',
			'C1083',
			'C1085',
			'C1086',
			'C1087',
			'C1088',
			'C1089',
			'C108A',
			'C108B',
			'C108C',
			'C108D',
			'C108E',
			'C108F',
			'C108J',
			'C108y',
			'C108z',
			'C109.',
			'C1090',
			'C1091',
			'C1092',
			'C1093',
			'C1094',
			'C1095',
			'C1096',
			'C1097',
			'C1099',
			'C109A',
			'C109B',
			'C109C',
			'C109D',
			'C109E',
			'C109F',
			'C109G',
			'C109H',
			'C109J',
			'C10A1',
			'C10B0',
			'C10C.',
			'C10D.',
			'C10E.',
			'C10E0',
			'C10E1',
			'C10E2',
			'C10E3',
			'C10E5',
			'C10E6',
			'C10E7',
			'C10E8',
			'C10E9',
			'C10EA',
			'C10EB',
			'C10EC',
			'C10ED',
			'C10EE',
			'C10EF',
			'C10EJ',
			'C10EK',
			'C10EL',
			'C10EM',
			'C10EN',
			'C10EP',
			'C10EQ',
			'C10ER',
			'C10F.',
			'C10F0',
			'C10F1',
			'C10F2',
			'C10F3',
			'C10F4',
			'C10F5',
			'C10F6',
			'C10F7',
			'C10F9',
			'C10FA',
			'C10FB',
			'C10FC',
			'C10FD',
			'C10FE',
			'C10FF',
			'C10FG',
			'C10FH',
			'C10FJ',
			'C10FL',
			'C10FM',
			'C10FN',
			'C10FP',
			'C10FQ',
			'C10FR',
			'C10H.',
			'C10y.',
			'C10yy',
			'C10z.',
			'C10zz',
			'Cyu2.',
			'Cyu23',
			'F1711',
			'F372.',
			'F3720',
			'F3721',
			'F3722',
			'F3813',
			'F3y0.',
			'F420.',
			'F4200',
			'F4204',
			'F4206',
			'F420z',
			'F42y9',
			'F4640',
			'M2710' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF8 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF8 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1491.',
			'1B5..',
			'1B53.',
			'F56..',
			'F561.',
			'F5610',
			'F5611',
			'F5614',
			'F561z',
			'F562.',
			'F562z',
			'FyuQ1',
			'R004.',
			'R0040',
			'R0043',
			'R0044' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF9 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF9 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '173..',
			'1732.',
			'1733.',
			'1734.',
			'1738.',
			'1739.',
			'173C.',
			'173K.',
			'173Z.',
			'2322.',
			'R0608',
			'R060A' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF10 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF10 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '16D2.'
			AND EVENT_VAL > 0 )
			OR (EVENT_CD IN ( '16D..',
			'16D1.',
			'8HTl.',
			'8Hk1.',
			'8O9..',
			'R200.',
			'TC...',
			'TC5..',
			'TCz..' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF11 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF11 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '13G8.',
			'9N08.',
			'9N1y7',
			'9N2Q.',
			'M20..',
			'M2000' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF12 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF12 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14G6.',
			'14G7.',
			'14G8.',
			'7K1D0',
			'7K1D6',
			'7K1H6',
			'7K1H8',
			'7K1J0',
			'7K1J6',
			'7K1J8',
			'7K1JB',
			'7K1JD',
			'7K1Jd',
			'7K1L4',
			'7K1LL',
			'7K1Y0',
			'N1y1.',
			'N331.',
			'N3311',
			'N331A',
			'N331D',
			'N331G',
			'N331H',
			'N331J',
			'N331K',
			'N331L',
			'N331M',
			'N331N',
			'NyuB0',
			'S10..',
			'S1000',
			'S1005',
			'S1006',
			'S1007',
			'S100H',
			'S100K',
			'S102.',
			'S1020',
			'S1021',
			'S102y',
			'S102z',
			'S1031',
			'S104.',
			'S1040',
			'S1041',
			'S1042',
			'S10A0',
			'S10B.',
			'S10B0',
			'S10B6',
			'S112.',
			'S114.',
			'S1145',
			'S15..',
			'S150.',
			'S1500',
			'S23..',
			'S234.',
			'S2341',
			'S2346',
			'S2351',
			'S23B.',
			'S23C.',
			'S23x1',
			'S23y.',
			'S3...',
			'S30..',
			'S300.',
			'S3000',
			'S3001',
			'S3004',
			'S3005',
			'S3006',
			'S3007',
			'S3009',
			'S300y',
			'S300z',
			'S3010',
			'S3015',
			'S302.',
			'S3020',
			'S3021',
			'S3022',
			'S3023',
			'S3024',
			'S302z',
			'S303.',
			'S3030',
			'S3032',
			'S3034',
			'S304.',
			'S305.',
			'S30y.',
			'S30z.',
			'S31z.',
			'S4500',
			'S4E..',
			'S4E0.',
			'S4E1.',
			'S4E2.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF13 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF13 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1C12.',
			'1C13.',
			'1C131',
			'1C132',
			'1C133',
			'1C16.',
			'2BM2.',
			'2BM3.',
			'2BM4.',
			'2DG..',
			'3134.',
			'31340',
			'8D2..',
			'8E3..',
			'8HR2.',
			'8HT2.',
			'8HT3.',
			'Eu446',
			'F5801',
			'F59..',
			'F590.',
			'F591.',
			'F5912',
			'F5915',
			'F5916',
			'F592.',
			'F594.',
			'F595.',
			'F59z.',
			'F5A..',
			'ZV532' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF14 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF14 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14A6.',
			'14AM.',
			'1736.',
			'1O1..',
			'33BA.',
			'388D.',
			'585f.',
			'662T.',
			'662W.',
			'662g.',
			'662h.',
			'662p.',
			'679X.',
			'67D4.',
			'8CL3.',
			'8H2S.',
			'8HBE.',
			'8HHb.',
			'8HHz.',
			'9N0k.',
			'9N2p.',
			'9N4s.',
			'9N4w.',
			'9N6T.',
			'9Or0.',
			'9Or5.',
			'9hH0.',
			'9hH1.',
			'G58..',
			'G580.',
			'G5800',
			'G5801',
			'G5804',
			'G581.',
			'G582.',
			'G58z.',
			'G5y4z',
			'G5yy9',
			'SP111' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF15 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF15 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( 'G540.',
			'G5402',
			'G5415',
			'G543.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF16 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF16 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '13CA.',
			'8HL..',
			'9N1C.',
			'9NF..',
			'9NF1.',
			'9NF2.',
			'9NF3.',
			'9NF8.',
			'9NF9.',
			'9NFB.',
			'9NFM.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF17 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF17 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '246W.'
			AND EVENT_VAL > 135 )
			OR (EVENT_CD = '246V.'
			AND EVENT_VAL > 85 )
			OR (EVENT_CD IN ( '14A2.',
			'246M.',
			'6627.',
			'6628.',
			'662F.',
			'662O.',
			'662b.',
			'8CR4.',
			'8HT5.',
			'8I3N.',
			'9N03.',
			'9N1y2',
			'9h3..',
			'9h31.',
			'9h32.',
			'F4211',
			'F4213',
			'G2...',
			'G20..',
			'G200.',
			'G201.',
			'G202.',
			'G203.',
			'G20z.',
			'G22z.',
			'G24..',
			'G240.',
			'G240z',
			'G241.',
			'G241z',
			'G244.',
			'G24z.',
			'G24z0',
			'G24z1',
			'G24zz',
			'G2z..',
			'Gyu20',
			'Gyu21' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF18 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF18 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1B55.',
			'1B6..',
			'1B62.',
			'1B65.',
			'1B68.',
			'79370',
			'F1303',
			'G87..',
			'G870.',
			'G871.',
			'G872.',
			'G873.',
			'G87z.',
			'R002.',
			'R0021',
			'R0022',
			'R0023',
			'R0042' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF19 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF19 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14A..',
			'14A4.',
			'14A5.',
			'182..',
			'322..',
			'3222.',
			'322Z.',
			'662K0',
			'662K1',
			'662K3',
			'6A2..',
			'6A4..',
			'792..',
			'7928.',
			'79294',
			'889A.',
			'8H2V.',
			'8I3z.',
			'G3...',
			'G30..',
			'G3071',
			'G308.',
			'G30y.',
			'G30yz',
			'G30z.',
			'G31..',
			'G311.',
			'G3111',
			'G31y2',
			'G31y3',
			'G31yz',
			'G32..',
			'G33..',
			'G332.',
			'G33z.',
			'G33z3',
			'G33z4',
			'G33z7',
			'G33zz',
			'G34..',
			'G340.',
			'G344.',
			'G34y0',
			'G34y1',
			'G34yz',
			'G34z.',
			'G36..',
			'G361.',
			'G362.',
			'G37..',
			'G3y..',
			'G3z..',
			'Gyu3.',
			'G3...',
			'Gyu30' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF20 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF20 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '3AD3.'
			AND (EVENT_VAL > 8
			OR EVENT_VAL = 8))
			OR (EVENT_CD IN ( '1461.',
			'1B1A.',
			'1S21.',
			'2841.',
			'28E..',
			'3A10.',
			'3A20.',
			'3A30.',
			'3A40.',
			'3A50.',
			'3A60.',
			'3A70.',
			'3A80.',
			'3A91.',
			'3AA1.',
			'3AE..',
			'66h..',
			'6AB..',
			'8HTY.',
			'9NdL.',
			'9Nk1.',
			'9Ou..',
			'9Ou2.',
			'9Ou3.',
			'9Ou4.',
			'9Ou5.',
			'9hD..',
			'9hD0.',
			'9hD1.',
			'E00..',
			'E000.',
			'E001.',
			'E0010',
			'E0011',
			'E0012',
			'E0013',
			'E001z',
			'E002.',
			'E0020',
			'E0021',
			'E002z',
			'E003.',
			'E004.',
			'E0040',
			'E0041',
			'E0042',
			'E0043',
			'E004z',
			'E012.',
			'E041.',
			'E2A10',
			'E2A11',
			'Eu00.',
			'Eu000',
			'Eu001',
			'Eu002',
			'Eu00z',
			'Eu01.',
			'Eu010',
			'Eu011',
			'Eu012',
			'Eu013',
			'Eu01y',
			'Eu01z',
			'Eu02.',
			'Eu020',
			'Eu021',
			'Eu022',
			'Eu023',
			'Eu025',
			'Eu02y',
			'Eu02z',
			'Eu041',
			'Eu057',
			'F110.',
			'F1100',
			'F1101',
			'F116.',
			'F21y2',
			'R00z0' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF21 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF21 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1381.',
			'13C2.',
			'13C4.',
			'13CD.',
			'13CE.',
			'398A.',
			'39B..',
			'8D4..',
			'8O15.',
			'N097.',
			'ZV4L0' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF22 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF22 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '58EE.'
			AND (EVENT_VAL <-2.5
			OR EVENT_VAL = -2.5) )
			OR (EVENT_CD IN ( '14OD.',
			'56812',
			'58EN.',
			'66a..',
			'66a2.',
			'66a3.',
			'66a4.',
			'66a5.',
			'66a6.',
			'66a7.',
			'66a8.',
			'66a9.',
			'66aA.',
			'66aE.',
			'8HTS.',
			'9N0h.',
			'9Od0.',
			'9Od2.',
			'N330.',
			'N3300',
			'N3301',
			'N3302',
			'N3303',
			'N3304',
			'N3305',
			'N3306',
			'N3307',
			'N3308',
			'N330A',
			'N330B',
			'N330C',
			'N330D',
			'N330z',
			'N3312',
			'N3315',
			'N3316',
			'N3318',
			'N3319',
			'N331B',
			'N331L',
			'N3370',
			'NyuB0',
			'NyuB1',
			'NyuB8',
			'NyuBC' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF23 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF23 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '297A.',
			'2987.',
			'2994.',
			'A94y1',
			'F116.',
			'F11x9',
			'F12..',
			'F120.',
			'F121.',
			'F12W.',
			'F12X.',
			'F12z.',
			'F13..',
			'F1303',
			'Fyu20',
			'Fyu21',
			'Fyu22',
			'Fyu29',
			'Fyu2B',
			'R0103',
			'TJ64.',
			'U6067' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF24 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF24 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14C1.',
			'1956.',
			'76121',
			'761D5',
			'761D6',
			'761J.',
			'761J0',
			'761J1',
			'761Jy',
			'761Jz',
			'7627.',
			'76270',
			'76271',
			'76272',
			'7627y',
			'7627z',
			'J1016',
			'J1020',
			'J11..',
			'J110.',
			'J1100',
			'J1101',
			'J1102',
			'J1103',
			'J1104',
			'J110y',
			'J110z',
			'J111.',
			'J1110',
			'J1111',
			'J1112',
			'J1114',
			'J111y',
			'J111z',
			'J112.',
			'J113.',
			'J113z',
			'J11y.',
			'J11y0',
			'J11y1',
			'J11y2',
			'J11yz',
			'J11z.',
			'J12..',
			'J120.',
			'J1200',
			'J1201',
			'J1202',
			'J1203',
			'J120y',
			'J120z',
			'J121.',
			'J1210',
			'J1211',
			'J1212',
			'J1213',
			'J1214',
			'J121y',
			'J121z',
			'J122.',
			'J124.',
			'J125.',
			'J126.',
			'J126z',
			'J12y.',
			'J12y0',
			'J12y1',
			'J12y2',
			'J12y3',
			'J12y4',
			'J12yy',
			'J12yz',
			'J12z.',
			'J13..',
			'J130.',
			'J1300',
			'J1301',
			'J1302',
			'J1303',
			'J130y',
			'J130z',
			'J131.',
			'J1310',
			'J1311',
			'J1312',
			'J131y',
			'J131z',
			'J13y.',
			'J13y0',
			'J13y1',
			'J13y2',
			'J13yz',
			'J13z.',
			'J14..',
			'J1401',
			'J1411',
			'J14y.',
			'J14z.',
			'J17y8',
			'J57y8',
			'ZV12C' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF25 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF25 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '585a.'
			AND EVENT_VAL < 0.95)
			OR (EVENT_CD IN ( '24E9.',
			'24EA.',
			'24EC.',
			'24F9.',
			'C107.',
			'C1086',
			'C109F',
			'C10E6',
			'C10FF',
			'G670.',
			'G700.',
			'G73..',
			'G73z.',
			'G73zz',
			'M2710' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF26 ( ALF_PE BIGINT,
	event_dt DATE,
	DEF26 BIGINT ) DISTRIBUTE BY HASH(ALF_PE);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF26 (
			SELECT SUB.ALF_PE,
			sub.event_dt,
			MAX(SUB.RANK)
		FROM
			(
				SELECT ALF_PE,
				A.event_dt AS event_dt,
				DENSE_RANK() OVER (PARTITION BY ALF_PE
			ORDER BY
				EVENT_CD) AS RANK
			FROM
				SAILW0972V.V2_GPDATA AS B
			JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
					USING (ALF_PE)
			WHERE
				B.EVENT_DT <= A.EVENT_DT
				AND B.EVENT_DT >= A.EVENT_DT - 1 YEARS
				AND (substr(EVENT_CD,
				1,
				1) <> UPPER(substr(EVENT_CD, 1, 1)) ) ) AS SUB
		GROUP BY
			SUB.ALF_PE ,
			sub.event_dt);

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF27 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF27 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '13F6.',
			'13F61',
			'13FX.',
			'13G6.',
			'13G61',
			'13WJ.',
			'8GEB.',
			'918F.',
			'9N1G.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF28 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF28 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '66Yf.'
			AND EVENT_VAL > 0)
			OR (EVENT_CD IN ( '14B..',
			'14B3.',
			'14B4.',
			'14OX.',
			'1712.',
			'1713.',
			'1715.',
			'171A.',
			'173A.',
			'178..',
			'1780.',
			'1O2..',
			'3399.',
			'339U.',
			'33G0.',
			'388t.',
			'663..',
			'663J.',
			'663N.',
			'663N0',
			'663N1',
			'663N2',
			'663O.',
			'663O0',
			'663P.',
			'663Q.',
			'663U.',
			'663V.',
			'663V0',
			'663V1',
			'663V2',
			'663V3',
			'663W.',
			'663d.',
			'663e.',
			'663f.',
			'663h.',
			'663j.',
			'663l.',
			'663m.',
			'663n.',
			'663p.',
			'663q.',
			'663r.',
			'663s.',
			'663t.',
			'663u.',
			'663v.',
			'663w.',
			'663x.',
			'663y.',
			'66Y5.',
			'66Y9.',
			'66YA.',
			'66YB.',
			'66YD.',
			'66YE.',
			'66YI.',
			'66YJ.',
			'66YK.',
			'66YL.',
			'66YM.',
			'66YP.',
			'66YQ.',
			'66YR.',
			'66YS.',
			'66YT.',
			'66YZ.',
			'66Yd.',
			'66Ye.',
			'66Yf.',
			'66Yg.',
			'66Yh.',
			'66Yi.',
			'679J.',
			'679V.',
			'74592',
			'8764.',
			'8776.',
			'8778.',
			'8793.',
			'8794.',
			'8795.',
			'8796.',
			'8797.',
			'8798.',
			'8B3j.',
			'8CR0.',
			'8CR1.',
			'8FA..',
			'8FA1.',
			'8H2P.',
			'8H2R.',
			'8H7u.',
			'8HTT.',
			'9N1d.',
			'9N4Q.',
			'9N4W.',
			'9OJ1.',
			'9OJ2.',
			'9OJ3.',
			'9OJ7.',
			'9OJA.',
			'9Oi3.',
			'9h52.',
			'9hA1.',
			'9hA2.',
			'9kf..',
			'9kf0.',
			'G401.',
			'G4011',
			'G410.',
			'G41y0',
			'H....',
			'H3...',
			'H30..',
			'H302.',
			'H31..',
			'H310.',
			'H3100',
			'H310z',
			'H311.',
			'H3110',
			'H3111',
			'H312.',
			'H3120',
			'H3122',
			'H312z',
			'H31y.',
			'H31yz',
			'H31z.',
			'H32..',
			'H33..',
			'H330.',
			'H3300',
			'H3301',
			'H330z',
			'H331.',
			'H3310',
			'H3311',
			'H331z',
			'H332.',
			'H333.',
			'H334.',
			'H33z.',
			'H33z0',
			'H33z1',
			'H33z2',
			'H33zz',
			'H36..',
			'H37..',
			'H38..',
			'H39..',
			'H3y..',
			'H3y0.',
			'H3y1.',
			'H3z..',
			'H564.',
			'Hyu31',
			'N04y0',
			'R062.',
			'TJF73',
			'U60F6',
			'ZV129' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF29 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF29 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14F3.',
			'14F5.',
			'2924.',
			'2FF..',
			'2FF2.',
			'2FF3.',
			'2FFZ.',
			'2G48.',
			'2G54.',
			'2G55.',
			'2G5H.',
			'2G5L.',
			'2G5V.',
			'2G5W.',
			'39C..',
			'39C0.',
			'4JG3.',
			'7G2E5',
			'7G2EA',
			'7G2EB',
			'7G2EC',
			'81H1.',
			'8CT1.',
			'8CV2.',
			'8HTh.',
			'9N0t.',
			'9NM5.',
			'C1094',
			'C10F4',
			'G830.',
			'G832.',
			'G835.',
			'G837.',
			'M07z.',
			'M27..',
			'M270.',
			'M271.',
			'M2710',
			'M2711',
			'M2712',
			'M2713',
			'M2714',
			'M2715',
			'M272.',
			'M27y.',
			'M27z.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF30 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF30 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1B1B.',
			'1B1Q.',
			'E274.',
			'Eu51.',
			'Fy02.',
			'R005.',
			'R0050',
			'R0052' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF31 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF31 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1335.',
			'133P.',
			'133V.',
			'13EH.',
			'13F3.',
			'13G4.',
			'13M1.',
			'13MF.',
			'13Z8.',
			'1B1K.',
			'8H75.',
			'8HHB.',
			'8I5..',
			'918V.',
			'9NNV.',
			'ZV603' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF32 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF32 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '44lD.'
			AND EVENT_VAL > 15)
			OR (EVENT_CD = '442W.'
			AND EVENT_VAL NOT BETWEEN 0.5 AND 4)
			OR (EVENT_CD = '442A.'
			AND EVENT_VAL NOT BETWEEN 0.5 AND 4)
			OR (EVENT_CD IN ( '1431.',
			'1432.',
			'4422.',
			'442I.',
			'66BB.',
			'66BZ.',
			'8CR5.',
			'9N4T.',
			'9Oj0.',
			'C0...',
			'C02..',
			'C04..',
			'C040.',
			'C041.',
			'C0410',
			'C041z',
			'C042.',
			'C043.',
			'C043z',
			'C044.',
			'C046.',
			'C04y.',
			'C04z.',
			'C1343',
			'Cyu1.',
			'Cyu11' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF33 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF33 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1593.',
			'16F..',
			'1A23.',
			'1A24.',
			'1A26.',
			'3940.',
			'3941.',
			'7B338',
			'7B33C',
			'7B421',
			'8D7..',
			'8D71.',
			'8HTX.',
			'K198.',
			'K586.',
			'Kyu5A',
			'R083.',
			'R0831',
			'R0832',
			'R083z' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF34 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF34 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14D..',
			'14DZ.',
			'1A1..',
			'1A13.',
			'1A1Z.',
			'1A55.',
			'1AA..',
			'1AC2.',
			'7B39.',
			'7B390',
			'8156.',
			'8H5B.',
			'K....',
			'K155.',
			'K1653',
			'K1654',
			'K16y4',
			'K190.',
			'K1903',
			'K1905',
			'K190z',
			'K1971',
			'K1973',
			'K20..',
			'Ky...',
			'Kz...',
			'R08..',
			'R082.',
			'R0822',
			'SP031' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF35 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF35 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1483.',
			'1B75.',
			'22E5.',
			'22EG.',
			'2BBm.',
			'2BBn.',
			'2BBo.',
			'2BBr.',
			'2BT..',
			'2BT0.',
			'2BT1.',
			'6688.',
			'6689.',
			'72630',
			'72661',
			'8F61.',
			'8H52.',
			'9m08.',
			'C108F',
			'C109E',
			'C10EF',
			'C10EP',
			'C10FE',
			'C10FQ',
			'F4042',
			'F421A',
			'F422.',
			'F422y',
			'F422z',
			'F4239',
			'F425.',
			'F4250',
			'F4251',
			'F4252',
			'F4253',
			'F4254',
			'F4257',
			'F427C',
			'F42y4',
			'F42y9',
			'F4305',
			'F4332',
			'F46..',
			'F4602',
			'F4603',
			'F4604',
			'F4605',
			'F4606',
			'F4607',
			'F460z',
			'F461.',
			'F4610',
			'F4614',
			'F4615',
			'F4617',
			'F4618',
			'F4619',
			'F461A',
			'F461B',
			'F461y',
			'F461z',
			'F462.',
			'F462z',
			'F463.',
			'F4633',
			'F4634',
			'F463z',
			'F464.',
			'F4640',
			'F4642',
			'F4644',
			'F4646',
			'F4647',
			'F464z',
			'F465.',
			'F4650',
			'F465z',
			'F466.',
			'F46y.',
			'F46yz',
			'F46z.',
			'F46z0',
			'F4840',
			'F49..',
			'F490.',
			'F4900',
			'F4909',
			'F490z',
			'F494.',
			'F4950',
			'F495A',
			'F49z.',
			'F4A24',
			'F4H34',
			'F4H40',
			'F4H73',
			'F4K2D',
			'FyuE1',
			'FyuF7',
			'FyuL.',
			'P33..',
			'P330.',
			'P331.',
			'P3310',
			'P3311',
			'P331z',
			'S813.',
			'SJ0z.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_MI_COHORT_EFI_DEF36 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_MI_COHORT_EFI_DEF36 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '687C.'
			AND (EVENT_VAL > 1
			OR EVENT_VAL = 1))
			OR (EVENT_CD IN ( '1612.',
			'1615.',
			'1623.',
			'1625.',
			'1D1A.',
			'22A8.',
			'R0300',
			'R032.' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );
			
		-----------------------Join tables
--drop table SAILW0972V.V2_VB_MI_COHORT_EFI_INDICATOR_dummy
		
CREATE TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_INDICATOR_dummy (
                      ALF_PE BIGINT ,event_dt date
                      , DEF1 BIGINT
                      , DEF2 BIGINT
                      , DEF3 BIGINT
                      , DEF4 BIGINT
                      , DEF5 BIGINT
                      , DEF6 BIGINT
                      , DEF7 BIGINT
                      , DEF8 BIGINT
                      , DEF9 BIGINT
                      , DEF10 BIGINT
                      , DEF11 BIGINT
                      , DEF12 BIGINT
                      , DEF13 BIGINT
                      , DEF14 BIGINT
                      , DEF15 BIGINT
                      , DEF16 BIGINT
                      , DEF17 BIGINT
                      , DEF18 BIGINT
                      , DEF19 BIGINT
                      , DEF20 BIGINT
                      , DEF21 BIGINT
                      , DEF22 BIGINT
                      , DEF23 BIGINT
                      , DEF24 BIGINT
                      , DEF25 BIGINT
                      , DEF26 BIGINT
                      , DEF27 BIGINT
                      , DEF28 BIGINT
                      , DEF29 BIGINT
                      , DEF30 BIGINT
                      , DEF31 BIGINT
                      , DEF32 BIGINT
                      , DEF33 BIGINT
                      , DEF34 BIGINT
                      , DEF35 BIGINT
                      , DEF36 BIGINT )
                      DISTRIBUTE BY HASH(ALF_PE);
		
		INSERT INTO SAILW0972V.V2_VB_MI_COHORT_EFI_INDICATOR_dummy  (
                      select COHORT.ALF_PE  ,cohort.event_dt , DUMMY1.EVENT_CD AS  dummy_def1 ,  DUMMY2.EVENT_CD AS dummy_def2 ,  DUMMY3.EVENT_CD AS dummy_def3 ,  DUMMY4.EVENT_CD AS dummy_def4 ,  DUMMY5.EVENT_CD AS dummy_def5 ,  DUMMY6.EVENT_CD AS dummy_def6 ,  DUMMY7.EVENT_CD AS dummy_def7 ,  DUMMY8.EVENT_CD AS dummy_def8 ,  DUMMY9.EVENT_CD AS dummy_def9 ,  DUMMY10.EVENT_CD AS dummy_def10 ,  DUMMY11.EVENT_CD AS dummy_def11 ,  DUMMY12.EVENT_CD AS dummy_def12 ,  DUMMY13.EVENT_CD AS dummy_def13 ,  DUMMY14.EVENT_CD AS dummy_def14 ,  DUMMY15.EVENT_CD AS dummy_def15 ,  DUMMY16.EVENT_CD AS dummy_def16 ,  DUMMY17.EVENT_CD AS dummy_def17 ,  DUMMY18.EVENT_CD AS dummy_def18 ,  DUMMY19.EVENT_CD AS dummy_def19 ,  DUMMY20.EVENT_CD AS dummy_def20 ,  DUMMY21.EVENT_CD AS dummy_def21 ,  DUMMY22.EVENT_CD AS dummy_def22 ,  DUMMY23.EVENT_CD AS dummy_def23 ,  DUMMY24.EVENT_CD AS dummy_def24 ,  DUMMY25.EVENT_CD AS dummy_def25 ,  DUMMY26.def26 AS dummy_def26 ,  DUMMY27.EVENT_CD AS dummy_def27 ,  DUMMY28.EVENT_CD AS dummy_def28 ,  DUMMY29.EVENT_CD AS dummy_def29 ,  DUMMY30.EVENT_CD AS dummy_def30 ,  DUMMY31.EVENT_CD AS dummy_def31 ,  DUMMY32.EVENT_CD AS dummy_def32 ,  DUMMY33.EVENT_CD AS dummy_def33 ,  DUMMY34.EVENT_CD AS dummy_def34 ,  DUMMY35.EVENT_CD AS dummy_def35 ,  DUMMY36.EVENT_CD AS dummy_def36 
                      from SAILW0972V.V2_COHORT_WITH_DUMMY_DATE  AS COHORT
                      LEFT JOIN  SAILW0972V.V2_VB_MI_COHORT_EFI_DEF1  AS  DUMMY1  ON COHORT.ALF_PE = DUMMY1.ALF_PE and COHORT.event_dt = DUMMY1.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF2   AS  DUMMY2  ON COHORT.ALF_PE = DUMMY2.ALF_PE and COHORT.event_dt = DUMMY2.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF3   AS  DUMMY3  ON COHORT.ALF_PE = DUMMY3.ALF_PE and COHORT.event_dt = DUMMY3.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF4   AS  DUMMY4  ON COHORT.ALF_PE = DUMMY4.ALF_PE and COHORT.event_dt = DUMMY4.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF5   AS  DUMMY5  ON COHORT.ALF_PE = DUMMY5.ALF_PE and COHORT.event_dt = DUMMY5.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF6   AS  DUMMY6  ON COHORT.ALF_PE = DUMMY6.ALF_PE and COHORT.event_dt = DUMMY6.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF7   AS  DUMMY7  ON COHORT.ALF_PE = DUMMY7.ALF_PE and COHORT.event_dt = DUMMY7.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF8   AS  DUMMY8  ON COHORT.ALF_PE = DUMMY8.ALF_PE and COHORT.event_dt = DUMMY8.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF9   AS  DUMMY9  ON COHORT.ALF_PE = DUMMY9.ALF_PE and COHORT.event_dt = DUMMY9.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF10   AS  DUMMY10  ON COHORT.ALF_PE = DUMMY10.ALF_PE and COHORT.event_dt = DUMMY10.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF11   AS  DUMMY11  ON COHORT.ALF_PE = DUMMY11.ALF_PE and COHORT.event_dt = DUMMY11.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF12   AS  DUMMY12  ON COHORT.ALF_PE = DUMMY12.ALF_PE and COHORT.event_dt = DUMMY12.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF13   AS  DUMMY13  ON COHORT.ALF_PE = DUMMY13.ALF_PE and COHORT.event_dt = DUMMY13.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF14   AS  DUMMY14  ON COHORT.ALF_PE = DUMMY14.ALF_PE and COHORT.event_dt = DUMMY14.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF15   AS  DUMMY15  ON COHORT.ALF_PE = DUMMY15.ALF_PE and COHORT.event_dt = DUMMY15.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF16   AS  DUMMY16  ON COHORT.ALF_PE = DUMMY16.ALF_PE and COHORT.event_dt = DUMMY16.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF17   AS  DUMMY17  ON COHORT.ALF_PE = DUMMY17.ALF_PE and COHORT.event_dt = DUMMY17.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF18   AS  DUMMY18  ON COHORT.ALF_PE = DUMMY18.ALF_PE and COHORT.event_dt = DUMMY18.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF19   AS  DUMMY19  ON COHORT.ALF_PE = DUMMY19.ALF_PE and COHORT.event_dt = DUMMY19.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF20   AS  DUMMY20  ON COHORT.ALF_PE = DUMMY20.ALF_PE and COHORT.event_dt = DUMMY20.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF21   AS  DUMMY21  ON COHORT.ALF_PE = DUMMY21.ALF_PE and COHORT.event_dt = DUMMY21.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF22   AS  DUMMY22  ON COHORT.ALF_PE = DUMMY22.ALF_PE and COHORT.event_dt = DUMMY22.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF23   AS  DUMMY23  ON COHORT.ALF_PE = DUMMY23.ALF_PE and COHORT.event_dt = DUMMY23.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF24   AS  DUMMY24  ON COHORT.ALF_PE = DUMMY24.ALF_PE and COHORT.event_dt = DUMMY24.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF25   AS  DUMMY25  ON COHORT.ALF_PE = DUMMY25.ALF_PE and COHORT.event_dt = DUMMY25.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF26   AS  DUMMY26  ON COHORT.ALF_PE = DUMMY26.ALF_PE and COHORT.event_dt = DUMMY26.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF27   AS  DUMMY27  ON COHORT.ALF_PE = DUMMY27.ALF_PE and COHORT.event_dt = DUMMY27.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF28   AS  DUMMY28  ON COHORT.ALF_PE = DUMMY28.ALF_PE and COHORT.event_dt = DUMMY28.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF29   AS  DUMMY29  ON COHORT.ALF_PE = DUMMY29.ALF_PE and COHORT.event_dt = DUMMY29.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF30   AS  DUMMY30  ON COHORT.ALF_PE = DUMMY30.ALF_PE and COHORT.event_dt = DUMMY30.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF31   AS  DUMMY31  ON COHORT.ALF_PE = DUMMY31.ALF_PE and COHORT.event_dt = DUMMY31.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF32   AS  DUMMY32  ON COHORT.ALF_PE = DUMMY32.ALF_PE and COHORT.event_dt = DUMMY32.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF33   AS  DUMMY33  ON COHORT.ALF_PE = DUMMY33.ALF_PE and COHORT.event_dt = DUMMY33.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF34   AS  DUMMY34  ON COHORT.ALF_PE = DUMMY34.ALF_PE and COHORT.event_dt = DUMMY34.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF35   AS  DUMMY35  ON COHORT.ALF_PE = DUMMY35.ALF_PE and COHORT.event_dt = DUMMY35.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_MI_COHORT_EFI_DEF36   AS  DUMMY36  ON COHORT.ALF_PE = DUMMY36.ALF_PE and COHORT.event_dt = DUMMY36.event_dt);
		
		
		----------------DROP ALL tables

DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF1;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF2;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF3;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF4;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF5;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF6;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF7;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF8;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF9;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF10;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF11;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF12;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF13;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF14;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF15;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF16;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF17;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF18;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF19;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF20;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF21;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF22;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF23;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF24;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF25;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF26;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF27;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF28;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF29;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF30;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF31;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF32;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF33;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF34;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF35;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_DEF36;
DROP ALIAS SAILW0972V.V2_GPDATA;

------------------------------------
CREATE TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_INDICATOR AS 
(SELECT * FROM SAILW0972V.V2_VB_MI_COHORT_EFI_INDICATOR_dummy) WITH NO DATA;


INSERT INTO SAILW0972V.V2_VB_MI_COHORT_EFI_INDICATOR 
                      select ALF_PE ,event_dt , CASE WHEN def1 IS NULL THEN 0 ELSE 1 END AS  DEF1 , CASE WHEN def2 IS NULL THEN 0 ELSE 1 END AS DEF2 ,  CASE WHEN def3 IS NULL THEN 0 ELSE 1 END AS DEF3 ,  CASE WHEN def4 IS NULL THEN 0 ELSE 1 END AS DEF4 ,  CASE WHEN def5 IS NULL THEN 0 ELSE 1 END AS DEF5 ,  CASE WHEN def6 IS NULL THEN 0 ELSE 1 END AS DEF6 ,  CASE WHEN def7 IS NULL THEN 0 ELSE 1 END AS DEF7 ,  CASE WHEN def8 IS NULL THEN 0 ELSE 1 END AS DEF8 ,  CASE WHEN def9 IS NULL THEN 0 ELSE 1 END AS DEF9 ,  CASE WHEN def10 IS NULL THEN 0 ELSE 1 END AS DEF10 ,  CASE WHEN def11 IS NULL THEN 0 ELSE 1 END AS DEF11 ,  CASE WHEN def12 IS NULL THEN 0 ELSE 1 END AS DEF12 ,  CASE WHEN def13 IS NULL THEN 0 ELSE 1 END AS DEF13 ,  CASE WHEN def14 IS NULL THEN 0 ELSE 1 END AS DEF14 ,  CASE WHEN def15 IS NULL THEN 0 ELSE 1 END AS DEF15 ,  CASE WHEN def16 IS NULL THEN 0 ELSE 1 END AS DEF16 ,  CASE WHEN def17 IS NULL THEN 0 ELSE 1 END AS DEF17 , CASE WHEN def18 IS NULL THEN 0 ELSE 1 END AS DEF18 ,  CASE WHEN def19 IS NULL THEN 0 ELSE 1 END AS DEF19 ,  CASE WHEN def20 IS NULL THEN 0 ELSE 1 END AS DEF20 ,  CASE WHEN def21 IS NULL THEN 0 ELSE 1 END AS DEF21 ,  CASE WHEN def22 IS NULL THEN 0 ELSE 1 END AS DEF22 ,  CASE WHEN def23 IS NULL THEN 0 ELSE 1 END AS DEF23 ,  CASE WHEN def24 IS NULL THEN 0 ELSE 1 END AS DEF24 ,  CASE WHEN def25 IS NULL THEN 0 ELSE 1 END AS DEF25 ,  CASE WHEN def26 IS NULL OR def26 < 5 THEN 0 ELSE 1 END AS DEF26 ,  CASE WHEN def27 IS NULL THEN 0 ELSE 1 END AS DEF27 ,  CASE WHEN def28 IS NULL THEN 0 ELSE 1 END AS DEF28 ,  CASE WHEN def29 IS NULL THEN 0 ELSE 1 END AS DEF29 ,  CASE WHEN def30 IS NULL THEN 0 ELSE 1 END AS DEF30 ,  CASE WHEN def31 IS NULL THEN 0 ELSE 1 END AS DEF31 ,  CASE WHEN def32 IS NULL THEN 0 ELSE 1 END AS DEF32 ,  CASE WHEN def33 IS NULL THEN 0 ELSE 1 END AS DEF33 ,  CASE WHEN def34 IS NULL THEN 0 ELSE 1 END AS DEF34 ,  CASE WHEN def35 IS NULL THEN 0 ELSE 1 END AS DEF35 ,  CASE WHEN def36 IS NULL THEN 0 ELSE 1 END AS DEF36 FROM SAILW0972V.V2_VB_MI_COHORT_EFI_INDICATOR_dummy ;


-----------------------------------------------

-----------------------------------------------

CREATE TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_sub (
                      ALF_PE BIGINT ,event_dt date
                      , DEF1 BIGINT
                      , DEF2 BIGINT
                      , DEF3 BIGINT
                      , DEF4 BIGINT
                      , DEF5 BIGINT
                      , DEF6 BIGINT
                      , DEF7 BIGINT
                      , DEF8 BIGINT
                      , DEF9 BIGINT
                      , DEF10 BIGINT
                      , DEF11 BIGINT
                      , DEF12 BIGINT
                      , DEF13 BIGINT
                      , DEF14 BIGINT
                      , DEF15 BIGINT
                      , DEF16 BIGINT
                      , DEF17 BIGINT
                      , DEF18 BIGINT
                      , DEF19 BIGINT
                      , DEF20 BIGINT
                      , DEF21 BIGINT
                      , DEF22 BIGINT
                      , DEF23 BIGINT
                      , DEF24 BIGINT
                      , DEF25 BIGINT
                      , DEF26 BIGINT
                      , DEF27 BIGINT
                      , DEF28 BIGINT
                      , DEF29 BIGINT
                      , DEF30 BIGINT
                      , DEF31 BIGINT
                      , DEF32 BIGINT
                      , DEF33 BIGINT
                      , DEF34 BIGINT
                      , DEF35 BIGINT
                      , DEF36 BIGINT
                      , Defict_sum bigint
                      , eFI decimal(6,4))
                      DISTRIBUTE BY HASH(ALF_PE);
                     
 INSERT INTO SAILW0972V.V2_VB_MI_COHORT_EFI_sub (
 
SELECT * , DEF1 + DEF2 + DEF3 + DEF4 + DEF5 + DEF6 + DEF7 + DEF8 + DEF9 + DEF10 + DEF11 + DEF12 + DEF13 + DEF14 + DEF15 + DEF16 + DEF17 + DEF18 + DEF19 + DEF20 + DEF21 + DEF22 + DEF23 + DEF24 + DEF25 + DEF26 + DEF27 + DEF28 + DEF29 + DEF30 + DEF31 + DEF32 + DEF33 + DEF34 + DEF35 + DEF36 AS deficit_sum , CAST( (DEF1 + DEF2 + DEF3 + DEF4 + DEF5 + DEF6 + DEF7 + DEF8 + DEF9 + DEF10 + DEF11 + DEF12 + DEF13 + DEF14 + DEF15 + DEF16 + DEF17 + DEF18 + DEF19 + DEF20 + DEF21 + DEF22 + DEF23 + DEF24 + DEF25 + DEF26 + DEF27 + DEF28 + DEF29 + DEF30 + DEF31 + DEF32 + DEF33 + DEF34 + DEF35 + DEF36) AS decimal(6,4))/36 AS eFI FROM SAILW0972V.V2_VB_MI_COHORT_EFI_INDICATOR);

DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_INDICATOR_dummy;



CREATE TABLE SAILW0972V.V2_VB_MI_COHORT_EFI AS (
SELECT
	* ,
	CASE
		WHEN (EFI > 0.12 AND EFI <= 0.24) THEN 1
		WHEN (EFI > 0.24 AND EFI <= 0.36) THEN 2 
		WHEN (EFI > 0.36) THEN 3
		ELSE 0 
		END 
		AS frailty
		,
	CASE
		WHEN (EFI > 0.12 AND EFI <= 0.24) THEN 'Mild'
		WHEN (EFI > 0.24 AND EFI <= 0.36) THEN 'Moderate'
		WHEN (EFI > 0.36) THEN 'Severe'
		ELSE 'Fit'
		END 
		AS frailty_def
	FROM
		SAILW0972V.V2_VB_MI_COHORT_EFI_sub) WITH NO DATA;
	

		INSERT INTO SAILW0972V.V2_VB_MI_COHORT_EFI (SELECT
	* ,
	CASE
		WHEN (EFI > 0.12 AND EFI <= 0.24) THEN 1
		WHEN (EFI > 0.24 AND EFI <= 0.36) THEN 2 
		WHEN (EFI > 0.36) THEN 3
		ELSE 0 
		END 
		AS frailty
		,
	CASE
		WHEN (EFI > 0.12 AND EFI <= 0.24) THEN 'Mild'
		WHEN (EFI > 0.24 AND EFI <= 0.36) THEN 'Moderate'
		WHEN (EFI > 0.36) THEN 'Severe'
		ELSE 'Fit'
		END 
		AS frailty_def
	FROM
		SAILW0972V.V2_VB_MI_COHORT_EFI_sub);
		
		DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_sub;
DROP TABLE SAILW0972V.V2_COHORT_WITH_DUMMY_DATE;
DROP TABLE SAILW0972V.V2_VB_MI_COHORT_EFI_INDICATOR;

/* update MI cohort table with eFI at time of first event */
					
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN EFI DECIMAL(6,4)
	ADD COLUMN FRAILTY INTEGER
	ADD COLUMN FRAILTY_DEF VARCHAR(8);

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SAILW0972V.V2_VB_MI_COHORT_EFI AS efi
		ON fe.ALF_PE = efi.ALF_PE 
			WHEN MATCHED THEN
				UPDATE
				SET fe.EFI = efi.EFI
			;
		
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SAILW0972V.V2_VB_MI_COHORT_EFI AS efi
		ON fe.ALF_PE = efi.ALF_PE 
			WHEN MATCHED THEN
				UPDATE
				SET fe.FRAILTY = efi.FRAILTY
			;
		
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SAILW0972V.V2_VB_MI_COHORT_EFI AS efi
		ON fe.ALF_PE = efi.ALF_PE 
			WHEN MATCHED THEN
				UPDATE
				SET fe.FRAILTY_DEF = efi.FRAILTY_DEF
			;
					
	
----------EFI for stroke cohort------------------	

/* EFI */
	
CREATE OR REPLACE ALIAS SAILW0972V.V2_GPDATA 
FOR SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301;

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_STROKE_COHORT_EFI');

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_cohort_with_dummy_date');


CREATE TABLE SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS (SELECT ALF_PE,  FIRST_EPI_STR_DT AS event_dt FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT) WITH no DATA ;

INSERT INTO SAILW0972V.V2_COHORT_WITH_DUMMY_DATE 
SELECT ALF_PE ,  FIRST_EPI_STR_DT AS event_dt FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT ;

--drop table SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF1

		
 CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF1 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF1(
		SELECT
			ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD = '39F..'
			AND EVENT_VAL < 19)
			OR (EVENT_CD IN ( '13O5.',
			'13V8.',
			'13VC.',
			'8F6..',
			'9EB5.' ) )
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF2 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF2 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '423..'
			AND EVENT_VAL BETWEEN 0 AND 12.5)
			OR (EVENT_CD = '423..'
			AND EVENT_VAL BETWEEN 25 AND 125)
			--need to take in to account a change in magnitude of measurement
			OR (EVENT_CD IN ( '145..',
			'1451.',
			'1452.',
			'1453.',
			'1454.',
			'2C23.',
			'42R41',
			'42T2.',
			'66E5.',
			'7Q090',
			'7Q091',
			'B9370',
			'B9371',
			'B9372',
			'B9373',
			'B937X',
			'BBmA.',
			'BBmB.',
			'BBmL.',
			'ByuHC',
			'C2620',
			'C2621',
			'D0...',
			'D00..',
			'D000.',
			'D001.',
			'D00y.',
			'D00y1',
			'D00yz',
			'D00z.',
			'D00z0',
			'D00z1',
			'D00z2',
			'D00zz',
			'D01..',
			'D010.',
			'D011.',
			'D0110',
			'D0111',
			'D011X',
			'D011z',
			'D012.',
			'D0121',
			'D0122',
			'D0123',
			'D0124',
			'D0125',
			'D012z',
			'D013.',
			'D0130',
			'D013z',
			'D014.',
			'D0140',
			'D014z',
			'D01y.',
			'D01yy',
			'D01yz',
			'D01z.',
			'D01z0',
			'D0y..',
			'D0z..',
			'D1...',
			'D104.',
			'D1040',
			'D1047',
			'D104z',
			'D106.',
			'D1060',
			'D1061',
			'D1062',
			'D106z',
			'D11..',
			'D110.',
			'D1100',
			'D1101',
			'D1102',
			'D1103',
			'D1104',
			'D110z',
			'D111.',
			'D1110',
			'D1111',
			'D1112',
			'D1114',
			'D1115',
			'D111y',
			'D111z',
			'D112z',
			'D11z.',
			'D1y..',
			'D1z..',
			'D2...',
			'D20..',
			'D200.',
			'D2000',
			'D2002',
			'D200y',
			'D200z',
			'D201.',
			'D2010',
			'D2011',
			'D2012',
			'D2013',
			'D2014',
			'D2017',
			'D201z',
			'D204.',
			'D20z.',
			'D21..',
			'D210.',
			'D2101',
			'D2103',
			'D2104',
			'D210z',
			'D211.',
			'D212.',
			'D2120',
			'D213.',
			'D214.',
			'D215.',
			'D2150',
			'D21y.',
			'D21yy',
			'D21yz',
			'D21z.',
			'D2y..',
			'D2z..',
			'Dyu0.',
			'Dyu00',
			'Dyu01',
			'Dyu02',
			'Dyu03',
			'Dyu04',
			'Dyu05',
			'Dyu06',
			'Dyu1.',
			'Dyu15',
			'Dyu16',
			'Dyu17',
			'Dyu2.',
			'Dyu21',
			'Dyu22',
			'Dyu23',
			'Dyu24',
			'J6141' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF3 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF3 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14G..',
			'14G1.',
			'14G2.',
			'52A31',
			'52A71',
			'66H..',
			'N0504',
			'7K3..',
			'7K30.',
			'7K32.',
			'7K6Z3',
			'7K6Z7',
			'7K6ZK',
			'C340.',
			'C34z.',
			'N023.',
			'N0310',
			'N04..',
			'N040.',
			'N0400',
			'N0401',
			'N0402',
			'N0404',
			'N0405',
			'N0407',
			'N0408',
			'N0409',
			'N040A',
			'N040B',
			'N040C',
			'N040D',
			'N040F',
			'N040G',
			'N040H',
			'N040J',
			'N040K',
			'N040L',
			'N040M',
			'N040P',
			'N040S',
			'N040T',
			'N047.',
			'N04X.',
			'N05..',
			'N050.',
			'N0502',
			'N0504',
			'N0506',
			'N0535',
			'N0536',
			'N05z1',
			'N05z4',
			'N05z5',
			'N05z6',
			'N05z9',
			'N05zJ',
			'N05zL',
			'N06z.',
			'N06z5',
			'N06z6',
			'N06zz',
			'N11..',
			'N11D.',
			'Nyu10',
			'Nyu11',
			'Nyu12',
			'Nyu1G' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF4 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF4 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '38DE.')
			OR (EVENT_CD IN ( '14AN.',
			'2432.',
			'3272.',
			'3273.',
			'662S.',
			'6A9..',
			'7936A',
			'9Os1.',
			'9hF0.',
			'9hF1.',
			'G573.',
			'G5730',
			'G5731',
			'G5732',
			'G5733',
			'G5734',
			'G5735',
			'G573z' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF5 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF5 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14A7.',
			'14AB.',
			'14AK.',
			'662M.',
			'662e.',
			'662o.',
			'7P242',
			'8HBJ.',
			'8HHM.',
			'8HTQ.',
			'9N0p.',
			'9N4X.',
			'9Om1.',
			'9Om2.',
			'9Om3.',
			'9Om4.',
			'9h21.',
			'9h22.',
			'F4236',
			'G6...',
			'G61..',
			'G621.',
			'G622.',
			'G631.',
			'G634.',
			'G64..',
			'G640.',
			'G65..',
			'G65y.',
			'G65z.',
			'G65z1',
			'G65zz',
			'G66..',
			'G663.',
			'G664.',
			'G667.',
			'G670.',
			'G6711',
			'G682.',
			'G68X.',
			'Gyu6.',
			'Gyu6B',
			'Gyu6C',
			'S62..',
			'S620.',
			'S622.',
			'S627.',
			'S628.',
			'S629.',
			'S6290' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF6 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF6 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '46W..'
			AND EVENT_VAL > 30)
			OR (EVENT_CD = '46TC.'
			AND EVENT_VAL > 30)
			OR (EVENT_CD = '46N7.'
			AND EVENT_VAL > 45)
			OR (EVENT_CD = '46N4.'
			AND EVENT_VAL > 30)
			OR (EVENT_CD = '46N..'
			AND EVENT_VAL > 150)
			OR (EVENT_CD = '451F.'
			AND EVENT_VAL < 60)
			OR (EVENT_CD IN ( '1Z1..',
			'1Z12.',
			'1Z13.',
			'1Z14.',
			'1Z15.',
			'1Z16.',
			'1Z1B.',
			'1Z1C.',
			'1Z1D.',
			'1Z1E.',
			'1Z1F.',
			'1Z1G.',
			'1Z1H.',
			'1Z1J.',
			'1Z1K.',
			'1Z1L.',
			'4677.',
			'6AA..',
			'9hE0.',
			'9hE1.',
			'C104.',
			'C104y',
			'C104z',
			'C1080',
			'C108D',
			'C1090',
			'C1093',
			'C109C',
			'C10E0',
			'C10ED',
			'C10EK',
			'C10EL',
			'C10F0',
			'C10F3',
			'C10FC',
			'C10FL',
			'C10FM',
			'Cyu23',
			'K05..',
			'K050.',
			'PD13.',
			'R110.' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF7 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF7 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '2BBR.',
			'2BBS.',
			'2BBT.',
			'2G5L.',
			'42W3.',
			'42c..',
			'66A..',
			'66A4.',
			'66A5.',
			'66AD.',
			'66AH0',
			'66AJ.',
			'66AR.',
			'66AS.',
			'66AU.',
			'66AZ.',
			'66Ab.',
			'66Ac.',
			'66Ai.',
			'66Aq.',
			'68A7.',
			'8A17.',
			'8BL2.',
			'8CR2.',
			'8H7f.',
			'8HBG.',
			'8HBH.',
			'8Hl1.',
			'9NND.',
			'9OL1.',
			'9OLD.',
			'9h4..',
			'9h41.',
			'9h42.',
			'C10..',
			'C100.',
			'C1000',
			'C1001',
			'C100z',
			'C101.',
			'C1010',
			'C1011',
			'C101y',
			'C101z',
			'C102.',
			'C102z',
			'C103.',
			'C1030',
			'C1031',
			'C103y',
			'C104.',
			'C104y',
			'C104z',
			'C105.',
			'C105y',
			'C105z',
			'C106.',
			'C1061',
			'C106y',
			'C106z',
			'C107.',
			'C107z',
			'C108.',
			'C1080',
			'C1081',
			'C1082',
			'C1083',
			'C1085',
			'C1086',
			'C1087',
			'C1088',
			'C1089',
			'C108A',
			'C108B',
			'C108C',
			'C108D',
			'C108E',
			'C108F',
			'C108J',
			'C108y',
			'C108z',
			'C109.',
			'C1090',
			'C1091',
			'C1092',
			'C1093',
			'C1094',
			'C1095',
			'C1096',
			'C1097',
			'C1099',
			'C109A',
			'C109B',
			'C109C',
			'C109D',
			'C109E',
			'C109F',
			'C109G',
			'C109H',
			'C109J',
			'C10A1',
			'C10B0',
			'C10C.',
			'C10D.',
			'C10E.',
			'C10E0',
			'C10E1',
			'C10E2',
			'C10E3',
			'C10E5',
			'C10E6',
			'C10E7',
			'C10E8',
			'C10E9',
			'C10EA',
			'C10EB',
			'C10EC',
			'C10ED',
			'C10EE',
			'C10EF',
			'C10EJ',
			'C10EK',
			'C10EL',
			'C10EM',
			'C10EN',
			'C10EP',
			'C10EQ',
			'C10ER',
			'C10F.',
			'C10F0',
			'C10F1',
			'C10F2',
			'C10F3',
			'C10F4',
			'C10F5',
			'C10F6',
			'C10F7',
			'C10F9',
			'C10FA',
			'C10FB',
			'C10FC',
			'C10FD',
			'C10FE',
			'C10FF',
			'C10FG',
			'C10FH',
			'C10FJ',
			'C10FL',
			'C10FM',
			'C10FN',
			'C10FP',
			'C10FQ',
			'C10FR',
			'C10H.',
			'C10y.',
			'C10yy',
			'C10z.',
			'C10zz',
			'Cyu2.',
			'Cyu23',
			'F1711',
			'F372.',
			'F3720',
			'F3721',
			'F3722',
			'F3813',
			'F3y0.',
			'F420.',
			'F4200',
			'F4204',
			'F4206',
			'F420z',
			'F42y9',
			'F4640',
			'M2710' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF8 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF8 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1491.',
			'1B5..',
			'1B53.',
			'F56..',
			'F561.',
			'F5610',
			'F5611',
			'F5614',
			'F561z',
			'F562.',
			'F562z',
			'FyuQ1',
			'R004.',
			'R0040',
			'R0043',
			'R0044' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF9 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF9 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '173..',
			'1732.',
			'1733.',
			'1734.',
			'1738.',
			'1739.',
			'173C.',
			'173K.',
			'173Z.',
			'2322.',
			'R0608',
			'R060A' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF10 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF10 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '16D2.'
			AND EVENT_VAL > 0 )
			OR (EVENT_CD IN ( '16D..',
			'16D1.',
			'8HTl.',
			'8Hk1.',
			'8O9..',
			'R200.',
			'TC...',
			'TC5..',
			'TCz..' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF11 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF11 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '13G8.',
			'9N08.',
			'9N1y7',
			'9N2Q.',
			'M20..',
			'M2000' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF12 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF12 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14G6.',
			'14G7.',
			'14G8.',
			'7K1D0',
			'7K1D6',
			'7K1H6',
			'7K1H8',
			'7K1J0',
			'7K1J6',
			'7K1J8',
			'7K1JB',
			'7K1JD',
			'7K1Jd',
			'7K1L4',
			'7K1LL',
			'7K1Y0',
			'N1y1.',
			'N331.',
			'N3311',
			'N331A',
			'N331D',
			'N331G',
			'N331H',
			'N331J',
			'N331K',
			'N331L',
			'N331M',
			'N331N',
			'NyuB0',
			'S10..',
			'S1000',
			'S1005',
			'S1006',
			'S1007',
			'S100H',
			'S100K',
			'S102.',
			'S1020',
			'S1021',
			'S102y',
			'S102z',
			'S1031',
			'S104.',
			'S1040',
			'S1041',
			'S1042',
			'S10A0',
			'S10B.',
			'S10B0',
			'S10B6',
			'S112.',
			'S114.',
			'S1145',
			'S15..',
			'S150.',
			'S1500',
			'S23..',
			'S234.',
			'S2341',
			'S2346',
			'S2351',
			'S23B.',
			'S23C.',
			'S23x1',
			'S23y.',
			'S3...',
			'S30..',
			'S300.',
			'S3000',
			'S3001',
			'S3004',
			'S3005',
			'S3006',
			'S3007',
			'S3009',
			'S300y',
			'S300z',
			'S3010',
			'S3015',
			'S302.',
			'S3020',
			'S3021',
			'S3022',
			'S3023',
			'S3024',
			'S302z',
			'S303.',
			'S3030',
			'S3032',
			'S3034',
			'S304.',
			'S305.',
			'S30y.',
			'S30z.',
			'S31z.',
			'S4500',
			'S4E..',
			'S4E0.',
			'S4E1.',
			'S4E2.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF13 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF13 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1C12.',
			'1C13.',
			'1C131',
			'1C132',
			'1C133',
			'1C16.',
			'2BM2.',
			'2BM3.',
			'2BM4.',
			'2DG..',
			'3134.',
			'31340',
			'8D2..',
			'8E3..',
			'8HR2.',
			'8HT2.',
			'8HT3.',
			'Eu446',
			'F5801',
			'F59..',
			'F590.',
			'F591.',
			'F5912',
			'F5915',
			'F5916',
			'F592.',
			'F594.',
			'F595.',
			'F59z.',
			'F5A..',
			'ZV532' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF14 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF14 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14A6.',
			'14AM.',
			'1736.',
			'1O1..',
			'33BA.',
			'388D.',
			'585f.',
			'662T.',
			'662W.',
			'662g.',
			'662h.',
			'662p.',
			'679X.',
			'67D4.',
			'8CL3.',
			'8H2S.',
			'8HBE.',
			'8HHb.',
			'8HHz.',
			'9N0k.',
			'9N2p.',
			'9N4s.',
			'9N4w.',
			'9N6T.',
			'9Or0.',
			'9Or5.',
			'9hH0.',
			'9hH1.',
			'G58..',
			'G580.',
			'G5800',
			'G5801',
			'G5804',
			'G581.',
			'G582.',
			'G58z.',
			'G5y4z',
			'G5yy9',
			'SP111' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF15 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF15 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( 'G540.',
			'G5402',
			'G5415',
			'G543.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF16 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF16 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '13CA.',
			'8HL..',
			'9N1C.',
			'9NF..',
			'9NF1.',
			'9NF2.',
			'9NF3.',
			'9NF8.',
			'9NF9.',
			'9NFB.',
			'9NFM.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF17 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF17 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '246W.'
			AND EVENT_VAL > 135 )
			OR (EVENT_CD = '246V.'
			AND EVENT_VAL > 85 )
			OR (EVENT_CD IN ( '14A2.',
			'246M.',
			'6627.',
			'6628.',
			'662F.',
			'662O.',
			'662b.',
			'8CR4.',
			'8HT5.',
			'8I3N.',
			'9N03.',
			'9N1y2',
			'9h3..',
			'9h31.',
			'9h32.',
			'F4211',
			'F4213',
			'G2...',
			'G20..',
			'G200.',
			'G201.',
			'G202.',
			'G203.',
			'G20z.',
			'G22z.',
			'G24..',
			'G240.',
			'G240z',
			'G241.',
			'G241z',
			'G244.',
			'G24z.',
			'G24z0',
			'G24z1',
			'G24zz',
			'G2z..',
			'Gyu20',
			'Gyu21' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF18 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF18 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1B55.',
			'1B6..',
			'1B62.',
			'1B65.',
			'1B68.',
			'79370',
			'F1303',
			'G87..',
			'G870.',
			'G871.',
			'G872.',
			'G873.',
			'G87z.',
			'R002.',
			'R0021',
			'R0022',
			'R0023',
			'R0042' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF19 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF19 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14A..',
			'14A4.',
			'14A5.',
			'182..',
			'322..',
			'3222.',
			'322Z.',
			'662K0',
			'662K1',
			'662K3',
			'6A2..',
			'6A4..',
			'792..',
			'7928.',
			'79294',
			'889A.',
			'8H2V.',
			'8I3z.',
			'G3...',
			'G30..',
			'G3071',
			'G308.',
			'G30y.',
			'G30yz',
			'G30z.',
			'G31..',
			'G311.',
			'G3111',
			'G31y2',
			'G31y3',
			'G31yz',
			'G32..',
			'G33..',
			'G332.',
			'G33z.',
			'G33z3',
			'G33z4',
			'G33z7',
			'G33zz',
			'G34..',
			'G340.',
			'G344.',
			'G34y0',
			'G34y1',
			'G34yz',
			'G34z.',
			'G36..',
			'G361.',
			'G362.',
			'G37..',
			'G3y..',
			'G3z..',
			'Gyu3.',
			'G3...',
			'Gyu30' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF20 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF20 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '3AD3.'
			AND (EVENT_VAL > 8
			OR EVENT_VAL = 8))
			OR (EVENT_CD IN ( '1461.',
			'1B1A.',
			'1S21.',
			'2841.',
			'28E..',
			'3A10.',
			'3A20.',
			'3A30.',
			'3A40.',
			'3A50.',
			'3A60.',
			'3A70.',
			'3A80.',
			'3A91.',
			'3AA1.',
			'3AE..',
			'66h..',
			'6AB..',
			'8HTY.',
			'9NdL.',
			'9Nk1.',
			'9Ou..',
			'9Ou2.',
			'9Ou3.',
			'9Ou4.',
			'9Ou5.',
			'9hD..',
			'9hD0.',
			'9hD1.',
			'E00..',
			'E000.',
			'E001.',
			'E0010',
			'E0011',
			'E0012',
			'E0013',
			'E001z',
			'E002.',
			'E0020',
			'E0021',
			'E002z',
			'E003.',
			'E004.',
			'E0040',
			'E0041',
			'E0042',
			'E0043',
			'E004z',
			'E012.',
			'E041.',
			'E2A10',
			'E2A11',
			'Eu00.',
			'Eu000',
			'Eu001',
			'Eu002',
			'Eu00z',
			'Eu01.',
			'Eu010',
			'Eu011',
			'Eu012',
			'Eu013',
			'Eu01y',
			'Eu01z',
			'Eu02.',
			'Eu020',
			'Eu021',
			'Eu022',
			'Eu023',
			'Eu025',
			'Eu02y',
			'Eu02z',
			'Eu041',
			'Eu057',
			'F110.',
			'F1100',
			'F1101',
			'F116.',
			'F21y2',
			'R00z0' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF21 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF21 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1381.',
			'13C2.',
			'13C4.',
			'13CD.',
			'13CE.',
			'398A.',
			'39B..',
			'8D4..',
			'8O15.',
			'N097.',
			'ZV4L0' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF22 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF22 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '58EE.'
			AND (EVENT_VAL <-2.5
			OR EVENT_VAL = -2.5) )
			OR (EVENT_CD IN ( '14OD.',
			'56812',
			'58EN.',
			'66a..',
			'66a2.',
			'66a3.',
			'66a4.',
			'66a5.',
			'66a6.',
			'66a7.',
			'66a8.',
			'66a9.',
			'66aA.',
			'66aE.',
			'8HTS.',
			'9N0h.',
			'9Od0.',
			'9Od2.',
			'N330.',
			'N3300',
			'N3301',
			'N3302',
			'N3303',
			'N3304',
			'N3305',
			'N3306',
			'N3307',
			'N3308',
			'N330A',
			'N330B',
			'N330C',
			'N330D',
			'N330z',
			'N3312',
			'N3315',
			'N3316',
			'N3318',
			'N3319',
			'N331B',
			'N331L',
			'N3370',
			'NyuB0',
			'NyuB1',
			'NyuB8',
			'NyuBC' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF23 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF23 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '297A.',
			'2987.',
			'2994.',
			'A94y1',
			'F116.',
			'F11x9',
			'F12..',
			'F120.',
			'F121.',
			'F12W.',
			'F12X.',
			'F12z.',
			'F13..',
			'F1303',
			'Fyu20',
			'Fyu21',
			'Fyu22',
			'Fyu29',
			'Fyu2B',
			'R0103',
			'TJ64.',
			'U6067' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF24 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF24 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14C1.',
			'1956.',
			'76121',
			'761D5',
			'761D6',
			'761J.',
			'761J0',
			'761J1',
			'761Jy',
			'761Jz',
			'7627.',
			'76270',
			'76271',
			'76272',
			'7627y',
			'7627z',
			'J1016',
			'J1020',
			'J11..',
			'J110.',
			'J1100',
			'J1101',
			'J1102',
			'J1103',
			'J1104',
			'J110y',
			'J110z',
			'J111.',
			'J1110',
			'J1111',
			'J1112',
			'J1114',
			'J111y',
			'J111z',
			'J112.',
			'J113.',
			'J113z',
			'J11y.',
			'J11y0',
			'J11y1',
			'J11y2',
			'J11yz',
			'J11z.',
			'J12..',
			'J120.',
			'J1200',
			'J1201',
			'J1202',
			'J1203',
			'J120y',
			'J120z',
			'J121.',
			'J1210',
			'J1211',
			'J1212',
			'J1213',
			'J1214',
			'J121y',
			'J121z',
			'J122.',
			'J124.',
			'J125.',
			'J126.',
			'J126z',
			'J12y.',
			'J12y0',
			'J12y1',
			'J12y2',
			'J12y3',
			'J12y4',
			'J12yy',
			'J12yz',
			'J12z.',
			'J13..',
			'J130.',
			'J1300',
			'J1301',
			'J1302',
			'J1303',
			'J130y',
			'J130z',
			'J131.',
			'J1310',
			'J1311',
			'J1312',
			'J131y',
			'J131z',
			'J13y.',
			'J13y0',
			'J13y1',
			'J13y2',
			'J13yz',
			'J13z.',
			'J14..',
			'J1401',
			'J1411',
			'J14y.',
			'J14z.',
			'J17y8',
			'J57y8',
			'ZV12C' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF25 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF25 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '585a.'
			AND EVENT_VAL < 0.95)
			OR (EVENT_CD IN ( '24E9.',
			'24EA.',
			'24EC.',
			'24F9.',
			'C107.',
			'C1086',
			'C109F',
			'C10E6',
			'C10FF',
			'G670.',
			'G700.',
			'G73..',
			'G73z.',
			'G73zz',
			'M2710' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF26 ( ALF_PE BIGINT,
	event_dt DATE,
	DEF26 BIGINT ) DISTRIBUTE BY HASH(ALF_PE);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF26 (
			SELECT SUB.ALF_PE,
			sub.event_dt,
			MAX(SUB.RANK)
		FROM
			(
				SELECT ALF_PE,
				A.event_dt AS event_dt,
				DENSE_RANK() OVER (PARTITION BY ALF_PE
			ORDER BY
				EVENT_CD) AS RANK
			FROM
				SAILW0972V.V2_GPDATA AS B
			JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
					USING (ALF_PE)
			WHERE
				B.EVENT_DT <= A.EVENT_DT
				AND B.EVENT_DT >= A.EVENT_DT - 1 YEARS
				AND (substr(EVENT_CD,
				1,
				1) <> UPPER(substr(EVENT_CD, 1, 1)) ) ) AS SUB
		GROUP BY
			SUB.ALF_PE ,
			sub.event_dt);

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF27 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF27 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '13F6.',
			'13F61',
			'13FX.',
			'13G6.',
			'13G61',
			'13WJ.',
			'8GEB.',
			'918F.',
			'9N1G.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF28 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF28 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '66Yf.'
			AND EVENT_VAL > 0)
			OR (EVENT_CD IN ( '14B..',
			'14B3.',
			'14B4.',
			'14OX.',
			'1712.',
			'1713.',
			'1715.',
			'171A.',
			'173A.',
			'178..',
			'1780.',
			'1O2..',
			'3399.',
			'339U.',
			'33G0.',
			'388t.',
			'663..',
			'663J.',
			'663N.',
			'663N0',
			'663N1',
			'663N2',
			'663O.',
			'663O0',
			'663P.',
			'663Q.',
			'663U.',
			'663V.',
			'663V0',
			'663V1',
			'663V2',
			'663V3',
			'663W.',
			'663d.',
			'663e.',
			'663f.',
			'663h.',
			'663j.',
			'663l.',
			'663m.',
			'663n.',
			'663p.',
			'663q.',
			'663r.',
			'663s.',
			'663t.',
			'663u.',
			'663v.',
			'663w.',
			'663x.',
			'663y.',
			'66Y5.',
			'66Y9.',
			'66YA.',
			'66YB.',
			'66YD.',
			'66YE.',
			'66YI.',
			'66YJ.',
			'66YK.',
			'66YL.',
			'66YM.',
			'66YP.',
			'66YQ.',
			'66YR.',
			'66YS.',
			'66YT.',
			'66YZ.',
			'66Yd.',
			'66Ye.',
			'66Yf.',
			'66Yg.',
			'66Yh.',
			'66Yi.',
			'679J.',
			'679V.',
			'74592',
			'8764.',
			'8776.',
			'8778.',
			'8793.',
			'8794.',
			'8795.',
			'8796.',
			'8797.',
			'8798.',
			'8B3j.',
			'8CR0.',
			'8CR1.',
			'8FA..',
			'8FA1.',
			'8H2P.',
			'8H2R.',
			'8H7u.',
			'8HTT.',
			'9N1d.',
			'9N4Q.',
			'9N4W.',
			'9OJ1.',
			'9OJ2.',
			'9OJ3.',
			'9OJ7.',
			'9OJA.',
			'9Oi3.',
			'9h52.',
			'9hA1.',
			'9hA2.',
			'9kf..',
			'9kf0.',
			'G401.',
			'G4011',
			'G410.',
			'G41y0',
			'H....',
			'H3...',
			'H30..',
			'H302.',
			'H31..',
			'H310.',
			'H3100',
			'H310z',
			'H311.',
			'H3110',
			'H3111',
			'H312.',
			'H3120',
			'H3122',
			'H312z',
			'H31y.',
			'H31yz',
			'H31z.',
			'H32..',
			'H33..',
			'H330.',
			'H3300',
			'H3301',
			'H330z',
			'H331.',
			'H3310',
			'H3311',
			'H331z',
			'H332.',
			'H333.',
			'H334.',
			'H33z.',
			'H33z0',
			'H33z1',
			'H33z2',
			'H33zz',
			'H36..',
			'H37..',
			'H38..',
			'H39..',
			'H3y..',
			'H3y0.',
			'H3y1.',
			'H3z..',
			'H564.',
			'Hyu31',
			'N04y0',
			'R062.',
			'TJF73',
			'U60F6',
			'ZV129' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF29 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF29 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14F3.',
			'14F5.',
			'2924.',
			'2FF..',
			'2FF2.',
			'2FF3.',
			'2FFZ.',
			'2G48.',
			'2G54.',
			'2G55.',
			'2G5H.',
			'2G5L.',
			'2G5V.',
			'2G5W.',
			'39C..',
			'39C0.',
			'4JG3.',
			'7G2E5',
			'7G2EA',
			'7G2EB',
			'7G2EC',
			'81H1.',
			'8CT1.',
			'8CV2.',
			'8HTh.',
			'9N0t.',
			'9NM5.',
			'C1094',
			'C10F4',
			'G830.',
			'G832.',
			'G835.',
			'G837.',
			'M07z.',
			'M27..',
			'M270.',
			'M271.',
			'M2710',
			'M2711',
			'M2712',
			'M2713',
			'M2714',
			'M2715',
			'M272.',
			'M27y.',
			'M27z.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF30 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF30 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1B1B.',
			'1B1Q.',
			'E274.',
			'Eu51.',
			'Fy02.',
			'R005.',
			'R0050',
			'R0052' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF31 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF31 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1335.',
			'133P.',
			'133V.',
			'13EH.',
			'13F3.',
			'13G4.',
			'13M1.',
			'13MF.',
			'13Z8.',
			'1B1K.',
			'8H75.',
			'8HHB.',
			'8I5..',
			'918V.',
			'9NNV.',
			'ZV603' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF32 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF32 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '44lD.'
			AND EVENT_VAL > 15)
			OR (EVENT_CD = '442W.'
			AND EVENT_VAL NOT BETWEEN 0.5 AND 4)
			OR (EVENT_CD = '442A.'
			AND EVENT_VAL NOT BETWEEN 0.5 AND 4)
			OR (EVENT_CD IN ( '1431.',
			'1432.',
			'4422.',
			'442I.',
			'66BB.',
			'66BZ.',
			'8CR5.',
			'9N4T.',
			'9Oj0.',
			'C0...',
			'C02..',
			'C04..',
			'C040.',
			'C041.',
			'C0410',
			'C041z',
			'C042.',
			'C043.',
			'C043z',
			'C044.',
			'C046.',
			'C04y.',
			'C04z.',
			'C1343',
			'Cyu1.',
			'Cyu11' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF33 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF33 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1593.',
			'16F..',
			'1A23.',
			'1A24.',
			'1A26.',
			'3940.',
			'3941.',
			'7B338',
			'7B33C',
			'7B421',
			'8D7..',
			'8D71.',
			'8HTX.',
			'K198.',
			'K586.',
			'Kyu5A',
			'R083.',
			'R0831',
			'R0832',
			'R083z' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF34 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF34 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '14D..',
			'14DZ.',
			'1A1..',
			'1A13.',
			'1A1Z.',
			'1A55.',
			'1AA..',
			'1AC2.',
			'7B39.',
			'7B390',
			'8156.',
			'8H5B.',
			'K....',
			'K155.',
			'K1653',
			'K1654',
			'K16y4',
			'K190.',
			'K1903',
			'K1905',
			'K190z',
			'K1971',
			'K1973',
			'K20..',
			'Ky...',
			'Kz...',
			'R08..',
			'R082.',
			'R0822',
			'SP031' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF35 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF35 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			(EVENT_CD IN ( '1483.',
			'1B75.',
			'22E5.',
			'22EG.',
			'2BBm.',
			'2BBn.',
			'2BBo.',
			'2BBr.',
			'2BT..',
			'2BT0.',
			'2BT1.',
			'6688.',
			'6689.',
			'72630',
			'72661',
			'8F61.',
			'8H52.',
			'9m08.',
			'C108F',
			'C109E',
			'C10EF',
			'C10EP',
			'C10FE',
			'C10FQ',
			'F4042',
			'F421A',
			'F422.',
			'F422y',
			'F422z',
			'F4239',
			'F425.',
			'F4250',
			'F4251',
			'F4252',
			'F4253',
			'F4254',
			'F4257',
			'F427C',
			'F42y4',
			'F42y9',
			'F4305',
			'F4332',
			'F46..',
			'F4602',
			'F4603',
			'F4604',
			'F4605',
			'F4606',
			'F4607',
			'F460z',
			'F461.',
			'F4610',
			'F4614',
			'F4615',
			'F4617',
			'F4618',
			'F4619',
			'F461A',
			'F461B',
			'F461y',
			'F461z',
			'F462.',
			'F462z',
			'F463.',
			'F4633',
			'F4634',
			'F463z',
			'F464.',
			'F4640',
			'F4642',
			'F4644',
			'F4646',
			'F4647',
			'F464z',
			'F465.',
			'F4650',
			'F465z',
			'F466.',
			'F46y.',
			'F46yz',
			'F46z.',
			'F46z0',
			'F4840',
			'F49..',
			'F490.',
			'F4900',
			'F4909',
			'F490z',
			'F494.',
			'F4950',
			'F495A',
			'F49z.',
			'F4A24',
			'F4H34',
			'F4H40',
			'F4H73',
			'F4K2D',
			'FyuE1',
			'FyuF7',
			'FyuL.',
			'P33..',
			'P330.',
			'P331.',
			'P3310',
			'P3311',
			'P331z',
			'S813.',
			'SJ0z.' ))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );

CREATE TABLE
	SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF36 ( ALF_PE BIGINT,
	event_dt DATE ,
	EVENT_CD CHAR(30)) DISTRIBUTE BY HASH(ALF_PE,
	EVENT_CD);

INSERT
	INTO
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF36 (
			SELECT ALF_PE,
			A.event_dt ,
			COUNT(EVENT_CD)
		FROM
			SAILW0972V.V2_GPDATA AS B
		JOIN SAILW0972V.V2_COHORT_WITH_DUMMY_DATE AS A
				USING (ALF_PE)
		WHERE
			((EVENT_CD = '687C.'
			AND (EVENT_VAL > 1
			OR EVENT_VAL = 1))
			OR (EVENT_CD IN ( '1612.',
			'1615.',
			'1623.',
			'1625.',
			'1D1A.',
			'22A8.',
			'R0300',
			'R032.' )))
			AND B.EVENT_DT <= A.EVENT_DT
			AND B.EVENT_DT >= A.EVENT_DT - 10 YEARS
		GROUP BY
			ALF_PE,
			A.event_dt );
			
		-----------------------Join tables
--drop table SAILW0972V.V2_VB_STROKE_COHORT_EFI_INDICATOR_dummy
		
CREATE TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_INDICATOR_dummy (
                      ALF_PE BIGINT ,event_dt date
                      , DEF1 BIGINT
                      , DEF2 BIGINT
                      , DEF3 BIGINT
                      , DEF4 BIGINT
                      , DEF5 BIGINT
                      , DEF6 BIGINT
                      , DEF7 BIGINT
                      , DEF8 BIGINT
                      , DEF9 BIGINT
                      , DEF10 BIGINT
                      , DEF11 BIGINT
                      , DEF12 BIGINT
                      , DEF13 BIGINT
                      , DEF14 BIGINT
                      , DEF15 BIGINT
                      , DEF16 BIGINT
                      , DEF17 BIGINT
                      , DEF18 BIGINT
                      , DEF19 BIGINT
                      , DEF20 BIGINT
                      , DEF21 BIGINT
                      , DEF22 BIGINT
                      , DEF23 BIGINT
                      , DEF24 BIGINT
                      , DEF25 BIGINT
                      , DEF26 BIGINT
                      , DEF27 BIGINT
                      , DEF28 BIGINT
                      , DEF29 BIGINT
                      , DEF30 BIGINT
                      , DEF31 BIGINT
                      , DEF32 BIGINT
                      , DEF33 BIGINT
                      , DEF34 BIGINT
                      , DEF35 BIGINT
                      , DEF36 BIGINT )
                      DISTRIBUTE BY HASH(ALF_PE);
		
		INSERT INTO SAILW0972V.V2_VB_STROKE_COHORT_EFI_INDICATOR_dummy  (
                      select COHORT.ALF_PE  ,cohort.event_dt , DUMMY1.EVENT_CD AS  dummy_def1 ,  DUMMY2.EVENT_CD AS dummy_def2 ,  DUMMY3.EVENT_CD AS dummy_def3 ,  DUMMY4.EVENT_CD AS dummy_def4 ,  DUMMY5.EVENT_CD AS dummy_def5 ,  DUMMY6.EVENT_CD AS dummy_def6 ,  DUMMY7.EVENT_CD AS dummy_def7 ,  DUMMY8.EVENT_CD AS dummy_def8 ,  DUMMY9.EVENT_CD AS dummy_def9 ,  DUMMY10.EVENT_CD AS dummy_def10 ,  DUMMY11.EVENT_CD AS dummy_def11 ,  DUMMY12.EVENT_CD AS dummy_def12 ,  DUMMY13.EVENT_CD AS dummy_def13 ,  DUMMY14.EVENT_CD AS dummy_def14 ,  DUMMY15.EVENT_CD AS dummy_def15 ,  DUMMY16.EVENT_CD AS dummy_def16 ,  DUMMY17.EVENT_CD AS dummy_def17 ,  DUMMY18.EVENT_CD AS dummy_def18 ,  DUMMY19.EVENT_CD AS dummy_def19 ,  DUMMY20.EVENT_CD AS dummy_def20 ,  DUMMY21.EVENT_CD AS dummy_def21 ,  DUMMY22.EVENT_CD AS dummy_def22 ,  DUMMY23.EVENT_CD AS dummy_def23 ,  DUMMY24.EVENT_CD AS dummy_def24 ,  DUMMY25.EVENT_CD AS dummy_def25 ,  DUMMY26.def26 AS dummy_def26 ,  DUMMY27.EVENT_CD AS dummy_def27 ,  DUMMY28.EVENT_CD AS dummy_def28 ,  DUMMY29.EVENT_CD AS dummy_def29 ,  DUMMY30.EVENT_CD AS dummy_def30 ,  DUMMY31.EVENT_CD AS dummy_def31 ,  DUMMY32.EVENT_CD AS dummy_def32 ,  DUMMY33.EVENT_CD AS dummy_def33 ,  DUMMY34.EVENT_CD AS dummy_def34 ,  DUMMY35.EVENT_CD AS dummy_def35 ,  DUMMY36.EVENT_CD AS dummy_def36 
                      from SAILW0972V.V2_COHORT_WITH_DUMMY_DATE  AS COHORT
                      LEFT JOIN  SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF1  AS  DUMMY1  ON COHORT.ALF_PE = DUMMY1.ALF_PE and COHORT.event_dt = DUMMY1.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF2   AS  DUMMY2  ON COHORT.ALF_PE = DUMMY2.ALF_PE and COHORT.event_dt = DUMMY2.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF3   AS  DUMMY3  ON COHORT.ALF_PE = DUMMY3.ALF_PE and COHORT.event_dt = DUMMY3.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF4   AS  DUMMY4  ON COHORT.ALF_PE = DUMMY4.ALF_PE and COHORT.event_dt = DUMMY4.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF5   AS  DUMMY5  ON COHORT.ALF_PE = DUMMY5.ALF_PE and COHORT.event_dt = DUMMY5.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF6   AS  DUMMY6  ON COHORT.ALF_PE = DUMMY6.ALF_PE and COHORT.event_dt = DUMMY6.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF7   AS  DUMMY7  ON COHORT.ALF_PE = DUMMY7.ALF_PE and COHORT.event_dt = DUMMY7.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF8   AS  DUMMY8  ON COHORT.ALF_PE = DUMMY8.ALF_PE and COHORT.event_dt = DUMMY8.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF9   AS  DUMMY9  ON COHORT.ALF_PE = DUMMY9.ALF_PE and COHORT.event_dt = DUMMY9.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF10   AS  DUMMY10  ON COHORT.ALF_PE = DUMMY10.ALF_PE and COHORT.event_dt = DUMMY10.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF11   AS  DUMMY11  ON COHORT.ALF_PE = DUMMY11.ALF_PE and COHORT.event_dt = DUMMY11.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF12   AS  DUMMY12  ON COHORT.ALF_PE = DUMMY12.ALF_PE and COHORT.event_dt = DUMMY12.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF13   AS  DUMMY13  ON COHORT.ALF_PE = DUMMY13.ALF_PE and COHORT.event_dt = DUMMY13.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF14   AS  DUMMY14  ON COHORT.ALF_PE = DUMMY14.ALF_PE and COHORT.event_dt = DUMMY14.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF15   AS  DUMMY15  ON COHORT.ALF_PE = DUMMY15.ALF_PE and COHORT.event_dt = DUMMY15.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF16   AS  DUMMY16  ON COHORT.ALF_PE = DUMMY16.ALF_PE and COHORT.event_dt = DUMMY16.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF17   AS  DUMMY17  ON COHORT.ALF_PE = DUMMY17.ALF_PE and COHORT.event_dt = DUMMY17.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF18   AS  DUMMY18  ON COHORT.ALF_PE = DUMMY18.ALF_PE and COHORT.event_dt = DUMMY18.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF19   AS  DUMMY19  ON COHORT.ALF_PE = DUMMY19.ALF_PE and COHORT.event_dt = DUMMY19.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF20   AS  DUMMY20  ON COHORT.ALF_PE = DUMMY20.ALF_PE and COHORT.event_dt = DUMMY20.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF21   AS  DUMMY21  ON COHORT.ALF_PE = DUMMY21.ALF_PE and COHORT.event_dt = DUMMY21.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF22   AS  DUMMY22  ON COHORT.ALF_PE = DUMMY22.ALF_PE and COHORT.event_dt = DUMMY22.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF23   AS  DUMMY23  ON COHORT.ALF_PE = DUMMY23.ALF_PE and COHORT.event_dt = DUMMY23.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF24   AS  DUMMY24  ON COHORT.ALF_PE = DUMMY24.ALF_PE and COHORT.event_dt = DUMMY24.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF25   AS  DUMMY25  ON COHORT.ALF_PE = DUMMY25.ALF_PE and COHORT.event_dt = DUMMY25.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF26   AS  DUMMY26  ON COHORT.ALF_PE = DUMMY26.ALF_PE and COHORT.event_dt = DUMMY26.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF27   AS  DUMMY27  ON COHORT.ALF_PE = DUMMY27.ALF_PE and COHORT.event_dt = DUMMY27.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF28   AS  DUMMY28  ON COHORT.ALF_PE = DUMMY28.ALF_PE and COHORT.event_dt = DUMMY28.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF29   AS  DUMMY29  ON COHORT.ALF_PE = DUMMY29.ALF_PE and COHORT.event_dt = DUMMY29.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF30   AS  DUMMY30  ON COHORT.ALF_PE = DUMMY30.ALF_PE and COHORT.event_dt = DUMMY30.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF31   AS  DUMMY31  ON COHORT.ALF_PE = DUMMY31.ALF_PE and COHORT.event_dt = DUMMY31.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF32   AS  DUMMY32  ON COHORT.ALF_PE = DUMMY32.ALF_PE and COHORT.event_dt = DUMMY32.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF33   AS  DUMMY33  ON COHORT.ALF_PE = DUMMY33.ALF_PE and COHORT.event_dt = DUMMY33.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF34   AS  DUMMY34  ON COHORT.ALF_PE = DUMMY34.ALF_PE and COHORT.event_dt = DUMMY34.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF35   AS  DUMMY35  ON COHORT.ALF_PE = DUMMY35.ALF_PE and COHORT.event_dt = DUMMY35.event_dt
                      LEFT JOIN   SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF36   AS  DUMMY36  ON COHORT.ALF_PE = DUMMY36.ALF_PE and COHORT.event_dt = DUMMY36.event_dt);
		
		
		----------------DROP ALL tables

DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF1;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF2;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF3;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF4;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF5;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF6;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF7;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF8;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF9;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF10;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF11;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF12;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF13;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF14;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF15;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF16;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF17;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF18;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF19;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF20;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF21;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF22;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF23;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF24;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF25;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF26;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF27;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF28;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF29;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF30;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF31;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF32;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF33;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF34;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF35;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_DEF36;

------------------------------------
CREATE TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_INDICATOR AS 
(SELECT * FROM SAILW0972V.V2_VB_STROKE_COHORT_EFI_INDICATOR_dummy) WITH NO DATA;


INSERT INTO SAILW0972V.V2_VB_STROKE_COHORT_EFI_INDICATOR 
                      select ALF_PE ,event_dt , CASE WHEN def1 IS NULL THEN 0 ELSE 1 END AS  DEF1 , CASE WHEN def2 IS NULL THEN 0 ELSE 1 END AS DEF2 ,  CASE WHEN def3 IS NULL THEN 0 ELSE 1 END AS DEF3 ,  CASE WHEN def4 IS NULL THEN 0 ELSE 1 END AS DEF4 ,  CASE WHEN def5 IS NULL THEN 0 ELSE 1 END AS DEF5 ,  CASE WHEN def6 IS NULL THEN 0 ELSE 1 END AS DEF6 ,  CASE WHEN def7 IS NULL THEN 0 ELSE 1 END AS DEF7 ,  CASE WHEN def8 IS NULL THEN 0 ELSE 1 END AS DEF8 ,  CASE WHEN def9 IS NULL THEN 0 ELSE 1 END AS DEF9 ,  CASE WHEN def10 IS NULL THEN 0 ELSE 1 END AS DEF10 ,  CASE WHEN def11 IS NULL THEN 0 ELSE 1 END AS DEF11 ,  CASE WHEN def12 IS NULL THEN 0 ELSE 1 END AS DEF12 ,  CASE WHEN def13 IS NULL THEN 0 ELSE 1 END AS DEF13 ,  CASE WHEN def14 IS NULL THEN 0 ELSE 1 END AS DEF14 ,  CASE WHEN def15 IS NULL THEN 0 ELSE 1 END AS DEF15 ,  CASE WHEN def16 IS NULL THEN 0 ELSE 1 END AS DEF16 ,  CASE WHEN def17 IS NULL THEN 0 ELSE 1 END AS DEF17 , CASE WHEN def18 IS NULL THEN 0 ELSE 1 END AS DEF18 ,  CASE WHEN def19 IS NULL THEN 0 ELSE 1 END AS DEF19 ,  CASE WHEN def20 IS NULL THEN 0 ELSE 1 END AS DEF20 ,  CASE WHEN def21 IS NULL THEN 0 ELSE 1 END AS DEF21 ,  CASE WHEN def22 IS NULL THEN 0 ELSE 1 END AS DEF22 ,  CASE WHEN def23 IS NULL THEN 0 ELSE 1 END AS DEF23 ,  CASE WHEN def24 IS NULL THEN 0 ELSE 1 END AS DEF24 ,  CASE WHEN def25 IS NULL THEN 0 ELSE 1 END AS DEF25 ,  CASE WHEN def26 IS NULL OR def26 < 5 THEN 0 ELSE 1 END AS DEF26 ,  CASE WHEN def27 IS NULL THEN 0 ELSE 1 END AS DEF27 ,  CASE WHEN def28 IS NULL THEN 0 ELSE 1 END AS DEF28 ,  CASE WHEN def29 IS NULL THEN 0 ELSE 1 END AS DEF29 ,  CASE WHEN def30 IS NULL THEN 0 ELSE 1 END AS DEF30 ,  CASE WHEN def31 IS NULL THEN 0 ELSE 1 END AS DEF31 ,  CASE WHEN def32 IS NULL THEN 0 ELSE 1 END AS DEF32 ,  CASE WHEN def33 IS NULL THEN 0 ELSE 1 END AS DEF33 ,  CASE WHEN def34 IS NULL THEN 0 ELSE 1 END AS DEF34 ,  CASE WHEN def35 IS NULL THEN 0 ELSE 1 END AS DEF35 ,  CASE WHEN def36 IS NULL THEN 0 ELSE 1 END AS DEF36 FROM SAILW0972V.V2_VB_STROKE_COHORT_EFI_INDICATOR_dummy ;


-----------------------------------------------

-----------------------------------------------

CREATE TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_sub (
                      ALF_PE BIGINT ,event_dt date
                      , DEF1 BIGINT
                      , DEF2 BIGINT
                      , DEF3 BIGINT
                      , DEF4 BIGINT
                      , DEF5 BIGINT
                      , DEF6 BIGINT
                      , DEF7 BIGINT
                      , DEF8 BIGINT
                      , DEF9 BIGINT
                      , DEF10 BIGINT
                      , DEF11 BIGINT
                      , DEF12 BIGINT
                      , DEF13 BIGINT
                      , DEF14 BIGINT
                      , DEF15 BIGINT
                      , DEF16 BIGINT
                      , DEF17 BIGINT
                      , DEF18 BIGINT
                      , DEF19 BIGINT
                      , DEF20 BIGINT
                      , DEF21 BIGINT
                      , DEF22 BIGINT
                      , DEF23 BIGINT
                      , DEF24 BIGINT
                      , DEF25 BIGINT
                      , DEF26 BIGINT
                      , DEF27 BIGINT
                      , DEF28 BIGINT
                      , DEF29 BIGINT
                      , DEF30 BIGINT
                      , DEF31 BIGINT
                      , DEF32 BIGINT
                      , DEF33 BIGINT
                      , DEF34 BIGINT
                      , DEF35 BIGINT
                      , DEF36 BIGINT
                      , Defict_sum bigint
                      , eFI decimal(6,4))
                      DISTRIBUTE BY HASH(ALF_PE);
                     
 INSERT INTO SAILW0972V.V2_VB_STROKE_COHORT_EFI_sub (
 
SELECT * , DEF1 + DEF2 + DEF3 + DEF4 + DEF5 + DEF6 + DEF7 + DEF8 + DEF9 + DEF10 + DEF11 + DEF12 + DEF13 + DEF14 + DEF15 + DEF16 + DEF17 + DEF18 + DEF19 + DEF20 + DEF21 + DEF22 + DEF23 + DEF24 + DEF25 + DEF26 + DEF27 + DEF28 + DEF29 + DEF30 + DEF31 + DEF32 + DEF33 + DEF34 + DEF35 + DEF36 AS deficit_sum , CAST( (DEF1 + DEF2 + DEF3 + DEF4 + DEF5 + DEF6 + DEF7 + DEF8 + DEF9 + DEF10 + DEF11 + DEF12 + DEF13 + DEF14 + DEF15 + DEF16 + DEF17 + DEF18 + DEF19 + DEF20 + DEF21 + DEF22 + DEF23 + DEF24 + DEF25 + DEF26 + DEF27 + DEF28 + DEF29 + DEF30 + DEF31 + DEF32 + DEF33 + DEF34 + DEF35 + DEF36) AS decimal(6,4))/36 AS eFI FROM SAILW0972V.V2_VB_STROKE_COHORT_EFI_INDICATOR);

DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_INDICATOR_dummy;



CREATE TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI AS (
SELECT
	* ,
	CASE
		WHEN (EFI > 0.12 AND EFI <= 0.24) THEN 1
		WHEN (EFI > 0.24 AND EFI <= 0.36) THEN 2 
		WHEN (EFI > 0.36) THEN 3
		ELSE 0 
		END 
		AS frailty
		,
	CASE
		WHEN (EFI > 0.12 AND EFI <= 0.24) THEN 'Mild'
		WHEN (EFI > 0.24 AND EFI <= 0.36) THEN 'Moderate'
		WHEN (EFI > 0.36) THEN 'Severe'
		ELSE 'Fit'
		END 
		AS frailty_def
	FROM
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_sub) WITH NO DATA;
	

		INSERT INTO SAILW0972V.V2_VB_STROKE_COHORT_EFI (SELECT
	* ,
	CASE
		WHEN (EFI > 0.12 AND EFI <= 0.24) THEN 1
		WHEN (EFI > 0.24 AND EFI <= 0.36) THEN 2 
		WHEN (EFI > 0.36) THEN 3
		ELSE 0 
		END 
		AS frailty
		,
	CASE
		WHEN (EFI > 0.12 AND EFI <= 0.24) THEN 'Mild'
		WHEN (EFI > 0.24 AND EFI <= 0.36) THEN 'Moderate'
		WHEN (EFI > 0.36) THEN 'Severe'
		ELSE 'Fit'
		END 
		AS frailty_def
	FROM
		SAILW0972V.V2_VB_STROKE_COHORT_EFI_sub);
		
		DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_sub;
DROP TABLE SAILW0972V.V2_COHORT_WITH_DUMMY_DATE;
DROP TABLE SAILW0972V.V2_VB_STROKE_COHORT_EFI_INDICATOR;

/* update stroke cohort table with eFI at time of first event */
					
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN EFI DECIMAL(6,4)
	ADD COLUMN FRAILTY INTEGER
	ADD COLUMN FRAILTY_DEF VARCHAR(8);

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SAILW0972V.V2_VB_STROKE_COHORT_EFI AS efi
		ON fe.ALF_PE = efi.ALF_PE 
			WHEN MATCHED THEN
				UPDATE
				SET fe.EFI = efi.EFI
			;
		
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SAILW0972V.V2_VB_STROKE_COHORT_EFI AS efi
		ON fe.ALF_PE = efi.ALF_PE 
			WHEN MATCHED THEN
				UPDATE
				SET fe.FRAILTY = efi.FRAILTY
			;
		
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SAILW0972V.V2_VB_STROKE_COHORT_EFI AS efi
		ON fe.ALF_PE = efi.ALF_PE 
			WHEN MATCHED THEN
				UPDATE
				SET fe.FRAILTY_DEF = efi.FRAILTY_DEF
			;
		
-------------------------------------------------------------------------------------------------------------
	
/* Link all Stroke cohort spells to gp event to identify any events with hypertension read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_HYPERTENSION_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_HYPERTENSION_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('14A2.',
								'G2...',
								'G20..',
								'G200.',
								'G201.',
								'G202.',
								'G203.',
								'G20z.',
								'G21..',
								'G210.',
								'G2100',
								'G2101',
								'G210z',
								'G211.',
								'G2110',
								'G2111',
								'G211z',
								'G21z.',
								'G21z0',
								'G21z1',
								'G21zz',
								'G22..',
								'G220.',
								'G221.',
								'G222.',
								'G22z.',
								'G23..',
								'G230.',
								'G231.',
								'G232.',
								'G233.',
								'G234.',
								'G23z.',
								'G24..',
								'G240.',
								'G2400',
								'G240z',
								'G241.',
								'G2410',
								'G241z',
								'G244.',
								'G24z.',
								'G24z0',
								'G24z1',
								'G24zz',
								'G25..',
								'G250.',
								'G251.',
								'G26..',
								'G27..',
								'G28..',
								'G2y..',
								'G2z..',
								'6627',
								'6628',
								'662F.',
								'662G.',
								'662O.',
								'662b.',
								'662c.',
								'662d.',
								'662r.',
								'7Q01.',
								'8B26.',
								'8BL0.',
								'8I3N.',
								'F4042',
								'F4213',
								'G672.',
								'Gyu2.',
								'L122.',
								'L1220',
								'L1221',
								'L1223',
								'L122z',
								'L127.',
								'L127z',
								'L128.',
								'L1280',
								'L1282',
								'Gyu21')
;

Commit;

/* Identify first event date for any episode with a recorded hypertension read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_HYPERTENSION_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_HYPERTENSION_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_HYPERTENSION_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_HYPERTENSION_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior hypertension date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN HYPERTENSION VARCHAR(5)
	ADD COLUMN FIRST_HYPERTENSION_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_HYPERTENSION_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_HYPERTENSION_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET HYPERTENSION = TRUE
		WHERE FIRST_HYPERTENSION_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET HYPERTENSION = FALSE
		WHERE FIRST_HYPERTENSION_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with hypertension read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_HYPERTENSION_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_HYPERTENSION_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('14A2.',
								'G2...',
								'G20..',
								'G200.',
								'G201.',
								'G202.',
								'G203.',
								'G20z.',
								'G21..',
								'G210.',
								'G2100',
								'G2101',
								'G210z',
								'G211.',
								'G2110',
								'G2111',
								'G211z',
								'G21z.',
								'G21z0',
								'G21z1',
								'G21zz',
								'G22..',
								'G220.',
								'G221.',
								'G222.',
								'G22z.',
								'G23..',
								'G230.',
								'G231.',
								'G232.',
								'G233.',
								'G234.',
								'G23z.',
								'G24..',
								'G240.',
								'G2400',
								'G240z',
								'G241.',
								'G2410',
								'G241z',
								'G244.',
								'G24z.',
								'G24z0',
								'G24z1',
								'G24zz',
								'G25..',
								'G250.',
								'G251.',
								'G26..',
								'G27..',
								'G28..',
								'G2y..',
								'G2z..',
								'6627',
								'6628',
								'662F.',
								'662G.',
								'662O.',
								'662b.',
								'662c.',
								'662d.',
								'662r.',
								'7Q01.',
								'8B26.',
								'8BL0.',
								'8I3N.',
								'F4042',
								'F4213',
								'G672.',
								'Gyu2.',
								'L122.',
								'L1220',
								'L1221',
								'L1223',
								'L122z',
								'L127.',
								'L127z',
								'L128.',
								'L1280',
								'L1282',
								'Gyu21')
;

Commit;

/* Identify first event date for any episode with a recorded hypertension read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_HYPERTENSION_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_HYPERTENSION_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_HYPERTENSION_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_HYPERTENSION_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior hypertension date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN HYPERTENSION VARCHAR(5)
	ADD COLUMN FIRST_HYPERTENSION_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_HYPERTENSION_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_HYPERTENSION_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET HYPERTENSION = TRUE
		WHERE FIRST_HYPERTENSION_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET HYPERTENSION = FALSE
		WHERE FIRST_HYPERTENSION_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with ASPIRIN read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_ASPIRIN_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_ASPIRIN_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('bu2..',
								'bu21.',
								'bu22.',
								'bu23.',
								'bu24.',
								'bu25.',
								'bu26.',
								'bu27.',
								'bu28.',
								'bu29.',
								'bu2a.',
								'bu2A.',
								'bu2b.',
								'bu2B.',
								'bu2C.',
								'bu2c.',
								'bu2D.',
								'bu2d.',
								'bu2E.',
								'bu2F.',
								'bu2G.',
								'bu2H.',
								'bu2I.',
								'bu2J.',
								'bu2K.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded ASPIRIN read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_ASPIRIN_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ASPIRIN_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_ASPIRIN_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ASPIRIN_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior ASPIRIN date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN ASPIRIN VARCHAR(5)
	ADD COLUMN FIRST_ASPIRIN_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_ASPIRIN_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_ASPIRIN_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET ASPIRIN = TRUE
		WHERE FIRST_ASPIRIN_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET ASPIRIN = FALSE
		WHERE FIRST_ASPIRIN_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with ASPIRIN read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_ASPIRIN_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_ASPIRIN_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('bu2..',
								'bu21.',
								'bu22.',
								'bu23.',
								'bu24.',
								'bu25.',
								'bu26.',
								'bu27.',
								'bu28.',
								'bu29.',
								'bu2a.',
								'bu2A.',
								'bu2b.',
								'bu2B.',
								'bu2C.',
								'bu2c.',
								'bu2D.',
								'bu2d.',
								'bu2E.',
								'bu2F.',
								'bu2G.',
								'bu2H.',
								'bu2I.',
								'bu2J.',
								'bu2K.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded ASPIRIN read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_ASPIRIN_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ASPIRIN_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_ASPIRIN_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ASPIRIN_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior ASPIRIN date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN ASPIRIN VARCHAR(5)
	ADD COLUMN FIRST_ASPIRIN_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_ASPIRIN_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_ASPIRIN_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET ASPIRIN = TRUE
		WHERE FIRST_ASPIRIN_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET ASPIRIN = FALSE
		WHERE FIRST_ASPIRIN_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with ANTIHYPERTENSIVES_EXCBETA read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_ANTIHYPERTENSIVES_EXCBETA_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_ANTIHYPERTENSIVES_EXCBETA_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('bi1..',
								'bi11.',
								'bi12.',
								'bi13.',
								'bi14.',
								'bi15.',
								'bi16.',
								'bi17.',
								'bi18.',
								'bi19.',
								'bi1A.',
								'bi1B.',
								'bi1C.',
								'bi1H.',
								'bi1I.',
								'bi1J.',
								'bi1K.',
								'bi1a.',
								'bi1b.',
								'bi1c.',
								'bi1d.',
								'bi1g.',
								'bi1h.',
								'bi1i.',
								'bi1j.',
								'bi1k.',
								'bi1l.',
								'bi1m.',
								'bi1n.',
								'bi1o.',
								'bi1p.',
								'bi1q.',
								'bi1r.',
								'bi1v.',
								'bi1w.',
								'bi1x.',
								'bi1y.',
								'bi1z.',
								'bi2..',
								'bi21.',
								'bi22.',
								'bi23.',
								'bi24.',
								'bi25.',
								'bi26.',
								'bi27.',
								'bi29.',
								'bi2A.',
								'bi2B.',
								'bi2C.',
								'bi2D.',
								'bi2E.',
								'bi2F.',
								'bi2G.',
								'bi2H.',
								'bi2J.',
								'bi2K.',
								'bi2L.',
								'bi2M.',
								'bi2a.',
								'bi2t.',
								'bi2u.',
								'bi2v.',
								'bi2w.',
								'bi2x.',
								'bi2y.',
								'bi2z.',
								'bi3..',
								'bi31.',
								'bi32.',
								'bi33.',
								'bi34.',
								'bi35.',
								'bi36.',
								'bi37.',
								'bi38.',
								'bi39.',
								'bi3a.',
								'bi3b.',
								'bi3c.',
								'bi3d.',
								'bi3e.',
								'bi3f.',
								'bi3g.',
								'bi3h.',
								'bi3i.',
								'bi3j.',
								'bi3k.',
								'bi3l.',
								'bi3m.',
								'bi3q.',
								'bi3r.',
								'bi3y.',
								'bi4..',
								'bi41.',
								'bi42.',
								'bi43.',
								'bi44.',
								'bi45.',
								'bi46.',
								'bi47.',
								'bi49.',
								'bi4A.',
								'bi4B.',
								'bi4C.',
								'bi4D.',
								'bi4E.',
								'bi5..',
								'bi51.',
								'bi52.',
								'bi53.',
								'bi54.',
								'bi57.',
								'bi58.',
								'bi6..',
								'bi61.',
								'bi62.',
								'bi63.',
								'bi64.',
								'bi65.',
								'bi66.',
								'bi67.',
								'bi68.',
								'bi69.',
								'bi6A.',
								'bi6B.',
								'bi6C.',
								'bi6D.',
								'bi6E.',
								'bi6F.',
								'bi6G.',
								'bi6o.',
								'bi6p.',
								'bi6q.',
								'bi6r.',
								'bi6s.',
								'bi6t.',
								'bi6u.',
								'bi6v.',
								'bi6w.',
								'bi6x.',
								'bi6y.',
								'bi6z.',
								'bi7..',
								'bi71.',
								'bi72.',
								'bi73.',
								'bi74.',
								'bi8..',
								'bi81.',
								'bi82.',
								'bi83.',
								'bi84.',
								'bi85.',
								'bi86.',
								'bi87.',
								'bi88.',
								'bi89.',
								'bi8a.',
								'bi9..',
								'bi91.',
								'bi92.',
								'bi93.',
								'bi94.',
								'bi95.',
								'bi96.',
								'bi97.',
								'bi98.',
								'bi99.',
								'bi9A.',
								'bi9z.',
								'biA..',
								'biA1.',
								'biA2.',
								'biA3.',
								'biA4.',
								'biB..',
								'biB1.',
								'biB2.',
								'biB3.',
								'biBx.',
								'biBy.',
								'biBz.',
								'biC..',
								'biC1.',
								'biC2.',
								'biC3.',
								'biC4.',
								'biC5.',
								'biC6.',
								'bk3..',
								'bk31.',
								'bk32.',
								'bk33.',
								'bk34.',
								'bk37.',
								'bk38.',
								'bk3B.',
								'bk3C.',
								'bk3D.',
								'bk3E.',
								'bk3F.',
								'bk3G.',
								'bk3H.',
								'bk4..',
								'bk41.',
								'bk42.',
								'bk43.',
								'bk44.',
								'bk45.',
								'bk46.',
								'bk4A.',
								'bk4B.',
								'bk4C.',
								'bk4s.',
								'bk4t.',
								'bk4u.',
								'bk4v.',
								'bk4w.',
								'bk5..',
								'bk51.',
								'bk52.',
								'bk53.',
								'bk54.',
								'bk55.',
								'bk56.',
								'bk7..',
								'bk71.',
								'bk72.',
								'bk73.',
								'bk74.',
								'bk75.',
								'bk76.',
								'bk77.',
								'bk78.',
								'bk79.',
								'bk7z.',
								'bk8..',
								'bk81.',
								'bk82.',
								'bk83.',
								'bk84.',
								'bk85.',
								'bk8z.',
								'bk9..',
								'bk91.',
								'bk92.',
								'bk93.',
								'bk9x.',
								'bk9y.',
								'bk9z.',
								'bkB..',
								'bkB1.',
								'bkB2.',
								'bkB3.',
								'bkB4.',
								'bkB5.',
								'bkB6.',
								'bkJ..',
								'bkJ1.',
								'bkJ2.',
								'bkJ3.',
								'bkJ4.',
								'bkJ5.',
								'bkJ6.',
								'bb3..',
								'bb31.',
								'bb32.',
								'bb33.',
								'bb34.',
								'bb35.',
								'bb36.',
								'bb37.',
								'bb38.',
								'bb39.',
								'bb3A.',
								'bb3B.',
								'bb3C.',
								'bb3D.',
								'bb3F.',
								'bb3G.',
								'bb3H.',
								'bb3J.',
								'bb3K.',
								'bb3L.',
								'bb3M.',
								'bb3N.',
								'bb3O.',
								'bb3P.',
								'bb3Q.',
								'bb3a.',
								'bb3b.',
								'bb3d.',
								'bb3e.',
								'bb3f.',
								'bb3g.',
								'bb3h.',
								'bb3i.',
								'bb3j.',
								'bb3k.',
								'bb3l.',
								'bb3m.',
								'bb3n.',
								'bb3p.',
								'bb3q.',
								'bb3r.',
								'bb3s.',
								'bb3v.',
								'bb3w.',
								'bb3x.',
								'bb3y.',
								'bb3z.',
								'bl5..',
								'bl51.',
								'bl52.',
								'bl53.',
								'bl54.',
								'bl55.',
								'bl56.',
								'bl57.',
								'bl58.',
								'bl59.',
								'bl5A.',
								'bl5B.',
								'bl5C.',
								'bl5D.',
								'bl5E.',
								'bl5F.',
								'bl5G.',
								'bl5H.',
								'bl5I.',
								'bl5J.',
								'bl5K.',
								'bl5L.',
								'bl5M.',
								'bl5N.',
								'bl5O.',
								'bl5P.',
								'bl5Q.',
								'bl5R.',
								'bl5S.',
								'bl5T.',
								'bl5U.',
								'bl5V.',
								'bl5W.',
								'bl5X.',
								'bl5Y.',
								'bl5Z.',
								'bl5a.',
								'bl5b.',
								'bl5c.',
								'bl5d.',
								'bl5e.',
								'bl5f.',
								'bl5g.',
								'bl5h.',
								'bl5j.',
								'bl5k.',
								'bl5l.',
								'bl5m.',
								'bl5n.',
								'bl5o.',
								'bl5p.',
								'bl5q.',
								'bl5r.',
								'bl5s.',
								'bl5t.',
								'bl5u.',
								'bl5v.',
								'bl5w.',
								'bl5x.',
								'bl5y.',
								'bl5z.',
								'bl7..',
								'bl71.',
								'bl72.',
								'bl73.',
								'bl74.',
								'bl7w.',
								'bl7x.',
								'bl7y.',
								'bl7z.',
								'bl8..',
								'bl81.',
								'bl82.',
								'bl83.',
								'bl84.',
								'bl85.',
								'bl86.',
								'bl89.',
								'bl8A.',
								'bl8B.',
								'bl8C.',
								'bl8D.',
								'bl8E.',
								'bl8F.',
								'bl8G.',
								'bl8H.',
								'bl8J.',
								'bl8K.',
								'bl8L.',
								'bl8M.',
								'bl8O.',
								'bl8P.',
								'bl8Q.',
								'bl8R.',
								'bl8S.',
								'bl8T.',
								'bl8U.',
								'bl8V.',
								'bl8W.',
								'bl8X.',
								'bl8Y.',
								'bl8Z.',
								'bl8a.',
								'bl8b.',
								'bl8c.',
								'bl8d.',
								'bl8e.',
								'bl8f.',
								'bl8g.',
								'bl8h.',
								'bl8i.',
								'bl8j.',
								'bl8k.',
								'bl8l.',
								'bl8m.',
								'bl8n.',
								'bl8o.',
								'bl8p.',
								'bl8q.',
								'bl8r.',
								'bl8s.',
								'bl8t.',
								'bl8u.',
								'bl8v.',
								'bl8w.',
								'bl8x.',
								'bl8y.',
								'bl8z.',
								'bla..',
								'bla1.',
								'bla2.',
								'blb..',
								'blb1.',
								'blb2.',
								'blb3.',
								'blb4.',
								'blb5.',
								'blb6.',
								'blb7.',
								'blb8.',
								'blc..',
								'blc1.',
								'blc2.',
								'blc3.',
								'blc4.',
								'blc5.',
								'blc6.',
								'blc7.',
								'blc8.',
								'blc9.',
								'blca.',
								'blcb.',
								'blcc.',
								'blcd.',
								'blce.',
								'blcf.',
								'blcg.',
								'blch.',
								'blci.',
								'blcj.',
								'blck.',
								'blcl.',
								'blcm.',
								'blcn.',
								'blco.',
								'blcp.',
								'blcq.',
								'blcr.',
								'blcs.',
								'blct.',
								'ble..',
								'ble1.',
								'ble2.',
								'ble3.',
								'ble4.',
								'ble5.',
								'blg..',
								'blg1.',
								'blg2.',
								'blg3.',
								'blg4.',
								'blg5.',
								'blg6.',
								'blh..',
								'blh1.',
								'blh2.',
								'blh3.',
								'blh4.',
								'blj..',
								'blj1.',
								'blj2.',
								'blj3.',
								'blj4.',
								'blj5.',
								'blj6.',
								'blj7.',
								'blj8.',
								'blj9.',
								'bljA.',
								'bljB.',
								'bljC.',
								'bljD.',
								'bljE.',
								'bljF.',
								'bljG.',
								'bljH.',
								'bljJ.',
								'bljK.',
								'bljL.',
								'bljM.',
								'bljN.',
								'bljO.',
								'bljP.',
								'bljQ.',
								'bljR.',
								'bljS.',
								'bljT.',
								'bljU.',
								'bljV.',
								'bljW.',
								'bljX.',
								'bljY.',
								'bljZ.',
								'blja.',
								'bljb.',
								'bljc.',
								'bljd.',
								'blje.',
								'bljf.',
								'bll..',
								'bll1.',
								'bll2.',
								'bll3.',
								'bll4.',
								'bll5.',
								'bll6.',
								'bll7.',
								'bll8.',
								'bll9.',
								'blla.',
								'bllb.',
								'bllc.',
								'blld.',
								'blle.',
								'bllf.',
								'bllg.',
								'bllh.',
								'blli.',
								'bllj.',
								'bllk.',
								'blll.',
								'dt1..',
								'dt13.',
								'dt14.',
								'b2...',
								'b21..',
								'b211.',
								'b212.',
								'b213.',
								'b214.',
								'b215.',
								'b216.',
								'b217.',
								'b218.',
								'b219.',
								'b21A.',
								'b21B.',
								'b21a.',
								'b21b.',
								'b22..',
								'b221.',
								'b222.',
								'b22y.',
								'b22z.',
								'b23..',
								'b231.',
								'b232.',
								'b23y.',
								'b23z.',
								'b24..',
								'b25..',
								'b251.',
								'b25z.',
								'b26..',
								'b261.',
								'b262.',
								'b263.',
								'b264.',
								'b26y.',
								'b26z.',
								'b27..',
								'b271.',
								'b27z.',
								'b28..',
								'b281.',
								'b282.',
								'b283.',
								'b284.',
								'b285.',
								'b286.',
								'b287.',
								'b288.',
								'b289.',
								'b28z.',
								'b29..',
								'b291.',
								'b29z.',
								'b2a..',
								'b2a1.',
								'b2az.',
								'b2b..',
								'b2b1.',
								'b2b2.',
								'b2b3.',
								'b2bz.',
								'b2c..',
								'b2c1.',
								'b2cz.',
								'b2d..',
								'b2d1.',
								'b2dz.',
								'bA1..',
								'bA11.',
								'bA12.',
								'bA1y.',
								'bA1z.',
								'bi1D.',
								'bi1E.',
								'bi1F.',
								'bi1G.',
								'bi1e.',
								'bi1f.',
								'bi1s.',
								'bi28.',
								'bi2b.',
								'bi3n.',
								'bi3p.',
								'bi3s.',
								'bi3t.',
								'bi3u.',
								'bi3v.',
								'bi3w.',
								'bi3x.',
								'bi48.',
								'bi4F.',
								'bi55.',
								'bi56.',
								'biC7.',
								'biC8.',
								'bk35.',
								'bk36.',
								'bk39.',
								'bk3A.',
								'bk3y.',
								'bk3z.',
								'bk47.',
								'bk48.',
								'bk49.',
								'bk4x.',
								'bk4y.',
								'bk4z.',
								'bk57.',
								'bk58.',
								'bk59.',
								'bk5x.',
								'bk5y.',
								'bk5z.',
								'bk86.',
								'bk87.',
								'bk88.',
								'bk8w.',
								'bk8x.',
								'bk8y.',
								'bkC..',
								'bkC1.',
								'bkC2.',
								'bkC3.',
								'bkCx.',
								'bkCy.',
								'bkCz.',
								'bkH..',
								'bkH1.',
								'bkH2.',
								'bkH3.',
								'bkHx.',
								'bkHy.',
								'bkHz.',
								'bkI..',
								'bkI1.',
								'bkI2.',
								'bkI3.',
								'bkI4.',
								'bkI5.',
								'bkL..',
								'bkL1.',
								'bkL2.',
								'bkL3.',
								'bkL4.',
								'bkL5.',
								'bkL6.',
								'bl5i.',
								'bh4..',
								'bh5y.',
								'bh56.',
								'bh41.',
								'bh4x.',
								'bh5z.',
								'bh63.',
								'bh55.',
								'bh54.',
								'bh6B.',
								'bh1y.',
								'bh65.',
								'bh4z.',
								'bh14.',
								'bh4D.',
								'bh6A.',
								'bh68.',
								'bh4v.',
								'bh4B.',
								'bh6F.',
								'bh61.',
								'bh69.',
								'bh46.',
								'bh21.',
								'bh6E.',
								'bh4y.',
								'bh45.',
								'bh47.',
								'bh6H.',
								'bh42.',
								'bh6y.',
								'bh1z.',
								'bh5..',
								'bh6C.',
								'bh6D.',
								'bh57.',
								'bh4C.',
								'bh4A.',
								'bh6G.',
								'bh66.',
								'bh1..',
								'bh4w.',
								'bh53.',
								'bh44.',
								'bh52.',
								'bh43.',
								'bh5x.',
								'bh6z.',
								'bh13.',
								'bh51.',
								'bh64.',
								'bh67.',
								'bh49.',
								'bh48.',
								'bh11.',
								'bh2y.',
								'bh6..',
								'bh12.',
								'bh62.',
								'bf39.',
								'bf26.',
								'bf1w.',
								'bf1x.',
								'bf35.',
								'bf3b.',
								'bf42.',
								'bf44.',
								'bf3a.',
								'bf4..',
								'bf2..',
								'bf2d.',
								'bf22.',
								'bf2v.',
								'bf13.',
								'bf2c.',
								'bf27.',
								'bf2j.',
								'bf23.',
								'bf24.',
								'bf12.',
								'bf3d.',
								'bf25.',
								'bf3c.',
								'bf31.',
								'bf43.',
								'bf36.',
								'bf2e.',
								'bf33.',
								'bf2b.',
								'bf2g.',
								'bf21.',
								'bf11.',
								'bf2h.',
								'bf2z.',
								'bf32.',
								'bf34.',
								'bf41.',
								'bf29.',
								'bf2a.',
								'bf2f.',
								'bf45.',
								'bf37.',
								'bf38.',
								'bf46.',
								'be3x.',
								'be2y.',
								'be3..',
								'be3z.',
								'be3y.',
								'be1..',
								'be2x.',
								'be22.',
								'be32.',
								'be21.',
								'be31.',
								'be2..',
								'be33.',
								'bd38.',
								'bd39.',
								'bdeM.',
								'bdeN.',
								'bdeO.',
								'bdeP.',
								'bdem.',
								'bden.',
								'bdeo.',
								'bdep.',
								'bdes.',
								'bdet.',
								'bdeu.',
								'bdev.',
								'bdew.',
								'bdex.',
								'bdey.',
								'bdez.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded ANTIHYPERTENSIVES_EXCBETA read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_ANTIHYPERTENSIVES_EXCBETA_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ANTIHYPERTENSIVES_EXCBETA_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_ANTIHYPERTENSIVES_EXCBETA_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ANTIHYPERTENSIVES_EXCBETA_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior ANTIHYPERTENSIVES_EXCBETA date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN ANTIHYPERTENSIVES_EXCBETA VARCHAR(5)
	ADD COLUMN FIRST_ANTIHYPERTENSIVES_EXCBETA_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_ANTIHYPERTENSIVES_EXCBETA_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_ANTIHYPERTENSIVES_EXCBETA_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET ANTIHYPERTENSIVES_EXCBETA = TRUE
		WHERE FIRST_ANTIHYPERTENSIVES_EXCBETA_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET ANTIHYPERTENSIVES_EXCBETA = FALSE
		WHERE FIRST_ANTIHYPERTENSIVES_EXCBETA_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with ANTIHYPERTENSIVES_EXCBETA read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_ANTIHYPERTENSIVES_EXCBETA_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_ANTIHYPERTENSIVES_EXCBETA_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('bi1..',
								'bi11.',
								'bi12.',
								'bi13.',
								'bi14.',
								'bi15.',
								'bi16.',
								'bi17.',
								'bi18.',
								'bi19.',
								'bi1A.',
								'bi1B.',
								'bi1C.',
								'bi1H.',
								'bi1I.',
								'bi1J.',
								'bi1K.',
								'bi1a.',
								'bi1b.',
								'bi1c.',
								'bi1d.',
								'bi1g.',
								'bi1h.',
								'bi1i.',
								'bi1j.',
								'bi1k.',
								'bi1l.',
								'bi1m.',
								'bi1n.',
								'bi1o.',
								'bi1p.',
								'bi1q.',
								'bi1r.',
								'bi1v.',
								'bi1w.',
								'bi1x.',
								'bi1y.',
								'bi1z.',
								'bi2..',
								'bi21.',
								'bi22.',
								'bi23.',
								'bi24.',
								'bi25.',
								'bi26.',
								'bi27.',
								'bi29.',
								'bi2A.',
								'bi2B.',
								'bi2C.',
								'bi2D.',
								'bi2E.',
								'bi2F.',
								'bi2G.',
								'bi2H.',
								'bi2J.',
								'bi2K.',
								'bi2L.',
								'bi2M.',
								'bi2a.',
								'bi2t.',
								'bi2u.',
								'bi2v.',
								'bi2w.',
								'bi2x.',
								'bi2y.',
								'bi2z.',
								'bi3..',
								'bi31.',
								'bi32.',
								'bi33.',
								'bi34.',
								'bi35.',
								'bi36.',
								'bi37.',
								'bi38.',
								'bi39.',
								'bi3a.',
								'bi3b.',
								'bi3c.',
								'bi3d.',
								'bi3e.',
								'bi3f.',
								'bi3g.',
								'bi3h.',
								'bi3i.',
								'bi3j.',
								'bi3k.',
								'bi3l.',
								'bi3m.',
								'bi3q.',
								'bi3r.',
								'bi3y.',
								'bi4..',
								'bi41.',
								'bi42.',
								'bi43.',
								'bi44.',
								'bi45.',
								'bi46.',
								'bi47.',
								'bi49.',
								'bi4A.',
								'bi4B.',
								'bi4C.',
								'bi4D.',
								'bi4E.',
								'bi5..',
								'bi51.',
								'bi52.',
								'bi53.',
								'bi54.',
								'bi57.',
								'bi58.',
								'bi6..',
								'bi61.',
								'bi62.',
								'bi63.',
								'bi64.',
								'bi65.',
								'bi66.',
								'bi67.',
								'bi68.',
								'bi69.',
								'bi6A.',
								'bi6B.',
								'bi6C.',
								'bi6D.',
								'bi6E.',
								'bi6F.',
								'bi6G.',
								'bi6o.',
								'bi6p.',
								'bi6q.',
								'bi6r.',
								'bi6s.',
								'bi6t.',
								'bi6u.',
								'bi6v.',
								'bi6w.',
								'bi6x.',
								'bi6y.',
								'bi6z.',
								'bi7..',
								'bi71.',
								'bi72.',
								'bi73.',
								'bi74.',
								'bi8..',
								'bi81.',
								'bi82.',
								'bi83.',
								'bi84.',
								'bi85.',
								'bi86.',
								'bi87.',
								'bi88.',
								'bi89.',
								'bi8a.',
								'bi9..',
								'bi91.',
								'bi92.',
								'bi93.',
								'bi94.',
								'bi95.',
								'bi96.',
								'bi97.',
								'bi98.',
								'bi99.',
								'bi9A.',
								'bi9z.',
								'biA..',
								'biA1.',
								'biA2.',
								'biA3.',
								'biA4.',
								'biB..',
								'biB1.',
								'biB2.',
								'biB3.',
								'biBx.',
								'biBy.',
								'biBz.',
								'biC..',
								'biC1.',
								'biC2.',
								'biC3.',
								'biC4.',
								'biC5.',
								'biC6.',
								'bk3..',
								'bk31.',
								'bk32.',
								'bk33.',
								'bk34.',
								'bk37.',
								'bk38.',
								'bk3B.',
								'bk3C.',
								'bk3D.',
								'bk3E.',
								'bk3F.',
								'bk3G.',
								'bk3H.',
								'bk4..',
								'bk41.',
								'bk42.',
								'bk43.',
								'bk44.',
								'bk45.',
								'bk46.',
								'bk4A.',
								'bk4B.',
								'bk4C.',
								'bk4s.',
								'bk4t.',
								'bk4u.',
								'bk4v.',
								'bk4w.',
								'bk5..',
								'bk51.',
								'bk52.',
								'bk53.',
								'bk54.',
								'bk55.',
								'bk56.',
								'bk7..',
								'bk71.',
								'bk72.',
								'bk73.',
								'bk74.',
								'bk75.',
								'bk76.',
								'bk77.',
								'bk78.',
								'bk79.',
								'bk7z.',
								'bk8..',
								'bk81.',
								'bk82.',
								'bk83.',
								'bk84.',
								'bk85.',
								'bk8z.',
								'bk9..',
								'bk91.',
								'bk92.',
								'bk93.',
								'bk9x.',
								'bk9y.',
								'bk9z.',
								'bkB..',
								'bkB1.',
								'bkB2.',
								'bkB3.',
								'bkB4.',
								'bkB5.',
								'bkB6.',
								'bkJ..',
								'bkJ1.',
								'bkJ2.',
								'bkJ3.',
								'bkJ4.',
								'bkJ5.',
								'bkJ6.',
								'bb3..',
								'bb31.',
								'bb32.',
								'bb33.',
								'bb34.',
								'bb35.',
								'bb36.',
								'bb37.',
								'bb38.',
								'bb39.',
								'bb3A.',
								'bb3B.',
								'bb3C.',
								'bb3D.',
								'bb3F.',
								'bb3G.',
								'bb3H.',
								'bb3J.',
								'bb3K.',
								'bb3L.',
								'bb3M.',
								'bb3N.',
								'bb3O.',
								'bb3P.',
								'bb3Q.',
								'bb3a.',
								'bb3b.',
								'bb3d.',
								'bb3e.',
								'bb3f.',
								'bb3g.',
								'bb3h.',
								'bb3i.',
								'bb3j.',
								'bb3k.',
								'bb3l.',
								'bb3m.',
								'bb3n.',
								'bb3p.',
								'bb3q.',
								'bb3r.',
								'bb3s.',
								'bb3v.',
								'bb3w.',
								'bb3x.',
								'bb3y.',
								'bb3z.',
								'bl5..',
								'bl51.',
								'bl52.',
								'bl53.',
								'bl54.',
								'bl55.',
								'bl56.',
								'bl57.',
								'bl58.',
								'bl59.',
								'bl5A.',
								'bl5B.',
								'bl5C.',
								'bl5D.',
								'bl5E.',
								'bl5F.',
								'bl5G.',
								'bl5H.',
								'bl5I.',
								'bl5J.',
								'bl5K.',
								'bl5L.',
								'bl5M.',
								'bl5N.',
								'bl5O.',
								'bl5P.',
								'bl5Q.',
								'bl5R.',
								'bl5S.',
								'bl5T.',
								'bl5U.',
								'bl5V.',
								'bl5W.',
								'bl5X.',
								'bl5Y.',
								'bl5Z.',
								'bl5a.',
								'bl5b.',
								'bl5c.',
								'bl5d.',
								'bl5e.',
								'bl5f.',
								'bl5g.',
								'bl5h.',
								'bl5j.',
								'bl5k.',
								'bl5l.',
								'bl5m.',
								'bl5n.',
								'bl5o.',
								'bl5p.',
								'bl5q.',
								'bl5r.',
								'bl5s.',
								'bl5t.',
								'bl5u.',
								'bl5v.',
								'bl5w.',
								'bl5x.',
								'bl5y.',
								'bl5z.',
								'bl7..',
								'bl71.',
								'bl72.',
								'bl73.',
								'bl74.',
								'bl7w.',
								'bl7x.',
								'bl7y.',
								'bl7z.',
								'bl8..',
								'bl81.',
								'bl82.',
								'bl83.',
								'bl84.',
								'bl85.',
								'bl86.',
								'bl89.',
								'bl8A.',
								'bl8B.',
								'bl8C.',
								'bl8D.',
								'bl8E.',
								'bl8F.',
								'bl8G.',
								'bl8H.',
								'bl8J.',
								'bl8K.',
								'bl8L.',
								'bl8M.',
								'bl8O.',
								'bl8P.',
								'bl8Q.',
								'bl8R.',
								'bl8S.',
								'bl8T.',
								'bl8U.',
								'bl8V.',
								'bl8W.',
								'bl8X.',
								'bl8Y.',
								'bl8Z.',
								'bl8a.',
								'bl8b.',
								'bl8c.',
								'bl8d.',
								'bl8e.',
								'bl8f.',
								'bl8g.',
								'bl8h.',
								'bl8i.',
								'bl8j.',
								'bl8k.',
								'bl8l.',
								'bl8m.',
								'bl8n.',
								'bl8o.',
								'bl8p.',
								'bl8q.',
								'bl8r.',
								'bl8s.',
								'bl8t.',
								'bl8u.',
								'bl8v.',
								'bl8w.',
								'bl8x.',
								'bl8y.',
								'bl8z.',
								'bla..',
								'bla1.',
								'bla2.',
								'blb..',
								'blb1.',
								'blb2.',
								'blb3.',
								'blb4.',
								'blb5.',
								'blb6.',
								'blb7.',
								'blb8.',
								'blc..',
								'blc1.',
								'blc2.',
								'blc3.',
								'blc4.',
								'blc5.',
								'blc6.',
								'blc7.',
								'blc8.',
								'blc9.',
								'blca.',
								'blcb.',
								'blcc.',
								'blcd.',
								'blce.',
								'blcf.',
								'blcg.',
								'blch.',
								'blci.',
								'blcj.',
								'blck.',
								'blcl.',
								'blcm.',
								'blcn.',
								'blco.',
								'blcp.',
								'blcq.',
								'blcr.',
								'blcs.',
								'blct.',
								'ble..',
								'ble1.',
								'ble2.',
								'ble3.',
								'ble4.',
								'ble5.',
								'blg..',
								'blg1.',
								'blg2.',
								'blg3.',
								'blg4.',
								'blg5.',
								'blg6.',
								'blh..',
								'blh1.',
								'blh2.',
								'blh3.',
								'blh4.',
								'blj..',
								'blj1.',
								'blj2.',
								'blj3.',
								'blj4.',
								'blj5.',
								'blj6.',
								'blj7.',
								'blj8.',
								'blj9.',
								'bljA.',
								'bljB.',
								'bljC.',
								'bljD.',
								'bljE.',
								'bljF.',
								'bljG.',
								'bljH.',
								'bljJ.',
								'bljK.',
								'bljL.',
								'bljM.',
								'bljN.',
								'bljO.',
								'bljP.',
								'bljQ.',
								'bljR.',
								'bljS.',
								'bljT.',
								'bljU.',
								'bljV.',
								'bljW.',
								'bljX.',
								'bljY.',
								'bljZ.',
								'blja.',
								'bljb.',
								'bljc.',
								'bljd.',
								'blje.',
								'bljf.',
								'bll..',
								'bll1.',
								'bll2.',
								'bll3.',
								'bll4.',
								'bll5.',
								'bll6.',
								'bll7.',
								'bll8.',
								'bll9.',
								'blla.',
								'bllb.',
								'bllc.',
								'blld.',
								'blle.',
								'bllf.',
								'bllg.',
								'bllh.',
								'blli.',
								'bllj.',
								'bllk.',
								'blll.',
								'dt1..',
								'dt13.',
								'dt14.',
								'b2...',
								'b21..',
								'b211.',
								'b212.',
								'b213.',
								'b214.',
								'b215.',
								'b216.',
								'b217.',
								'b218.',
								'b219.',
								'b21A.',
								'b21B.',
								'b21a.',
								'b21b.',
								'b22..',
								'b221.',
								'b222.',
								'b22y.',
								'b22z.',
								'b23..',
								'b231.',
								'b232.',
								'b23y.',
								'b23z.',
								'b24..',
								'b25..',
								'b251.',
								'b25z.',
								'b26..',
								'b261.',
								'b262.',
								'b263.',
								'b264.',
								'b26y.',
								'b26z.',
								'b27..',
								'b271.',
								'b27z.',
								'b28..',
								'b281.',
								'b282.',
								'b283.',
								'b284.',
								'b285.',
								'b286.',
								'b287.',
								'b288.',
								'b289.',
								'b28z.',
								'b29..',
								'b291.',
								'b29z.',
								'b2a..',
								'b2a1.',
								'b2az.',
								'b2b..',
								'b2b1.',
								'b2b2.',
								'b2b3.',
								'b2bz.',
								'b2c..',
								'b2c1.',
								'b2cz.',
								'b2d..',
								'b2d1.',
								'b2dz.',
								'bA1..',
								'bA11.',
								'bA12.',
								'bA1y.',
								'bA1z.',
								'bi1D.',
								'bi1E.',
								'bi1F.',
								'bi1G.',
								'bi1e.',
								'bi1f.',
								'bi1s.',
								'bi28.',
								'bi2b.',
								'bi3n.',
								'bi3p.',
								'bi3s.',
								'bi3t.',
								'bi3u.',
								'bi3v.',
								'bi3w.',
								'bi3x.',
								'bi48.',
								'bi4F.',
								'bi55.',
								'bi56.',
								'biC7.',
								'biC8.',
								'bk35.',
								'bk36.',
								'bk39.',
								'bk3A.',
								'bk3y.',
								'bk3z.',
								'bk47.',
								'bk48.',
								'bk49.',
								'bk4x.',
								'bk4y.',
								'bk4z.',
								'bk57.',
								'bk58.',
								'bk59.',
								'bk5x.',
								'bk5y.',
								'bk5z.',
								'bk86.',
								'bk87.',
								'bk88.',
								'bk8w.',
								'bk8x.',
								'bk8y.',
								'bkC..',
								'bkC1.',
								'bkC2.',
								'bkC3.',
								'bkCx.',
								'bkCy.',
								'bkCz.',
								'bkH..',
								'bkH1.',
								'bkH2.',
								'bkH3.',
								'bkHx.',
								'bkHy.',
								'bkHz.',
								'bkI..',
								'bkI1.',
								'bkI2.',
								'bkI3.',
								'bkI4.',
								'bkI5.',
								'bkL..',
								'bkL1.',
								'bkL2.',
								'bkL3.',
								'bkL4.',
								'bkL5.',
								'bkL6.',
								'bl5i.',
								'bh4..',
								'bh5y.',
								'bh56.',
								'bh41.',
								'bh4x.',
								'bh5z.',
								'bh63.',
								'bh55.',
								'bh54.',
								'bh6B.',
								'bh1y.',
								'bh65.',
								'bh4z.',
								'bh14.',
								'bh4D.',
								'bh6A.',
								'bh68.',
								'bh4v.',
								'bh4B.',
								'bh6F.',
								'bh61.',
								'bh69.',
								'bh46.',
								'bh21.',
								'bh6E.',
								'bh4y.',
								'bh45.',
								'bh47.',
								'bh6H.',
								'bh42.',
								'bh6y.',
								'bh1z.',
								'bh5..',
								'bh6C.',
								'bh6D.',
								'bh57.',
								'bh4C.',
								'bh4A.',
								'bh6G.',
								'bh66.',
								'bh1..',
								'bh4w.',
								'bh53.',
								'bh44.',
								'bh52.',
								'bh43.',
								'bh5x.',
								'bh6z.',
								'bh13.',
								'bh51.',
								'bh64.',
								'bh67.',
								'bh49.',
								'bh48.',
								'bh11.',
								'bh2y.',
								'bh6..',
								'bh12.',
								'bh62.',
								'bf39.',
								'bf26.',
								'bf1w.',
								'bf1x.',
								'bf35.',
								'bf3b.',
								'bf42.',
								'bf44.',
								'bf3a.',
								'bf4..',
								'bf2..',
								'bf2d.',
								'bf22.',
								'bf2v.',
								'bf13.',
								'bf2c.',
								'bf27.',
								'bf2j.',
								'bf23.',
								'bf24.',
								'bf12.',
								'bf3d.',
								'bf25.',
								'bf3c.',
								'bf31.',
								'bf43.',
								'bf36.',
								'bf2e.',
								'bf33.',
								'bf2b.',
								'bf2g.',
								'bf21.',
								'bf11.',
								'bf2h.',
								'bf2z.',
								'bf32.',
								'bf34.',
								'bf41.',
								'bf29.',
								'bf2a.',
								'bf2f.',
								'bf45.',
								'bf37.',
								'bf38.',
								'bf46.',
								'be3x.',
								'be2y.',
								'be3..',
								'be3z.',
								'be3y.',
								'be1..',
								'be2x.',
								'be22.',
								'be32.',
								'be21.',
								'be31.',
								'be2..',
								'be33.',
								'bd38.',
								'bd39.',
								'bdeM.',
								'bdeN.',
								'bdeO.',
								'bdeP.',
								'bdem.',
								'bden.',
								'bdeo.',
								'bdep.',
								'bdes.',
								'bdet.',
								'bdeu.',
								'bdev.',
								'bdew.',
								'bdex.',
								'bdey.',
								'bdez.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded ANTIH read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_ANTIHYPERTENSIVES_EXCBETA_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ANTIHYPERTENSIVES_EXCBETA_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_ANTIHYPERTENSIVES_EXCBETA_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ANTIHYPERTENSIVES_EXCBETA_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior ANTIHYPERTENSIVES_EXCBETA date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN ANTIHYPERTENSIVES_EXCBETA VARCHAR(5)
	ADD COLUMN FIRST_ANTIHYPERTENSIVES_EXCBETA_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_ANTIHYPERTENSIVES_EXCBETA_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_ANTIHYPERTENSIVES_EXCBETA_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET ANTIHYPERTENSIVES_EXCBETA = TRUE
		WHERE FIRST_ANTIHYPERTENSIVES_EXCBETA_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET ANTIHYPERTENSIVES_EXCBETA = FALSE
		WHERE FIRST_ANTIHYPERTENSIVES_EXCBETA_DT IS NULL;
	
	/* Link all Stroke cohort spells to gp event to identify any events with BETABLOCKERS read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_BETABLOCKERS_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_BETABLOCKERS_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('bd',
								'bd1..',
								'bd11.',
								'bd12.',
								'bd13.',
								'bd14.',
								'bd15.',
								'bd16.',
								'bd17.',
								'bd18.',
								'bd19.',
								'bd1A.',
								'bd1B.',
								'bd1C.',
								'bd1D.',
								'bd1E.',
								'bd1F.',
								'bd1G.',
								'bd1I.',
								'bd1J.',
								'bd1K.',
								'bd1L.',
								'bd1M.',
								'bd1N.',
								'bd1O.',
								'bd1P.',
								'bd1Q.',
								'bd1R.',
								'bd1S.',
								'bd1T.',
								'bd1U.',
								'bd1V.',
								'bd1W.',
								'bd1X.',
								'bd1Y.',
								'bd1Z.',
								'bd1a.',
								'bd1b.',
								'bd1c.',
								'bd1d.',
								'bd1e.',
								'bd1f.',
								'bd1g.',
								'bd1h.',
								'bd1i.',
								'bd1j.',
								'bd1k.',
								'bd1l.',
								'bd1m.',
								'bd1n.',
								'bd1o.',
								'bd1p.',
								'bd1r.',
								'bd1s.',
								'bd1t.',
								'bd1u.',
								'bd1v.',
								'bd1w.',
								'bd1x.',
								'bd1y.',
								'bd1z.',
								'bd2..',
								'bd21.',
								'bd22.',
								'bd23.',
								'bd2w.',
								'bd2x.',
								'bd2y.',
								'bd3..',
								'bd31.',
								'bd32.',
								'bd34.',
								'bd35.',
								'bd36.',
								'bd37.',
								'bd3a.',
								'bd3b.',
								'bd3c.',
								'bd3d.',
								'bd3e.',
								'bd3f.',
								'bd3g.',
								'bd3h.',
								'bd3i.',
								'bd3j.',
								'bd3k.',
								'bd3l.',
								'bd3x.',
								'bd3z.',
								'bd4..',
								'bd41.',
								'bd4z.',
								'bd5..',
								'bd51.',
								'bd52.',
								'bd53.',
								'bd54.',
								'bd55.',
								'bd56.',
								'bd57.',
								'bd58.',
								'bd59.',
								'bd5a.',
								'bd5t.',
								'bd5u.',
								'bd5v.',
								'bd5w.',
								'bd5x.',
								'bd5y.',
								'bd6..',
								'bd61.',
								'bd62.',
								'bd64.',
								'bd65.',
								'bd66.',
								'bd67.',
								'bd68.',
								'bd6b.',
								'bd6c.',
								'bd6d.',
								'bd6e.',
								'bd6w.',
								'bd6x.',
								'bd6z.',
								'bd7..',
								'bd71.',
								'bd72.',
								'bd7y.',
								'bd7z.',
								'bd8..',
								'bd81.',
								'bd82.',
								'bd83.',
								'bd84.',
								'bd85.',
								'bd86.',
								'bd87.',
								'bd88.',
								'bd89.',
								'bd8a.',
								'bd8b.',
								'bd8c.',
								'bd8d.',
								'bd8e.',
								'bd8f.',
								'bd8g.',
								'bd8h.',
								'bd8i.',
								'bd8k.',
								'bd8l.',
								'bd8m.',
								'bd8n.',
								'bd8o.',
								'bd8u.',
								'bd9..',
								'bda..',
								'bda1.',
								'bda2.',
								'bda3.',
								'bda4.',
								'bday.',
								'bdaz.',
								'bdb..',
								'bdc..',
								'bdc1.',
								'bdc2.',
								'bdc3.',
								'bdc4.',
								'bdc5.',
								'bdcu.',
								'bdcv.',
								'bdcw.',
								'bdcx.',
								'bdd..',
								'bdd1.',
								'bdd2.',
								'bddz.',
								'bde..',
								'bde1.',
								'bde2.',
								'bde3.',
								'bde4.',
								'bde5.',
								'bde6.',
								'bde7.',
								'bde8.',
								'bde9.',
								'bdeQ.',
								'bdeR.',
								'bdea.',
								'bdeb.',
								'bdec.',
								'bded.',
								'bdee.',
								'bdef.',
								'bdeg.',
								'bdeh.',
								'bdei.',
								'bdej.',
								'bdek.',
								'bDEL1.',
								'bdf..',
								'bdf1.',
								'bdf2.',
								'bdf3.',
								'bdf4.',
								'bdf5.',
								'bdf6.',
								'bdf7.',
								'bdf8.',
								'bdf9.',
								'bdfA.',
								'bdfB.',
								'bdfC.',
								'bdfD.',
								'bdfE.',
								'bdfF.',
								'bdfG.',
								'bdfH.',
								'bdfI.',
								'bdfJ.',
								'bdfK.',
								'bdfL.',
								'bdfM.',
								'bdfw.',
								'bdfx.',
								'bdfy.',
								'bdfz.',
								'bdg..',
								'bdg1.',
								'bdg2.',
								'bdh..',
								'bdh1.',
								'bdh2.',
								'bdh3.',
								'bdh4.',
								'bdi..',
								'bdi1.',
								'bdi2.',
								'bdj..',
								'bdj1.',
								'bdj2.',
								'bdj3.',
								'bdj4.',
								'bdj5.',
								'bdl..',
								'bdl1.',
								'bdl2.',
								'bdl3.',
								'bdl4.',
								'bdl5.',
								'bdl6.',
								'bdl7.',
								'bdl8.',
								'bdm..',
								'bdm1.',
								'bdm2.',
								'bdmy.',
								'bdmz.',
								'bdn..',
								'bdn1.',
								'bdn2.',
								'bdn3.',
								'bdn4.',
								'bdn5.',
								'bdn6.',
								'bd38.',
								'bd39.',
								'bdeA.',
								'bdeB.',
								'bdeC.',
								'bdeD.',
								'bdeE.',
								'bdeF.',
								'bdeG.',
								'bdeH.',
								'bdeJ.',
								'bdeK.',
								'bDEL1.',
								'bdeM.',
								'bdeN.',
								'bdeO.',
								'bdeP.',
								'bdem.',
								'bden.',
								'bdeo.',
								'bdep.',
								'bdeq.',
								'bder.',
								'bdes.',
								'bdet.',
								'bdeu.',
								'bdev.',
								'bdew.',
								'bdex.',
								'bdey.',
								'bdez.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded BETABLOCKERS read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_BETABLOCKERS_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_BETABLOCKERS_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_BETABLOCKERS_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_BETABLOCKERS_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior BETABLOCKERS date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN BETABLOCKERS VARCHAR(5)
	ADD COLUMN FIRST_BETABLOCKERS_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_BETABLOCKERS_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_BETABLOCKERS_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET BETABLOCKERS = TRUE
		WHERE FIRST_BETABLOCKERS_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET BETABLOCKERS = FALSE
		WHERE FIRST_BETABLOCKERS_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with BETABLOCKERS read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_BETABLOCKERS_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_BETABLOCKERS_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('bd',
								'bd1..',
								'bd11.',
								'bd12.',
								'bd13.',
								'bd14.',
								'bd15.',
								'bd16.',
								'bd17.',
								'bd18.',
								'bd19.',
								'bd1A.',
								'bd1B.',
								'bd1C.',
								'bd1D.',
								'bd1E.',
								'bd1F.',
								'bd1G.',
								'bd1I.',
								'bd1J.',
								'bd1K.',
								'bd1L.',
								'bd1M.',
								'bd1N.',
								'bd1O.',
								'bd1P.',
								'bd1Q.',
								'bd1R.',
								'bd1S.',
								'bd1T.',
								'bd1U.',
								'bd1V.',
								'bd1W.',
								'bd1X.',
								'bd1Y.',
								'bd1Z.',
								'bd1a.',
								'bd1b.',
								'bd1c.',
								'bd1d.',
								'bd1e.',
								'bd1f.',
								'bd1g.',
								'bd1h.',
								'bd1i.',
								'bd1j.',
								'bd1k.',
								'bd1l.',
								'bd1m.',
								'bd1n.',
								'bd1o.',
								'bd1p.',
								'bd1r.',
								'bd1s.',
								'bd1t.',
								'bd1u.',
								'bd1v.',
								'bd1w.',
								'bd1x.',
								'bd1y.',
								'bd1z.',
								'bd2..',
								'bd21.',
								'bd22.',
								'bd23.',
								'bd2w.',
								'bd2x.',
								'bd2y.',
								'bd3..',
								'bd31.',
								'bd32.',
								'bd34.',
								'bd35.',
								'bd36.',
								'bd37.',
								'bd3a.',
								'bd3b.',
								'bd3c.',
								'bd3d.',
								'bd3e.',
								'bd3f.',
								'bd3g.',
								'bd3h.',
								'bd3i.',
								'bd3j.',
								'bd3k.',
								'bd3l.',
								'bd3x.',
								'bd3z.',
								'bd4..',
								'bd41.',
								'bd4z.',
								'bd5..',
								'bd51.',
								'bd52.',
								'bd53.',
								'bd54.',
								'bd55.',
								'bd56.',
								'bd57.',
								'bd58.',
								'bd59.',
								'bd5a.',
								'bd5t.',
								'bd5u.',
								'bd5v.',
								'bd5w.',
								'bd5x.',
								'bd5y.',
								'bd6..',
								'bd61.',
								'bd62.',
								'bd64.',
								'bd65.',
								'bd66.',
								'bd67.',
								'bd68.',
								'bd6b.',
								'bd6c.',
								'bd6d.',
								'bd6e.',
								'bd6w.',
								'bd6x.',
								'bd6z.',
								'bd7..',
								'bd71.',
								'bd72.',
								'bd7y.',
								'bd7z.',
								'bd8..',
								'bd81.',
								'bd82.',
								'bd83.',
								'bd84.',
								'bd85.',
								'bd86.',
								'bd87.',
								'bd88.',
								'bd89.',
								'bd8a.',
								'bd8b.',
								'bd8c.',
								'bd8d.',
								'bd8e.',
								'bd8f.',
								'bd8g.',
								'bd8h.',
								'bd8i.',
								'bd8k.',
								'bd8l.',
								'bd8m.',
								'bd8n.',
								'bd8o.',
								'bd8u.',
								'bd9..',
								'bda..',
								'bda1.',
								'bda2.',
								'bda3.',
								'bda4.',
								'bday.',
								'bdaz.',
								'bdb..',
								'bdc..',
								'bdc1.',
								'bdc2.',
								'bdc3.',
								'bdc4.',
								'bdc5.',
								'bdcu.',
								'bdcv.',
								'bdcw.',
								'bdcx.',
								'bdd..',
								'bdd1.',
								'bdd2.',
								'bddz.',
								'bde..',
								'bde1.',
								'bde2.',
								'bde3.',
								'bde4.',
								'bde5.',
								'bde6.',
								'bde7.',
								'bde8.',
								'bde9.',
								'bdeQ.',
								'bdeR.',
								'bdea.',
								'bdeb.',
								'bdec.',
								'bded.',
								'bdee.',
								'bdef.',
								'bdeg.',
								'bdeh.',
								'bdei.',
								'bdej.',
								'bdek.',
								'bDEL1.',
								'bdf..',
								'bdf1.',
								'bdf2.',
								'bdf3.',
								'bdf4.',
								'bdf5.',
								'bdf6.',
								'bdf7.',
								'bdf8.',
								'bdf9.',
								'bdfA.',
								'bdfB.',
								'bdfC.',
								'bdfD.',
								'bdfE.',
								'bdfF.',
								'bdfG.',
								'bdfH.',
								'bdfI.',
								'bdfJ.',
								'bdfK.',
								'bdfL.',
								'bdfM.',
								'bdfw.',
								'bdfx.',
								'bdfy.',
								'bdfz.',
								'bdg..',
								'bdg1.',
								'bdg2.',
								'bdh..',
								'bdh1.',
								'bdh2.',
								'bdh3.',
								'bdh4.',
								'bdi..',
								'bdi1.',
								'bdi2.',
								'bdj..',
								'bdj1.',
								'bdj2.',
								'bdj3.',
								'bdj4.',
								'bdj5.',
								'bdl..',
								'bdl1.',
								'bdl2.',
								'bdl3.',
								'bdl4.',
								'bdl5.',
								'bdl6.',
								'bdl7.',
								'bdl8.',
								'bdm..',
								'bdm1.',
								'bdm2.',
								'bdmy.',
								'bdmz.',
								'bdn..',
								'bdn1.',
								'bdn2.',
								'bdn3.',
								'bdn4.',
								'bdn5.',
								'bdn6.',
								'bd38.',
								'bd39.',
								'bdeA.',
								'bdeB.',
								'bdeC.',
								'bdeD.',
								'bdeE.',
								'bdeF.',
								'bdeG.',
								'bdeH.',
								'bdeJ.',
								'bdeK.',
								'bDEL1.',
								'bdeM.',
								'bdeN.',
								'bdeO.',
								'bdeP.',
								'bdem.',
								'bden.',
								'bdeo.',
								'bdep.',
								'bdeq.',
								'bder.',
								'bdes.',
								'bdet.',
								'bdeu.',
								'bdev.',
								'bdew.',
								'bdex.',
								'bdey.',
								'bdez.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded BETABLOCKERS read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_BETABLOCKERS_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_BETABLOCKERS_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_BETABLOCKERS_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_BETABLOCKERS_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior BETABLOCKERS date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN BETABLOCKERS VARCHAR(5)
	ADD COLUMN FIRST_BETABLOCKERS_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_BETABLOCKERS_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_BETABLOCKERS_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET BETABLOCKERS = TRUE
		WHERE FIRST_BETABLOCKERS_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET BETABLOCKERS = FALSE
		WHERE FIRST_BETABLOCKERS_DT IS NULL;
	
	
	
/* Link all Stroke cohort spells to gp event to identify any events with RENAL_DISEASE read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_RENAL_DISEASE_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_RENAL_DISEASE_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('1Z13.',
								'1Z14.',
								'1Z1H.',
								'1Z1J.',
								'1Z1K.',
								'1Z1L.',
								'K050.',
								'K054.',
								'K055.',
								'K060.',
								'K08z.',
								'K0D..',
								'1Z10.',
								'1Z17.',
								'1Z18.',
								'1Z11.',
								'1Z19.',
								'1Z1A.',
								'1Z12.',
								'1Z15.',
								'1Z16.',
								'1Z1B.',
								'1Z1C.',
								'1Z1D.',
								'1Z1E.',
								'1Z1F.',
								'1Z1G.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded RENAL_DISEASE read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_RENAL_DISEASE_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_RENAL_DISEASE_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_RENAL_DISEASE_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_RENAL_DISEASE_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior RENAL_DISEASE date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN RENAL_DISEASE VARCHAR(5)
	ADD COLUMN FIRST_RENAL_DISEASE_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_RENAL_DISEASE_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_RENAL_DISEASE_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET RENAL_DISEASE = TRUE
		WHERE FIRST_RENAL_DISEASE_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET RENAL_DISEASE = FALSE
		WHERE FIRST_RENAL_DISEASE_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with RENAL_DISEASE read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_RENAL_DISEASE_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_RENAL_DISEASE_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('1Z13.',
								'1Z14.',
								'1Z1H.',
								'1Z1J.',
								'1Z1K.',
								'1Z1L.',
								'K050.',
								'K054.',
								'K055.',
								'K060.',
								'K08z.',
								'K0D..',
								'1Z10.',
								'1Z17.',
								'1Z18.',
								'1Z11.',
								'1Z19.',
								'1Z1A.',
								'1Z12.',
								'1Z15.',
								'1Z16.',
								'1Z1B.',
								'1Z1C.',
								'1Z1D.',
								'1Z1E.',
								'1Z1F.',
								'1Z1G.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded RENAL_DISEASE read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_RENAL_DISEASE_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_RENAL_DISEASE_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_RENAL_DISEASE_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_RENAL_DISEASE_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior RENAL_DISEASE date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN RENAL_DISEASE VARCHAR(5)
	ADD COLUMN FIRST_RENAL_DISEASE_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_RENAL_DISEASE_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_RENAL_DISEASE_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET RENAL_DISEASE = TRUE
		WHERE FIRST_RENAL_DISEASE_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET RENAL_DISEASE = FALSE
		WHERE FIRST_RENAL_DISEASE_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with COPD read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_COPD_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_COPD_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('H3...',
								'H3121',
								'H3122',
								'H32..',
								'H320.',
								'H3200',
								'H3201',
								'H3202',
								'H3203',
								'H320z',
								'H321.',
								'H322.',
								'H32y.',
								'H32yz',
								'H32z.',
								'H36..',
								'H37..',
								'H38..',
								'H39..',
								'H3A..',
								'H3B..',
								'H3y..',
								'H3y0.',
								'H3y1.',
								'H3z..',
								'66Yg.',
								'679V.',
								'8CE6.',
								'H312.',
								'H31y.',
								'H31yz',
								'66YB.',
								'66YD.',
								'66YL.',
								'66YM.',
								'66YS.',
								'66YT.',
								'9Oi..',
								'9Oi0.',
								'9Oi1.',
								'9Oi2.',
								'H31..',
								'H312z',
								'H31z.',
								'Hyu30',
								'Hyu31',
								'66Yf.',
								'8CR1.',
								'9Oi3.',
								'9Oi4.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded COPD read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_COPD_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_COPD_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_COPD_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_COPD_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior COPD date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN COPD VARCHAR(5)
	ADD COLUMN FIRST_COPD_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_COPD_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_COPD_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET COPD = TRUE
		WHERE FIRST_COPD_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET COPD = FALSE
		WHERE FIRST_COPD_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with COPD read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_COPD_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_COPD_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('H3...',
								'H3121',
								'H3122',
								'H32..',
								'H320.',
								'H3200',
								'H3201',
								'H3202',
								'H3203',
								'H320z',
								'H321.',
								'H322.',
								'H32y.',
								'H32yz',
								'H32z.',
								'H36..',
								'H37..',
								'H38..',
								'H39..',
								'H3A..',
								'H3B..',
								'H3y..',
								'H3y0.',
								'H3y1.',
								'H3z..',
								'66Yg.',
								'679V.',
								'8CE6.',
								'H312.',
								'H31y.',
								'H31yz',
								'66YB.',
								'66YD.',
								'66YL.',
								'66YM.',
								'66YS.',
								'66YT.',
								'9Oi..',
								'9Oi0.',
								'9Oi1.',
								'9Oi2.',
								'H31..',
								'H312z',
								'H31z.',
								'Hyu30',
								'Hyu31',
								'66Yf.',
								'8CR1.',
								'9Oi3.',
								'9Oi4.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded COPD read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_COPD_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_COPD_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_COPD_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_COPD_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior COPD date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN COPD VARCHAR(5)
	ADD COLUMN FIRST_COPD_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_COPD_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_COPD_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET COPD = TRUE
		WHERE FIRST_COPD_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET COPD = FALSE
		WHERE FIRST_COPD_DT IS NULL;
	
	
-------------------------------------------------------------------------------------------------------------------------------------------------
			
--update MI cohort table with ethnicity
		
DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_VB_MI_ETHNICITY AS (
	SELECT	ALF_PE, 
			ETHN_EC_ONS_CODE
		FROM SAILW0972V.ETHN_0972_PREP_DATE)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_VB_MI_ETHNICITY
							(ALF_PE,
							ETHN_EC_ONS_CODE)
					WITH CTE AS 
						(SELECT eth.ALF_PE, 
								max(eth.ETHN_DATE) AS ETHN_DATE
						FROM SAILW0972V.ETHN_0972_PREP_DATE AS eth
							RIGHT JOIN SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS coh
							ON eth.ALF_PE = coh.ALF_PE
							WHERE eth.ETHN_DATE < coh.FIRST_EPI_STR_DT
						GROUP BY eth.ALF_PE)
				SELECT eth2.ALF_PE,
						eth2.ETHN_EC_ONS_CODE
					FROM SAILW0972V.ETHN_0972_PREP_DATE AS eth2
						RIGHT JOIN CTE
							ON eth2.ALF_PE = CTE.ALF_PE
							AND eth2.ETHN_DATE = CTE.ETHN_DATE;					
						
Commit;

--delete duplicate rows where the same ethnicity is recorded in both rows

delete FROM 
	(SELECT ROWNUMBER()	OVER(PARTITION BY ALF_PE, ETHN_EC_ONS_CODE) AS rn
			FROM SESSION.V2_VB_MI_ETHNICITY) AS mqo
			WHERE rn > 1;

--delete all rows for person where a different ethnicity is recorded on the same date

delete FROM SESSION.V2_VB_MI_ETHNICITY AS eth
WHERE EXISTS (SELECT ALF_PE, ALF_COUNT
		FROM (SELECT ALF_PE, COUNT(ALF_PE) AS ALF_COUNT
			FROM SESSION.V2_VB_MI_ETHNICITY
			GROUP BY ALF_PE
			HAVING COUNT(ALF_PE)>1) AS dup
		WHERE eth.ALF_PE = dup.ALF_PE);

/* Update MI cohort table with ethnicity */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN ETHNIC INTEGER;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS coh
	USING SESSION.V2_VB_MI_ETHNICITY AS eth
		ON coh.ALF_PE = eth.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET coh.ETHNIC = eth.ETHN_EC_ONS_CODE
			;	
	
-------------------------------------------------------------------------------------------------------------------------------------------------
			
--update STROKE cohort table with ethnicity
		
DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_VB_STROKE_ETHNICITY AS (
	SELECT	ALF_PE, 
			ETHN_EC_ONS_CODE
		FROM SAILW0972V.ETHN_0972_PREP_DATE)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_VB_STROKE_ETHNICITY
							(ALF_PE,
							ETHN_EC_ONS_CODE)
					WITH CTE AS 
						(SELECT eth.ALF_PE, 
								max(eth.ETHN_DATE) AS ETHN_DATE
						FROM SAILW0972V.ETHN_0972_PREP_DATE AS eth
							RIGHT JOIN SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS coh
							ON eth.ALF_PE = coh.ALF_PE
							WHERE eth.ETHN_DATE < coh.FIRST_EPI_STR_DT
						GROUP BY eth.ALF_PE)
				SELECT eth2.ALF_PE,
						eth2.ETHN_EC_ONS_CODE
					FROM SAILW0972V.ETHN_0972_PREP_DATE AS eth2
						RIGHT JOIN CTE
							ON eth2.ALF_PE = CTE.ALF_PE
							AND eth2.ETHN_DATE = CTE.ETHN_DATE;
				
Commit;

--delete duplicate rows where the same ethnicity is recorded in both rows

delete FROM 
	(SELECT ROWNUMBER()	OVER(PARTITION BY ALF_PE, ETHN_EC_ONS_CODE) AS rn
			FROM SESSION.V2_VB_STROKE_ETHNICITY) AS mqo
			WHERE rn > 1;

--delete all rows for person where a different ethnicity is recorded on the same date

delete FROM SESSION.V2_VB_STROKE_ETHNICITY AS eth
WHERE EXISTS (SELECT ALF_PE, ALF_COUNT
		FROM (SELECT ALF_PE, COUNT(ALF_PE) AS ALF_COUNT
			FROM SESSION.V2_VB_STROKE_ETHNICITY
			GROUP BY ALF_PE
			HAVING COUNT(ALF_PE)>1) AS dup
		WHERE eth.ALF_PE = dup.ALF_PE);

/* Update MI cohort table with ethnicity */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN ETHNIC INTEGER;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS coh
	USING SESSION.V2_VB_STROKE_ETHNICITY AS eth
		ON coh.ALF_PE = eth.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET coh.ETHNIC = eth.ETHN_EC_ONS_CODE
			;			
	
/* Link all Stroke cohort spells to gp event to identify any events with OTHER_ISCHAEMIC_HD read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_OTHER_ISCHAEMIC_HD_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_OTHER_ISCHAEMIC_HD_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('G33z4',
								'G34..',
								'G34y.',
								'G34y0',
								'G34y1',
								'G34yz',
								'G34z.',
								'G34z0',
								'G3y..',
								'G3z..',
								'G31y3',
								'G332.',
								'6A2..',
								'6A4..',
								'8B3k.',
								'8H2V.',
								'G3...',
								'G31..',
								'G3110',
								'G31y.',
								'G31y2',
								'G31yz',
								'G340.',
								'G343.',
								'G344.',
								'Gyu3.',
								'Gyu32',
								'Gyu33'
								)
;

Commit;

/* Identify first event date for any episode with a recorded OTHER_ISCHAEMIC_HD read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_OTHER_ISCHAEMIC_HD_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_OTHER_ISCHAEMIC_HD_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_OTHER_ISCHAEMIC_HD_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_OTHER_ISCHAEMIC_HD_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior OTHER_ISCHAEMIC_HD date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN OTHER_ISCHAEMIC_HD VARCHAR(5)
	ADD COLUMN FIRST_OTHER_ISCHAEMIC_HD_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_OTHER_ISCHAEMIC_HD_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_OTHER_ISCHAEMIC_HD_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET OTHER_ISCHAEMIC_HD = TRUE
		WHERE FIRST_OTHER_ISCHAEMIC_HD_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET OTHER_ISCHAEMIC_HD = FALSE
		WHERE FIRST_OTHER_ISCHAEMIC_HD_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with OTHER_ISCHAEMIC_HD read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_OTHER_ISCHAEMIC_HD_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_OTHER_ISCHAEMIC_HD_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('G33z4',
								'G34..',
								'G34y.',
								'G34y0',
								'G34y1',
								'G34yz',
								'G34z.',
								'G34z0',
								'G3y..',
								'G3z..',
								'G31y3',
								'G332.',
								'6A2..',
								'6A4..',
								'8B3k.',
								'8H2V.',
								'G3...',
								'G31..',
								'G3110',
								'G31y.',
								'G31y2',
								'G31yz',
								'G340.',
								'G343.',
								'G344.',
								'Gyu3.',
								'Gyu32',
								'Gyu33'
								)
;

Commit;

/* Identify first event date for any episode with a recorded OTHER_ISCHAEMIC_HD read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_OTHER_ISCHAEMIC_HD_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_OTHER_ISCHAEMIC_HD_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_OTHER_ISCHAEMIC_HD_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_OTHER_ISCHAEMIC_HD_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior OTHER_ISCHAEMIC_HD date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN OTHER_ISCHAEMIC_HD VARCHAR(5)
	ADD COLUMN FIRST_OTHER_ISCHAEMIC_HD_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_OTHER_ISCHAEMIC_HD_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_OTHER_ISCHAEMIC_HD_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET OTHER_ISCHAEMIC_HD = TRUE
		WHERE FIRST_OTHER_ISCHAEMIC_HD_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET OTHER_ISCHAEMIC_HD = FALSE
		WHERE FIRST_OTHER_ISCHAEMIC_HD_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with ATRIAL_FIBRILLATION read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_ATRIAL_FIBRILLATION_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_ATRIAL_FIBRILLATION_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('14AN.',
								'14AR.',
								'3272',
								'8CMW2',
								'G573.',
								'G5730',
								'G5731',
								'G5732',
								'G5733',
								'G5734',
								'G5735',
								'G5736',
								'G5737',
								'G5738',
								'G5739',
								'G573z',
								'3273',
								'793M1',
								'793M3'
								)
;

Commit;

/* Identify first event date for any episode with a recorded ATRIAL_FIBRILLATION read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_ATRIAL_FIBRILLATION_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ATRIAL_FIBRILLATION_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_ATRIAL_FIBRILLATION_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ATRIAL_FIBRILLATION_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior ATRIAL_FIBRILLATION date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN ATRIAL_FIBRILLATION VARCHAR(5)
	ADD COLUMN FIRST_ATRIAL_FIBRILLATION_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_ATRIAL_FIBRILLATION_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_ATRIAL_FIBRILLATION_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET ATRIAL_FIBRILLATION = TRUE
		WHERE FIRST_ATRIAL_FIBRILLATION_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET ATRIAL_FIBRILLATION = FALSE
		WHERE FIRST_ATRIAL_FIBRILLATION_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with ATRIAL_FIBRILLATION read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_ATRIAL_FIBRILLATION_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_ATRIAL_FIBRILLATION_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('14AN.',
								'14AR.',
								'3272',
								'8CMW2',
								'G573.',
								'G5730',
								'G5731',
								'G5732',
								'G5733',
								'G5734',
								'G5735',
								'G5736',
								'G5737',
								'G5738',
								'G5739',
								'G573z',
								'3273',
								'793M1',
								'793M3'
								)
;

Commit;

/* Identify first event date for any episode with a recorded ATRIAL_FIBRILLATION read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_ATRIAL_FIBRILLATION_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ATRIAL_FIBRILLATION_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_ATRIAL_FIBRILLATION_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ATRIAL_FIBRILLATION_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior ATRIAL_FIBRILLATION date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN ATRIAL_FIBRILLATION VARCHAR(5)
	ADD COLUMN FIRST_ATRIAL_FIBRILLATION_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_ATRIAL_FIBRILLATION_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_ATRIAL_FIBRILLATION_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET ATRIAL_FIBRILLATION = TRUE
		WHERE FIRST_ATRIAL_FIBRILLATION_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET ATRIAL_FIBRILLATION = FALSE
		WHERE FIRST_ATRIAL_FIBRILLATION_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with PERIPHERAL_VD read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_PERIPHERAL_VD_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_PERIPHERAL_VD_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('G73..',
								'G734.',
								'G73y.',
								'G73z.',
								'G73z0',
								'G73zz',
								'Gyu74',
								'2G63.',
								'A3A0F',
								'C107.',
								'C1070',
								'C1071',
								'C1073',
								'C1074',
								'C107z',
								'C108G',
								'C109F',
								'C10EG',
								'C10FF',
								'G700.',
								'G702.',
								'G702z',
								'G731.',
								'G7310',
								'G731z',
								'G732.',
								'G7320',
								'G7321',
								'G733.',
								'G73y0',
								'G73y1',
								'G73yz',
								'G740.',
								'G742z',
								'M271.',
								'M2710',
								'M2713',
								'R0550'
								)
;

Commit;

/* Identify first event date for any episode with a recorded PERIPHERAL_VD read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_PERIPHERAL_VD_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_PERIPHERAL_VD_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_PERIPHERAL_VD_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_PERIPHERAL_VD_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior PERIPHERAL_VD date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN PERIPHERAL_VD VARCHAR(5)
	ADD COLUMN FIRST_PERIPHERAL_VD_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_PERIPHERAL_VD_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_PERIPHERAL_VD_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET PERIPHERAL_VD = TRUE
		WHERE FIRST_PERIPHERAL_VD_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET PERIPHERAL_VD = FALSE
		WHERE FIRST_PERIPHERAL_VD_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with PERIPHERAL_VD read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_PERIPHERAL_VD_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_PERIPHERAL_VD_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('G73..',
								'G734.',
								'G73y.',
								'G73z.',
								'G73z0',
								'G73zz',
								'Gyu74',
								'2G63.',
								'A3A0F',
								'C107.',
								'C1070',
								'C1071',
								'C1073',
								'C1074',
								'C107z',
								'C108G',
								'C109F',
								'C10EG',
								'C10FF',
								'G700.',
								'G702.',
								'G702z',
								'G731.',
								'G7310',
								'G731z',
								'G732.',
								'G7320',
								'G7321',
								'G733.',
								'G73y0',
								'G73y1',
								'G73yz',
								'G740.',
								'G742z',
								'M271.',
								'M2710',
								'M2713',
								'R0550'
								)
;

Commit;

/* Identify first event date for any episode with a recorded PERIPHERAL_VD read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_PERIPHERAL_VD_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_PERIPHERAL_VD_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_PERIPHERAL_VD_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_PERIPHERAL_VD_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior PERIPHERAL_VD date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN PERIPHERAL_VD VARCHAR(5)
	ADD COLUMN FIRST_PERIPHERAL_VD_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_PERIPHERAL_VD_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_PERIPHERAL_VD_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET PERIPHERAL_VD = TRUE
		WHERE FIRST_PERIPHERAL_VD_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET PERIPHERAL_VD = FALSE
		WHERE FIRST_PERIPHERAL_VD_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with ANGINA read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_ANGINA_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_ANGINA_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('G3112',
								'G33..',
								'G330.',
								'G3300',
								'G330z',
								'G33z.',
								'G33z3',
								'G33z7',
								'G33zz',
								'662K.',
								'662K0',
								'662K1',
								'662K2',
								'662Kz',
								'8B27.',
								'G33z1',
								'G33z2',
								'G33z5',
								'G33z6',
								'G34y0',
								'Gyu30'
								)
;

Commit;

/* Identify first event date for any episode with a recorded ANGINA read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_ANGINA_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ANGINA_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_ANGINA_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ANGINA_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior ANGINA date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN ANGINA VARCHAR(5)
	ADD COLUMN FIRST_ANGINA_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_ANGINA_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_ANGINA_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET ANGINA = TRUE
		WHERE FIRST_ANGINA_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET ANGINA = FALSE
		WHERE FIRST_ANGINA_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with ANGINA read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_ANGINA_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_ANGINA_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('G3112',
								'G33..',
								'G330.',
								'G3300',
								'G330z',
								'G33z.',
								'G33z3',
								'G33z7',
								'G33zz',
								'662K.',
								'662K0',
								'662K1',
								'662K2',
								'662Kz',
								'8B27.',
								'G33z1',
								'G33z2',
								'G33z5',
								'G33z6',
								'G34y0',
								'Gyu30'
								)
;

Commit;

/* Identify first event date for any episode with a recorded ANGINA read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_ANGINA_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ANGINA_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_ANGINA_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ANGINA_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior ANGINA date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN ANGINA VARCHAR(5)
	ADD COLUMN FIRST_ANGINA_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_ANGINA_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_ANGINA_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET ANGINA = TRUE
		WHERE FIRST_ANGINA_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET ANGINA = FALSE
		WHERE FIRST_ANGINA_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with TRANSIENT_ISCHAEMIC read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_TRANSIENT_ISCHAEMIC_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_TRANSIENT_ISCHAEMIC_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('G65z.',
								'G65zz',
								'G65z1',
								'G65y.',
								'14AB.',
								'G65z0',
								'Fyu55',
								'G65..'
								)
;

Commit;

/* Identify first event date for any episode with a recorded TRANSIENT_ISCHAEMIC read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_TRANSIENT_ISCHAEMIC_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_TRANSIENT_ISCHAEMIC_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_TRANSIENT_ISCHAEMIC_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_TRANSIENT_ISCHAEMIC_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior TRANSIENT_ISCHAEMIC date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN TRANSIENT_ISCHAEMIC VARCHAR(5)
	ADD COLUMN FIRST_TRANSIENT_ISCHAEMIC_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_TRANSIENT_ISCHAEMIC_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_TRANSIENT_ISCHAEMIC_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET TRANSIENT_ISCHAEMIC = TRUE
		WHERE FIRST_TRANSIENT_ISCHAEMIC_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET TRANSIENT_ISCHAEMIC = FALSE
		WHERE FIRST_TRANSIENT_ISCHAEMIC_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with TRANSIENT_ISCHAEMIC read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_TRANSIENT_ISCHAEMIC_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_TRANSIENT_ISCHAEMIC_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('G65z.',
								'G65zz',
								'G65z1',
								'G65y.',
								'14AB.',
								'G65z0',
								'Fyu55',
								'G65..'
								)
;

Commit;

/* Identify first event date for any episode with a recorded TRANSIENT_ISCHAEMIC read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_TRANSIENT_ISCHAEMIC_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_TRANSIENT_ISCHAEMIC_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_TRANSIENT_ISCHAEMIC_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_TRANSIENT_ISCHAEMIC_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior TRANSIENT_ISCHAEMIC date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN TRANSIENT_ISCHAEMIC VARCHAR(5)
	ADD COLUMN FIRST_TRANSIENT_ISCHAEMIC_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_TRANSIENT_ISCHAEMIC_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_TRANSIENT_ISCHAEMIC_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET TRANSIENT_ISCHAEMIC = TRUE
		WHERE FIRST_TRANSIENT_ISCHAEMIC_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET TRANSIENT_ISCHAEMIC = FALSE
		WHERE FIRST_TRANSIENT_ISCHAEMIC_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with HEART_FAILURE read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_HEART_FAILURE_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_HEART_FAILURE_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('G58..',
								'G580.',
								'G5800',
								'G5801',
								'G5802',
								'G5803',
								'G5804',
								'G581.',
								'G5810',
								'G582.',
								'G583.',
								'G584.',
								'G58z.',
								'G232.',
								'G234.',
								'G1yz1',
								'1O1..',
								'662W.',
								'662p.',
								'8B29.',
								'8H2S.',
								'9Or0.',
								'G400.',
								'G41z.',
								'G5540',
								'G5yy9',
								'G5yyA',
								'R2y10',
								'585f.',
								'585g.',
								'14A6.',
								'14AM.',
								'1736',
								'1J60.',
								'23E1.',
								'388D.',
								'662T.',
								'662f.',
								'662g.',
								'662h.',
								'662i.',
								'679X.',
								'8CL3.',
								'8HBE.',
								'8HHz.',
								'8Hg8.',
								'8Hk0.',
								'9N0k.',
								'9N2p.',
								'9N4s.',
								'9N4w.',
								'9N6T.',
								'9On..',
								'9On0.',
								'9On1.',
								'9On2.',
								'9On3.',
								'9On4.',
								'9Or..',
								'9Or1.',
								'9Or2.',
								'9Or3.',
								'9Or4.',
								'9Or5.',
								'9h1..',
								'9h11.',
								'9h12.',
								'9hH..',
								'9hH0.',
								'9hH1.',
								'H54..',
								'H541.',
								'H5410',
								'H541z',
								'H54z.',
								'H584.',
								'H584z',
								'ZRad.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded HEART_FAILURE read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_HEART_FAILURE_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_HEART_FAILURE_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_HEART_FAILURE_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_HEART_FAILURE_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior HEART_FAILURE date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN HEART_FAILURE VARCHAR(5)
	ADD COLUMN FIRST_HEART_FAILURE_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_HEART_FAILURE_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_HEART_FAILURE_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET HEART_FAILURE = TRUE
		WHERE FIRST_HEART_FAILURE_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET HEART_FAILURE = FALSE
		WHERE FIRST_HEART_FAILURE_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with HEART_FAILURE read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_HEART_FAILURE_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_HEART_FAILURE_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('G58..',
								'G580.',
								'G5800',
								'G5801',
								'G5802',
								'G5803',
								'G5804',
								'G581.',
								'G5810',
								'G582.',
								'G583.',
								'G584.',
								'G58z.',
								'G232.',
								'G234.',
								'G1yz1',
								'1O1..',
								'662W.',
								'662p.',
								'8B29.',
								'8H2S.',
								'9Or0.',
								'G400.',
								'G41z.',
								'G5540',
								'G5yy9',
								'G5yyA',
								'R2y10',
								'585f.',
								'585g.',
								'14A6.',
								'14AM.',
								'1736',
								'1J60.',
								'23E1.',
								'388D.',
								'662T.',
								'662f.',
								'662g.',
								'662h.',
								'662i.',
								'679X.',
								'8CL3.',
								'8HBE.',
								'8HHz.',
								'8Hg8.',
								'8Hk0.',
								'9N0k.',
								'9N2p.',
								'9N4s.',
								'9N4w.',
								'9N6T.',
								'9On..',
								'9On0.',
								'9On1.',
								'9On2.',
								'9On3.',
								'9On4.',
								'9Or..',
								'9Or1.',
								'9Or2.',
								'9Or3.',
								'9Or4.',
								'9Or5.',
								'9h1..',
								'9h11.',
								'9h12.',
								'9hH..',
								'9hH0.',
								'9hH1.',
								'H54..',
								'H541.',
								'H5410',
								'H541z',
								'H54z.',
								'H584.',
								'H584z',
								'ZRad.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded HEART_FAILURE read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_HEART_FAILURE_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_HEART_FAILURE_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_HEART_FAILURE_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_HEART_FAILURE_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior HEART_FAILURE date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN HEART_FAILURE VARCHAR(5)
	ADD COLUMN FIRST_HEART_FAILURE_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_HEART_FAILURE_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_HEART_FAILURE_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET HEART_FAILURE = TRUE
		WHERE FIRST_HEART_FAILURE_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET HEART_FAILURE = FALSE
		WHERE FIRST_HEART_FAILURE_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with LIPID_LOWERING read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_LIPID_LOWERING_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_LIPID_LOWERING_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('bxd5.',
								'bxd2.',
								'bxi2.',
								'bxi3.',
								'bxi1.',
								'bxiz.',
								'bxd1.',
								'bxl1.',
								'bxe7.',
								'bxkx.',
								'bxe6.',
								'bxkw.',
								'bxky.',
								'bxe5.',
								'bxdz.',
								'bx14.',
								'bxcA.',
								'bxcC.',
								'bxkz.',
								'bxc8.',
								'bxf2.',
								'bx13.',
								'bxg4.',
								'bxg3.',
								'bx12.',
								'bxc6.',
								'bxi4.',
								'bxlz.',
								'bxi5.',
								'bxcB.',
								'bxgz.',
								'bxdx.',
								'bxc4.',
								'bxi6.',
								'bxi..',
								'bxk1.',
								'bxdv.',
								'bxdy.',
								'bxiy.',
								'bxk4.',
								'bxd8.',
								'bx63.',
								'bxc5.',
								'bxc9.',
								'bxiB.',
								'bxdu.',
								'bxi7.',
								'bxdw.',
								'bx6z.',
								'bxk2.',
								'bxd6.',
								'bx11.',
								'bxe8.',
								'bxdC.',
								'bxdI.',
								'bxg2.',
								'bx18.',
								'bxe4.',
								'bxc7.',
								'bxdH.',
								'bxd7.',
								'bxi9.',
								'bxdB.',
								'bx62.',
								'bxi8.',
								'bxe3.',
								'bxg1.',
								'bxd3.',
								'bxiA.',
								'bxd9.',
								'bxd..',
								'bxk3.',
								'bxdA.',
								'bxdJ.',
								'bxg5.',
								'bxf1.',
								'bx61.',
								'bxe..',
								'bx17.',
								'bxdK.',
								'bxc..',
								'bxc1.',
								'bx1..'
								)
;

Commit;

/* Identify first event date for any episode with a recorded LIPID_LOWERING read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_LIPID_LOWERING_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_LIPID_LOWERING_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_LIPID_LOWERING_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_LIPID_LOWERING_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior LIPID_LOWERING date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN LIPID_LOWERING VARCHAR(5)
	ADD COLUMN FIRST_LIPID_LOWERING_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_LIPID_LOWERING_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_LIPID_LOWERING_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET LIPID_LOWERING = TRUE
		WHERE FIRST_LIPID_LOWERING_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET LIPID_LOWERING = FALSE
		WHERE FIRST_LIPID_LOWERING_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with LIPID_LOWERING read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_LIPID_LOWERING_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_LIPID_LOWERING_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('bxd5.',
								'bxd2.',
								'bxi2.',
								'bxi3.',
								'bxi1.',
								'bxiz.',
								'bxd1.',
								'bxl1.',
								'bxe7.',
								'bxkx.',
								'bxe6.',
								'bxkw.',
								'bxky.',
								'bxe5.',
								'bxdz.',
								'bx14.',
								'bxcA.',
								'bxcC.',
								'bxkz.',
								'bxc8.',
								'bxf2.',
								'bx13.',
								'bxg4.',
								'bxg3.',
								'bx12.',
								'bxc6.',
								'bxi4.',
								'bxlz.',
								'bxi5.',
								'bxcB.',
								'bxgz.',
								'bxdx.',
								'bxc4.',
								'bxi6.',
								'bxi..',
								'bxk1.',
								'bxdv.',
								'bxdy.',
								'bxiy.',
								'bxk4.',
								'bxd8.',
								'bx63.',
								'bxc5.',
								'bxc9.',
								'bxiB.',
								'bxdu.',
								'bxi7.',
								'bxdw.',
								'bx6z.',
								'bxk2.',
								'bxd6.',
								'bx11.',
								'bxe8.',
								'bxdC.',
								'bxdI.',
								'bxg2.',
								'bx18.',
								'bxe4.',
								'bxc7.',
								'bxdH.',
								'bxd7.',
								'bxi9.',
								'bxdB.',
								'bx62.',
								'bxi8.',
								'bxe3.',
								'bxg1.',
								'bxd3.',
								'bxiA.',
								'bxd9.',
								'bxd..',
								'bxk3.',
								'bxdA.',
								'bxdJ.',
								'bxg5.',
								'bxf1.',
								'bx61.',
								'bxe..',
								'bx17.',
								'bxdK.',
								'bxc..',
								'bxc1.',
								'bx1..'
								)
;

Commit;

/* Identify first event date for any episode with a recorded LIPID_LOWERING read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_LIPID_LOWERING_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_LIPID_LOWERING_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_LIPID_LOWERING_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_LIPID_LOWERING_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior LIPID_LOWERING date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN LIPID_LOWERING VARCHAR(5)
	ADD COLUMN FIRST_LIPID_LOWERING_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_LIPID_LOWERING_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_LIPID_LOWERING_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET LIPID_LOWERING = TRUE
		WHERE FIRST_LIPID_LOWERING_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET LIPID_LOWERING = FALSE
		WHERE FIRST_LIPID_LOWERING_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with DIABETES read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_DIABETES_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_DIABETES_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('66AJ.',
								'66AJ1',
								'66AJz',
								'66An.',
								'66Ao.',
								'8CR2.',
								'9OLA.',
								'C10..',
								'C100.',
								'C1000',
								'C100z',
								'C101.',
								'C1010',
								'C1011',
								'C101y',
								'C102.',
								'C1020',
								'C1021',
								'C102z',
								'C103.',
								'C1030',
								'C1031',
								'C103y',
								'C103z',
								'C104.',
								'C1040',
								'C1041',
								'C104y',
								'C104z',
								'C105.',
								'C1050',
								'C1051',
								'C105y',
								'C105z',
								'C106.',
								'C1060',
								'C1061',
								'C106y',
								'C106z',
								'C107.',
								'C1070',
								'C1071',
								'C1072',
								'C1073',
								'C1074',
								'C107y',
								'C107z',
								'C108.',
								'C1080',
								'C1081',
								'C1082',
								'C1083',
								'C1084',
								'C1085',
								'C1086',
								'C1087',
								'C1088',
								'C1089',
								'C108A',
								'C108B',
								'C108C',
								'C108D',
								'C108E',
								'C108F',
								'C108G',
								'C108H',
								'C108J',
								'C108y',
								'C108z',
								'C109.',
								'C1090',
								'C1091',
								'C1092',
								'C1093',
								'C1094',
								'C1095',
								'C1096',
								'C1097',
								'C1099',
								'C109A',
								'C109B',
								'C109C',
								'C109D',
								'C109E',
								'C109F',
								'C109G',
								'C109H',
								'C109J',
								'C109K',
								'C10A0',
								'C10A1',
								'C10A2',
								'C10A3',
								'C10A4',
								'C10A5',
								'C10A6',
								'C10A7',
								'C10AW',
								'C10AX',
								'C10B.',
								'C10B0',
								'C10C.',
								'C10D.',
								'C10E.',
								'C10E0',
								'C10E1',
								'C10E2',
								'C10E3',
								'C10E4',
								'C10E5',
								'C10E6',
								'C10E7',
								'C10E8',
								'C10E9',
								'C10EA',
								'C10EB',
								'C10EC',
								'C10ED',
								'C10EE',
								'C10EF',
								'C10EG',
								'C10EH',
								'C10EJ',
								'C10EK',
								'C10EL',
								'C10EM',
								'C10EN',
								'C10EP',
								'C10EQ',
								'C10ER',
								'C10F.',
								'C10F0',
								'C10F1',
								'C10F2',
								'C10F3',
								'C10F4',
								'C10F5',
								'C10F6',
								'C10F7',
								'C10F9',
								'C10FA',
								'C10FB',
								'C10FC',
								'C10FD',
								'C10FE',
								'C10FF',
								'C10FG',
								'C10FH',
								'C10FJ',
								'C10FK',
								'C10FL',
								'C10FM',
								'C10FN',
								'C10FP',
								'C10FQ',
								'C10FR',
								'C10FS',
								'C10G.',
								'C10G0',
								'C10H.',
								'C10H0',
								'C10K.',
								'C10K0',
								'C10M.',
								'C10M0',
								'C10N.',
								'C10N0',
								'C10N1',
								'C10P.',
								'C10P0',
								'C10P1',
								'C10y.',
								'C10y1',
								'C10yy',
								'C10yz',
								'C10z.',
								'C10z0',
								'C10z1',
								'C10zy',
								'C10zz',
								'F372.',
								'F3720',
								'F3721',
								'F3722',
								'1434',
								'14F4.',
								'14P3.',
								'9OL9.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded DIABETES read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_DIABETES_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_DIABETES_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_DIABETES_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_DIABETES_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior DIABETES date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN DIABETES VARCHAR(5)
	ADD COLUMN FIRST_DIABETES_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_DIABETES_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_DIABETES_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET DIABETES = TRUE
		WHERE FIRST_DIABETES_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET DIABETES = FALSE
		WHERE FIRST_DIABETES_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with DIABETES read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_DIABETES_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_DIABETES_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('66AJ.',
								'66AJ1',
								'66AJz',
								'66An.',
								'66Ao.',
								'8CR2.',
								'9OLA.',
								'C10..',
								'C100.',
								'C1000',
								'C100z',
								'C101.',
								'C1010',
								'C1011',
								'C101y',
								'C102.',
								'C1020',
								'C1021',
								'C102z',
								'C103.',
								'C1030',
								'C1031',
								'C103y',
								'C103z',
								'C104.',
								'C1040',
								'C1041',
								'C104y',
								'C104z',
								'C105.',
								'C1050',
								'C1051',
								'C105y',
								'C105z',
								'C106.',
								'C1060',
								'C1061',
								'C106y',
								'C106z',
								'C107.',
								'C1070',
								'C1071',
								'C1072',
								'C1073',
								'C1074',
								'C107y',
								'C107z',
								'C108.',
								'C1080',
								'C1081',
								'C1082',
								'C1083',
								'C1084',
								'C1085',
								'C1086',
								'C1087',
								'C1088',
								'C1089',
								'C108A',
								'C108B',
								'C108C',
								'C108D',
								'C108E',
								'C108F',
								'C108G',
								'C108H',
								'C108J',
								'C108y',
								'C108z',
								'C109.',
								'C1090',
								'C1091',
								'C1092',
								'C1093',
								'C1094',
								'C1095',
								'C1096',
								'C1097',
								'C1099',
								'C109A',
								'C109B',
								'C109C',
								'C109D',
								'C109E',
								'C109F',
								'C109G',
								'C109H',
								'C109J',
								'C109K',
								'C10A0',
								'C10A1',
								'C10A2',
								'C10A3',
								'C10A4',
								'C10A5',
								'C10A6',
								'C10A7',
								'C10AW',
								'C10AX',
								'C10B.',
								'C10B0',
								'C10C.',
								'C10D.',
								'C10E.',
								'C10E0',
								'C10E1',
								'C10E2',
								'C10E3',
								'C10E4',
								'C10E5',
								'C10E6',
								'C10E7',
								'C10E8',
								'C10E9',
								'C10EA',
								'C10EB',
								'C10EC',
								'C10ED',
								'C10EE',
								'C10EF',
								'C10EG',
								'C10EH',
								'C10EJ',
								'C10EK',
								'C10EL',
								'C10EM',
								'C10EN',
								'C10EP',
								'C10EQ',
								'C10ER',
								'C10F.',
								'C10F0',
								'C10F1',
								'C10F2',
								'C10F3',
								'C10F4',
								'C10F5',
								'C10F6',
								'C10F7',
								'C10F9',
								'C10FA',
								'C10FB',
								'C10FC',
								'C10FD',
								'C10FE',
								'C10FF',
								'C10FG',
								'C10FH',
								'C10FJ',
								'C10FK',
								'C10FL',
								'C10FM',
								'C10FN',
								'C10FP',
								'C10FQ',
								'C10FR',
								'C10FS',
								'C10G.',
								'C10G0',
								'C10H.',
								'C10H0',
								'C10K.',
								'C10K0',
								'C10M.',
								'C10M0',
								'C10N.',
								'C10N0',
								'C10N1',
								'C10P.',
								'C10P0',
								'C10P1',
								'C10y.',
								'C10y1',
								'C10yy',
								'C10yz',
								'C10z.',
								'C10z0',
								'C10z1',
								'C10zy',
								'C10zz',
								'F372.',
								'F3720',
								'F3721',
								'F3722',
								'1434',
								'14F4.',
								'14P3.',
								'9OL9.'
								)
;

Commit;

/* Identify first event date for any episode with a recorded DIABETES read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_DIABETES_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_DIABETES_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_DIABETES_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_DIABETES_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior DIABETES date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN DIABETES VARCHAR(5)
	ADD COLUMN FIRST_DIABETES_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_DIABETES_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_DIABETES_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET DIABETES = TRUE
		WHERE FIRST_DIABETES_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET DIABETES = FALSE
		WHERE FIRST_DIABETES_DT IS NULL;
	
/* Link all Stroke cohort spells to gp event to identify any events with ASTHMA read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_ASTHMA_STROKE AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_ASTHMA_STROKE
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('14B4.',
								'14Ok0',
								'173A.',
								'173c.',
								'173d.',
								'178..',
								'1780',
								'1781',
								'1782',
								'1783',
								'1784',
								'1785',
								'1786',
								'1787',
								'1788',
								'1789',
								'178A.',
								'178B.',
								'1O2..',
								'388t.',
								'388t0',
								'38B8.',
								'38DL.',
								'38DT.',
								'38DV.',
								'38QM.',
								'661M1',
								'661N1',
								'663..',
								'663J.',
								'663N.',
								'663N0',
								'663N1',
								'663N2',
								'663O.',
								'663O0',
								'663P.',
								'663P0',
								'663P1',
								'663P2',
								'663Q.',
								'663U.',
								'663V.',
								'663V0',
								'663V1',
								'663V2',
								'663V3',
								'663W.',
								'663d.',
								'663e.',
								'663',
								'6.63E',
								'663f.',
								'663h.',
								'663m.',
								'663r.',
								'663s.',
								'663t.',
								'663x.',
								'663y.',
								'66Y5.',
								'66Y9.',
								'66YA.',
								'66YC.',
								'66YE.',
								'66YJ.',
								'66YK.',
								'66YP.',
								'66YQ.',
								'66YR.',
								'66Ys.',
								'66Yu.',
								'66Yz0',
								'66Yz5',
								'679J.',
								'679J0',
								'679J1',
								'679J2',
								'8791',
								'8793',
								'8794',
								'8795',
								'8796',
								'8797',
								'8798',
								'8B3j.',
								'8CE2.',
								'8CMA0',
								'8CR0.',
								'8H2P.',
								'8HTT.',
								'9N1d.',
								'9N1d0',
								'9N4Q.',
								'9NI8.',
								'9NNX.',
								'9OJ..',
								'9OJ1.',
								'9OJ2.',
								'9OJ3.',
								'9OJ4.',
								'9OJ5.',
								'9OJ6.',
								'9OJ7.',
								'9OJ8.',
								'9OJA.',
								'9OJB.',
								'9OJB0',
								'9OJB1',
								'9OJB2',
								'9OJC.',
								'9OJZ.',
								'9Q21.',
								'9hA..',
								'9hA1.',
								'9hA2.',
								'H3120',
								'H33..',
								'H330.',
								'H3300',
								'H3301',
								'H330z',
								'H331.',
								'H3310',
								'H3311',
								'H331z',
								'H332.',
								'H333.',
								'H334.',
								'H335.',
								'H33z.',
								'H33z0',
								'H33z1',
								'H33z2',
								'H33zz',
								'H35y6',
								'H35y7',
								'H3B..',
								'H47y0'
								)
;

Commit;

/* Identify first event date for any episode with a recorded ASTHMA read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_ASTHMA_STROKE AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ASTHMA_STROKE AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_ASTHMA_STROKE
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ASTHMA_STROKE AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the Stroke cohort table with the prior ASTHMA date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN ASTHMA VARCHAR(5)
	ADD COLUMN FIRST_ASTHMA_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_ASTHMA_STROKE AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_ASTHMA_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET ASTHMA = TRUE
		WHERE FIRST_ASTHMA_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET ASTHMA = FALSE
		WHERE FIRST_ASTHMA_DT IS NULL;
	
/* Link all MI cohort spells to gp event to identify any events with ASTHMA read codes */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_GP_EVENT_ASTHMA_MI AS (
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_GP_EVENT_ASTHMA_MI
	SELECT	fe.ALF_PE, 
			gp.EVENT_DT,
			gp.EVENT_CD
		FROM	SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe,
				SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301 AS gp
			WHERE 	fe.ALF_PE = gp.ALF_PE
			AND		gp.EVENT_DT < fe.FIRST_EPI_STR_DT 
			AND gp.EVENT_CD IN ('14B4.',
								'14Ok0',
								'173A.',
								'173c.',
								'173d.',
								'178..',
								'1780',
								'1781',
								'1782',
								'1783',
								'1784',
								'1785',
								'1786',
								'1787',
								'1788',
								'1789',
								'178A.',
								'178B.',
								'1O2..',
								'388t.',
								'388t0',
								'38B8.',
								'38DL.',
								'38DT.',
								'38DV.',
								'38QM.',
								'661M1',
								'661N1',
								'663..',
								'663J.',
								'663N.',
								'663N0',
								'663N1',
								'663N2',
								'663O.',
								'663O0',
								'663P.',
								'663P0',
								'663P1',
								'663P2',
								'663Q.',
								'663U.',
								'663V.',
								'663V0',
								'663V1',
								'663V2',
								'663V3',
								'663W.',
								'663d.',
								'663e.',
								'663',
								'6.63E',
								'663f.',
								'663h.',
								'663m.',
								'663r.',
								'663s.',
								'663t.',
								'663x.',
								'663y.',
								'66Y5.',
								'66Y9.',
								'66YA.',
								'66YC.',
								'66YE.',
								'66YJ.',
								'66YK.',
								'66YP.',
								'66YQ.',
								'66YR.',
								'66Ys.',
								'66Yu.',
								'66Yz0',
								'66Yz5',
								'679J.',
								'679J0',
								'679J1',
								'679J2',
								'8791',
								'8793',
								'8794',
								'8795',
								'8796',
								'8797',
								'8798',
								'8B3j.',
								'8CE2.',
								'8CMA0',
								'8CR0.',
								'8H2P.',
								'8HTT.',
								'9N1d.',
								'9N1d0',
								'9N4Q.',
								'9NI8.',
								'9NNX.',
								'9OJ..',
								'9OJ1.',
								'9OJ2.',
								'9OJ3.',
								'9OJ4.',
								'9OJ5.',
								'9OJ6.',
								'9OJ7.',
								'9OJ8.',
								'9OJA.',
								'9OJB.',
								'9OJB0',
								'9OJB1',
								'9OJB2',
								'9OJC.',
								'9OJZ.',
								'9Q21.',
								'9hA..',
								'9hA1.',
								'9hA2.',
								'H3120',
								'H33..',
								'H330.',
								'H3300',
								'H3301',
								'H330z',
								'H331.',
								'H3310',
								'H3311',
								'H331z',
								'H332.',
								'H333.',
								'H334.',
								'H335.',
								'H33z.',
								'H33z0',
								'H33z1',
								'H33z2',
								'H33zz',
								'H35y6',
								'H35y7',
								'H3B..',
								'H47y0'
								)
;

Commit;

/* Identify first event date for any episode with a recorded ASTHMA read code */

DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_ALL_COHORT_FIRST_ASTHMA_MI AS (
	SELECT	gpev.ALF_PE, 
			gpev.EVENT_DT
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ASTHMA_MI AS gpev)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_ALL_COHORT_FIRST_ASTHMA_MI
	SELECT	gpev.ALF_PE,
			MIN(gpev.EVENT_DT)
		FROM SESSION.V2_ALL_COHORT_GP_EVENT_ASTHMA_MI AS gpev
	GROUP BY gpev.ALF_PE
;

Commit;

/* Update the MI cohort table with the prior ASTHMA date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN ASTHMA VARCHAR(5)
	ADD COLUMN FIRST_ASTHMA_DT DATE;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_ALL_COHORT_FIRST_ASTHMA_MI AS gpev
		ON fe.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.FIRST_ASTHMA_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET ASTHMA = TRUE
		WHERE FIRST_ASTHMA_DT IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET ASTHMA = FALSE
		WHERE FIRST_ASTHMA_DT IS NULL;
	


-----------------------------------------------------------
--smoking algorithm
--BY:       s.j.aldridge@swansea.ac.uk
--aim:      to get smoking cohort ready
-----------------------------------------------------------

-- This is an algorithm to assign smoker status of your ALFs of interest using
-- a built in classification table based off of the individuals GP records
-- The smoker statuses are N - Never smoker, E - ex-smoker and S - current smoker
-- A detailed documentation of instructions can be found in the README of the Smoking_algorithm repository


-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
---------------------------- declare variables --------------------------------

---define variables here:

-- STEP 1 --
	-- find and replace all instances of "nnnn" to your project code (e.g. 1234)
	-- using ctrl + f


-- STEP 2 --
--	create a user table specifying your ALF_PEs, their diagnosis dates (DIAG_DATE).

------------Change from temp to proper table-----

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_MI_COHORT_ALF_DATE');

CREATE TABLE SAILW0972V.V2_VB_MI_COHORT_ALF_DATE
	(	ALF_PE VARCHAR(20),
		DIAG_DATE DATE);

INSERT INTO SAILW0972V.V2_VB_MI_COHORT_ALF_DATE
	SELECT	fe.ALF_PE,
			fe.FIRST_EPI_STR_DT
		FROM SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
;

--	An example code for creating this table can be found in the example folder
CREATE OR REPLACE ALIAS SAILW0972V.V2_input_USER_table FOR SAILW0972V.V2_VB_MI_COHORT_ALF_DATE; -- change to user table

-- STEP 3 --
	--- Specify your GP table
	--- This algorithm will expand your input table to obtain the necessary details needed to run the algorithm, these
	--- are sourced from a GP table. Please specify the table you'd like to use.
CREATE OR REPLACE ALIAS SAILW0972V.V2_gp_database FOR SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301; 


-- STEP 4 --
	--- Specify your ALF format
	--- The DEFAULT is ALF_PE, but if yours is different, please REPLACE all "ALF_PE" with your format
	

-- STEP 5 --
	-- specify for which timepoint you want your smoker status to be assigned at,
	-- smoker status at point of diagnosis, up until a defined cut-off date (STEP 4)
	-- is the default.
	-- OPTION 1 - gives smoker-status at your specified cut-off date, regardless of diagnosis date
	-- OPTION 2 - gives smoker_status between diagnosis date and your cut-off date
	-- OPTION 3 - gives most recent smoker status with cut-off applied to DIAG_DATE
	--			- gives smoker status after DIAG_DATE (if using DIAG_DATE as your cut-off i.e. NULL setting from STEP 4)
	-- See the readme for details and instructions on how to implement each option.


-- STEP 6 --
	--- Specify your cutoff date (formatted as 'YYYY-MM-DD'): un-comment 6b and replace it with your date,
	--- or use 6a with 'NULL' to obtain smoker status at the point of diagnosis.
	--- NULL is the DEFAULT setting
	--6a
CREATE OR REPLACE VARIABLE SAILW0972V.V2_input_smoking_date_cutoff VARCHAR(100) DEFAULT 'NULL';
	--6b
-- CREATE OR REPLACE VARIABLE SAILW0972V.V2_input_smoking_date_cutoff VARCHAR(100) DEFAULT 'NULL';


-- STEP 7 --
	--- assign time since last smoker recording until you are happy to classify as 'ex-smoker' in days. i.e. an individual can't have
	---	been recorded a smoker for at least this period of time in the run up to the cut-off date for the algorithm to assign
	--- them as an ex-smoker
	--- DEFAULT is 180 days - approx 6 months
CREATE OR REPLACE VARIABLE SAILW0972V.V2_ex_smoker_cutoff INTEGER DEFAULT 540;


-- STEP 8 --
	---desired ALF_STS_CDs - specify the ALF STS codes wanted for inclusion, default is 1, 4 and 39.
	---If you want more codes included, add the values to this table
CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_ALF_STS_CD_SMOKING');
CREATE TABLE SAILW0972V.V2_ALF_STS_CD_SMOKING
	(ALF_STS_CD	BIGINT);
COMMIT;
INSERT INTO SAILW0972V.V2_ALF_STS_CD_SMOKING
VALUES (1), (4), (39); -- remove or add additional codes to this line using the same format
COMMIT;
SELECT * FROM SAILW0972V.V2_ALF_STS_CD_SMOKING;


-- STEP 9 --
	--- The read codes for smoker status have been determined in the development of this algorithm and do not require input.
	--- *However*, if you'd like to edit this table, do so in the section titled "Create look up table".
	--- If you'd like to supply a new table of your own, comment out the "Create look up table" section and insert a reference to your own table below
-- CREATE OR REPLACE ALIAS SAILW0972V.V2_SMOKER_LOOKUP FOR SAILW0972V.V2_YOUR_LOOK_UP_TABLE_GOES_HERE;


-- STEP 10 --
	-- Select all (Ctrl A) and run this algorithm (right click, execute --> Execute SQL script)


-- STEP 11 --
	-- results are generated to the output table SAILW0972V.V2_VB_SMOKER_OUTPUT_MI and feature
	-- the PATIENT_ID, SMOKER STATUS and SMOKER STATUS DESCRIPTION
	
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-------------------------- Create look up table --------------------------------

-- This is an updated list of read codes put together by SA based on the codes published by MH,
-- and with the guidance of AA, FT and RL (June 2021)

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_SMOKER_LOOKUP');

CREATE TABLE sailW0972V.V2_smoker_lookup
(
        sm_code         CHAR(6),
        description		VARCHAR(300),
        smoking_status  VARCHAR(1),
        complexity		VARCHAR(20)
)
DISTRIBUTE BY HASH (sm_code); --previously was best practise, but might be outdated now
COMMIT;

--granting access to team mates
GRANT ALL ON TABLE SAILW0972V.V2_SMOKER_LOOKUP TO ROLE NRDASAIL_SAIL_0972_ANALYST;

--worth doing for large chunks of data
alter table SAILW0972V.V2_SMOKER_LOOKUP activate not logged INITIALLY;

--inserting read codes relevent to smoking
insert into SAILW0972V.V2_SMOKER_LOOKUP
	(sm_code, description, smoking_status, complexity)
VALUES
	('1371.'	,	'Never smoked tobacco'											,	'N'	,	'SIMPLE'	)	,
	('1372.'	,	'Trivial smoker - < 1 cig/day'									,	'S'	,	'SIMPLE'	)	,
	('1373.'	,	'Light smoker - 1-9 cigs/day'									,	'S'	,	'SIMPLE'	)	,
	('1374.'	,	'Moderate smoker - 10-19 cigs/d'								,	'S'	,	'SIMPLE'	)	,
	('1375.'	,	'Heavy smoker - 20-39 cigs/day'									,	'S'	,	'SIMPLE'	)	,
	('1376.'	,	'Very heavy smoker - 40+cigs/d'									,	'S'	,	'SIMPLE'	)	,
	('1377.'	,	'Ex-trivial smoker (<1/day)'									,	'E'	,	'SIMPLE'	)	,
	('1378.'	,	'Ex-light smoker (1-9/day)'										,	'E'	,	'SIMPLE'	)	,
	('1379.'	,	'Ex-moderate smoker (10-19/day)'								,	'E'	,	'SIMPLE'	)	,
	('6791.'	,	'Health ed. - smoking'											,	'S'	,	'SIMPLE'	)	,
	('67910'	,	'Health education - parental smoking'							,	'S'	,	'SIMPLE'	)	,
	('137..'	,	'Tobacco consumption'											,	'S'	,	'EVENT_VAL DEPENDENT'	),
	('137A.'	,	'Ex-heavy smoker (20-39/day)'									,	'E'	,	'SIMPLE'	)	,
	('137a.'	,	'Pipe tobacco consumption'										,	'S'	,	'SIMPLE'	)	,
	('137B.'	,	'Ex-very heavy smoker (40+/day)'								,	'E'	,	'SIMPLE'	)	,
	('137b.'	,	'Ready to stop smoking'											,	'S'	,	'SIMPLE'	)	,
	('137C.'	,	'Keeps trying to stop smoking'									,	'S'	,	'SIMPLE'	)	,
	('137c.'	,	'Thinking about stopping smoking'								,	'S'	,	'SIMPLE'	)	,
	('137D.'	,	'Admitted tobacco cons untrue ?'								,	'S'	,	'SIMPLE'	)	,
	('137d.'	,	'Not interested in stopping smoking'							,	'S'	,	'SIMPLE'	)	,
	('137e.'	,	'Smoking restarted'												,	'S'	,	'SIMPLE'	)	,
	('137E.'	,	'Tobacco consumption unknown'									,	'S'	,	'EVENT_VAL DEPENDENT'	),
	('137F.'	,	'Ex-smoker - amount unknown'									,	'E'	,	'SIMPLE'	)	,
	('137f.'	,	'Reason for restarting smoking'									,	'S'	,	'SIMPLE'	)	,
	('137G.'	,	'Trying to give up smoking'										,	'S'	,	'SIMPLE'	)	,
	('137g.'	,	'Cigarette pack-years'											,	'S'	,	'EVENT_VAL DEPENDENT'	),
	('137h.'	,	'Minutes from waking to first tobacco consumption'				,	'S'	,	'SIMPLE'	)	,
	('137H.'	,	'Pipe smoker'													,	'S'	,	'SIMPLE'	)	,
	('137j.'	,	'Ex-cigarette smoker'											,	'E'	,	'SIMPLE'	)	,
	('137J.'	,	'Cigar smoker'													,	'S'	,	'SIMPLE'	)	,
	('137K.'	,	'Stopped smoking'												,	'E'	,	'SIMPLE'	)	,
	('137K0'	,	'Recently stopped smoking'										,	'E'	,	'SIMPLE'	)	,
	('137l.'	,	'Ex roll-up cigarette smoker'									,	'E'	,	'SIMPLE'	)	,
	('137L.'	,	'Current non-smoker'											,	'N'	,	'SIMPLE'	)	,
	('137m.'	,	'Failed attempt to stop smoking'								,	'S'	,	'SIMPLE'	)	,
	('137M.'	,	'Rolls own cigarettes'                                 			,	'S'	,	'SIMPLE'	)	,
	('137N.'	,	'Ex pipe smoker'                                        		,	'E'	,	'SIMPLE'	)	,
	('137O.'	,	'Ex cigar smoker'                                               ,	'E'	,	'SIMPLE'	)	,
	('137P.'	,	'Cigarette smoker'                                    			,	'S'	,	'SIMPLE'	)	,
	('137Q.'	,	'Smoking started'                                               ,	'S'	,	'SIMPLE'	)	,
	('137R.'	,	'Current smoker'                                                ,	'S'	,	'SIMPLE'	)	,
	('137S.'	,	'Ex smoker'                                                     ,	'E'	,	'SIMPLE'	)	,
	('137T.'	,	'Date ceased smoking'                                           ,	'E'	,	'SIMPLE'	)	,
	('137V.'	,	'Smoking reduced'                                               ,	'S'	,	'SIMPLE'	)	,
	('137X.'	,	'Cigarette consumption'                                         ,	'S'	,	'EVENT_VAL DEPENDENT'	)	,
	('137Y.'	,	'Cigar consumption'                                             ,	'S'	,	'EVENT_VAL DEPENDENT'	)	,
	('137Z.'	,	'Tobacco consumption NOS'                                       ,	'S'	,	'EVENT_VAL DEPENDENT'	)	,
	('13cA.'	,	'Smokes drugs'													,	'S'	,	'SIMPLE'	)	,
	('13p..'	,	'Smoking cessation milestones'                                  ,	'S'	,	'SIMPLE'	)	,
	('13p0.'	,	'Negotiated date for cessation of smoking'	                    ,	'S'	,	'SIMPLE'	)	,
	('13p4.'	,	'Smoking free weeks'                                            ,	'E'	,	'SIMPLE'	)	,
	('13p5.'	,	'Smoking cessation programme start date'	                	,	'S'	,	'SIMPLE'	)	,
	('13p50'	,	'Practice based smoking cessation programme start date'         ,	'S'	,	'SIMPLE'	)	,
	('13p8.'	,	'Lost to smok cessation fllw-up'                                ,	'S'	,	'SIMPLE'	)	,
	('1V08.'	,	'Smokes drugs in cigarette form'								,	'S'	,	'SIMPLE'	)	,
	('1V09.'	,	'Smokes drugs through a pipe'									,	'S'	,	'SIMPLE'	)	,
	('38DH.'	,	'Fagerstrom test for nicotine dependence'	                    ,	'S'	,	'SIMPLE'	)	,
	('67A3.'	,	'Pregnancy smoking advice'                                      ,	'S'	,	'SIMPLE'	)	,
	('67H1.'	,	'Lifestyle advice regarding smoking'	                        ,	'S'	,	'SIMPLE'	)	,
	('67H6.'	,	'Brief intervention for smoking cessation'	                    ,	'S'	,	'SIMPLE'	)	,
	('745H.'	,	'Smoking cessation therapy'                                     ,	'S'	,	'SIMPLE'	)	,
	('745H0'	,	'Nicotine replacement therapy using nicotine patches'	        ,	'S'	,	'SIMPLE'	)	,
	('745H1'	,	'Nicotine replacement therapy using nicotine gum'	            ,	'S'	,	'SIMPLE'	)	,
	('745H2'	,	'Nicotine replacement therapy using nicotine inhalator'		    ,	'S'	,	'SIMPLE'	)	,
	('745H3'	,	'Nicotine replacement therapy using nicotine lozenges'	        ,	'S'	,	'SIMPLE'	)	,
	('745H4'	,	'Smoking cessation drug therapy'                                ,	'S'	,	'SIMPLE'	)	,
	('745H5'	,	'Varenicline therapy'                                           ,	'S'	,	'SIMPLE'	)	,
	('745Hy'	,	'Other specified smoking cessation therapy'		                ,	'S'	,	'SIMPLE'	)	,
	('745Hz'	,	'Smoking cessation therapy NOS'                                 ,	'S'	,	'SIMPLE'	)	,
	('8B2B.'	,	'Nicotine replacement therapy'                                  ,	'S'	,	'SIMPLE'	)	,
	('8B2B0'	,	'Issue of nicotine replacement therapy voucher'					,	'S'	,	'SIMPLE'	)	,
	('8B31G'	,	'Varenicline smoking cessation therapy offered'					,	'S'	,	'SIMPLE'	)	,
	('8B3f.'	,	'Nicotine replacement therapy provided free'	                ,	'S'	,	'SIMPLE'	)	,
	('8B3Y.'	,	'Over the counter nicotine replacement therapy'		            ,	'S'	,	'SIMPLE'	)	,
	('8BP3.'	,	'Nicotine replacement therapy provided by community pharmacis'	,	'S'	,	'SIMPLE'	)	,
	('8BPh.'	,	'Bupropion therapy'												,	'S'	,	'SIMPLE'	)	,
	('8CAg.'	,	'Smoking cessation advice provided by community pharmacist'		,	'S'	,	'SIMPLE'	)	,
	('8CAL.'	,	'Smoking cessation advice'                                      ,	'S'	,	'SIMPLE'	)	,
	('8CdB.'	,	'Stop smoking service opportunity signposted'	                ,	'S'	,	'SIMPLE'	)	,
	('8H7i.'	,	'Referral to smoking cessation advisor'		                    ,	'S'	,	'SIMPLE'	)	,
	('8HBM.'	,	'Stop smoking face to face follow-up'	                        ,	'S'	,	'SIMPLE'	)	,
	('8HBP.'	,	'Smoking cessation 12 week follow-up'							,	'S'	,	'SIMPLE'	)	,
	('8HkQ.'	,	'Referral to NHS stop smoking service'	                        ,	'S'	,	'SIMPLE'	)	,
	('8HTK.'	,	'Referral to stop-smoking clinic'	                            ,	'S'	,	'SIMPLE'	)	,
	('8I2I.'	,	'Nicotine replacement therapy contraindicated'	                ,	'S'	,	'SIMPLE'	)	,
	('8I2J.'	,	'Bupropion contraindicated'                                     ,	'S'	,	'SIMPLE'	)	,
	('8I39.'	,	'Nicotine replacement therapy refused'	                        ,	'S'	,	'SIMPLE'	)	,
	('8I3M.'	,	'Bupropion refused'                                             ,	'S'	,	'SIMPLE'	)	,
	('8I6H.'	,	'Smoking review not indicated'                                  ,	'S'	,	'SIMPLE'	)	,
	('8IAj.'	,	'Smoking cessation advice declined'		                        ,	'S'	,	'SIMPLE'	)	,
	('8IEK.'	,	'Smoking cessation programme declined'	                        ,	'S'	,	'SIMPLE'	)	,
	('8IEM.'	,	'Smoking cessation drug therapy declined'	                    ,	'S'	,	'SIMPLE'	)	,
	('8IEM0'	,	'Varenicline smoking cessation therapy declined'				,	'S'	,	'SIMPLE'	)	,
	('8IEo.'	,	'Referral to smoking cessation service declined'				,	'S'	,	'SIMPLE'	)	,
	('8T08.'	,	'Referral to smoking cessation service'							,	'S'	,	'SIMPLE'	)	,
	('9hG..'	,	'Exception reporting: smoking quality indicators'	            ,	'S'	,	'SIMPLE'	)	,
	('9hG0.'	,	'Excepted from smoking quality indicators: Patient unsuitable'	,	'S'	,	'SIMPLE'	)	,
	('9hG1.'	,	'Excepted from smoking quality indicators: Informed dissent'	,	'S'	,	'SIMPLE'	)	,
	('9kc..'	,	'Smoking cessation - enhanced services administration'	        ,	'S'	,	'SIMPLE'	)	,
	('9kc0.'	,	'Smoking cessatn monitor template complet - enhanc serv admin'	,	'S'	,	'SIMPLE'	)	,
	('9km..'	,	'Ex-smoker annual review - enhanced services administration'	,	'E'	,	'SIMPLE'	)	,
	('9kn..'	,	'Non-smoker annual review - enhanced services administration'	,	'N'	,	'SIMPLE'	)	,
	('9ko..'	,	'Current smoker annual review - enhanced services admin'	    ,	'S'	,	'SIMPLE'	)	,
	('9N2k.'	,	'Seen by smoking cessation advisor'		                        ,	'S'	,	'SIMPLE'	)	,
	('9N4M.'	,	'DNA - Did not attend smoking cessation clinic'		            ,	'S'	,	'SIMPLE'	)	,
	('9Ndf.'	,	'Consent given for follow-up by smoking cessation team'			,	'S'	,	'SIMPLE'	)	,
	('9Ndg.'	,	'Declined consent for follow-up by smoking cessation team'	    ,	'S'	,	'SIMPLE'	)	,
	('9NdV.'	,	'Consent given follow-up after smoking cessation intervention'	,	'S'	,	'SIMPLE'	)	,
	('9NdW.'	,	'Consent given for smoking cessation data sharing'	            ,	'S'	,	'SIMPLE'	)	,
	('9NdY.'	,	'Declin cons follow-up evaluation after smoking cess interven'	,	'S'	,	'SIMPLE'	)	,
	('9NdZ.'	,	'Declined consent for smoking cessation data sharing'	        ,	'S'	,	'SIMPLE'	)	,
	('9NS02'	,	'Referral for smoking cessation service offered'	            ,	'S'	,	'SIMPLE'	)	,
	('9OO..'	,	'Anti-smoking monitoring admin.'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO1.'	,	'Attends stop smoking monitor.'                                 ,	'S'	,	'SIMPLE'	)	,
	('9OO2.'	,	'Refuses stop smoking monitor'                                  ,	'S'	,	'SIMPLE'	)	,
	('9OO3.'	,	'Stop smoking monitor default'                                  ,	'S'	,	'SIMPLE'	)	,
	('9OO4.'	,	'Stop smoking monitor 1st lettr'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO5.'	,	'Stop smoking monitor 2nd lettr'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO6.'	,	'Stop smoking monitor 3rd lettr'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO7.'	,	'Stop smoking monitor verb.inv.'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO8.'	,	'Stop smoking monitor phone inv'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO9.'	,	'Stop smoking monitoring delete'                                ,	'S'	,	'SIMPLE'	)	,
	('9OOA.'	,	'Stop smoking monitor.chck done'                                ,	'S'	,	'SIMPLE'	)	,
	('9OOB.'	,	'Stop smoking invitation short message service text message'	,	'S'	,	'SIMPLE'	)	,
	('9OOB0'	,	'Stop smoking invitation first SMS text message'	            ,	'S'	,	'SIMPLE'	)	,
	('9OOB1'	,	'Stop smoking invitation second SMS text message'	            ,	'S'	,	'SIMPLE'	)	,
	('9OOB2'	,	'Stop smoking invitation third SMS text message'	            ,	'S'	,	'SIMPLE'	)	,
	('9OOZ.'	,	'Stop smoking monitor admin.NOS'                                ,	'S'	,	'SIMPLE'	)	,
	('du3..'	,	'NICOTINE'                                                      ,	'S'	,	'SIMPLE'	)	,
	('du31.'	,	'NICOTINE 2mg chewing gum'                                      ,	'S'	,	'SIMPLE'	)	,
	('du32.'	,	'NICOTINE 4mg chewing gum'                                      ,	'S'	,	'SIMPLE'	)	,
	('du33.'	,	'NICORETTE 2mg chewing gum'                                     ,	'S'	,	'SIMPLE'	)	,
	('du34.'	,	'NICORETTE 4mg chewing gum'                                     ,	'S'	,	'SIMPLE'	)	,
	('du35.'	,	'NICOTINELL TTS 10 patches'                                     ,	'S'	,	'SIMPLE'	)	,
	('du36.'	,	'NICOTINELL TTS 20 patches'                                     ,	'S'	,	'SIMPLE'	)	,
	('du37.'	,	'NICOTINELL TTS 30 patches'                                     ,	'S'	,	'SIMPLE'	)	,
	('du38.'	,	'NICOTINE 7mg/24hours patches'                                  ,	'S'	,	'SIMPLE'	)	,
	('du39.'	,	'NICOTINE 14mg/24hours patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3a.'	,	'NICORETTE nasal spray'                                         ,	'S'	,	'SIMPLE'	)	,
	('du3A.'	,	'NICOTINE 21mg/24hours patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3B.'	,	'*NICORETTE 5mg patches x7'                                     ,	'S'	,	'SIMPLE'	)	,
	('du3b.'	,	'NICOTINE 10mg/mL nasal spray'                                  ,	'S'	,	'SIMPLE'	)	,
	('du3C.'	,	'*NICORETTE 10mg patches x7'                                    ,	'S'	,	'SIMPLE'	)	,
	('du3c.'	,	'NICOTINELL ORIGINAL 2mg gum'                                   ,	'S'	,	'SIMPLE'	)	,
	('du3D.'	,	'*NICORETTE 15mg patches x7'                                    ,	'S'	,	'SIMPLE'	)	,
	('du3d.'	,	'NICOTINELL MINT 2mg gum'                                       ,	'S'	,	'SIMPLE'	)	,
	('du3E.'	,	'*NICORETTE 15mg patches x28'                                   ,	'S'	,	'SIMPLE'	)	,
	('du3e.'	,	'NICOTINE 10mg inhalator starter pack' 		                    ,	'S'	,	'SIMPLE'	)	,
	('du3f.'	,	'NICOTINE 10mg inhalator refill pack'	                        ,	'S'	,	'SIMPLE'	)	,
	('du3F.'	,	'NICOTINE 5mg/16hours patches'                                  ,	'S'	,	'SIMPLE'	)	,
	('du3g.'	,	'NICORETTE 10mg inhalator starter pack'		                    ,	'S'	,	'SIMPLE'	)	,
	('du3G.'	,	'NICOTINE 10mg/16hours patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3h.'	,	'NICORETTE 10mg inhalator refill pack'	                        ,	'S'	,	'SIMPLE'	)	,
	('du3H.'	,	'NICOTINE 15mg/16hours patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3i.'	,	'NICOTINELL ORIGINAL 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du3I.'	,	'NIQUITIN CQ 2mg original lozenges'		                        ,	'S'	,	'SIMPLE'	)	,
	('du3J.'	,	'*NICABATE 7mg patches x14'                                     ,	'S'	,	'SIMPLE'	)	,
	('du3j.'	,	'NICOTINELL MINT 4mg chewing gum'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3K.'	,	'*NICABATE 14mg patches x14'                                    ,	'S'	,	'SIMPLE'	)	,
	('du3k.'	,	'NIQUITIN CQ 7mg/24hours patches'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3L.'	,	'*NICABATE 21mg patches x14'                                    ,	'S'	,	'SIMPLE'	)	,
	('du3l.'	,	'NIQUITIN CQ 14mg/24hours patches'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3M.'	,	'*NICABATE 7mg patches x7'                                      ,	'S'	,	'SIMPLE'	)	,
	('du3m.'	,	'NIQUITIN CQ 21mg/24hours patches'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3N.'	,	'*NICABATE 14mg patches x7'                                     ,	'S'	,	'SIMPLE'	)	,
	('du3n.'	,	'NICOTINE 2mg sublingual tablets'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3o.'	,	'NICORETTE MICROTAB 2mg sublingual tablets'		                ,	'S'	,	'SIMPLE'	)	,
	('du3O.'	,	'NIQUITIN CQ 7mg/24hours clear patches'		                    ,	'S'	,	'SIMPLE'	)	,
	('du3P.'	,	'*NICABATE 21mg patches x7'                                     ,	'S'	,	'SIMPLE'	)	,
	('du3p.'	,	'*NICOTINE 1mg mint lozenges'                                   ,	'S'	,	'SIMPLE'	)	,
	('du3Q.'	,	'*NICORETTE 15mg patches x3'                                    ,	'S'	,	'SIMPLE'	)	,
	('du3q.'	,	'NICOTINELL MINT 1mg lozenges'                                  ,	'S'	,	'SIMPLE'	)	,
	('du3R.'	,	'*NICONIL-11 patches'                                           ,	'S'	,	'SIMPLE'	)	,
	('du3r.'	,	'NIQUITIN CQ 14mg/24hours clear patches'	                    ,	'S'	,	'SIMPLE'	)	,
	('du3S.'	,	'*NICONIL-22 patches'                                           ,	'S'	,	'SIMPLE'	)	,
	('du3s.'	,	'NIQUITIN CQ 21mg/24hours clear patches'	                    ,	'S'	,	'SIMPLE'	)	,
	('du3T.'	,	'*NICOTINE 11mg/24hours patches'                                ,	'S'	,	'SIMPLE'	)	,
	('du3t.'	,	'NICOTINE 2mg fruit chewing gum'                                ,	'S'	,	'SIMPLE'	)	,
	('du3U.'	,	'*NICOTINE 22mg/24hours patches'                                ,	'S'	,	'SIMPLE'	)	,
	('du3u.'	,	'NICOTINE 4mg fruit chewing gum'                                ,	'S'	,	'SIMPLE'	)	,
	('du3V.'	,	'NICORETTE 2mg mint chewing gum'                                ,	'S'	,	'SIMPLE'	)	,
	('du3v.'	,	'NICOTINE 2mg citrus chewing gum'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3w.'	,	'NICORETTE CITRUS 2mg chewing gum'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3W.'	,	'NICORETTE MINT PLUS 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du3x.'	,	'NICOTINE 1mg lozenges'                                         ,	'S'	,	'SIMPLE'	)	,
	('du3X.'	,	'NICOTINE 2mg mint chewing gum'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3y.'	,	'NICOTINE 2mg lozenges'                                         ,	'S'	,	'SIMPLE'	)	,
	('du3Y.'	,	'NICOTINE 4mg mint chewing gum'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3Z.'	,	'*NICONIL 22 starter pack'                                      ,	'S'	,	'SIMPLE'	)	,
	('du3z.'	,	'NICOTINE 4mg lozenges'                                         ,	'S'	,	'SIMPLE'	)	,
	('du6..'	,	'BUPROPION'                                                     ,	'S'	,	'SIMPLE'	)	,
	('du61.'	,	'ZYBAN 150mg m/r tablets'                                       ,	'S'	,	'SIMPLE'	)	,
	('du6z.'	,	'BUPROPION HYDROCHLORIDE 150mg m/r tablets'		                ,	'S'	,	'SIMPLE'	)	,
	('du7..'	,	'NICOTINE 2'                                                    ,	'S'	,	'SIMPLE'	)	,
	('du71.'	,	'NIQUITIN CQ 4mg original lozenges'		                        ,	'S'	,	'SIMPLE'	)	,
	('du72.'	,	'NIQUITIN CQ 2mg mint chewing gum'	                            ,	'S'	,	'SIMPLE'	)	,
	('du73.'	,	'NIQUITIN CQ 4mg mint chewing gum'	                            ,	'S'	,	'SIMPLE'	)	,
	('du74.'	,	'*NICORETTE 15mg patches x2'                                    ,	'S'	,	'SIMPLE'	)	,
	('du75.'	,	'NICOTINELL 2mg liquorice chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du76.'	,	'NICOTINELL 4mg liquorice chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du77.'	,	'NICOTINELL 2mg mint lozenges'                                  ,	'S'	,	'SIMPLE'	)	,
	('du78.'	,	'NIQUITIN CQ 2mg mint lozenges'                                 ,	'S'	,	'SIMPLE'	)	,
	('du79.'	,	'NIQUITIN CQ 4mg mint lozenges'                                 ,	'S'	,	'SIMPLE'	)	,
	('du7A.'	,	'NICORETTE FRESHMINT 2mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7a.'	,	'NICOTINELL ICEMINT 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7b.'	,	'NICORETTE 15mg inhalator'                                      ,	'S'	,	'SIMPLE'	)	,
	('du7B.'	,	'NICORETTE FRESHMINT 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7c.'	,	'NICOTINE 15mg inhalator'                                       ,	'S'	,	'SIMPLE'	)	,
	('du7C.'	,	'NICOTINELL CLASSIC 2mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7d.'	,	'NICASSIST 7mg/24hours patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du7D.'	,	'NICOTINELL CLASSIC 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7e.'	,	'NICASSIST 14mg/24hours patches'                                ,	'S'	,	'SIMPLE'	)	,
	('du7E.'	,	'NICORETTE FRESHFRUIT 2mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7f.'	,	'NICASSIST 21mg/24hours patches'                                ,	'S'	,	'SIMPLE'	)	,
	('du7F.'	,	'NICORETTE FRESHFRUIT 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7G.'	,	'*NICOPATCH 7mg/24hours patches'                                ,	'S'	,	'SIMPLE'	)	,
	('du7g.'	,	'NICORETTE COOLS 2mg lozenges'                                  ,	'S'	,	'SIMPLE'	)	,
	('du7H.'	,	'NICOPATCH 14mg/24hours patches'	                            ,	'S'	,	'SIMPLE'	)	,
	('du7h.'	,	'NICORETTE COOLS 4mg lozenges'                                  ,	'S'	,	'SIMPLE'	)	,
	('du7I.'	,	'NICOPATCH 21mg/24hours patches'	                            ,	'S'	,	'SIMPLE'	)	,
	('du7i.'	,	'NIQUITIN PRE-QUIT 21mg/24 hours clear patches'		            ,	'S'	,	'SIMPLE'	)	,
	('du7J.'	,	'NICOPASS 1.5mg fresh mint lozenges'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7j.'	,	'NICORETTE FRUITFUSION 2mg chewing gum'		                    ,	'S'	,	'SIMPLE'	)	,
	('du7K.'	,	'NICOPASS 1.5mg liquorice mint lozenges'	                    ,	'S'	,	'SIMPLE'	)	,
	('du7k.'	,	'NICORETTE FRUITFUSION 4mg chewing gum'		                    ,	'S'	,	'SIMPLE'	)	,
	('du7l.'	,	'NICORETTE FRUITFUSION 6mg chewing gum'		                    ,	'S'	,	'SIMPLE'	)	,
	('du7L.'	,	'NIQUITIN PRE-QUIT 4mg mint lozenges'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7M.'	,	'NICORETTE INVISI 10mg patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du7N.'	,	'NICORETTE INVISI 15mg patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du7n.'	,	'NICOTINE 6mg fruit chewing gum'								,	'S'	,	'SIMPLE'	)	,
	('du7O.'	,	'NICORETTE INVISI 25mg patches'									,	'S'	,	'SIMPLE'	)	,
	('du7o.'	,	'NICOTINE 4mg icemint chewing gum'								,	'S'	,	'SIMPLE'	)	,
	('du7P.'	,	'NICORETTE ICY WHITE 2mg chewing gum'							,	'S'	,	'SIMPLE'	)	,
	('du7p.'	,	'NICOTINE 2mg icemint chewing gum'								,	'S'	,	'SIMPLE'	)	,
	('du7Q.'	,	'NICORETTE ICY WHITE 4mg chewing gum' 							,	'S'	,	'SIMPLE'	)	,
	('du7q.'	,	'NICOTINE 1mg oromucosal spray'									,	'S'	,	'SIMPLE'	)	,
	('du7r.'	,	'NICOTINE 1.5mg cherry lozenges'								,	'S'	,	'SIMPLE'	)	,
	('du7R.'	,	'NIQUITIN MINIS MINT 1.5mg lozenges'							,	'S'	,	'SIMPLE'	)	,
	('du7s.'	,	'NICOTINE 4mg cherry lozenges'									,	'S'	,	'SIMPLE'	)	,
	('du7S.'	,	'NIQUITIN MINIS MINT 4mg lozenges'								,	'S'	,	'SIMPLE'	)	,
	('du7T.'	,	'NICORETTE MICROTAB LEMON 2mg sublingual tablets'				,	'S'	,	'SIMPLE'	)	,
	('du7t.'	,	'NICOTINE 15mg/16hours patches and 2mg chewing gum'				,	'S'	,	'SIMPLE'	)	,
	('du7U.'	,	'NICORETTE COMBI 15mg patches and 2mg chewing gum'				,	'S'	,	'SIMPLE'	)	,
	('du7u.'	,	'NICOTINE 1.5mg lozenges'										,	'S'	,	'SIMPLE'	)	,
	('du7v.'	,	'NICOTINE 25mg/16hours patches'									,	'S'	,	'SIMPLE'	)	,
	('du7V.'	,	'NIQUITIN MINIS 1.5mg cherry lozenges'							,	'S'	,	'SIMPLE'	)	,
	('du7w.'	,	'NICOTINE 1.5mg fresh mint lozenges'							,	'S'	,	'SIMPLE'	)	,
	('du7W.'	,	'NIQUITIN MINIS 4mg cherry lozenges'							,	'S'	,	'SIMPLE'	)	,
	('du7X.'	,	'NICORETTE FRESHMINT 2mg lozenges'								,	'S'	,	'SIMPLE'	)	,
	('du7x.'	,	'NICOTINE 1.5mg liquorice mint lozenges'						,	'S'	,	'SIMPLE'	)	,
	('du7Y.'	,	'NICORETTE QUICKMIST 1mg oromucosal spray'						,	'S'	,	'SIMPLE'	)	,
	('du7y.'	,	'NICOTINE 4mg liquorice chewing gum'							,	'S'	,	'SIMPLE'	)	,
	('du7z.'	,	'NICOTINE 2mg liquorice chewing gum'							,	'S'	,	'SIMPLE'	)	,
	('du7Z.'	,	'NICOTINELL ICEMINT 2mg chewing gum'							,	'S'	,	'SIMPLE'	)	,
	('du8..'	,	'VARENICLINE'													,	'S'	,	'SIMPLE'	)	,
	('du81.'	,	'CHAMPIX 1mg tablets'											,	'S'	,	'SIMPLE'	)	,
	('du82.'	,	'CHAMPIX 500microgram tablets'									,	'S'	,	'SIMPLE'	)	,
	('du83.'	,	'CHAMPIX TREATMENT INITIATION pack'								,  	'S'	,	'SIMPLE'	)	,
	('du8x.'	,	'VARENICLINE 500micrograms+1mg tablets'							,  	'S'	,	'SIMPLE'	)	,
	('du8y.'	,	'VARENICLINE 500microgram tablets'								,	'S'	,	'SIMPLE'	)	,
	('du8z.'	,	'VARENICLINE 1mg tablets'										,	'S'	,	'SIMPLE'	)	,
	('du9..'	,	'NICOTINE WITHDRAWAL PRODUCTS'									,	'S'	,	'SIMPLE'	)	,
	('du91.'	,	'NICOBREVIN capsules'											,	'S'	,	'SIMPLE'	)	,
	('duB1.'	,	'NIQUITIN STRIPS 2.5mg mint oral film'							,	'S'	,	'SIMPLE'	)	,
	('duB2.'	,	'NIQUITIN MINIS 1.5mg orange lozenges'							,	'S'	,	'SIMPLE'	)	,
	('duB3.'	,	'NICOTINELL SUPPORT ICEMINT 2mg chewing gum'					,	'S'	,	'SIMPLE'	)	,
	('duB4.'	,	'NICOTINELL SUPPORT ICEMINT 4mg chewing gum'					,	'S'	,	'SIMPLE'	)	,
	('duBz.'	,	'NICOTINE 2.5mg oral film'										,	'S'	,	'SIMPLE'	)	,
	('E023.'	,	'Nicotine withdrawal'											,  	'S'	,	'SIMPLE'	)	,
	('E251.'	,	'Tobacco dependence'											,	'S'	,	'SIMPLE'	)	,
	('E2510'	,	'Tobacco dependence, unspecified'								,	'S'	,	'SIMPLE'	)	,
	('E2511'	,	'Tobacco dependence, continuous'								,	'S'	,	'SIMPLE'	)	,
	('E2512'	,	'Tobacco dependence, episodic'									,	'S'	,	'SIMPLE'	)	,
	('E2513'	,	'Tobacco dependence in remission'								,	'S'	,	'SIMPLE'	)	,
	('E251z'	,	'Tobacco dependence NOS'										,	'S'	,	'SIMPLE'	)	,
	('J0364'	,	'Tobacco deposit on teeth'										,	'S'	,	'SIMPLE'	)	,
	('SMC..'	,	'Toxic effect of tobacco and nicotine'							,	'S'	,	'SIMPLE'	)	,
	('U6099'	,	'[X]Bupropion causing adverse effects in therapeutic use'		,	'S'	,	'SIMPLE'	)	,
	('ZV4K0'	,	'[V]Tobacco use'												,	'S'	,	'SIMPLE'	)	,
	('ZV6D8'	,	'[V]Tobacco abuse counselling'									,	'S'	,	'SIMPLE'	)
	;
COMMIT;

CALL SYSPROC.ADMIN_CMD('runstats on table SAILW0972V.V2_SMOKER_LOOKUP with distribution and detailed indexes all'); -- makes tables compatible with all functions e.g. avg etc

COMMIT;

--check
SELECT * FROM SAILW0972V.V2_SMOKER_LOOKUP;

--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
----------------------------- Expand the user table ----------------------------

-- this expands the user table to include EVENT_ details for the ALFs specified

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_input_USER_smoking');
CREATE TABLE sailW0972V.V2_input_USER_smoking
(
 	    patient_id          BIGINT,
        alf_sts_cd      INTEGER,
        diag_date		DATE,
        event_dt        DATE,
        event_cd        CHAR(100),
        event_val		DECIMAL(31,8)
)
DISTRIBUTE BY HASH (PATIENT_ID); --previously was best practise, but might be outdated now
COMMIT;
GRANT ALL ON TABLE SAILW0972V.V2_input_USER_smoking TO ROLE NRDASAIL_SAIL_0972_ANALYST; --granting access to team mates
alter table SAILW0972V.V2_input_USER_smoking activate not logged INITIALLY; --worth doing for large chunks of data

insert into SAILW0972V.V2_input_USER_smoking
select
 	    distinct
        US.ALF_PE,
        GP.ALF_STS_CD,
        US.DIAG_DATE,
        GP.EVENT_DT,
        GP.EVENT_CD,
        GP.EVENT_VAL
FROM    
(
	SELECT * FROM SAILW0972V.V2_gp_database
		 WHERE
    		ALF_PE IS NOT NULL
		AND
		    event_cd is not NULL
		AND
		    event_DT is not NULL
		AND
			event_DT >= DATE('2000-01-01')
		AND
			event_DT < CURRENT_DATE	
)	gp	
RIGHT OUTER JOIN
(
	SELECT * FROM SAILW0972V.V2_input_USER_table
) US
	ON
	(GP.ALF_PE = US.ALF_PE)

	;
COMMIT;
CALL SYSPROC.ADMIN_CMD('runstats on table SAILW0972V.V2_input_USER_smoking with distribution and detailed indexes all'); -- makes tables compatible with all functions e.g. avg etc
COMMIT;

SELECT * FROM SAILW0972V.V2_INPUT_USER_SMOKING;

--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-------- Create event table that combines lookup table and user table ----------

-- combines selected tables using the variables declared above


--DROP TABLE SAILW0972V.V2_GP_SMOKE_EVENT;
CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_GP_SMOKE_EVENT');

CREATE TABLE sailW0972V.V2_gp_smoke_event
(
        patient_id 		        BIGINT,
        alf_sts_cd		        INTEGER,
        diag_date				DATE,
        event_dt  		        VARCHAR(10),
        event_cd  		        CHAR(6),
        complexity				VARCHAR(20),
        event_val				DECIMAL(31,8),
        description  		    VARCHAR(300),
        smoking_status 			VARCHAR(1),
        diff_day				INTEGER, -- this is the difference between the diagnosis date and the event date
        row_seq					INTEGER, -- ranks the event dates in order from most recent per ALF
        dd_minus_smoker_period	DATE, -- diagnosis date - the ex-smoker cutoff period
        ss_during_cutoff		VARCHAR(20), -- whether or not there is a smoker recording during the period above
        ever_smoked				CHAR(1)
)
DISTRIBUTE BY HASH (patient_id); --previously was best practise, but might be outdated now
COMMIT;

--granting access to team mates
GRANT ALL ON TABLE SAILW0972V.V2_GP_SMOKE_EVENT TO ROLE NRDASAIL_SAIL_0972_ANALYST;

--worth doing for large chunks of data
alter table SAILW0972V.V2_GP_SMOKE_EVENT activate not logged INITIALLY;

insert into SAILW0972V.V2_GP_SMOKE_EVENT
SELECT DISTINCT 	PATIENT_ID,
					ALF_STS_CD,
					DIAG_DATE,
					EVENT_DT,
					EVENT_CD,
					COMPLEXITY,
					EVENT_VAL,
					DESCRIPTION,
					SMOKING_STATUS,
					DIFF_DAY,
					ROW_NUMBER() OVER(PARTITION BY PATIENT_ID ORDER BY DIFF_DAY), -- ranks the event dates in order from most recent per ALF
					DD_MINUS_SMOKER_PERIOD, -- diagnosis date - the ex-smoker cutoff period
					CASE 	WHEN SMOKING_STATUS = 'S'
							AND EVENT_DT BETWEEN DATE(DD_MINUS_SMOKER_PERIOD) AND DATE(DIAG_DATE) THEN 'S'
							ELSE NULL END AS SS_DURING_CUTOFF,
							-- assigns smoker status to anyone with a smoker recording during the period above
					CASE 	WHEN SAILW0972V.V2_input_smoking_date_cutoff <> 'NULL' THEN
								(CASE	WHEN SMOKING_STATUS = 'S' AND EVENT_DT<= SAILW0972V.V2_input_smoking_date_cutoff THEN '1'
										WHEN SMOKING_STATUS = 'E' AND EVENT_DT<= SAILW0972V.V2_input_smoking_date_cutoff THEN '1'
										ELSE NULL
										END)
							WHEN SAILW0972V.V2_input_smoking_date_cutoff = 'NULL' THEN
								(CASE	WHEN SMOKING_STATUS = 'S' AND EVENT_DT<= DIAG_DATE THEN '1'
										WHEN SMOKING_STATUS = 'E' AND EVENT_DT<= DIAG_DATE THEN '1'
										ELSE NULL
										END)
							END AS EVER_SMOKED
				FROM
(select
    distinct
        PATIENT_ID,
        STS.ALF_STS_CD,
        US.DIAG_DATE,
		US.EVENT_DT,
		US.EVENT_CD,
        US.EVENT_VAL,
        LU.DESCRIPTION,
		CASE	WHEN (COMPLEXITY = 'EVENT_VAL DEPENDENT' AND EVENT_VAL > 0) THEN 'S'
				WHEN (COMPLEXITY = 'EVENT_VAL DEPENDENT' AND EVENT_VAL = '0') THEN NULL
				WHEN (COMPLEXITY = 'EVENT_VAL DEPENDENT' AND EVENT_VAL IS NULL) THEN NULL
				ELSE LU.SMOKING_STATUS
				END AS SMOKING_STATUS, -- These cases are only classed as smoker when event_val > 0, otherwise they are unknown
		LU.COMPLEXITY,
		DAYS(US.DIAG_DATE) - DAYS(US.EVENT_DT) AS DIFF_DAY, -- this is the difference between the diagnosis date and the event date
		US.DIAG_DATE - SAILW0972V.V2_ex_smoker_cutoff AS DD_MINUS_SMOKER_PERIOD -- ex smoker classification cutoff
FROM    SAILW0972V.V2_input_USER_smoking US -- extract data from user table
RIGHT OUTER JOIN
(
	SELECT * FROM SAILW0972V.V2_SMOKER_LOOKUP
) LU --extract data from Look up table (read codes)
	ON
	(US.EVENT_CD = LU.SM_CODE)
RIGHT OUTER JOIN
(
	SELECT * FROM SAILW0972V.V2_ALF_STS_CD_SMOKING
) STS -- limit results to those that have the desired STS codes (default is 1, 4, 39)
	ON
	(US.ALF_STS_CD = STS.ALF_STS_CD)
 WHERE
    PATIENT_ID IS NOT NULL
AND  -- restrict to events before diagnosis
	CASE	WHEN SAILW0972V.V2_input_smoking_date_cutoff <> 'NULL' THEN US.DIAG_DATE <= SAILW0972V.V2_input_smoking_date_cutoff -- only extract cases where diagnosis date is before the cutoff
			WHEN SAILW0972V.V2_input_smoking_date_cutoff = 'NULL' THEN US.DIAG_DATE = US.DIAG_DATE
			END
AND --restrict to events before the cutoff
	CASE	WHEN SAILW0972V.V2_input_smoking_date_cutoff = 'NULL' THEN US.EVENT_DT <= US.DIAG_DATE
			WHEN SAILW0972V.V2_input_smoking_date_cutoff <> 'NULL' THEN US.EVENT_DT <= SAILW0972V.V2_input_smoking_date_cutoff
			END
GROUP BY PATIENT_ID, EVENT_DT, EVENT_CD, STS.ALF_STS_CD, DIAG_DATE, EVENT_VAL, DESCRIPTION, SMOKING_STATUS, COMPLEXITY -- not entirely sure if necessary?
ORDER BY PATIENT_ID, EVENT_DT, EVENT_CD, STS.ALF_STS_CD, DIAG_DATE, EVENT_VAL, DESCRIPTION, SMOKING_STATUS, COMPLEXITY
)
 WHERE DIFF_DAY >= 0 	-- limit data to entries with event_dt before diagnosis date
					-- IF YOU WANT TO CHANGE TO ENTRIES AFTER DIAGNOSIS REPLACE WITH 'DIFF_DAY < 0'
    ;
COMMIT;

--update GP smoking table to add ever smoked

alter table SAILW0972V.V2_GP_SMOKE_EVENT
ADD COLUMN EVER_SMOKED_SUM INTEGER;

UPDATE SAILW0972V.V2_GP_SMOKE_EVENT
SET EVER_SMOKED_SUM  = CASE WHEN SUM(EVER_SMOKED) OVER(PARTITION BY PATIENT_ID) IS NOT NULL
								THEN SUM(EVER_SMOKED) OVER(PARTITION BY PATIENT_ID)
									ELSE 0
							END;

CALL SYSPROC.ADMIN_CMD('runstats on table SAILW0972V.V2_GP_SMOKE_EVENT with distribution and detailed indexes all'); -- makes tables compatible with all functions e.g. avg etc

COMMIT;

--checks
SELECT * FROM SAILW0972V.V2_GP_SMOKE_EVENT
GROUP BY PATIENT_ID, EVENT_DT, EVENT_CD, ALF_STS_CD, DIAG_DATE, EVENT_VAL, COMPLEXITY, DESCRIPTION, SMOKING_STATUS, DIFF_DAY, ROW_SEQ, DD_MINUS_SMOKER_PERIOD, SS_DURING_CUTOFF,EVER_SMOKED, EVER_SMOKED_SUM
ORDER BY PATIENT_ID, DIFF_DAY;

SELECT DISTINCT ALF_STS_CD FROM SAILW0972V.V2_GP_SMOKE_EVENT;
SELECT MIN(EVENT_DT) AS MIN_EVENT_DT, MAX(EVENT_DT) AS MAX_EVENT_DT, MIN(DIAG_DATE) AS MIN_DIAG_DT, MAX(DIAG_DATE) AS MAX_DIAG_DT FROM SAILW0972V.V2_GP_SMOKE_EVENT;
-- SELECT * FROM SAILW0972V.V2_GP_SMOKE_EVENT WHERE DIAG_DATE < EVENT_DT; -- check to see if the recorded events are within your specified time frame

-----------------------------------------------------------------------------
--identify same day smoking category mismatches and set to smoking status unclear

--Multi smoking categories

CALL FNC.DROP_IF_EXISTS('SAILW0972V.VB_MULTI_SMOK_CAT_MI');

CREATE TABLE SAILW0972V.VB_MULTI_SMOK_CAT_MI AS
(SELECT PATIENT_ID, DIAG_DATE, EVENT_DT FROM SAILW0972V.V2_GP_SMOKE_EVENT OP)
WITH NO DATA;

INSERT INTO SAILW0972V.VB_MULTI_SMOK_CAT_MI
(SELECT PATIENT_ID, DIAG_DATE, EVENT_DT FROM
(SELECT DISTINCT PATIENT_ID,
				DIAG_DATE,
				EVENT_DT, 
				CASE WHEN SS_DURING_CUTOFF = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'E' THEN 'E'
					WHEN SMOKING_STATUS = 'N' AND EVER_SMOKED_SUM > 0 THEN 'E' -- if ALF has ever been recorded as smoker or ex smoker, then sum(ever_smoker) > 0
					WHEN SMOKING_STATUS IS NULL THEN NULL
						ELSE 'N'
							END	AS SMOKER_STATUS
			FROM SAILW0972V.V2_GP_SMOKE_EVENT OP
ORDER BY PATIENT_ID, EVENT_DT)
GROUP BY PATIENT_ID, DIAG_DATE, EVENT_DT
HAVING COUNT(PATIENT_ID||DIAG_DATE||EVENT_DT) > 1);

-------------------------------------------------------------------------------------------------
--Single smoking categories
CALL FNC.DROP_IF_EXISTS('SAILW0972V.VB_SINGLE_SMOK_CAT_MI');

CREATE TABLE SAILW0972V.VB_SINGLE_SMOK_CAT_MI AS
(SELECT PATIENT_ID, DIAG_DATE, EVENT_DT FROM SAILW0972V.V2_GP_SMOKE_EVENT OP)
WITH NO DATA;

INSERT INTO SAILW0972V.VB_SINGLE_SMOK_CAT_MI
(SELECT PATIENT_ID, DIAG_DATE, EVENT_DT FROM
(SELECT DISTINCT PATIENT_ID,
				DIAG_DATE,
				EVENT_DT, 
				CASE WHEN SS_DURING_CUTOFF = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'E' THEN 'E'
					WHEN SMOKING_STATUS = 'N' AND EVER_SMOKED_SUM > 0 THEN 'E' -- if ALF has ever been recorded as smoker or ex smoker, then sum(ever_smoker) > 0
					WHEN SMOKING_STATUS IS NULL THEN NULL
						ELSE 'N'
							END	AS SMOKER_STATUS
			FROM SAILW0972V.V2_GP_SMOKE_EVENT OP
ORDER BY PATIENT_ID, EVENT_DT)
GROUP BY PATIENT_ID, DIAG_DATE, EVENT_DT
HAVING COUNT(PATIENT_ID||DIAG_DATE||EVENT_DT) = 1);

-----------------------------------------------------------------------------
-----------------------------------------------------------------------------
----------------------- Create Output table ---------------------------------

-- table takes data from the EVENT table and record one smoker status per ALF,
-- rewriting the status where necessary based on their smoking history within
-- the cutoff period

--DROP TABLE SAILW0972V.V2_GP_SMOKE_EVENT;
CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_SMOKER_OUTPUT_MI_PRE');

CREATE TABLE SAILW0972V.V2_VB_SMOKER_OUTPUT_MI_PRE
(
        patient_id    		    	    BIGINT,
        diag_date					DATE,
        event_dt					DATE,
        smoking_status 				CHAR(1),
        smoking_status_description	VARCHAR(15)
)
DISTRIBUTE BY HASH (PATIENT_ID);--previously was best practise, but might be outdated now

COMMIT;

--granting access to team mates
GRANT ALL ON TABLE SAILW0972V.V2_VB_SMOKER_OUTPUT_MI_PRE TO ROLE NRDASAIL_SAIL_0972_ANALYST;

--worth doing for large chunks of data
alter table SAILW0972V.V2_VB_SMOKER_OUTPUT_MI_PRE activate not logged INITIALLY;

--Insert no smoking category mismatches
INSERT INTO SAILW0972V.V2_VB_SMOKER_OUTPUT_MI_PRE
SELECT PATIENT_ID,
	DIAG_DATE,
	EVENT_DT,
	CASE WHEN SS_DURING_CUTOFF = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'E' THEN 'E'
					WHEN SMOKING_STATUS = 'N' AND EVER_SMOKED_SUM > 0 THEN 'E' -- if ALF has ever been recorded as smoker or ex smoker, then sum(ever_smoker) > 0
					WHEN SMOKING_STATUS IS NULL THEN NULL
						ELSE 'N'
							END	AS SMOKING_STATUS,
	CASE WHEN SS_DURING_CUTOFF = 'S' THEN 'SMOKER'
					WHEN SMOKING_STATUS = 'S' THEN 'SMOKER'
					WHEN SMOKING_STATUS = 'E' THEN 'EX-SMOKER'
					WHEN SMOKING_STATUS = 'N' AND EVER_SMOKED_SUM > 0 THEN 'EX-SMOKER' -- if ALF has ever been recorded as smoker or ex smoker, then sum(ever_smoker) > 0
					WHEN SMOKING_STATUS IS NULL THEN NULL
						ELSE 'NEVER SMOKED'
							END AS SMOKER_STATUS_DESCRIPTION
FROM SAILW0972V.V2_GP_SMOKE_EVENT AS OP
WHERE OP.PATIENT_ID||OP.DIAG_DATE||OP.EVENT_DT
IN (SELECT SI.PATIENT_ID||SI.DIAG_DATE||SI.EVENT_DT FROM SAILW0972V.VB_SINGLE_SMOK_CAT_MI AS SI);

--Insert smoking category mismatches
INSERT INTO SAILW0972V.V2_VB_SMOKER_OUTPUT_MI_PRE
SELECT PATIENT_ID,
	DIAG_DATE,
	EVENT_DT,
	'U',
	'UNCLEAR'
FROM SAILW0972V.V2_GP_SMOKE_EVENT AS OP
WHERE OP.PATIENT_ID||OP.DIAG_DATE||OP.EVENT_DT
IN (SELECT SI.PATIENT_ID||SI.DIAG_DATE||SI.EVENT_DT FROM SAILW0972V.VB_MULTI_SMOK_CAT_MI AS SI);


ALTER TABLE SAILW0972V.V2_VB_SMOKER_OUTPUT_MI_PRE
ADD COLUMN ROW_SEQ INTEGER;

UPDATE SAILW0972V.V2_VB_SMOKER_OUTPUT_MI_PRE
SET ROW_SEQ = ROW_NUMBER() OVER(PARTITION BY PATIENT_ID ORDER BY EVENT_DT desc);

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_SMOKER_OUTPUT_MI');

CREATE TABLE SAILW0972V.V2_VB_SMOKER_OUTPUT_MI
(
        patient_id    		    	BIGINT,
        diag_date					DATE,
        smoking_status 				CHAR(1),
        smoking_status_description	VARCHAR(15)
)
DISTRIBUTE BY HASH (PATIENT_ID);

COMMIT;

INSERT INTO SAILW0972V.V2_VB_SMOKER_OUTPUT_MI
SELECT PATIENT_ID, DIAG_DATE, SMOKING_STATUS, SMOKING_STATUS_DESCRIPTION FROM SAILW0972V.V2_VB_SMOKER_OUTPUT_MI_PRE
WHERE ROW_SEQ = 1;

SELECT COUNT(DISTINCT PATIENT_ID) AS ORIGINAL_DATASET_COUNT FROM SAILW0972V.V2_input_USER_smoking;
SELECT COUNT(DISTINCT PATIENT_ID) AS OUTPUT_TABLE_COUNT FROM SAILW0972V.V2_VB_SMOKER_OUTPUT_MI;
SELECT COUNT(PATIENT_ID), SMOKING_STATUS FROM SAILW0972V.V2_VB_SMOKER_OUTPUT_MI
GROUP BY SMOKING_STATUS;	
	
-------------------------------------------------------------------------------------------------	
	
/* update MI cohort table with smoker status */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN SMOKING_STATUS_DESCRIPTION VARCHAR(30);

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SAILW0972V.V2_VB_SMOKER_OUTPUT_MI AS smi
		ON fe.ALF_PE = smi.PATIENT_ID
			WHEN MATCHED THEN
				UPDATE
				SET fe.SMOKING_STATUS_DESCRIPTION = smi.SMOKING_STATUS_DESCRIPTION
			;

-----------------------------------------------------------
-----------------------------------------------------------		
-----------------------------------------------------------
--smoking algorithm
--BY:       s.j.aldridge@swansea.ac.uk
--aim:      to get smoking cohort ready
-----------------------------------------------------------

-- This is an algorithm to assign smoker status of your ALFs of interest using
-- a built in classification table based off of the individuals GP records
-- The smoker statuses are N - Never smoker, E - ex-smoker and S - current smoker
-- A detailed documentation of instructions can be found in the README of the Smoking_algorithm repository


-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
---------------------------- declare variables --------------------------------

---define variables here:

-- STEP 1 --
	-- find and replace all instances of "nnnn" to your project code (e.g. 1234)
	-- using ctrl + f


-- STEP 2 --
--	create a user table specifying your ALF_PEs, their diagnosis dates (DIAG_DATE).

------------Change from temp to proper table-----

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_STROKE_COHORT_ALF_DATE');

CREATE TABLE SAILW0972V.V2_VB_STROKE_COHORT_ALF_DATE
	(	ALF_PE VARCHAR(20),
		DIAG_DATE DATE);

INSERT INTO SAILW0972V.V2_VB_STROKE_COHORT_ALF_DATE
	SELECT	fe.ALF_PE,
			fe.FIRST_EPI_STR_DT
		FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
;

--	An example code for creating this table can be found in the example folder
CREATE OR REPLACE ALIAS SAILW0972V.V2_input_USER_table FOR SAILW0972V.V2_VB_STROKE_COHORT_ALF_DATE; -- change to user table

-- STEP 3 --
	--- Specify your GP table
	--- This algorithm will expand your input table to obtain the necessary details needed to run the algorithm, these
	--- are sourced from a GP table. Please specify the table you'd like to use.
CREATE OR REPLACE ALIAS SAILW0972V.V2_gp_database FOR SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301; 


-- STEP 4 --
	--- Specify your ALF format
	--- The DEFAULT is ALF_PE, but if yours is different, please REPLACE all "ALF_PE" with your format
	

-- STEP 5 --
	-- specify for which timepoint you want your smoker status to be assigned at,
	-- smoker status at point of diagnosis, up until a defined cut-off date (STEP 4)
	-- is the default.
	-- OPTION 1 - gives smoker-status at your specified cut-off date, regardless of diagnosis date
	-- OPTION 2 - gives smoker_status between diagnosis date and your cut-off date
	-- OPTION 3 - gives most recent smoker status with cut-off applied to DIAG_DATE
	--			- gives smoker status after DIAG_DATE (if using DIAG_DATE as your cut-off i.e. NULL setting from STEP 4)
	-- See the readme for details and instructions on how to implement each option.


-- STEP 6 --
	--- Specify your cutoff date (formatted as 'YYYY-MM-DD'): un-comment 6b and replace it with your date,
	--- or use 6a with 'NULL' to obtain smoker status at the point of diagnosis.
	--- NULL is the DEFAULT setting
	--6a
CREATE OR REPLACE VARIABLE SAILW0972V.V2_input_smoking_date_cutoff VARCHAR(100) DEFAULT 'NULL';
	--6b
-- CREATE OR REPLACE VARIABLE SAILW0972V.V2_input_smoking_date_cutoff VARCHAR(100) DEFAULT 'NULL';


-- STEP 7 --
	--- assign time since last smoker recording until you are happy to classify as 'ex-smoker' in days. i.e. an individual can't have
	---	been recorded a smoker for at least this period of time in the run up to the cut-off date for the algorithm to assign
	--- them as an ex-smoker
	--- DEFAULT is 180 days - approx 6 months
CREATE OR REPLACE VARIABLE SAILW0972V.V2_ex_smoker_cutoff INTEGER DEFAULT 540;


-- STEP 8 --
	---desired ALF_STS_CDs - specify the ALF STS codes wanted for inclusion, default is 1, 4 and 39.
	---If you want more codes included, add the values to this table
CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_ALF_STS_CD_SMOKING');
CREATE TABLE SAILW0972V.V2_ALF_STS_CD_SMOKING
	(ALF_STS_CD	BIGINT);
COMMIT;
INSERT INTO SAILW0972V.V2_ALF_STS_CD_SMOKING
VALUES (1), (4), (39); -- remove or add additional codes to this line using the same format
COMMIT;
SELECT * FROM SAILW0972V.V2_ALF_STS_CD_SMOKING;


-- STEP 9 --
	--- The read codes for smoker status have been determined in the development of this algorithm and do not require input.
	--- *However*, if you'd like to edit this table, do so in the section titled "Create look up table".
	--- If you'd like to supply a new table of your own, comment out the "Create look up table" section and insert a reference to your own table below
-- CREATE OR REPLACE ALIAS SAILW0972V.V2_SMOKER_LOOKUP FOR SAILW0972V.V2_YOUR_LOOK_UP_TABLE_GOES_HERE;


-- STEP 10 --
	-- Select all (Ctrl A) and run this algorithm (right click, execute --> Execute SQL script)


-- STEP 11 --
	-- results are generated to the output table SAILW0972V.V2_VB_SMOKER_OUTPUT_MI and feature
	-- the PATIENT_ID, SMOKER STATUS and SMOKER STATUS DESCRIPTION
	
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-------------------------- Create look up table --------------------------------

-- This is an updated list of read codes put together by SA based on the codes published by MH,
-- and with the guidance of AA, FT and RL (June 2021)

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_SMOKER_LOOKUP');

CREATE TABLE sailW0972V.V2_smoker_lookup
(
        sm_code         CHAR(6),
        description		VARCHAR(300),
        smoking_status  VARCHAR(1),
        complexity		VARCHAR(20)
)
DISTRIBUTE BY HASH (sm_code); --previously was best practise, but might be outdated now
COMMIT;

--granting access to team mates
GRANT ALL ON TABLE SAILW0972V.V2_SMOKER_LOOKUP TO ROLE NRDASAIL_SAIL_0972_ANALYST;

--worth doing for large chunks of data
alter table SAILW0972V.V2_SMOKER_LOOKUP activate not logged INITIALLY;

--inserting read codes relevent to smoking
insert into SAILW0972V.V2_SMOKER_LOOKUP
	(sm_code, description, smoking_status, complexity)
VALUES
	('1371.'	,	'Never smoked tobacco'											,	'N'	,	'SIMPLE'	)	,
	('1372.'	,	'Trivial smoker - < 1 cig/day'									,	'S'	,	'SIMPLE'	)	,
	('1373.'	,	'Light smoker - 1-9 cigs/day'									,	'S'	,	'SIMPLE'	)	,
	('1374.'	,	'Moderate smoker - 10-19 cigs/d'								,	'S'	,	'SIMPLE'	)	,
	('1375.'	,	'Heavy smoker - 20-39 cigs/day'									,	'S'	,	'SIMPLE'	)	,
	('1376.'	,	'Very heavy smoker - 40+cigs/d'									,	'S'	,	'SIMPLE'	)	,
	('1377.'	,	'Ex-trivial smoker (<1/day)'									,	'E'	,	'SIMPLE'	)	,
	('1378.'	,	'Ex-light smoker (1-9/day)'										,	'E'	,	'SIMPLE'	)	,
	('1379.'	,	'Ex-moderate smoker (10-19/day)'								,	'E'	,	'SIMPLE'	)	,
	('6791.'	,	'Health ed. - smoking'											,	'S'	,	'SIMPLE'	)	,
	('67910'	,	'Health education - parental smoking'							,	'S'	,	'SIMPLE'	)	,
	('137..'	,	'Tobacco consumption'											,	'S'	,	'EVENT_VAL DEPENDENT'	),
	('137A.'	,	'Ex-heavy smoker (20-39/day)'									,	'E'	,	'SIMPLE'	)	,
	('137a.'	,	'Pipe tobacco consumption'										,	'S'	,	'SIMPLE'	)	,
	('137B.'	,	'Ex-very heavy smoker (40+/day)'								,	'E'	,	'SIMPLE'	)	,
	('137b.'	,	'Ready to stop smoking'											,	'S'	,	'SIMPLE'	)	,
	('137C.'	,	'Keeps trying to stop smoking'									,	'S'	,	'SIMPLE'	)	,
	('137c.'	,	'Thinking about stopping smoking'								,	'S'	,	'SIMPLE'	)	,
	('137D.'	,	'Admitted tobacco cons untrue ?'								,	'S'	,	'SIMPLE'	)	,
	('137d.'	,	'Not interested in stopping smoking'							,	'S'	,	'SIMPLE'	)	,
	('137e.'	,	'Smoking restarted'												,	'S'	,	'SIMPLE'	)	,
	('137E.'	,	'Tobacco consumption unknown'									,	'S'	,	'EVENT_VAL DEPENDENT'	),
	('137F.'	,	'Ex-smoker - amount unknown'									,	'E'	,	'SIMPLE'	)	,
	('137f.'	,	'Reason for restarting smoking'									,	'S'	,	'SIMPLE'	)	,
	('137G.'	,	'Trying to give up smoking'										,	'S'	,	'SIMPLE'	)	,
	('137g.'	,	'Cigarette pack-years'											,	'S'	,	'EVENT_VAL DEPENDENT'	),
	('137h.'	,	'Minutes from waking to first tobacco consumption'				,	'S'	,	'SIMPLE'	)	,
	('137H.'	,	'Pipe smoker'													,	'S'	,	'SIMPLE'	)	,
	('137j.'	,	'Ex-cigarette smoker'											,	'E'	,	'SIMPLE'	)	,
	('137J.'	,	'Cigar smoker'													,	'S'	,	'SIMPLE'	)	,
	('137K.'	,	'Stopped smoking'												,	'E'	,	'SIMPLE'	)	,
	('137K0'	,	'Recently stopped smoking'										,	'E'	,	'SIMPLE'	)	,
	('137l.'	,	'Ex roll-up cigarette smoker'									,	'E'	,	'SIMPLE'	)	,
	('137L.'	,	'Current non-smoker'											,	'N'	,	'SIMPLE'	)	,
	('137m.'	,	'Failed attempt to stop smoking'								,	'S'	,	'SIMPLE'	)	,
	('137M.'	,	'Rolls own cigarettes'                                 			,	'S'	,	'SIMPLE'	)	,
	('137N.'	,	'Ex pipe smoker'                                        		,	'E'	,	'SIMPLE'	)	,
	('137O.'	,	'Ex cigar smoker'                                               ,	'E'	,	'SIMPLE'	)	,
	('137P.'	,	'Cigarette smoker'                                    			,	'S'	,	'SIMPLE'	)	,
	('137Q.'	,	'Smoking started'                                               ,	'S'	,	'SIMPLE'	)	,
	('137R.'	,	'Current smoker'                                                ,	'S'	,	'SIMPLE'	)	,
	('137S.'	,	'Ex smoker'                                                     ,	'E'	,	'SIMPLE'	)	,
	('137T.'	,	'Date ceased smoking'                                           ,	'E'	,	'SIMPLE'	)	,
	('137V.'	,	'Smoking reduced'                                               ,	'S'	,	'SIMPLE'	)	,
	('137X.'	,	'Cigarette consumption'                                         ,	'S'	,	'EVENT_VAL DEPENDENT'	)	,
	('137Y.'	,	'Cigar consumption'                                             ,	'S'	,	'EVENT_VAL DEPENDENT'	)	,
	('137Z.'	,	'Tobacco consumption NOS'                                       ,	'S'	,	'EVENT_VAL DEPENDENT'	)	,
	('13cA.'	,	'Smokes drugs'													,	'S'	,	'SIMPLE'	)	,
	('13p..'	,	'Smoking cessation milestones'                                  ,	'S'	,	'SIMPLE'	)	,
	('13p0.'	,	'Negotiated date for cessation of smoking'	                    ,	'S'	,	'SIMPLE'	)	,
	('13p4.'	,	'Smoking free weeks'                                            ,	'E'	,	'SIMPLE'	)	,
	('13p5.'	,	'Smoking cessation programme start date'	                	,	'S'	,	'SIMPLE'	)	,
	('13p50'	,	'Practice based smoking cessation programme start date'         ,	'S'	,	'SIMPLE'	)	,
	('13p8.'	,	'Lost to smok cessation fllw-up'                                ,	'S'	,	'SIMPLE'	)	,
	('1V08.'	,	'Smokes drugs in cigarette form'								,	'S'	,	'SIMPLE'	)	,
	('1V09.'	,	'Smokes drugs through a pipe'									,	'S'	,	'SIMPLE'	)	,
	('38DH.'	,	'Fagerstrom test for nicotine dependence'	                    ,	'S'	,	'SIMPLE'	)	,
	('67A3.'	,	'Pregnancy smoking advice'                                      ,	'S'	,	'SIMPLE'	)	,
	('67H1.'	,	'Lifestyle advice regarding smoking'	                        ,	'S'	,	'SIMPLE'	)	,
	('67H6.'	,	'Brief intervention for smoking cessation'	                    ,	'S'	,	'SIMPLE'	)	,
	('745H.'	,	'Smoking cessation therapy'                                     ,	'S'	,	'SIMPLE'	)	,
	('745H0'	,	'Nicotine replacement therapy using nicotine patches'	        ,	'S'	,	'SIMPLE'	)	,
	('745H1'	,	'Nicotine replacement therapy using nicotine gum'	            ,	'S'	,	'SIMPLE'	)	,
	('745H2'	,	'Nicotine replacement therapy using nicotine inhalator'		    ,	'S'	,	'SIMPLE'	)	,
	('745H3'	,	'Nicotine replacement therapy using nicotine lozenges'	        ,	'S'	,	'SIMPLE'	)	,
	('745H4'	,	'Smoking cessation drug therapy'                                ,	'S'	,	'SIMPLE'	)	,
	('745H5'	,	'Varenicline therapy'                                           ,	'S'	,	'SIMPLE'	)	,
	('745Hy'	,	'Other specified smoking cessation therapy'		                ,	'S'	,	'SIMPLE'	)	,
	('745Hz'	,	'Smoking cessation therapy NOS'                                 ,	'S'	,	'SIMPLE'	)	,
	('8B2B.'	,	'Nicotine replacement therapy'                                  ,	'S'	,	'SIMPLE'	)	,
	('8B2B0'	,	'Issue of nicotine replacement therapy voucher'					,	'S'	,	'SIMPLE'	)	,
	('8B31G'	,	'Varenicline smoking cessation therapy offered'					,	'S'	,	'SIMPLE'	)	,
	('8B3f.'	,	'Nicotine replacement therapy provided free'	                ,	'S'	,	'SIMPLE'	)	,
	('8B3Y.'	,	'Over the counter nicotine replacement therapy'		            ,	'S'	,	'SIMPLE'	)	,
	('8BP3.'	,	'Nicotine replacement therapy provided by community pharmacis'	,	'S'	,	'SIMPLE'	)	,
	('8BPh.'	,	'Bupropion therapy'												,	'S'	,	'SIMPLE'	)	,
	('8CAg.'	,	'Smoking cessation advice provided by community pharmacist'		,	'S'	,	'SIMPLE'	)	,
	('8CAL.'	,	'Smoking cessation advice'                                      ,	'S'	,	'SIMPLE'	)	,
	('8CdB.'	,	'Stop smoking service opportunity signposted'	                ,	'S'	,	'SIMPLE'	)	,
	('8H7i.'	,	'Referral to smoking cessation advisor'		                    ,	'S'	,	'SIMPLE'	)	,
	('8HBM.'	,	'Stop smoking face to face follow-up'	                        ,	'S'	,	'SIMPLE'	)	,
	('8HBP.'	,	'Smoking cessation 12 week follow-up'							,	'S'	,	'SIMPLE'	)	,
	('8HkQ.'	,	'Referral to NHS stop smoking service'	                        ,	'S'	,	'SIMPLE'	)	,
	('8HTK.'	,	'Referral to stop-smoking clinic'	                            ,	'S'	,	'SIMPLE'	)	,
	('8I2I.'	,	'Nicotine replacement therapy contraindicated'	                ,	'S'	,	'SIMPLE'	)	,
	('8I2J.'	,	'Bupropion contraindicated'                                     ,	'S'	,	'SIMPLE'	)	,
	('8I39.'	,	'Nicotine replacement therapy refused'	                        ,	'S'	,	'SIMPLE'	)	,
	('8I3M.'	,	'Bupropion refused'                                             ,	'S'	,	'SIMPLE'	)	,
	('8I6H.'	,	'Smoking review not indicated'                                  ,	'S'	,	'SIMPLE'	)	,
	('8IAj.'	,	'Smoking cessation advice declined'		                        ,	'S'	,	'SIMPLE'	)	,
	('8IEK.'	,	'Smoking cessation programme declined'	                        ,	'S'	,	'SIMPLE'	)	,
	('8IEM.'	,	'Smoking cessation drug therapy declined'	                    ,	'S'	,	'SIMPLE'	)	,
	('8IEM0'	,	'Varenicline smoking cessation therapy declined'				,	'S'	,	'SIMPLE'	)	,
	('8IEo.'	,	'Referral to smoking cessation service declined'				,	'S'	,	'SIMPLE'	)	,
	('8T08.'	,	'Referral to smoking cessation service'							,	'S'	,	'SIMPLE'	)	,
	('9hG..'	,	'Exception reporting: smoking quality indicators'	            ,	'S'	,	'SIMPLE'	)	,
	('9hG0.'	,	'Excepted from smoking quality indicators: Patient unsuitable'	,	'S'	,	'SIMPLE'	)	,
	('9hG1.'	,	'Excepted from smoking quality indicators: Informed dissent'	,	'S'	,	'SIMPLE'	)	,
	('9kc..'	,	'Smoking cessation - enhanced services administration'	        ,	'S'	,	'SIMPLE'	)	,
	('9kc0.'	,	'Smoking cessatn monitor template complet - enhanc serv admin'	,	'S'	,	'SIMPLE'	)	,
	('9km..'	,	'Ex-smoker annual review - enhanced services administration'	,	'E'	,	'SIMPLE'	)	,
	('9kn..'	,	'Non-smoker annual review - enhanced services administration'	,	'N'	,	'SIMPLE'	)	,
	('9ko..'	,	'Current smoker annual review - enhanced services admin'	    ,	'S'	,	'SIMPLE'	)	,
	('9N2k.'	,	'Seen by smoking cessation advisor'		                        ,	'S'	,	'SIMPLE'	)	,
	('9N4M.'	,	'DNA - Did not attend smoking cessation clinic'		            ,	'S'	,	'SIMPLE'	)	,
	('9Ndf.'	,	'Consent given for follow-up by smoking cessation team'			,	'S'	,	'SIMPLE'	)	,
	('9Ndg.'	,	'Declined consent for follow-up by smoking cessation team'	    ,	'S'	,	'SIMPLE'	)	,
	('9NdV.'	,	'Consent given follow-up after smoking cessation intervention'	,	'S'	,	'SIMPLE'	)	,
	('9NdW.'	,	'Consent given for smoking cessation data sharing'	            ,	'S'	,	'SIMPLE'	)	,
	('9NdY.'	,	'Declin cons follow-up evaluation after smoking cess interven'	,	'S'	,	'SIMPLE'	)	,
	('9NdZ.'	,	'Declined consent for smoking cessation data sharing'	        ,	'S'	,	'SIMPLE'	)	,
	('9NS02'	,	'Referral for smoking cessation service offered'	            ,	'S'	,	'SIMPLE'	)	,
	('9OO..'	,	'Anti-smoking monitoring admin.'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO1.'	,	'Attends stop smoking monitor.'                                 ,	'S'	,	'SIMPLE'	)	,
	('9OO2.'	,	'Refuses stop smoking monitor'                                  ,	'S'	,	'SIMPLE'	)	,
	('9OO3.'	,	'Stop smoking monitor default'                                  ,	'S'	,	'SIMPLE'	)	,
	('9OO4.'	,	'Stop smoking monitor 1st lettr'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO5.'	,	'Stop smoking monitor 2nd lettr'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO6.'	,	'Stop smoking monitor 3rd lettr'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO7.'	,	'Stop smoking monitor verb.inv.'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO8.'	,	'Stop smoking monitor phone inv'                                ,	'S'	,	'SIMPLE'	)	,
	('9OO9.'	,	'Stop smoking monitoring delete'                                ,	'S'	,	'SIMPLE'	)	,
	('9OOA.'	,	'Stop smoking monitor.chck done'                                ,	'S'	,	'SIMPLE'	)	,
	('9OOB.'	,	'Stop smoking invitation short message service text message'	,	'S'	,	'SIMPLE'	)	,
	('9OOB0'	,	'Stop smoking invitation first SMS text message'	            ,	'S'	,	'SIMPLE'	)	,
	('9OOB1'	,	'Stop smoking invitation second SMS text message'	            ,	'S'	,	'SIMPLE'	)	,
	('9OOB2'	,	'Stop smoking invitation third SMS text message'	            ,	'S'	,	'SIMPLE'	)	,
	('9OOZ.'	,	'Stop smoking monitor admin.NOS'                                ,	'S'	,	'SIMPLE'	)	,
	('du3..'	,	'NICOTINE'                                                      ,	'S'	,	'SIMPLE'	)	,
	('du31.'	,	'NICOTINE 2mg chewing gum'                                      ,	'S'	,	'SIMPLE'	)	,
	('du32.'	,	'NICOTINE 4mg chewing gum'                                      ,	'S'	,	'SIMPLE'	)	,
	('du33.'	,	'NICORETTE 2mg chewing gum'                                     ,	'S'	,	'SIMPLE'	)	,
	('du34.'	,	'NICORETTE 4mg chewing gum'                                     ,	'S'	,	'SIMPLE'	)	,
	('du35.'	,	'NICOTINELL TTS 10 patches'                                     ,	'S'	,	'SIMPLE'	)	,
	('du36.'	,	'NICOTINELL TTS 20 patches'                                     ,	'S'	,	'SIMPLE'	)	,
	('du37.'	,	'NICOTINELL TTS 30 patches'                                     ,	'S'	,	'SIMPLE'	)	,
	('du38.'	,	'NICOTINE 7mg/24hours patches'                                  ,	'S'	,	'SIMPLE'	)	,
	('du39.'	,	'NICOTINE 14mg/24hours patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3a.'	,	'NICORETTE nasal spray'                                         ,	'S'	,	'SIMPLE'	)	,
	('du3A.'	,	'NICOTINE 21mg/24hours patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3B.'	,	'*NICORETTE 5mg patches x7'                                     ,	'S'	,	'SIMPLE'	)	,
	('du3b.'	,	'NICOTINE 10mg/mL nasal spray'                                  ,	'S'	,	'SIMPLE'	)	,
	('du3C.'	,	'*NICORETTE 10mg patches x7'                                    ,	'S'	,	'SIMPLE'	)	,
	('du3c.'	,	'NICOTINELL ORIGINAL 2mg gum'                                   ,	'S'	,	'SIMPLE'	)	,
	('du3D.'	,	'*NICORETTE 15mg patches x7'                                    ,	'S'	,	'SIMPLE'	)	,
	('du3d.'	,	'NICOTINELL MINT 2mg gum'                                       ,	'S'	,	'SIMPLE'	)	,
	('du3E.'	,	'*NICORETTE 15mg patches x28'                                   ,	'S'	,	'SIMPLE'	)	,
	('du3e.'	,	'NICOTINE 10mg inhalator starter pack' 		                    ,	'S'	,	'SIMPLE'	)	,
	('du3f.'	,	'NICOTINE 10mg inhalator refill pack'	                        ,	'S'	,	'SIMPLE'	)	,
	('du3F.'	,	'NICOTINE 5mg/16hours patches'                                  ,	'S'	,	'SIMPLE'	)	,
	('du3g.'	,	'NICORETTE 10mg inhalator starter pack'		                    ,	'S'	,	'SIMPLE'	)	,
	('du3G.'	,	'NICOTINE 10mg/16hours patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3h.'	,	'NICORETTE 10mg inhalator refill pack'	                        ,	'S'	,	'SIMPLE'	)	,
	('du3H.'	,	'NICOTINE 15mg/16hours patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3i.'	,	'NICOTINELL ORIGINAL 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du3I.'	,	'NIQUITIN CQ 2mg original lozenges'		                        ,	'S'	,	'SIMPLE'	)	,
	('du3J.'	,	'*NICABATE 7mg patches x14'                                     ,	'S'	,	'SIMPLE'	)	,
	('du3j.'	,	'NICOTINELL MINT 4mg chewing gum'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3K.'	,	'*NICABATE 14mg patches x14'                                    ,	'S'	,	'SIMPLE'	)	,
	('du3k.'	,	'NIQUITIN CQ 7mg/24hours patches'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3L.'	,	'*NICABATE 21mg patches x14'                                    ,	'S'	,	'SIMPLE'	)	,
	('du3l.'	,	'NIQUITIN CQ 14mg/24hours patches'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3M.'	,	'*NICABATE 7mg patches x7'                                      ,	'S'	,	'SIMPLE'	)	,
	('du3m.'	,	'NIQUITIN CQ 21mg/24hours patches'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3N.'	,	'*NICABATE 14mg patches x7'                                     ,	'S'	,	'SIMPLE'	)	,
	('du3n.'	,	'NICOTINE 2mg sublingual tablets'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3o.'	,	'NICORETTE MICROTAB 2mg sublingual tablets'		                ,	'S'	,	'SIMPLE'	)	,
	('du3O.'	,	'NIQUITIN CQ 7mg/24hours clear patches'		                    ,	'S'	,	'SIMPLE'	)	,
	('du3P.'	,	'*NICABATE 21mg patches x7'                                     ,	'S'	,	'SIMPLE'	)	,
	('du3p.'	,	'*NICOTINE 1mg mint lozenges'                                   ,	'S'	,	'SIMPLE'	)	,
	('du3Q.'	,	'*NICORETTE 15mg patches x3'                                    ,	'S'	,	'SIMPLE'	)	,
	('du3q.'	,	'NICOTINELL MINT 1mg lozenges'                                  ,	'S'	,	'SIMPLE'	)	,
	('du3R.'	,	'*NICONIL-11 patches'                                           ,	'S'	,	'SIMPLE'	)	,
	('du3r.'	,	'NIQUITIN CQ 14mg/24hours clear patches'	                    ,	'S'	,	'SIMPLE'	)	,
	('du3S.'	,	'*NICONIL-22 patches'                                           ,	'S'	,	'SIMPLE'	)	,
	('du3s.'	,	'NIQUITIN CQ 21mg/24hours clear patches'	                    ,	'S'	,	'SIMPLE'	)	,
	('du3T.'	,	'*NICOTINE 11mg/24hours patches'                                ,	'S'	,	'SIMPLE'	)	,
	('du3t.'	,	'NICOTINE 2mg fruit chewing gum'                                ,	'S'	,	'SIMPLE'	)	,
	('du3U.'	,	'*NICOTINE 22mg/24hours patches'                                ,	'S'	,	'SIMPLE'	)	,
	('du3u.'	,	'NICOTINE 4mg fruit chewing gum'                                ,	'S'	,	'SIMPLE'	)	,
	('du3V.'	,	'NICORETTE 2mg mint chewing gum'                                ,	'S'	,	'SIMPLE'	)	,
	('du3v.'	,	'NICOTINE 2mg citrus chewing gum'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3w.'	,	'NICORETTE CITRUS 2mg chewing gum'	                            ,	'S'	,	'SIMPLE'	)	,
	('du3W.'	,	'NICORETTE MINT PLUS 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du3x.'	,	'NICOTINE 1mg lozenges'                                         ,	'S'	,	'SIMPLE'	)	,
	('du3X.'	,	'NICOTINE 2mg mint chewing gum'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3y.'	,	'NICOTINE 2mg lozenges'                                         ,	'S'	,	'SIMPLE'	)	,
	('du3Y.'	,	'NICOTINE 4mg mint chewing gum'                                 ,	'S'	,	'SIMPLE'	)	,
	('du3Z.'	,	'*NICONIL 22 starter pack'                                      ,	'S'	,	'SIMPLE'	)	,
	('du3z.'	,	'NICOTINE 4mg lozenges'                                         ,	'S'	,	'SIMPLE'	)	,
	('du6..'	,	'BUPROPION'                                                     ,	'S'	,	'SIMPLE'	)	,
	('du61.'	,	'ZYBAN 150mg m/r tablets'                                       ,	'S'	,	'SIMPLE'	)	,
	('du6z.'	,	'BUPROPION HYDROCHLORIDE 150mg m/r tablets'		                ,	'S'	,	'SIMPLE'	)	,
	('du7..'	,	'NICOTINE 2'                                                    ,	'S'	,	'SIMPLE'	)	,
	('du71.'	,	'NIQUITIN CQ 4mg original lozenges'		                        ,	'S'	,	'SIMPLE'	)	,
	('du72.'	,	'NIQUITIN CQ 2mg mint chewing gum'	                            ,	'S'	,	'SIMPLE'	)	,
	('du73.'	,	'NIQUITIN CQ 4mg mint chewing gum'	                            ,	'S'	,	'SIMPLE'	)	,
	('du74.'	,	'*NICORETTE 15mg patches x2'                                    ,	'S'	,	'SIMPLE'	)	,
	('du75.'	,	'NICOTINELL 2mg liquorice chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du76.'	,	'NICOTINELL 4mg liquorice chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du77.'	,	'NICOTINELL 2mg mint lozenges'                                  ,	'S'	,	'SIMPLE'	)	,
	('du78.'	,	'NIQUITIN CQ 2mg mint lozenges'                                 ,	'S'	,	'SIMPLE'	)	,
	('du79.'	,	'NIQUITIN CQ 4mg mint lozenges'                                 ,	'S'	,	'SIMPLE'	)	,
	('du7A.'	,	'NICORETTE FRESHMINT 2mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7a.'	,	'NICOTINELL ICEMINT 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7b.'	,	'NICORETTE 15mg inhalator'                                      ,	'S'	,	'SIMPLE'	)	,
	('du7B.'	,	'NICORETTE FRESHMINT 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7c.'	,	'NICOTINE 15mg inhalator'                                       ,	'S'	,	'SIMPLE'	)	,
	('du7C.'	,	'NICOTINELL CLASSIC 2mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7d.'	,	'NICASSIST 7mg/24hours patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du7D.'	,	'NICOTINELL CLASSIC 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7e.'	,	'NICASSIST 14mg/24hours patches'                                ,	'S'	,	'SIMPLE'	)	,
	('du7E.'	,	'NICORETTE FRESHFRUIT 2mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7f.'	,	'NICASSIST 21mg/24hours patches'                                ,	'S'	,	'SIMPLE'	)	,
	('du7F.'	,	'NICORETTE FRESHFRUIT 4mg chewing gum'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7G.'	,	'*NICOPATCH 7mg/24hours patches'                                ,	'S'	,	'SIMPLE'	)	,
	('du7g.'	,	'NICORETTE COOLS 2mg lozenges'                                  ,	'S'	,	'SIMPLE'	)	,
	('du7H.'	,	'NICOPATCH 14mg/24hours patches'	                            ,	'S'	,	'SIMPLE'	)	,
	('du7h.'	,	'NICORETTE COOLS 4mg lozenges'                                  ,	'S'	,	'SIMPLE'	)	,
	('du7I.'	,	'NICOPATCH 21mg/24hours patches'	                            ,	'S'	,	'SIMPLE'	)	,
	('du7i.'	,	'NIQUITIN PRE-QUIT 21mg/24 hours clear patches'		            ,	'S'	,	'SIMPLE'	)	,
	('du7J.'	,	'NICOPASS 1.5mg fresh mint lozenges'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7j.'	,	'NICORETTE FRUITFUSION 2mg chewing gum'		                    ,	'S'	,	'SIMPLE'	)	,
	('du7K.'	,	'NICOPASS 1.5mg liquorice mint lozenges'	                    ,	'S'	,	'SIMPLE'	)	,
	('du7k.'	,	'NICORETTE FRUITFUSION 4mg chewing gum'		                    ,	'S'	,	'SIMPLE'	)	,
	('du7l.'	,	'NICORETTE FRUITFUSION 6mg chewing gum'		                    ,	'S'	,	'SIMPLE'	)	,
	('du7L.'	,	'NIQUITIN PRE-QUIT 4mg mint lozenges'	                        ,	'S'	,	'SIMPLE'	)	,
	('du7M.'	,	'NICORETTE INVISI 10mg patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du7N.'	,	'NICORETTE INVISI 15mg patches'                                 ,	'S'	,	'SIMPLE'	)	,
	('du7n.'	,	'NICOTINE 6mg fruit chewing gum'								,	'S'	,	'SIMPLE'	)	,
	('du7O.'	,	'NICORETTE INVISI 25mg patches'									,	'S'	,	'SIMPLE'	)	,
	('du7o.'	,	'NICOTINE 4mg icemint chewing gum'								,	'S'	,	'SIMPLE'	)	,
	('du7P.'	,	'NICORETTE ICY WHITE 2mg chewing gum'							,	'S'	,	'SIMPLE'	)	,
	('du7p.'	,	'NICOTINE 2mg icemint chewing gum'								,	'S'	,	'SIMPLE'	)	,
	('du7Q.'	,	'NICORETTE ICY WHITE 4mg chewing gum' 							,	'S'	,	'SIMPLE'	)	,
	('du7q.'	,	'NICOTINE 1mg oromucosal spray'									,	'S'	,	'SIMPLE'	)	,
	('du7r.'	,	'NICOTINE 1.5mg cherry lozenges'								,	'S'	,	'SIMPLE'	)	,
	('du7R.'	,	'NIQUITIN MINIS MINT 1.5mg lozenges'							,	'S'	,	'SIMPLE'	)	,
	('du7s.'	,	'NICOTINE 4mg cherry lozenges'									,	'S'	,	'SIMPLE'	)	,
	('du7S.'	,	'NIQUITIN MINIS MINT 4mg lozenges'								,	'S'	,	'SIMPLE'	)	,
	('du7T.'	,	'NICORETTE MICROTAB LEMON 2mg sublingual tablets'				,	'S'	,	'SIMPLE'	)	,
	('du7t.'	,	'NICOTINE 15mg/16hours patches and 2mg chewing gum'				,	'S'	,	'SIMPLE'	)	,
	('du7U.'	,	'NICORETTE COMBI 15mg patches and 2mg chewing gum'				,	'S'	,	'SIMPLE'	)	,
	('du7u.'	,	'NICOTINE 1.5mg lozenges'										,	'S'	,	'SIMPLE'	)	,
	('du7v.'	,	'NICOTINE 25mg/16hours patches'									,	'S'	,	'SIMPLE'	)	,
	('du7V.'	,	'NIQUITIN MINIS 1.5mg cherry lozenges'							,	'S'	,	'SIMPLE'	)	,
	('du7w.'	,	'NICOTINE 1.5mg fresh mint lozenges'							,	'S'	,	'SIMPLE'	)	,
	('du7W.'	,	'NIQUITIN MINIS 4mg cherry lozenges'							,	'S'	,	'SIMPLE'	)	,
	('du7X.'	,	'NICORETTE FRESHMINT 2mg lozenges'								,	'S'	,	'SIMPLE'	)	,
	('du7x.'	,	'NICOTINE 1.5mg liquorice mint lozenges'						,	'S'	,	'SIMPLE'	)	,
	('du7Y.'	,	'NICORETTE QUICKMIST 1mg oromucosal spray'						,	'S'	,	'SIMPLE'	)	,
	('du7y.'	,	'NICOTINE 4mg liquorice chewing gum'							,	'S'	,	'SIMPLE'	)	,
	('du7z.'	,	'NICOTINE 2mg liquorice chewing gum'							,	'S'	,	'SIMPLE'	)	,
	('du7Z.'	,	'NICOTINELL ICEMINT 2mg chewing gum'							,	'S'	,	'SIMPLE'	)	,
	('du8..'	,	'VARENICLINE'													,	'S'	,	'SIMPLE'	)	,
	('du81.'	,	'CHAMPIX 1mg tablets'											,	'S'	,	'SIMPLE'	)	,
	('du82.'	,	'CHAMPIX 500microgram tablets'									,	'S'	,	'SIMPLE'	)	,
	('du83.'	,	'CHAMPIX TREATMENT INITIATION pack'								,  	'S'	,	'SIMPLE'	)	,
	('du8x.'	,	'VARENICLINE 500micrograms+1mg tablets'							,  	'S'	,	'SIMPLE'	)	,
	('du8y.'	,	'VARENICLINE 500microgram tablets'								,	'S'	,	'SIMPLE'	)	,
	('du8z.'	,	'VARENICLINE 1mg tablets'										,	'S'	,	'SIMPLE'	)	,
	('du9..'	,	'NICOTINE WITHDRAWAL PRODUCTS'									,	'S'	,	'SIMPLE'	)	,
	('du91.'	,	'NICOBREVIN capsules'											,	'S'	,	'SIMPLE'	)	,
	('duB1.'	,	'NIQUITIN STRIPS 2.5mg mint oral film'							,	'S'	,	'SIMPLE'	)	,
	('duB2.'	,	'NIQUITIN MINIS 1.5mg orange lozenges'							,	'S'	,	'SIMPLE'	)	,
	('duB3.'	,	'NICOTINELL SUPPORT ICEMINT 2mg chewing gum'					,	'S'	,	'SIMPLE'	)	,
	('duB4.'	,	'NICOTINELL SUPPORT ICEMINT 4mg chewing gum'					,	'S'	,	'SIMPLE'	)	,
	('duBz.'	,	'NICOTINE 2.5mg oral film'										,	'S'	,	'SIMPLE'	)	,
	('E023.'	,	'Nicotine withdrawal'											,  	'S'	,	'SIMPLE'	)	,
	('E251.'	,	'Tobacco dependence'											,	'S'	,	'SIMPLE'	)	,
	('E2510'	,	'Tobacco dependence, unspecified'								,	'S'	,	'SIMPLE'	)	,
	('E2511'	,	'Tobacco dependence, continuous'								,	'S'	,	'SIMPLE'	)	,
	('E2512'	,	'Tobacco dependence, episodic'									,	'S'	,	'SIMPLE'	)	,
	('E2513'	,	'Tobacco dependence in remission'								,	'S'	,	'SIMPLE'	)	,
	('E251z'	,	'Tobacco dependence NOS'										,	'S'	,	'SIMPLE'	)	,
	('J0364'	,	'Tobacco deposit on teeth'										,	'S'	,	'SIMPLE'	)	,
	('SMC..'	,	'Toxic effect of tobacco and nicotine'							,	'S'	,	'SIMPLE'	)	,
	('U6099'	,	'[X]Bupropion causing adverse effects in therapeutic use'		,	'S'	,	'SIMPLE'	)	,
	('ZV4K0'	,	'[V]Tobacco use'												,	'S'	,	'SIMPLE'	)	,
	('ZV6D8'	,	'[V]Tobacco abuse counselling'									,	'S'	,	'SIMPLE'	)
	;
COMMIT;

CALL SYSPROC.ADMIN_CMD('runstats on table SAILW0972V.V2_SMOKER_LOOKUP with distribution and detailed indexes all'); -- makes tables compatible with all functions e.g. avg etc

COMMIT;

--check
SELECT * FROM SAILW0972V.V2_SMOKER_LOOKUP;

--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
----------------------------- Expand the user table ----------------------------

-- this expands the user table to include EVENT_ details for the ALFs specified

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_input_USER_smoking');
CREATE TABLE sailW0972V.V2_input_USER_smoking
(
 	    patient_id          BIGINT,
        alf_sts_cd      INTEGER,
        diag_date		DATE,
        event_dt        DATE,
        event_cd        CHAR(100),
        event_val		DECIMAL(31,8)
)
DISTRIBUTE BY HASH (PATIENT_ID); --previously was best practise, but might be outdated now
COMMIT;
GRANT ALL ON TABLE SAILW0972V.V2_input_USER_smoking TO ROLE NRDASAIL_SAIL_0972_ANALYST; --granting access to team mates
alter table SAILW0972V.V2_input_USER_smoking activate not logged INITIALLY; --worth doing for large chunks of data

insert into SAILW0972V.V2_input_USER_smoking
select
 	    distinct
        US.ALF_PE,
        GP.ALF_STS_CD,
        US.DIAG_DATE,
        GP.EVENT_DT,
        GP.EVENT_CD,
        GP.EVENT_VAL
FROM    
(
	SELECT * FROM SAILW0972V.V2_gp_database
		 WHERE
    		ALF_PE IS NOT NULL
		AND
		    event_cd is not NULL
		AND
		    event_DT is not NULL
		AND
			event_DT >= DATE('2000-01-01')
		AND
			event_DT < CURRENT_DATE	
)	gp	
RIGHT OUTER JOIN
(
	SELECT * FROM SAILW0972V.V2_input_USER_table
) US
	ON
	(GP.ALF_PE = US.ALF_PE)

	;
COMMIT;
CALL SYSPROC.ADMIN_CMD('runstats on table SAILW0972V.V2_input_USER_smoking with distribution and detailed indexes all'); -- makes tables compatible with all functions e.g. avg etc
COMMIT;

SELECT * FROM SAILW0972V.V2_INPUT_USER_SMOKING;

--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-------- Create event table that combines lookup table and user table ----------

-- combines selected tables using the variables declared above


--DROP TABLE SAILW0972V.V2_GP_SMOKE_EVENT;
CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_GP_SMOKE_EVENT');

CREATE TABLE sailW0972V.V2_gp_smoke_event
(
        patient_id 		        BIGINT,
        alf_sts_cd		        INTEGER,
        diag_date				DATE,
        event_dt  		        VARCHAR(10),
        event_cd  		        CHAR(6),
        complexity				VARCHAR(20),
        event_val				DECIMAL(31,8),
        description  		    VARCHAR(300),
        smoking_status 			VARCHAR(1),
        diff_day				INTEGER, -- this is the difference between the diagnosis date and the event date
        row_seq					INTEGER, -- ranks the event dates in order from most recent per ALF
        dd_minus_smoker_period	DATE, -- diagnosis date - the ex-smoker cutoff period
        ss_during_cutoff		VARCHAR(20), -- whether or not there is a smoker recording during the period above
        ever_smoked				CHAR(1)
)
DISTRIBUTE BY HASH (patient_id); --previously was best practise, but might be outdated now
COMMIT;

--granting access to team mates
GRANT ALL ON TABLE SAILW0972V.V2_GP_SMOKE_EVENT TO ROLE NRDASAIL_SAIL_0972_ANALYST;

--worth doing for large chunks of data
alter table SAILW0972V.V2_GP_SMOKE_EVENT activate not logged INITIALLY;

insert into SAILW0972V.V2_GP_SMOKE_EVENT
SELECT DISTINCT 	PATIENT_ID,
					ALF_STS_CD,
					DIAG_DATE,
					EVENT_DT,
					EVENT_CD,
					COMPLEXITY,
					EVENT_VAL,
					DESCRIPTION,
					SMOKING_STATUS,
					DIFF_DAY,
					ROW_NUMBER() OVER(PARTITION BY PATIENT_ID ORDER BY DIFF_DAY), -- ranks the event dates in order from most recent per ALF
					DD_MINUS_SMOKER_PERIOD, -- diagnosis date - the ex-smoker cutoff period
					CASE 	WHEN SMOKING_STATUS = 'S'
							AND EVENT_DT BETWEEN DATE(DD_MINUS_SMOKER_PERIOD) AND DATE(DIAG_DATE) THEN 'S'
							ELSE NULL END AS SS_DURING_CUTOFF,
							-- assigns smoker status to anyone with a smoker recording during the period above
					CASE 	WHEN SAILW0972V.V2_input_smoking_date_cutoff <> 'NULL' THEN
								(CASE	WHEN SMOKING_STATUS = 'S' AND EVENT_DT<= SAILW0972V.V2_input_smoking_date_cutoff THEN '1'
										WHEN SMOKING_STATUS = 'E' AND EVENT_DT<= SAILW0972V.V2_input_smoking_date_cutoff THEN '1'
										ELSE NULL
										END)
							WHEN SAILW0972V.V2_input_smoking_date_cutoff = 'NULL' THEN
								(CASE	WHEN SMOKING_STATUS = 'S' AND EVENT_DT<= DIAG_DATE THEN '1'
										WHEN SMOKING_STATUS = 'E' AND EVENT_DT<= DIAG_DATE THEN '1'
										ELSE NULL
										END)
							END AS EVER_SMOKED
				FROM
(select
    distinct
        PATIENT_ID,
        STS.ALF_STS_CD,
        US.DIAG_DATE,
		US.EVENT_DT,
		US.EVENT_CD,
        US.EVENT_VAL,
        LU.DESCRIPTION,
		CASE	WHEN (COMPLEXITY = 'EVENT_VAL DEPENDENT' AND EVENT_VAL > 0) THEN 'S'
				WHEN (COMPLEXITY = 'EVENT_VAL DEPENDENT' AND EVENT_VAL = '0') THEN NULL
				WHEN (COMPLEXITY = 'EVENT_VAL DEPENDENT' AND EVENT_VAL IS NULL) THEN NULL
				ELSE LU.SMOKING_STATUS
				END AS SMOKING_STATUS, -- These cases are only classed as smoker when event_val > 0, otherwise they are unknown
		LU.COMPLEXITY,
		DAYS(US.DIAG_DATE) - DAYS(US.EVENT_DT) AS DIFF_DAY, -- this is the difference between the diagnosis date and the event date
		US.DIAG_DATE - SAILW0972V.V2_ex_smoker_cutoff AS DD_MINUS_SMOKER_PERIOD -- ex smoker classification cutoff
FROM    SAILW0972V.V2_input_USER_smoking US -- extract data from user table
RIGHT OUTER JOIN
(
	SELECT * FROM SAILW0972V.V2_SMOKER_LOOKUP
) LU --extract data from Look up table (read codes)
	ON
	(US.EVENT_CD = LU.SM_CODE)
RIGHT OUTER JOIN
(
	SELECT * FROM SAILW0972V.V2_ALF_STS_CD_SMOKING
) STS -- limit results to those that have the desired STS codes (default is 1, 4, 39)
	ON
	(US.ALF_STS_CD = STS.ALF_STS_CD)
 WHERE
    PATIENT_ID IS NOT NULL
AND  -- restrict to events before diagnosis
	CASE	WHEN SAILW0972V.V2_input_smoking_date_cutoff <> 'NULL' THEN US.DIAG_DATE <= SAILW0972V.V2_input_smoking_date_cutoff -- only extract cases where diagnosis date is before the cutoff
			WHEN SAILW0972V.V2_input_smoking_date_cutoff = 'NULL' THEN US.DIAG_DATE = US.DIAG_DATE
			END
AND --restrict to events before the cutoff
	CASE	WHEN SAILW0972V.V2_input_smoking_date_cutoff = 'NULL' THEN US.EVENT_DT <= US.DIAG_DATE
			WHEN SAILW0972V.V2_input_smoking_date_cutoff <> 'NULL' THEN US.EVENT_DT <= SAILW0972V.V2_input_smoking_date_cutoff
			END
GROUP BY PATIENT_ID, EVENT_DT, EVENT_CD, STS.ALF_STS_CD, DIAG_DATE, EVENT_VAL, DESCRIPTION, SMOKING_STATUS, COMPLEXITY -- not entirely sure if necessary?
ORDER BY PATIENT_ID, EVENT_DT, EVENT_CD, STS.ALF_STS_CD, DIAG_DATE, EVENT_VAL, DESCRIPTION, SMOKING_STATUS, COMPLEXITY
)
 WHERE DIFF_DAY >= 0 	-- limit data to entries with event_dt before diagnosis date
					-- IF YOU WANT TO CHANGE TO ENTRIES AFTER DIAGNOSIS REPLACE WITH 'DIFF_DAY < 0'
    ;
COMMIT;

--update GP smoking table to add ever smoked

alter table SAILW0972V.V2_GP_SMOKE_EVENT
ADD COLUMN EVER_SMOKED_SUM INTEGER;

UPDATE SAILW0972V.V2_GP_SMOKE_EVENT
SET EVER_SMOKED_SUM  = CASE WHEN SUM(EVER_SMOKED) OVER(PARTITION BY PATIENT_ID) IS NOT NULL
								THEN SUM(EVER_SMOKED) OVER(PARTITION BY PATIENT_ID)
									ELSE 0
							END;

CALL SYSPROC.ADMIN_CMD('runstats on table SAILW0972V.V2_GP_SMOKE_EVENT with distribution and detailed indexes all'); -- makes tables compatible with all functions e.g. avg etc

COMMIT;

--checks
SELECT * FROM SAILW0972V.V2_GP_SMOKE_EVENT
GROUP BY PATIENT_ID, EVENT_DT, EVENT_CD, ALF_STS_CD, DIAG_DATE, EVENT_VAL, COMPLEXITY, DESCRIPTION, SMOKING_STATUS, DIFF_DAY, ROW_SEQ, DD_MINUS_SMOKER_PERIOD, SS_DURING_CUTOFF,EVER_SMOKED, EVER_SMOKED_SUM
ORDER BY PATIENT_ID, DIFF_DAY;

SELECT DISTINCT ALF_STS_CD FROM SAILW0972V.V2_GP_SMOKE_EVENT;
SELECT MIN(EVENT_DT) AS MIN_EVENT_DT, MAX(EVENT_DT) AS MAX_EVENT_DT, MIN(DIAG_DATE) AS MIN_DIAG_DT, MAX(DIAG_DATE) AS MAX_DIAG_DT FROM SAILW0972V.V2_GP_SMOKE_EVENT;
-- SELECT * FROM SAILW0972V.V2_GP_SMOKE_EVENT WHERE DIAG_DATE < EVENT_DT; -- check to see if the recorded events are within your specified time frame

-----------------------------------------------------------------------------
--identify same day smoking category mismatches and set to smoking status unclear

--Multi smoking categories

CALL FNC.DROP_IF_EXISTS('SAILW0972V.VB_MULTI_SMOK_CAT_STROKE');

CREATE TABLE SAILW0972V.VB_MULTI_SMOK_CAT_STROKE AS
(SELECT PATIENT_ID, DIAG_DATE, EVENT_DT FROM SAILW0972V.V2_GP_SMOKE_EVENT OP)
WITH NO DATA;

INSERT INTO SAILW0972V.VB_MULTI_SMOK_CAT_STROKE
(SELECT PATIENT_ID, DIAG_DATE, EVENT_DT FROM
(SELECT DISTINCT PATIENT_ID,
				DIAG_DATE,
				EVENT_DT, 
				CASE WHEN SS_DURING_CUTOFF = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'E' THEN 'E'
					WHEN SMOKING_STATUS = 'N' AND EVER_SMOKED_SUM > 0 THEN 'E' -- if ALF has ever been recorded as smoker or ex smoker, then sum(ever_smoker) > 0
					WHEN SMOKING_STATUS IS NULL THEN NULL
						ELSE 'N'
							END	AS SMOKER_STATUS
			FROM SAILW0972V.V2_GP_SMOKE_EVENT OP
ORDER BY PATIENT_ID, EVENT_DT)
GROUP BY PATIENT_ID, DIAG_DATE, EVENT_DT
HAVING COUNT(PATIENT_ID||DIAG_DATE||EVENT_DT) > 1);

-------------------------------------------------------------------------------------------------
--Single smoking categories
CALL FNC.DROP_IF_EXISTS('SAILW0972V.VB_SINGLE_SMOK_CAT_STROKE');

CREATE TABLE SAILW0972V.VB_SINGLE_SMOK_CAT_STROKE AS
(SELECT PATIENT_ID, DIAG_DATE, EVENT_DT FROM SAILW0972V.V2_GP_SMOKE_EVENT OP)
WITH NO DATA;

INSERT INTO SAILW0972V.VB_SINGLE_SMOK_CAT_STROKE
(SELECT PATIENT_ID, DIAG_DATE, EVENT_DT FROM
(SELECT DISTINCT PATIENT_ID,
				DIAG_DATE,
				EVENT_DT, 
				CASE WHEN SS_DURING_CUTOFF = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'E' THEN 'E'
					WHEN SMOKING_STATUS = 'N' AND EVER_SMOKED_SUM > 0 THEN 'E' -- if ALF has ever been recorded as smoker or ex smoker, then sum(ever_smoker) > 0
					WHEN SMOKING_STATUS IS NULL THEN NULL
						ELSE 'N'
							END	AS SMOKER_STATUS
			FROM SAILW0972V.V2_GP_SMOKE_EVENT OP
ORDER BY PATIENT_ID, EVENT_DT)
GROUP BY PATIENT_ID, DIAG_DATE, EVENT_DT
HAVING COUNT(PATIENT_ID||DIAG_DATE||EVENT_DT) = 1);

-----------------------------------------------------------------------------
-----------------------------------------------------------------------------
----------------------- Create Output table ---------------------------------

-- table takes data from the EVENT table and record one smoker status per ALF,
-- rewriting the status where necessary based on their smoking history within
-- the cutoff period

--DROP TABLE SAILW0972V.V2_GP_SMOKE_EVENT;
CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE_PRE');

CREATE TABLE SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE_PRE
(
        patient_id    		    	    BIGINT,
        diag_date					DATE,
        event_dt					DATE,
        smoking_status 				CHAR(1),
        smoking_status_description	VARCHAR(15)
)
DISTRIBUTE BY HASH (PATIENT_ID);--previously was best practise, but might be outdated now

COMMIT;

--granting access to team mates
GRANT ALL ON TABLE SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE_PRE TO ROLE NRDASAIL_SAIL_0972_ANALYST;

--worth doing for large chunks of data
alter table SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE_PRE activate not logged INITIALLY;

--Insert no smoking category mismatches
INSERT INTO SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE_PRE
SELECT PATIENT_ID,
	DIAG_DATE,
	EVENT_DT,
	CASE WHEN SS_DURING_CUTOFF = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'S' THEN 'S'
					WHEN SMOKING_STATUS = 'E' THEN 'E'
					WHEN SMOKING_STATUS = 'N' AND EVER_SMOKED_SUM > 0 THEN 'E' -- if ALF has ever been recorded as smoker or ex smoker, then sum(ever_smoker) > 0
					WHEN SMOKING_STATUS IS NULL THEN NULL
						ELSE 'N'
							END	AS SMOKING_STATUS,
	CASE WHEN SS_DURING_CUTOFF = 'S' THEN 'SMOKER'
					WHEN SMOKING_STATUS = 'S' THEN 'SMOKER'
					WHEN SMOKING_STATUS = 'E' THEN 'EX-SMOKER'
					WHEN SMOKING_STATUS = 'N' AND EVER_SMOKED_SUM > 0 THEN 'EX-SMOKER' -- if ALF has ever been recorded as smoker or ex smoker, then sum(ever_smoker) > 0
					WHEN SMOKING_STATUS IS NULL THEN NULL
						ELSE 'NEVER SMOKED'
							END AS SMOKER_STATUS_DESCRIPTION
FROM SAILW0972V.V2_GP_SMOKE_EVENT AS OP
WHERE OP.PATIENT_ID||OP.DIAG_DATE||OP.EVENT_DT
IN (SELECT SI.PATIENT_ID||SI.DIAG_DATE||SI.EVENT_DT FROM SAILW0972V.VB_SINGLE_SMOK_CAT_STROKE AS SI);

--Insert smoking category mismatches
INSERT INTO SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE_PRE
SELECT PATIENT_ID,
	DIAG_DATE,
	EVENT_DT,
	'U',
	'UNCLEAR'
FROM SAILW0972V.V2_GP_SMOKE_EVENT AS OP
WHERE OP.PATIENT_ID||OP.DIAG_DATE||OP.EVENT_DT
IN (SELECT SI.PATIENT_ID||SI.DIAG_DATE||SI.EVENT_DT FROM SAILW0972V.VB_MULTI_SMOK_CAT_STROKE AS SI);


ALTER TABLE SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE_PRE
ADD COLUMN ROW_SEQ INTEGER;

UPDATE SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE_PRE
SET ROW_SEQ = ROW_NUMBER() OVER(PARTITION BY PATIENT_ID ORDER BY EVENT_DT desc);

CALL FNC.DROP_IF_EXISTS ('SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE');

CREATE TABLE SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE
(
        patient_id    		    	BIGINT,
        diag_date					DATE,
        smoking_status 				CHAR(1),
        smoking_status_description	VARCHAR(15)
)
DISTRIBUTE BY HASH (PATIENT_ID);

COMMIT;

INSERT INTO SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE
SELECT PATIENT_ID, DIAG_DATE, SMOKING_STATUS, SMOKING_STATUS_DESCRIPTION FROM SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE_PRE
WHERE ROW_SEQ = 1;

SELECT COUNT(DISTINCT PATIENT_ID) AS ORIGINAL_DATASET_COUNT FROM SAILW0972V.V2_input_USER_smoking;
SELECT COUNT(DISTINCT PATIENT_ID) AS OUTPUT_TABLE_COUNT FROM SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE;
SELECT COUNT(PATIENT_ID), SMOKING_STATUS FROM SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE
GROUP BY SMOKING_STATUS;	

------------------------------------------------------------------------------------------------
--Drop aliases

DROP ALIAS SAILW0972V.V2_input_USER_table;
DROP ALIAS SAILW0972V.V2_gp_database;
		
------------------------------------------------------------------------------------------------
/* update stroke cohort table with smoker status */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN SMOKING_STATUS_DESCRIPTION VARCHAR(30);

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SAILW0972V.V2_VB_SMOKER_OUTPUT_STROKE AS sst
		ON fe.ALF_PE = sst.PATIENT_ID
			WHEN MATCHED THEN
				UPDATE
				SET fe.SMOKING_STATUS_DESCRIPTION = sst.SMOKING_STATUS_DESCRIPTION
			;
		
/* add ADDE DOD to MI cohort table */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN DOD Date
	ADD COLUMN DIED_IN_PERIOD VARCHAR(5);

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SAIL0972V.ADDE_DEATHS_20210428 AS ad
		ON fe.ALF_PE = ad.ALF_PE
		AND ad.DEATH_DT BETWEEN '2010-01-01' AND '2020-12-31'
			WHEN MATCHED THEN
				UPDATE
				SET fe.DOD = ad.DEATH_DT
			;
	
/* where ADDE DOD is NULL fill in WDSD DOD */
	
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SAIL0972V.WDSD_AR_PERS_20210502 AS wd
		ON fe.ALF_PE = wd.ALF_PE
		AND wd.DOD BETWEEN '2010-01-01' AND '2020-12-31'
		AND fe.DOD IS NULL
			WHEN MATCHED THEN
				UPDATE
				SET fe.DOD = wd.DOD
			;
		
UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET DIED_IN_PERIOD = TRUE
		WHERE DOD IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET DIED_IN_PERIOD = FALSE
		WHERE DOD IS NULL;

/* add DOD to Stroke cohort table */
	
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN DOD Date
	ADD COLUMN DIED_IN_PERIOD VARCHAR(5);

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SAIL0972V.ADDE_DEATHS_20210428 AS ad
		ON fe.ALF_PE = ad.ALF_PE
		AND ad.DEATH_DT BETWEEN '2010-01-01' AND '2020-12-31'
			WHEN MATCHED THEN
				UPDATE
				SET fe.DOD = ad.DEATH_DT
			;
		
/* where ADDE DOD is NULL fill in WDSD DOD */
		
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SAIL0972V.WDSD_AR_PERS_20210502 AS wd
		ON fe.ALF_PE = wd.ALF_PE
		AND wd.DOD BETWEEN '2010-01-01' AND '2020-12-31'
		AND fe.DOD IS NULL
			WHEN MATCHED THEN
				UPDATE
				SET fe.DOD = wd.DOD
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET DIED_IN_PERIOD = TRUE
		WHERE DOD IS NOT NULL;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET DIED_IN_PERIOD = FALSE
		WHERE DOD IS NULL;
	
-------------------------------------------------------------------------------------------------

--create table to identify an individual's first period of inclusion dates	
	
DECLARE GLOBAL TEMPORARY TABLE SESSION.V2_VB_FIRST_PER_IN_COHORT AS
	(SELECT ALF_PE,
			LATEST_START,
			EARLIEST_END
			FROM sailW0972V.V2_VB_WDSD_DAYS_IN_COHORT) 
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.V2_VB_FIRST_PER_IN_COHORT
	(ALF_PE,
	LATEST_START,
	EARLIEST_END)
	SELECT dic.ALF_PE,
			min(dic.LATEST_START),
			min(dic.EARLIEST_END)
	FROM SAILW0972V.V2_VB_WDSD_DAYS_IN_COHORT AS dic
	GROUP BY dic. ALF_PE;

Commit;

delete FROM SESSION.V2_VB_FIRST_PER_IN_COHORT
	WHERE EARLIEST_END < LATEST_START;

-----------------------------------------------------------------------------------
--Add start and end dates for first period of inclusion to stroke cohort table

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN INC_START Date
	ADD COLUMN INC_END Date;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_VB_FIRST_PER_IN_COHORT AS fp
		ON fe.ALF_PE = fp.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.INC_START = fp.LATEST_START
			;
		
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS fe
	USING SESSION.V2_VB_FIRST_PER_IN_COHORT AS fp
		ON fe.ALF_PE = fp.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.INC_END = fp.EARLIEST_END
			;
		
--Add start and end dates for first period of inclusion to stroke cohort table
		
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN INC_START Date
	ADD COLUMN INC_END Date;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_VB_FIRST_PER_IN_COHORT AS fp
		ON fe.ALF_PE = fp.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.INC_START = fp.LATEST_START
			;
		
MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS fe
	USING SESSION.V2_VB_FIRST_PER_IN_COHORT AS fp
		ON fe.ALF_PE = fp.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET fe.INC_END = fp.EARLIEST_END
			;
		
------------------------------------------------------------------------------------------------
--add flag for event in first period of inclusion to stroke cohort

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN EVENT_IN_FST_INC varchar(5);

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET EVENT_IN_FST_INC = TRUE
		WHERE FIRST_EPI_STR_DT BETWEEN INC_START AND INC_END;
	
UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET EVENT_IN_FST_INC = FALSE
		WHERE EVENT_IN_FST_INC IS NULL;
	
--add flag for event in first period of inclusion to MI cohort
	
ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN EVENT_IN_FST_INC varchar(5);

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET EVENT_IN_FST_INC = TRUE
		WHERE FIRST_EPI_STR_DT BETWEEN INC_START AND INC_END;
	
UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET EVENT_IN_FST_INC = FALSE
		WHERE EVENT_IN_FST_INC IS NULL;
	
	SELECT * FROM SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT;

------------------------------------------------------------------------------------------
--Add catheter use

/* update cohort table with catheter
Link all cohort1 rUTI events to gp event to identify any events with catheter read codes
Identify first event date for any episode with a recorded catheter read code */
		
DECLARE GLOBAL TEMPORARY TABLE SESSION.VB_COHORT_EVENT_CATHETER AS (
	SELECT	ALF_PE, 
			EVENT_DT
		FROM SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.VB_COHORT_EVENT_CATHETER
							(ALF_PE,
							EVENT_DT)
				WITH CTE AS 
						(SELECT ALF_PE,
							EVENT_CD,
							EVENT_DT
						FROM SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301
							WHERE EVENT_CD IN ('461C.','4JJ4.','66K8.','66K9.','66K90','66K91','7B241','7B2B.','7B2B1','7B2B2','7B2B5','7B2B8',
												'7B2By','7B2Bz','7B2C1','7B2C2','7B2C9','8156.','81560','8B3v.','8D74.','8D76.','8E98.','9NgX.',
												'K182.','SP...','SP031','SP033','SP07Q','TB16.','ZV536','ZV53A','ZV53E','ZV658','gf2..','gf2k.',
												'gf2l.','gf2m.','gf2n.','gf2o.','gf2p.','p8...','p81..','p811.','p812.','p813.','p814.','p815.',
												'p816.','p817.','p818.','p819.','p81A.','p81B.','p81C.','p81D.','p81E.','p81F.','p81G.','p81H.',
												'p81I.','p81J.','p81K.','p81L.','p81M.','p81N.','p81O.','p81P.','p81Q.','p81R.','p81S.','p81T.',
												'p81U.','p81V.','p81W.','p81X.','p81Y.','p81a.','p81b.','p81c.','p81d.','p81e.','p81f.','p81g.',
												'p81h.','p81i.','p81j.','p81k.','p81l.','p81m.','p81n.','p81o.','p81p.','p81q.','p81r.','p81s.',
												'p81t.','p81u.','p81v.','p81w.','p81x.','p81y.','p81z.','p82..','p821.','p822.','p823.','p824.',
												'p825.','p83..','p831.','p832.','p833.','p834.','p835.','p836.','p837.','p838.','p839.','p83A.',
												'p83B.','p83C.','p83D.','p83E.','p83F.','p83G.','p83H.','p83J.','p83K.','p83L.','p83M.','p83N.',
												'p83P.','p83Q.','p83R.','p83S.','p83T.','p83U.','p83V.','p83W.','p83X.','p83Y.','p83Z.','p83a.',
												'p83b.','p83c.','p83d.','p83e.','p83f.','p83g.','p83h.','p83i.','p83j.','p83k.','p83l.','p83m.',
												'p83n.','p83o.','p83p.','p83q.','p83r.','p83s.','p83t.','p83u.','p83v.','p83w.','p83x.','p83y.',
												'p84..','p841.','p842.','p843.','p844.','p845.','p846.','p847.','p848.','p849.','p84A.','p84B.',
												'p84C.','p84D.','p84E.','p84F.','p84G.','p84H.','p84I.','p84J.','p84K.','p84L.','p84M.','p84N.',
												'p84O.','p84P.','p84Q.','p84R.','p84S.','p84T.','p84U.','p84V.','p84W.','p84X.','p84Y.','p84Z.',
												'p84a.','p84b.','p84c.','p84d.','p84e.','p84f.','p84g.','p84h.','p84i.','p84j.','p84k.','p84l.',
												'p84m.','p84n.','p84o.','p84p.','p84q.','p84r.','p84s.','p84t.','p84u.','p84v.','p84w.','p84x.',
												'p84y.','p84z.','p86..','p861.','p862.','p863.','p864.','p865.','p866.','p867.','p868.','p869.',
												'p86A.','p86B.','p86C.','p86D.','p86E.','p86F.','p86G.','p86H.','p86I.','p86J.','p86K.','p86L.',
												'p86M.','p86N.','p86O.','p86P.','p86Q.','p86R.','p86S.','p86T.','p86U.','p86V.','p86W.','p86X.',
												'p86Y.','p86Z.','p86a.','p86b.','p86c.','p86d.','p86e.','p86f.','p86g.','p86h.','p86i.','p86j.',
												'p86k.','p86l.','p86m.','p86n.','p86o.','p86p.','p86q.','p86r.','p86s.','p86t.','p86u.','p86v.',
												'p86w.','p86x.','p86y.','p86z.','p87..','p871.','p872.','p873.','p874.','p875.','p876.','p877.',
												'p878.','p879.','p87A.','p87B.','p87C.','p87D.','p87E.','p87F.','p87G.','p87H.','p87J.','p87K.',
												'p87L.','p87M.','p87N.','p87P.','p87Q.','p87R.','p87S.','p87T.','p87U.','p87V.','p87W.','p87X.',
												'p87Y.','p87Z.','p87a.','p87b.','p87c.','p87d.','p87e.','p87f.','p87g.','p87h.','p87i.','p87j.',
												'p87k.','p87m.','p87n.','p87o.','p87p.','p87q.','p87r.','p87s.','p87t.','p87u.','p87v.','p87w.',
												'p87x.','p87y.','p87z.','p88..','p881.','p882.','p883.','p884.','p885.','p886.','p887.','p888.',
												'p889.','p88A.','p88B.','p88C.','p88D.','p88E.','p88F.','p88G.','p88H.','p88I.','p88J.','p88K.',
												'p88L.','p88M.','p88N.','p88P.','p88Q.','p88R.','p88S.','p88T.','p88U.','p88V.','p88W.','p88X.',
												'p88Y.','p88Z.','p88a.','p88b.','p88c.','p88d.','p88e.','p88f.','p88g.','p88h.','p88j.','p88k.',
												'p88l.','p88m.','p88n.','p88o.','p88p.','p88q.','p88r.','p88s.','p88t.','p88u.','p88v.','p88w.',
												'p88x.','p88y.','p88z.','p89..','p891.','p892.','p893.','p894.','p895.','p896.','p897.','p898.',
												'p899.','p89A.','p89B.','p89C.','p89D.','p89E.','p89F.','p89G.','p89H.','p89I.','p89J.','p89K.',
												'p89L.','p89M.','p89N.','p89O.','p89P.','p89Q.','p89R.','p89S.','p89T.','p89U.','p89V.','p89W.',
												'p89X.','p89Y.','p89Z.','p89a.','p89b.','p89c.','p89d.','p89e.','p89f.','p89g.','p89h.','p89i.',
												'p89j.','p89k.','p89m.','p89n.','p89p.','p89q.','p89r.','p89s.','p89t.','p89u.','p89v.','p89w.',
												'p89x.','p89y.','p8A..','p8A1.','p8A2.','p8A3.','p8A4.','p8A5.','p8A6.','p8A7.','p8A8.','p8A9.',
												'p8AA.','p8AB.','p8AC.','p8AD.','p8AE.','p8AF.','p8AG.','p8AH.','p8AJ.','p8AK.','p8AL.','p8AM.',
												'p8AN.','p8AP.','p8AQ.','p8AR.','p8AS.','p8AT.','p8AU.','p8AV.','p8AW.','p8AX.','p8AY.','p8AZ.',
												'p8Aa.','p8Ab.','p8Ac.','p8Ad.','p8Ae.','p8Af.','p8Ag.','p8Ah.','p8Aj.','p8Ak.','p8Am.','p8An.',
												'p8Ap.','p8Aq.','p8Ar.','p8As.','p8At.','p8Au.','p8B..','p8B1.','p8B2.','p8B3.','p8B4.','p8B5.',
												'p8B6.','p8B7.','p8B8.','p8B9.','p8BA.','p8BB.','p8BC.','p8BD.','p8BE.','p8BF.','p8BG.','p8BH.',
												'p8BJ.','p8BK.','p8BL.','p8BM.','p8BN.','p8BP.','p8BQ.','p8BR.','p8BS.','p8BT.','p8BU.','p8BV.',
												'p8BW.','p8BX.','p8BY.','p8BZ.','p8Ba.','p8Bb.','p8Bc.','p8Bd.','p8Be.','p8Bf.','p8Bg.','p8Bh.',
												'p8Bj.','p8Bk.','p8Bm.','p8Bn.','p8Bp.','p8Bq.','p8Br.','p8Bs.','p8Bt.','p8Bu.','p8Bv.','p8Bw.',
												'p8Bx.','p8By.','p8Bz.','p8C..','p8C1.','p8C2.','p8C3.','p8C4.','p8C5.','p8C6.','p8C7.','p8C8.',
												'p8C9.','p8CA.','p8CB.','p8CC.','p8CD.','p8CE.','p8CF.','p8CG.','p8CH.','p8CJ.','p8CK.','p8CL.',
												'p8CM.','p8CN.','p8CP.','p8CQ.','p8CR.','p8CS.','p8CT.','p8CU.','p8CV.','p8CW.','p8CX.','p8CY.',
												'p8CZ.','p8Ca.','p8Cb.','p8Cc.','p8Cd.','p8Ce.','p8Cf.','p8Cg.','p8Ch.','p8Ci.','p8Cj.','p8Ck.',
												'p8Cm.','p8Cn.','p8Co.','p8Cp.','p8Cq.','p8Cr.','p8Cs.','p8Ct.','p8Cu.','p8Cv.','p8Cw.','p8Cx.',
												'p8Cy.','p8Cz.','p8D..','p8D1.','p8D2.','p8D3.','p8D4.','p8D5.','p8D6.','p8D7.','p8D8.','p8D9.',
												'p8DA.','p8DB.','p8DC.','p8DD.','p8DE.','p8DF.','p8DG.','p8DH.','p8DJ.','p8DK.','p8DL.','p8DM.',
												'p8DN.','p8DP.','p8DQ.','p8DR.','p8DS.','p8DT.','p8DU.','p8DV.','p8DW.','p8DX.','p8DY.','p8DZ.',
												'p8Da.','p8Db.','p8Dc.','p8Dd.','p8De.','p8Df.','p8Dg.','p8Dh.','p8Di.','p8Dj.','p8Dk.','p8Dl.',
												'p8Dm.','p8Dn.','p8Do.','p8Dp.','p8Dq.','p8Dr.','p8Ds.','p8Dt.','p8Du.','p8Dv.','p8Dw.','p8Dx.',
												'p8Dy.','p8Dz.','p8E..','p8E1.','p8E2.','p8E3.','p8E4.','p8E5.','p8E6.','p8E7.','p8E8.','p8E9.',
												'p8EA.','p8EB.','p8EC.','p8ED.','p8EE.','p8EF.','p8EG.','p8EH.','p8EI.','p8EJ.','p8EK.','p8EL.',
												'p8EM.','p8EN.','p8EP.','p8EQ.','p8ER.','p8ES.','p8ET.','p8EU.','p8EV.','p8EW.','p8EX.','p8EY.',
												'p8EZ.','p8Ea.','p8Eb.','p8Ec.','p8Ed.','p8Ee.','p8Ef.','p8Eg.','p8Eh.','p8Ei.','p8Ej.','p8Ek.',
												'p8Em.','p8En.','p8Eo.','p8Ep.','p8Eq.','p8Er.','p8Es.','p8Et.','p8Eu.','p8Ev.','p8Ew.','p8Ex.',
												'p8Ey.','p8Ez.','p8G..','p8G1.','p8G2.','p8G3.','p8G4.','p8G5.','p8G6.','p8G7.','p8G8.','p8G9.',
												'p8GA.','p8GB.','p8GC.','p8GD.','p8GE.','p8GF.','p8GG.','p8GH.','p8GI.','p8GJ.','p8GK.','p8GL.',
												'p8GM.','p8GN.','p8GO.','p8GP.','p8GQ.','p8GR.','p8GS.','p8GT.','p8GU.','p8GV.','p8GW.','p8GX.',
												'p8GY.','p8GZ.','p8Ga.','p8Gb.','p8Gc.','p8Gd.','p8Ge.','p8Gf.','p8Gg.','p8Gh.','p8Gi.','p8Gj.',
												'p8Gk.','p8Gl.','p8Gm.','p8Gn.','p8Go.','p8Gp.','p8Gq.','p8Gr.','p8Gs.','p8Gt.','p8Gu.','p8Gv.',
												'p8Gw.','p8Gx.','p8Gy.','p8Gz.','p8H..','p8H1.','p8H2.','p8H3.','p8H4.','p8H5.','p8H6.','p8H7.',
												'p8H8.','p8H9.','p8HA.','p8HB.','p8HC.','p8HD.','p8HE.','p8HF.','p8HG.','p8HH.','p8HJ.','p8HK.',
												'p8HL.','p8HM.','p8HN.','p8HO.','p8HP.','p8HQ.','p8HR.','p8HS.','p8HT.','p8HU.','p8HV.','p8HW.',
												'p8HX.','p8HY.','p8HZ.','p8Ha.','p8Hb.','p8Hc.','p8Hd.','p8He.','p8Hf.','p8Hg.','p8Hh.','p8Hi.',
												'p8Hj.','p8Hk.','p8Hl.','p8Hm.','p8Hn.','p8Ho.','p8Hp.','p8Hq.','p8Hr.','p8Hs.','p8Ht.','p8Hu.',
												'p8Hv.','p8Hw.','p8Hx.','p8Hy.','p8J..','p8J1.','p8J2.','p8J3.','p8J4.','p8J5.','p8J6.','p8J7.',
												'p8J8.','p8J9.','p8JA.','p8JB.','p8JC.','p8JD.','p8JE.','p8JF.','p8JG.','p8JH.','p8JI.','p8JJ.',
												'p8JK.','p8JL.','p8JM.','p8JN.','p8JO.','p8JP.','p8JQ.','p8JR.','p8JS.','p8JT.','p8JU.','p8JV.',
												'p8JW.','p8JX.','p8JY.','p8JZ.','p8Ja.','p8Jb.','p8Jc.','p8Jd.','p8Je.','p8Jf.','p8Jg.','p8Jh.',
												'p8Ji.','p8Jj.','p8Jk.','p8Jl.','p8Jm.','p8Jn.','p8Jo.','p8Jp.','p8Jq.','p8Jr.','p8Js.','p8Jt.',
												'p8Ju.','p8Jv.','p8Jw.','p8Jx.','p8Jy.','p8Jz.','p8K..','p8K1.','p8K2.','p8K3.','p8K4.','p8K5.',
												'p8K6.','p8K7.','p8K8.','p8K9.','p8KA.','p8KB.','p8KC.','p8KD.','p8KE.','p8KF.','p8KG.','p8KH.',
												'p8KJ.','p8KK.','p8KL.','p8KM.','p8KN.','p8KP.','p8KQ.','p8KR.','p8KS.','p8KT.','p8KU.','p8KV.',
												'p8KW.','p8KX.','p8KY.','p8KZ.','p8Ka.','p8Kb.','p8Kc.','p8Kd.','p8Ke.','p8Kf.','p8Kg.','p8Kh.',
												'p8Ki.','p8Kj.','p8Kk.','p8Km.','p8Kn.','p8Kp.','p8Kq.','p8Kr.','p8Ks.','p8Kt.','p8Ku.','p8Kv.',
												'p8Kw.','p8Kx.','p8Ky.','p8L..','p8L1.','p8L2.','p8L3.','p8L4.','p8L5.','p8L6.','p8L7.','p8L8.',
												'p8L9.','p8LA.','p8LB.','p8LC.','p8LD.','p8LE.','p8LF.','p8LG.','p8LH.','p8LJ.','p8LK.','p8LL.',
												'p8LM.','p8LP.','p8LQ.','p8LR.','p8LS.','p8LT.','p8LU.','p8LV.','p8LW.','p8LX.','p8LY.','p8LZ.',
												'p8La.','p8Lb.','p8Lc.','p8Ld.','p8Le.','p8Lf.','p8Lg.','p8Lh.','p8Li.','p8Lj.','p8Lk.','p8Ll.',
												'p8Lm.','p8Ln.','p8Lo.','p8Lp.','p8Lq.','p8Lr.','p8Ls.','p8Lt.','p8M..','p8M1.','p8M2.','p8M3.',
												'p8M4.','p8M5.','p8M6.','p8M7.','p8M8.','p8M9.','p8MA.','p8MB.','p8MC.','p8MD.','p8ME.','p8MF.',
												'p8MG.','p8MH.','p8MJ.','p8MK.','p8ML.','p8MM.','p8MN.','p8MO.','p8MP.','p8MQ.','p8MR.','p8MS.',
												'p8MT.','p8MU.','p8MV.','p8MW.','p8MX.','p8MY.','p8MZ.','p8Ma.','p8Mb.','p8Mc.','p8Md.','p8Me.',
												'p8Mf.','p8Mg.','p8Mh.','p8N..','p8N1.','p8N2.','p8N3.','p8N4.','p8N5.','p8N6.','p8N7.','p8N8.',
												'p8N9.','p8NA.','p8NB.','p8NC.','p8ND.','p8NE.','p8NF.','p8NG.','p8NH.','p8NJ.','p8NK.','p8NL.',
												'p8NM.','p8NN.','p8NP.','p8NQ.','p8NR.','p8NS.','p8NT.','p8NU.','p8NV.','p8NW.','p8NX.','p8NY.',
												'p8NZ.','p8Na.','p8Nb.','p8Nc.','p8Nd.','p8Ne.','p8Nf.','p8Ng.','p8Nh.','p8Ni.','p8Nj.','p8Nk.',
												'p8Nl.','p8Nm.','p8Nn.','p8No.','p8Np.','p8Nq.','p8Nr.','p8Ns.','p8Nt.','p8Nu.','p8Nv.','p8Nw.',
												'p8Nx.','p8Ny.','p8Nz.','p8O..','p8O1.','p8O2.','p8O3.','p8O4.','p8O5.','p8O6.','p8O7.','p8O8.',
												'p8O9.','p8OA.','p8OB.','p8OC.','p8OD.','p8OE.','p8OF.','p8OG.','p8OH.','p8OI.','p8OJ.','p8OK.',
												'p8OL.','p8OM.','p8ON.','p8OO.','p8OP.','p8OQ.','p8OR.','p8OS.','p8OT.','p8OU.','p8OV.','p8OW.',
												'p8OX.','p8OY.','p8OZ.','p8Oa.','p8Ob.','p8Oc.','p8Od.','p8Oe.','p8Of.','p8Og.','p8Oh.','p8Oi.',
												'p8Oj.','p8Ok.','p8Ol.','p8Om.','p8P..','p8P1.','p8P2.','p8P3.','p8P4.','p8P5.','p8P6.','p8P7.',
												'p8P8.','p8P9.','p8PA.','p8PB.','p8PC.','p8PD.','p8PE.','p8PF.','p8PG.','p8PH.','p8PI.','p8PJ.',
												'p8PK.','p8PL.','p8PM.','p8PN.','p8PO.','p8PP.','p8PQ.','p8PR.','p8PS.','p8PT.','p8PU.','p8PV.',
												'p8PW.','p8PX.','p8PY.','p8PZ.','p8Pa.','p8Pb.','p8Pc.','p8Pd.','p8Pe.','p8Pf.','p8Pg.','p8Ph.',
												'p8Pi.','p8Pj.','p8Pk.','p8Pl.','p8Pm.','p8Pn.','p8Po.','p8Pp.','p8Pq.','p8Pr.','p8Ps.','p8Pt.',
												'p8Pu.','p8Pv.','p8Pw.','p8Px.','p8Py.','p8Pz.','p8Q..','p8Q1.','p8Q2.','p8Q3.','p8Q4.','p8Q5.',
												'p8Q6.','p8Q7.','p8Q8.','p8Q9.','p8QA.','p8QB.','p8QC.','p8QD.','p8QE.','p8QF.','p8QG.','p8QH.',
												'p8QI.','p8QJ.','p8QK.','p8QL.','p8QM.','p8QN.','p8QO.','p8QP.','p8QQ.','p8QR.','p8QS.','p8QT.',
												'p8QU.','p8QV.','p8QW.','p8QX.','p8R..','p8R1.','p8R2.','p8R3.','p8R4.','p8R5.','p8R6.','p8R7.',
												'p8R8.','p8R9.','p8RA.','p8RB.','p8RC.','p8RD.','p8RE.','p8RF.','p8RG.','p8RH.','p8RI.','p8RJ.',
												'p8RK.','p8RL.','p8RM.','p8RN.','p8RO.','p8RP.','p8RQ.','p8RR.','p8RS.','p8RT.','p8RU.','p8RV.',
												'p8RW.','p8RX.','p8RY.','p8RZ.','p8Ra.','p8Rb.','p8Rc.','p8Rd.','p8Re.','p8Rf.','p8Rg.','p8Rh.',
												'p8Ri.','p8Rj.','p8Rk.','p8Rl.','p8Rm.','p8Rn.','p8Ro.','p8Rp.','p8Rq.','p8Rr.','p8S..','p8S1.',
												'p8S2.','p8S3.','p8S4.','p8S5.','p8S6.','p8S7.','p8S8.','p8S9.','p8SA.','p8SB.','p8SC.','p8SD.',
												'p8SE.','p8SF.','p8SG.','p8SH.','p8SI.','p8SJ.','p8SK.','p8SL.','p8SM.','p8SN.','p8SO.','p8SP.',
												'p8SQ.','p8SR.','p8SS.','p8ST.','p8SU.','p8SV.','p8SW.','p8SX.','p8SY.','p8SZ.','p8Sa.','p8Sb.',
												'p8Sc.','p8Sd.','p8Se.','p8Sf.','p8Sg.','p8Sh.','p8Si.','p8Sj.','p8Sk.','p8Sl.','p8Sm.','p8Sn.',
												'p8So.','p8Sp.','p8Sq.','p8Sr.','p8Ss.','p8St.','p8Su.','p8Sv.','p8Sw.','p8Sx.','p8Sy.','p8Sz.',
												'p8T..','p8T1.','p8T2.','p8T3.','p8T4.','p8T5.','p8T6.','p8T7.','p8T8.','p8T9.','p8TA.','p8TB.',
												'p8TC.','p8TD.','p8TE.','p8TF.','p8TG.','p8TH.','p8TI.','p8TJ.','p8TK.','p8TL.','p8TM.','p8TN.',
												'p8TO.','p8TP.','p8TQ.','p8TR.','p8TS.','p8TT.','p8TU.','p8TV.','p8TW.','p8TX.','p8TY.','p8TZ.',
												'p8Ta.','p8Tb.','p8Tc.','p8Td.','p8Te.','p8Tf.','p8Tg.','p8Th.','p8Ti.','p8Tj.','p8Tk.','p8Tl.',
												'p8Tm.','p8Tn.','p8To.','p8Tp.','p8Tq.','p8Tr.','p8Ts.','p8Tt.','p8Tu.','p8Tv.','p8Tw.','p8Tx.',
												'p8Ty.','p8Tz.','p8U..','p8U1.','p8U2.','p8U3.','p8U4.','p8U5.','p8U6.','p8U7.','p8U8.','p8U9.',
												'p8UA.','p8UB.','p8UC.','p8UD.','p8UE.','p8UF.','p8UG.','p8UH.','p8UI.','p8UJ.','p8UK.','p8UL.',
												'p8UM.','p8UN.','p8UO.','p8UP.','p8UQ.','p8UR.','p8US.','p8UT.','p8UU.','p8UV.','p8UW.','p8UX.',
												'p8UY.','p8UZ.','p8Ua.','p8Ub.','p8Uc.','p8Ud.','p8Ue.','p8Uf.','p8Ug.','p8Uh.','p8Ui.','p8Uj.',
												'p8Uk.','p8Ul.','p8Um.','p8Un.','p8Uo.','p8Up.','p8Uq.','p8Ur.','p8Us.','p8Ut.','p8Uv.','p8Uw.',
												'p8Ux.','p8Uy.','p8Uz.','p8V..','p8V1.','p8W..','p8W1.','p8W2.','p8W3.','p8W4.','p8W5.','p8W6.',
												'p8W7.','p8W8.','p8W9.','p8WA.','p8WB.','p8WC.','p8WD.','p8WE.','p8WF.','p8WG.','p8WH.','p8WI.',
												'p8WJ.','p8WK.','p8WL.','p8WM.','p8WN.','p8WO.','p8WP.','p8WQ.','p8WR.','p8WS.','p8WT.','p8WU.',
												'p8WV.','p8WW.','p8WX.','p8WY.','p8WZ.','p8Wa.','p8Wb.','p8Wc.','p8Wd.','p8We.','p8Wf.','p8Wg.',
												'p8Wn.','p8Wo.','p8Wp.','p8Wq.','p8Wr.','p8Ws.','p8Wt.','p8Wu.','p8Wv.','p8Ww.','p8X..','p8X1.',
												'p8X2.','p8X3.','p8X4.','p8X5.','p8X6.','p8X7.','p8X8.','p8X9.','p8XA.','p8XB.','p8XC.','p8XD.',
												'p8XE.','p8XF.','p8XG.','p8XH.','p8XI.','p8XJ.','p8XK.','p8XL.','p8XM.','p8XN.','p8XO.','p8XP.',
												'p8XQ.','p8XR.','p8XS.','p8XT.','p8XU.','p8XV.','p8XW.','p8XX.','p8XY.','p8XZ.','p8Xa.','p8Xb.',
												'p8Xc.','p8Xd.','p8Xe.','p8Xf.','p8Xg.','p8Xh.','p8Xi.','p8Xj.','p8Xk.','p8Xl.','p8Xm.','p8Xn.',
												'p8Xo.','p8Xp.','p8Xq.','p8Xr.','p8Xs.','p8Xt.','p8Xu.','p8Xv.','p8Xw.','p8Y..','p8Y1.','p8Y2.',
												'p8Y3.','p8Y4.','p8Y5.','p8Y6.','p8Y7.','p8Y8.','p8Y9.','p8YA.','p8YB.','p8YC.','p8YD.','p8YE.',
												'p8YF.','p8YG.','p8YH.','p8YI.','p8YJ.','p8YK.','p8YM.','p8YN.','p8YO.','p8YP.','p8YQ.','p8YR.',
												'p8YS.','p8YT.','p8YU.','p8YV.','p8YW.','p8YX.','p8YY.','p8YZ.','p8Ya.','p8Yb.','p8Yc.','p8Yd.',
												'p8Ye.','p8Yf.','p8Yg.','p8Yh.','p8Yi.','p8Yj.','p8Yk.','p8Yl.','p8Ym.','p8Yn.','p8Yo.','p8Yp.',
												'p8Yq.','p8Yr.','p8Ys.','p8Yt.','p8Yu.','p8Yv.','p8Yw.','p8Yx.','p8Yy.','p8Yz.','p8Z..','p8Z1.',
												'p8Z2.','p8Z3.','p8Z4.','p8Z5.','p8Z6.','p8Z7.','p8Z8.','p8Z9.','p8ZA.','p8ZB.','p8ZC.','p8ZD.',
												'p8ZE.','p8ZF.','p8ZG.','p8ZH.','p8ZJ.','p8ZK.','p8ZL.','p8ZM.','p8ZN.','p8ZR.','p8ZS.','p8a..',
												'p8a1.','p8a2.','p8a3.','p8a4.','p8a5.','p8a6.','p8a7.','p8a8.','p8a9.','p8aA.','p8aB.','p8aC.',
												'p8aD.','p8aE.','p8aF.','p8aG.','p8aH.','p8aI.','p8aJ.','p8aK.','p8aL.','p8aM.','p8aN.','p8aO.',
												'p8aP.','p8aQ.','p8aR.','p8aS.','p8aT.','p8aU.','p8aV.','p8aW.','p8aX.','p8aY.','p8aZ.','p8aa.',
												'p8ab.','p8ac.','p8ad.','p8ae.','p8af.','p8ag.','p8ah.','p8ai.','p8aj.','p8ak.','p8al.','p8am.',
												'p8an.','p8ao.','p8ap.','p8aq.','p8ar.','p8as.','p8at.','p8au.','p8av.','p8aw.','p8ax.','p8ay.',
												'p8az.','p8b..','p8b1.','p8b2.','p8b3.','p8b4.','p8b5.','p8b6.','p8b7.','p8b8.','p8b9.','p8bA.',
												'p8bB.','p8bC.','p8bD.','p8bE.','p8bF.','p8bG.','p8bH.','p8bI.','p8bJ.','p8bK.','p8bL.','p8bM.',
												'p8bN.','p8bO.','p8bP.','p8bQ.','p8bR.','p8bS.','p8bT.','p8bU.','p8bn.','p8bo.','p8bp.','p8bq.',
												'p8br.','p8bs.','p8bt.','p8bu.','p8bv.','p8bw.','p8bx.','p8by.','p8bz.','p8c..','p8c1.','p8c2.',
												'p8c3.','p8c4.','p8c5.','p8c6.','p8c7.','p8c8.','p8c9.','p8cA.','p8cB.','p8cC.','p8cD.','p8cE.',
												'p8cF.','p8cG.','p8cH.','p8cI.','p8cJ.','p8cK.','p8cL.','p8cM.','p8cN.','p8cO.','p8cP.','p8cQ.',
												'p8cR.','p8cS.','p8cT.','p8cU.','p8cV.','p8cW.','p8cX.','p8cY.','p8cZ.','p8ca.','p8cb.','p8cc.',
												'p8cd.','p8ce.','p8cf.','p8cg.','p8ch.','p8ci.','p8cj.','p8ck.','p8cl.','p8cm.','p8cn.','p8co.',
												'p8cp.','p8cq.','p8cr.','p8cs.','p8ct.','p8cu.','p8cw.','p8cx.','p8cy.','p8cz.','p8d..','p8d1.',
												'p8d2.','p8d3.','p8d4.','p8d5.','p8d6.','p8d7.','p8d8.','p8d9.','p8dA.','p8dB.','p8dC.','p8dD.',
												'p8dE.','p8dF.','p8dG.','p8dH.','p8dI.','p8dJ.','p8dK.','p8dL.','p8dM.','p8dN.','p8dO.','p8dP.',
												'p8dQ.','p8dR.','p8dS.','p8dT.','p8dU.','p8dV.','p8dW.','p8dX.','p8dY.','p8dZ.','p8da.','p8db.',
												'p8dc.','p8dd.','p8de.','p8df.','p8dg.','p8dh.','p8di.','p8dj.','p8dk.','p8dl.','p8dm.','p8dn.',
												'p8do.','p8dp.','p8dq.','p8dr.','p8ds.','p8dt.','p8du.','p8dv.','p8dw.','p8dx.','p8dy.','p8dz.',
												'p8e..','p8e1.','p8e2.','p8e3.','p8e4.','p8e5.','p8e6.','p8e7.','p8e8.','p8e9.','p8eA.','p8eB.',
												'p8eC.','p8eD.','p8eE.','p8eF.','p8eG.','p8eH.','p8eI.','p8eJ.','p8eK.','p8eL.','p8ee.','p8ef.',
												'p8eg.','p8eh.','p8ei.','p8ej.','p8ek.','p8el.','p8em.','p8en.','p8eo.','p8ep.','p8eq.','p8er.',
												'p8es.','p8et.','p8eu.','p8ev.','p8ew.','p8ex.','p8ey.','p8ez.','p8f..','p8f1.','p8f2.','p8f3.',
												'p8f4.','p8f5.','p8f6.','p8f7.','p8f8.','p8f9.','p8fA.','p8fB.','p8fC.','p8fD.','p8fE.','p8fF.',
												'p8fG.','p8fH.','p8fI.','p8fJ.','p8fK.','p8fL.','p8fM.','p8fN.','p8fO.','p8fP.','p8fQ.','p8fR.',
												'p8fS.','p8fT.','p8fU.','p8fV.','p8fW.','p8fX.','p8fY.','p8fZ.','p8fa.','p8fb.','p8fc.','p8fd.',
												'p8fe.','p8ff.','p8fg.','p8fh.','p8fi.','p8fj.','p8fk.','p8fl.','p8fm.','p8fn.','p8fo.','p8fp.',
												'p8fq.','p8fr.','p8fs.','p8ft.','p8fu.','p8fv.','p8fw.','p8fx.','p8fy.','p8fz.','p8g..','p8g1.',
												'p8g2.','p8g3.','p8g4.','p8g5.','p8g6.','p8g7.','p8g8.','p8g9.','p8gA.','p8gB.','p8gC.','p8gD.',
												'p8gE.','p8gF.','p8gG.','p8gH.','p8gI.','p8gJ.','p8gK.','p8gL.','p8gM.','p8gN.','p8gO.','p8gP.',
												'p8gQ.','p8gR.','p8gS.','p8gT.','p8gU.','p8gV.','p8gW.','p8gX.','p8gY.','p8gZ.','p8ga.','p8gb.',
												'p8gc.','p8gd.','p8ge.','p8gf.','p8gg.','p8gh.','p8gi.','p8gj.','p8gk.','p8gl.','p8gm.','p8gn.',
												'p8go.','p8gp.','p8gq.','p8gr.','p8gs.','p8gt.','p8gu.','p8gv.','p8gw.','p8gx.','p8gy.','p8gz.',
												'p8h..','p8h1.','p8h2.','p8h3.','p8h4.','p8h5.','p8h6.','p8h7.','p8h8.','p8h9.','p8hA.','p8hB.',
												'p8hC.','p8hD.','p8hE.','p8hF.','p8hG.','p8hH.','p8hI.','p8hJ.','p8hK.','p8hL.','p8hM.','p8hN.',
												'p8hO.','p8hQ.','p8hR.','p8hS.','p8hT.','p8hU.','p8hV.','p8hW.','p8hX.','p8hY.','p8hZ.','p8ha.',
												'p8hb.','p8hc.','p8hd.','p8he.','p8hf.','p8hg.','p8hh.','p8hi.','p8hx.','p8hy.','p8hz.','p8i..',
												'p8i1.','p8i2.','p8i3.','p8i4.','p8i5.','p8i6.','p8i7.','p8i8.','p8i9.','p8iA.','p8iB.','p8iC.',
												'p8iD.','p8iE.','p8iF.','p8iG.','p8iH.','p8iI.','p8iJ.','p8iK.','p8iL.','p8iM.','p8iN.','p8iO.',
												'p8iP.','p8iQ.','p8iR.','p8iS.','p8iT.','p8iU.','p8iV.','p8iW.','p8iX.','p8iY.','p8iZ.','p8ia.',
												'p8ib.','p8ic.','p8id.','p8ie.','p8if.','p8ig.','p8ih.','p8ii.','p8ij.','p8ik.','p8il.','p8im.',
												'p8in.','p8io.','p8ip.','p8iq.','p8ir.','p8is.','p8it.','p8iu.','p8iv.','p8iw.','p8ix.','p8iy.',
												'p8iz.','p8j..','p8j1.','p8j2.','p8j3.','p8j4.','p8jj.','p8jk.','p8jl.','p8jm.','p8jn.','p8jo.',
												'p8jp.','p8jq.','p8jr.','p8js.','p8jt.','p8ju.','p8jv.','p8jw.','p8k..','p8k1.','p8k2.','p8k3.',
												'p8k4.','p8k5.','p8k6.','p8k7.','p8k8.','p8k9.','p8kA.','p8kB.','p8kC.','p8kD.','p8kE.','p8kF.',
												'p8kG.','p8kH.','p8kK.','p8kL.','p8kM.','p8kN.','p8kO.','p8kP.','p8kU.','p8kV.','p8kW.','p8kX.',
												'p8kY.','p8kZ.','p8ka.','p8kb.','p8kc.','p8kf.','p8kg.','p8kh.','p8ki.','p8kj.','p8kk.','p8kl.',
												'p8km.','p8kn.','p8ko.','p8kp.','p8kq.','p8kr.','p8ks.','p8kt.','p8ku.','p8kv.','p8kw.','p8kx.',
												'p8ky.','p8kz.','p8l..','p8l1.','p8l2.','p8l3.','p8l4.','p8l5.','p8l6.','p8l7.','p8l8.','p8l9.',
												'p8lA.','p8lB.','p8lC.','p8lD.','p8lE.','p8lF.','p8lH.','p8lI.','p8lJ.','p8lK.','p8lL.','p8lM.',
												'p8lN.','p8lO.','p8lP.','p8lQ.','p8lR.','p8lS.','p8lT.','p8lU.','p8lV.','p8lW.','p8lX.','p8lY.',
												'p8lZ.','p8la.','p8lb.','p8lc.','p8ld.','p8le.','p8lf.','p8lg.','p8lh.','p8li.','p8lj.','p8lk.',
												'p8ll.','p8lm.','p8ln.','p8lo.','p8lp.','p8lq.','p8m..','p8m6.','p8m7.','p8m8.','p8m9.','p8mA.',
												'p8mB.','p8mC.','p8mD.','p8mE.','p8mF.','p8mG.','p8mH.','p8mI.','p8mJ.','p8mK.','p8mL.','p8mM.',
												'p8mN.','p8mO.','p8mP.','p8mQ.','p8mR.','p8mS.','p8mT.','p8mU.','p8mV.','p8mW.','p8mX.','p8mY.',
												'p8mZ.','p8ma.','p8mb.','p8mc.','p8mi.','p8mj.','p8mk.','p8ml.','p8mm.','p8mn.','p8n..','p8n7.',
												'p8o..','pv...','pv1..','pv11.','pv12.','pv13.','pv14.','pv15.','pv16.','pv17.','pv18.','pv19.',
												'pv1A.','pv1B.','pv1C.','pv1D.','pv1E.','pv2..','pv21.','pv22.','pv23.','pv24.','pv25.','pv26.',
												'pv27.','pv28.','pv29.','pv2A.','pv2B.','pv2C.','pv2D.','pv2E.','pv3..','pv31.','pv32.','pv33.',
												'pv34.','pv35.','pv36.','pv37.','pv38.','pv39.','pv3A.','pv3B.','pv3C.','pv3D.','pv3E.','pv4..',
												'pv41.','pv42.','pv43.','pv44.','pv45.','pv46.','pv47.','pv48.','pv49.','pv4A.','pv4B.','pv4C.',
												'pv4D.','pv4E.','pv4F.','pv4G.','pv4H.','pv4I.','pv4J.','pv4K.','pv4L.','pv5..','pv51.','pv52.',
												'pv53.','pv54.','pv55.','pv56.','pv57.','pv6..','pv61.','pv62.','pv63.','pv64.','pv65.','pv66.',
												'pv67.','pv68.','pv69.','pv6A.','pv6B.','pv6C.','pv6D.','pv6E.','pv6F.','pv6G.','pv6H.','pv6I.',
												'pv6J.','pv6K.','pv6L.','pv6M.','pv6N.','pv6O.','pv6P.','pv6Q.','pv6R.','pv6S.','pv6T.','pv6U.',
												'pv6V.','pv6W.','px...','px1..','px11.','px12.','px13.','px14.','px15.','px16.','px17.','px18.',
												'px19.','px1a.','px1b.','px1c.','px1d.','px1e.','px1f.','px1g.','px2..','px21.','py...','py1..',
												'py11.','py12.','py13.','py14.','py15.','py16.','py17.','py18.','py19.','py1A.','py1B.','py1C.',
												'py3..','py31.','py32.','py33.','py34.','py35.','py36.','py4..','py41.','py42.','py43.','py44.',
												'pz...','pz1..','pz11.','pz12.','pz13.','pz14.','pz2..','pz21.','pz22.','pz23.','pz24.','q5p1.',
												'q8D5.','q8D6.','q8D7.','q8D8.','q8D9.','q8f1.','q8f2.','q8f3.','q8h2.','q8q8.'
												))
				SELECT coh.ALF_PE,
						min(CTE.EVENT_DT)
					FROM SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS coh
						LEFT JOIN CTE
							ON coh.ALF_PE = CTE.ALF_PE
						WHERE CTE.EVENT_DT < coh.FIRST_EPI_STR_DT
					GROUP BY coh.ALF_PE;
				
Commit;					

/* Update stroke table with the prior catheter date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	ADD COLUMN FIRST_CATHETER_DT DATE
	ADD COLUMN CATHETER INTEGER;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT AS coh
	USING SESSION.VB_COHORT_EVENT_CATHETER AS gpev
		ON coh.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET coh.FIRST_CATHETER_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_STROKE_FIRST_EVENT
	SET CATHETER = CASE WHEN FIRST_CATHETER_DT IS NOT NULL
					THEN 1
				ELSE 0
			END;
			
-------------------------------------------------------------------
		--ADD catheter MI
		
CALL FNC.DROP_IF_EXISTS('SESSION.VB_COHORT_EVENT_CATHETER');		
		
DECLARE GLOBAL TEMPORARY TABLE SESSION.VB_COHORT_EVENT_CATHETER AS (
	SELECT	ALF_PE, 
			EVENT_DT
		FROM SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301)
DEFINITION ONLY
ON COMMIT PRESERVE ROWS;

Commit;

INSERT INTO SESSION.VB_COHORT_EVENT_CATHETER
							(ALF_PE,
							EVENT_DT)
				WITH CTE AS 
						(SELECT ALF_PE,
							EVENT_CD,
							EVENT_DT
						FROM SAIL0972V.WLGP_GP_EVENT_CLEANSED_20220301
							WHERE EVENT_CD IN ('461C.','4JJ4.','66K8.','66K9.','66K90','66K91','7B241','7B2B.','7B2B1','7B2B2','7B2B5','7B2B8',
												'7B2By','7B2Bz','7B2C1','7B2C2','7B2C9','8156.','81560','8B3v.','8D74.','8D76.','8E98.','9NgX.',
												'K182.','SP...','SP031','SP033','SP07Q','TB16.','ZV536','ZV53A','ZV53E','ZV658','gf2..','gf2k.',
												'gf2l.','gf2m.','gf2n.','gf2o.','gf2p.','p8...','p81..','p811.','p812.','p813.','p814.','p815.',
												'p816.','p817.','p818.','p819.','p81A.','p81B.','p81C.','p81D.','p81E.','p81F.','p81G.','p81H.',
												'p81I.','p81J.','p81K.','p81L.','p81M.','p81N.','p81O.','p81P.','p81Q.','p81R.','p81S.','p81T.',
												'p81U.','p81V.','p81W.','p81X.','p81Y.','p81a.','p81b.','p81c.','p81d.','p81e.','p81f.','p81g.',
												'p81h.','p81i.','p81j.','p81k.','p81l.','p81m.','p81n.','p81o.','p81p.','p81q.','p81r.','p81s.',
												'p81t.','p81u.','p81v.','p81w.','p81x.','p81y.','p81z.','p82..','p821.','p822.','p823.','p824.',
												'p825.','p83..','p831.','p832.','p833.','p834.','p835.','p836.','p837.','p838.','p839.','p83A.',
												'p83B.','p83C.','p83D.','p83E.','p83F.','p83G.','p83H.','p83J.','p83K.','p83L.','p83M.','p83N.',
												'p83P.','p83Q.','p83R.','p83S.','p83T.','p83U.','p83V.','p83W.','p83X.','p83Y.','p83Z.','p83a.',
												'p83b.','p83c.','p83d.','p83e.','p83f.','p83g.','p83h.','p83i.','p83j.','p83k.','p83l.','p83m.',
												'p83n.','p83o.','p83p.','p83q.','p83r.','p83s.','p83t.','p83u.','p83v.','p83w.','p83x.','p83y.',
												'p84..','p841.','p842.','p843.','p844.','p845.','p846.','p847.','p848.','p849.','p84A.','p84B.',
												'p84C.','p84D.','p84E.','p84F.','p84G.','p84H.','p84I.','p84J.','p84K.','p84L.','p84M.','p84N.',
												'p84O.','p84P.','p84Q.','p84R.','p84S.','p84T.','p84U.','p84V.','p84W.','p84X.','p84Y.','p84Z.',
												'p84a.','p84b.','p84c.','p84d.','p84e.','p84f.','p84g.','p84h.','p84i.','p84j.','p84k.','p84l.',
												'p84m.','p84n.','p84o.','p84p.','p84q.','p84r.','p84s.','p84t.','p84u.','p84v.','p84w.','p84x.',
												'p84y.','p84z.','p86..','p861.','p862.','p863.','p864.','p865.','p866.','p867.','p868.','p869.',
												'p86A.','p86B.','p86C.','p86D.','p86E.','p86F.','p86G.','p86H.','p86I.','p86J.','p86K.','p86L.',
												'p86M.','p86N.','p86O.','p86P.','p86Q.','p86R.','p86S.','p86T.','p86U.','p86V.','p86W.','p86X.',
												'p86Y.','p86Z.','p86a.','p86b.','p86c.','p86d.','p86e.','p86f.','p86g.','p86h.','p86i.','p86j.',
												'p86k.','p86l.','p86m.','p86n.','p86o.','p86p.','p86q.','p86r.','p86s.','p86t.','p86u.','p86v.',
												'p86w.','p86x.','p86y.','p86z.','p87..','p871.','p872.','p873.','p874.','p875.','p876.','p877.',
												'p878.','p879.','p87A.','p87B.','p87C.','p87D.','p87E.','p87F.','p87G.','p87H.','p87J.','p87K.',
												'p87L.','p87M.','p87N.','p87P.','p87Q.','p87R.','p87S.','p87T.','p87U.','p87V.','p87W.','p87X.',
												'p87Y.','p87Z.','p87a.','p87b.','p87c.','p87d.','p87e.','p87f.','p87g.','p87h.','p87i.','p87j.',
												'p87k.','p87m.','p87n.','p87o.','p87p.','p87q.','p87r.','p87s.','p87t.','p87u.','p87v.','p87w.',
												'p87x.','p87y.','p87z.','p88..','p881.','p882.','p883.','p884.','p885.','p886.','p887.','p888.',
												'p889.','p88A.','p88B.','p88C.','p88D.','p88E.','p88F.','p88G.','p88H.','p88I.','p88J.','p88K.',
												'p88L.','p88M.','p88N.','p88P.','p88Q.','p88R.','p88S.','p88T.','p88U.','p88V.','p88W.','p88X.',
												'p88Y.','p88Z.','p88a.','p88b.','p88c.','p88d.','p88e.','p88f.','p88g.','p88h.','p88j.','p88k.',
												'p88l.','p88m.','p88n.','p88o.','p88p.','p88q.','p88r.','p88s.','p88t.','p88u.','p88v.','p88w.',
												'p88x.','p88y.','p88z.','p89..','p891.','p892.','p893.','p894.','p895.','p896.','p897.','p898.',
												'p899.','p89A.','p89B.','p89C.','p89D.','p89E.','p89F.','p89G.','p89H.','p89I.','p89J.','p89K.',
												'p89L.','p89M.','p89N.','p89O.','p89P.','p89Q.','p89R.','p89S.','p89T.','p89U.','p89V.','p89W.',
												'p89X.','p89Y.','p89Z.','p89a.','p89b.','p89c.','p89d.','p89e.','p89f.','p89g.','p89h.','p89i.',
												'p89j.','p89k.','p89m.','p89n.','p89p.','p89q.','p89r.','p89s.','p89t.','p89u.','p89v.','p89w.',
												'p89x.','p89y.','p8A..','p8A1.','p8A2.','p8A3.','p8A4.','p8A5.','p8A6.','p8A7.','p8A8.','p8A9.',
												'p8AA.','p8AB.','p8AC.','p8AD.','p8AE.','p8AF.','p8AG.','p8AH.','p8AJ.','p8AK.','p8AL.','p8AM.',
												'p8AN.','p8AP.','p8AQ.','p8AR.','p8AS.','p8AT.','p8AU.','p8AV.','p8AW.','p8AX.','p8AY.','p8AZ.',
												'p8Aa.','p8Ab.','p8Ac.','p8Ad.','p8Ae.','p8Af.','p8Ag.','p8Ah.','p8Aj.','p8Ak.','p8Am.','p8An.',
												'p8Ap.','p8Aq.','p8Ar.','p8As.','p8At.','p8Au.','p8B..','p8B1.','p8B2.','p8B3.','p8B4.','p8B5.',
												'p8B6.','p8B7.','p8B8.','p8B9.','p8BA.','p8BB.','p8BC.','p8BD.','p8BE.','p8BF.','p8BG.','p8BH.',
												'p8BJ.','p8BK.','p8BL.','p8BM.','p8BN.','p8BP.','p8BQ.','p8BR.','p8BS.','p8BT.','p8BU.','p8BV.',
												'p8BW.','p8BX.','p8BY.','p8BZ.','p8Ba.','p8Bb.','p8Bc.','p8Bd.','p8Be.','p8Bf.','p8Bg.','p8Bh.',
												'p8Bj.','p8Bk.','p8Bm.','p8Bn.','p8Bp.','p8Bq.','p8Br.','p8Bs.','p8Bt.','p8Bu.','p8Bv.','p8Bw.',
												'p8Bx.','p8By.','p8Bz.','p8C..','p8C1.','p8C2.','p8C3.','p8C4.','p8C5.','p8C6.','p8C7.','p8C8.',
												'p8C9.','p8CA.','p8CB.','p8CC.','p8CD.','p8CE.','p8CF.','p8CG.','p8CH.','p8CJ.','p8CK.','p8CL.',
												'p8CM.','p8CN.','p8CP.','p8CQ.','p8CR.','p8CS.','p8CT.','p8CU.','p8CV.','p8CW.','p8CX.','p8CY.',
												'p8CZ.','p8Ca.','p8Cb.','p8Cc.','p8Cd.','p8Ce.','p8Cf.','p8Cg.','p8Ch.','p8Ci.','p8Cj.','p8Ck.',
												'p8Cm.','p8Cn.','p8Co.','p8Cp.','p8Cq.','p8Cr.','p8Cs.','p8Ct.','p8Cu.','p8Cv.','p8Cw.','p8Cx.',
												'p8Cy.','p8Cz.','p8D..','p8D1.','p8D2.','p8D3.','p8D4.','p8D5.','p8D6.','p8D7.','p8D8.','p8D9.',
												'p8DA.','p8DB.','p8DC.','p8DD.','p8DE.','p8DF.','p8DG.','p8DH.','p8DJ.','p8DK.','p8DL.','p8DM.',
												'p8DN.','p8DP.','p8DQ.','p8DR.','p8DS.','p8DT.','p8DU.','p8DV.','p8DW.','p8DX.','p8DY.','p8DZ.',
												'p8Da.','p8Db.','p8Dc.','p8Dd.','p8De.','p8Df.','p8Dg.','p8Dh.','p8Di.','p8Dj.','p8Dk.','p8Dl.',
												'p8Dm.','p8Dn.','p8Do.','p8Dp.','p8Dq.','p8Dr.','p8Ds.','p8Dt.','p8Du.','p8Dv.','p8Dw.','p8Dx.',
												'p8Dy.','p8Dz.','p8E..','p8E1.','p8E2.','p8E3.','p8E4.','p8E5.','p8E6.','p8E7.','p8E8.','p8E9.',
												'p8EA.','p8EB.','p8EC.','p8ED.','p8EE.','p8EF.','p8EG.','p8EH.','p8EI.','p8EJ.','p8EK.','p8EL.',
												'p8EM.','p8EN.','p8EP.','p8EQ.','p8ER.','p8ES.','p8ET.','p8EU.','p8EV.','p8EW.','p8EX.','p8EY.',
												'p8EZ.','p8Ea.','p8Eb.','p8Ec.','p8Ed.','p8Ee.','p8Ef.','p8Eg.','p8Eh.','p8Ei.','p8Ej.','p8Ek.',
												'p8Em.','p8En.','p8Eo.','p8Ep.','p8Eq.','p8Er.','p8Es.','p8Et.','p8Eu.','p8Ev.','p8Ew.','p8Ex.',
												'p8Ey.','p8Ez.','p8G..','p8G1.','p8G2.','p8G3.','p8G4.','p8G5.','p8G6.','p8G7.','p8G8.','p8G9.',
												'p8GA.','p8GB.','p8GC.','p8GD.','p8GE.','p8GF.','p8GG.','p8GH.','p8GI.','p8GJ.','p8GK.','p8GL.',
												'p8GM.','p8GN.','p8GO.','p8GP.','p8GQ.','p8GR.','p8GS.','p8GT.','p8GU.','p8GV.','p8GW.','p8GX.',
												'p8GY.','p8GZ.','p8Ga.','p8Gb.','p8Gc.','p8Gd.','p8Ge.','p8Gf.','p8Gg.','p8Gh.','p8Gi.','p8Gj.',
												'p8Gk.','p8Gl.','p8Gm.','p8Gn.','p8Go.','p8Gp.','p8Gq.','p8Gr.','p8Gs.','p8Gt.','p8Gu.','p8Gv.',
												'p8Gw.','p8Gx.','p8Gy.','p8Gz.','p8H..','p8H1.','p8H2.','p8H3.','p8H4.','p8H5.','p8H6.','p8H7.',
												'p8H8.','p8H9.','p8HA.','p8HB.','p8HC.','p8HD.','p8HE.','p8HF.','p8HG.','p8HH.','p8HJ.','p8HK.',
												'p8HL.','p8HM.','p8HN.','p8HO.','p8HP.','p8HQ.','p8HR.','p8HS.','p8HT.','p8HU.','p8HV.','p8HW.',
												'p8HX.','p8HY.','p8HZ.','p8Ha.','p8Hb.','p8Hc.','p8Hd.','p8He.','p8Hf.','p8Hg.','p8Hh.','p8Hi.',
												'p8Hj.','p8Hk.','p8Hl.','p8Hm.','p8Hn.','p8Ho.','p8Hp.','p8Hq.','p8Hr.','p8Hs.','p8Ht.','p8Hu.',
												'p8Hv.','p8Hw.','p8Hx.','p8Hy.','p8J..','p8J1.','p8J2.','p8J3.','p8J4.','p8J5.','p8J6.','p8J7.',
												'p8J8.','p8J9.','p8JA.','p8JB.','p8JC.','p8JD.','p8JE.','p8JF.','p8JG.','p8JH.','p8JI.','p8JJ.',
												'p8JK.','p8JL.','p8JM.','p8JN.','p8JO.','p8JP.','p8JQ.','p8JR.','p8JS.','p8JT.','p8JU.','p8JV.',
												'p8JW.','p8JX.','p8JY.','p8JZ.','p8Ja.','p8Jb.','p8Jc.','p8Jd.','p8Je.','p8Jf.','p8Jg.','p8Jh.',
												'p8Ji.','p8Jj.','p8Jk.','p8Jl.','p8Jm.','p8Jn.','p8Jo.','p8Jp.','p8Jq.','p8Jr.','p8Js.','p8Jt.',
												'p8Ju.','p8Jv.','p8Jw.','p8Jx.','p8Jy.','p8Jz.','p8K..','p8K1.','p8K2.','p8K3.','p8K4.','p8K5.',
												'p8K6.','p8K7.','p8K8.','p8K9.','p8KA.','p8KB.','p8KC.','p8KD.','p8KE.','p8KF.','p8KG.','p8KH.',
												'p8KJ.','p8KK.','p8KL.','p8KM.','p8KN.','p8KP.','p8KQ.','p8KR.','p8KS.','p8KT.','p8KU.','p8KV.',
												'p8KW.','p8KX.','p8KY.','p8KZ.','p8Ka.','p8Kb.','p8Kc.','p8Kd.','p8Ke.','p8Kf.','p8Kg.','p8Kh.',
												'p8Ki.','p8Kj.','p8Kk.','p8Km.','p8Kn.','p8Kp.','p8Kq.','p8Kr.','p8Ks.','p8Kt.','p8Ku.','p8Kv.',
												'p8Kw.','p8Kx.','p8Ky.','p8L..','p8L1.','p8L2.','p8L3.','p8L4.','p8L5.','p8L6.','p8L7.','p8L8.',
												'p8L9.','p8LA.','p8LB.','p8LC.','p8LD.','p8LE.','p8LF.','p8LG.','p8LH.','p8LJ.','p8LK.','p8LL.',
												'p8LM.','p8LP.','p8LQ.','p8LR.','p8LS.','p8LT.','p8LU.','p8LV.','p8LW.','p8LX.','p8LY.','p8LZ.',
												'p8La.','p8Lb.','p8Lc.','p8Ld.','p8Le.','p8Lf.','p8Lg.','p8Lh.','p8Li.','p8Lj.','p8Lk.','p8Ll.',
												'p8Lm.','p8Ln.','p8Lo.','p8Lp.','p8Lq.','p8Lr.','p8Ls.','p8Lt.','p8M..','p8M1.','p8M2.','p8M3.',
												'p8M4.','p8M5.','p8M6.','p8M7.','p8M8.','p8M9.','p8MA.','p8MB.','p8MC.','p8MD.','p8ME.','p8MF.',
												'p8MG.','p8MH.','p8MJ.','p8MK.','p8ML.','p8MM.','p8MN.','p8MO.','p8MP.','p8MQ.','p8MR.','p8MS.',
												'p8MT.','p8MU.','p8MV.','p8MW.','p8MX.','p8MY.','p8MZ.','p8Ma.','p8Mb.','p8Mc.','p8Md.','p8Me.',
												'p8Mf.','p8Mg.','p8Mh.','p8N..','p8N1.','p8N2.','p8N3.','p8N4.','p8N5.','p8N6.','p8N7.','p8N8.',
												'p8N9.','p8NA.','p8NB.','p8NC.','p8ND.','p8NE.','p8NF.','p8NG.','p8NH.','p8NJ.','p8NK.','p8NL.',
												'p8NM.','p8NN.','p8NP.','p8NQ.','p8NR.','p8NS.','p8NT.','p8NU.','p8NV.','p8NW.','p8NX.','p8NY.',
												'p8NZ.','p8Na.','p8Nb.','p8Nc.','p8Nd.','p8Ne.','p8Nf.','p8Ng.','p8Nh.','p8Ni.','p8Nj.','p8Nk.',
												'p8Nl.','p8Nm.','p8Nn.','p8No.','p8Np.','p8Nq.','p8Nr.','p8Ns.','p8Nt.','p8Nu.','p8Nv.','p8Nw.',
												'p8Nx.','p8Ny.','p8Nz.','p8O..','p8O1.','p8O2.','p8O3.','p8O4.','p8O5.','p8O6.','p8O7.','p8O8.',
												'p8O9.','p8OA.','p8OB.','p8OC.','p8OD.','p8OE.','p8OF.','p8OG.','p8OH.','p8OI.','p8OJ.','p8OK.',
												'p8OL.','p8OM.','p8ON.','p8OO.','p8OP.','p8OQ.','p8OR.','p8OS.','p8OT.','p8OU.','p8OV.','p8OW.',
												'p8OX.','p8OY.','p8OZ.','p8Oa.','p8Ob.','p8Oc.','p8Od.','p8Oe.','p8Of.','p8Og.','p8Oh.','p8Oi.',
												'p8Oj.','p8Ok.','p8Ol.','p8Om.','p8P..','p8P1.','p8P2.','p8P3.','p8P4.','p8P5.','p8P6.','p8P7.',
												'p8P8.','p8P9.','p8PA.','p8PB.','p8PC.','p8PD.','p8PE.','p8PF.','p8PG.','p8PH.','p8PI.','p8PJ.',
												'p8PK.','p8PL.','p8PM.','p8PN.','p8PO.','p8PP.','p8PQ.','p8PR.','p8PS.','p8PT.','p8PU.','p8PV.',
												'p8PW.','p8PX.','p8PY.','p8PZ.','p8Pa.','p8Pb.','p8Pc.','p8Pd.','p8Pe.','p8Pf.','p8Pg.','p8Ph.',
												'p8Pi.','p8Pj.','p8Pk.','p8Pl.','p8Pm.','p8Pn.','p8Po.','p8Pp.','p8Pq.','p8Pr.','p8Ps.','p8Pt.',
												'p8Pu.','p8Pv.','p8Pw.','p8Px.','p8Py.','p8Pz.','p8Q..','p8Q1.','p8Q2.','p8Q3.','p8Q4.','p8Q5.',
												'p8Q6.','p8Q7.','p8Q8.','p8Q9.','p8QA.','p8QB.','p8QC.','p8QD.','p8QE.','p8QF.','p8QG.','p8QH.',
												'p8QI.','p8QJ.','p8QK.','p8QL.','p8QM.','p8QN.','p8QO.','p8QP.','p8QQ.','p8QR.','p8QS.','p8QT.',
												'p8QU.','p8QV.','p8QW.','p8QX.','p8R..','p8R1.','p8R2.','p8R3.','p8R4.','p8R5.','p8R6.','p8R7.',
												'p8R8.','p8R9.','p8RA.','p8RB.','p8RC.','p8RD.','p8RE.','p8RF.','p8RG.','p8RH.','p8RI.','p8RJ.',
												'p8RK.','p8RL.','p8RM.','p8RN.','p8RO.','p8RP.','p8RQ.','p8RR.','p8RS.','p8RT.','p8RU.','p8RV.',
												'p8RW.','p8RX.','p8RY.','p8RZ.','p8Ra.','p8Rb.','p8Rc.','p8Rd.','p8Re.','p8Rf.','p8Rg.','p8Rh.',
												'p8Ri.','p8Rj.','p8Rk.','p8Rl.','p8Rm.','p8Rn.','p8Ro.','p8Rp.','p8Rq.','p8Rr.','p8S..','p8S1.',
												'p8S2.','p8S3.','p8S4.','p8S5.','p8S6.','p8S7.','p8S8.','p8S9.','p8SA.','p8SB.','p8SC.','p8SD.',
												'p8SE.','p8SF.','p8SG.','p8SH.','p8SI.','p8SJ.','p8SK.','p8SL.','p8SM.','p8SN.','p8SO.','p8SP.',
												'p8SQ.','p8SR.','p8SS.','p8ST.','p8SU.','p8SV.','p8SW.','p8SX.','p8SY.','p8SZ.','p8Sa.','p8Sb.',
												'p8Sc.','p8Sd.','p8Se.','p8Sf.','p8Sg.','p8Sh.','p8Si.','p8Sj.','p8Sk.','p8Sl.','p8Sm.','p8Sn.',
												'p8So.','p8Sp.','p8Sq.','p8Sr.','p8Ss.','p8St.','p8Su.','p8Sv.','p8Sw.','p8Sx.','p8Sy.','p8Sz.',
												'p8T..','p8T1.','p8T2.','p8T3.','p8T4.','p8T5.','p8T6.','p8T7.','p8T8.','p8T9.','p8TA.','p8TB.',
												'p8TC.','p8TD.','p8TE.','p8TF.','p8TG.','p8TH.','p8TI.','p8TJ.','p8TK.','p8TL.','p8TM.','p8TN.',
												'p8TO.','p8TP.','p8TQ.','p8TR.','p8TS.','p8TT.','p8TU.','p8TV.','p8TW.','p8TX.','p8TY.','p8TZ.',
												'p8Ta.','p8Tb.','p8Tc.','p8Td.','p8Te.','p8Tf.','p8Tg.','p8Th.','p8Ti.','p8Tj.','p8Tk.','p8Tl.',
												'p8Tm.','p8Tn.','p8To.','p8Tp.','p8Tq.','p8Tr.','p8Ts.','p8Tt.','p8Tu.','p8Tv.','p8Tw.','p8Tx.',
												'p8Ty.','p8Tz.','p8U..','p8U1.','p8U2.','p8U3.','p8U4.','p8U5.','p8U6.','p8U7.','p8U8.','p8U9.',
												'p8UA.','p8UB.','p8UC.','p8UD.','p8UE.','p8UF.','p8UG.','p8UH.','p8UI.','p8UJ.','p8UK.','p8UL.',
												'p8UM.','p8UN.','p8UO.','p8UP.','p8UQ.','p8UR.','p8US.','p8UT.','p8UU.','p8UV.','p8UW.','p8UX.',
												'p8UY.','p8UZ.','p8Ua.','p8Ub.','p8Uc.','p8Ud.','p8Ue.','p8Uf.','p8Ug.','p8Uh.','p8Ui.','p8Uj.',
												'p8Uk.','p8Ul.','p8Um.','p8Un.','p8Uo.','p8Up.','p8Uq.','p8Ur.','p8Us.','p8Ut.','p8Uv.','p8Uw.',
												'p8Ux.','p8Uy.','p8Uz.','p8V..','p8V1.','p8W..','p8W1.','p8W2.','p8W3.','p8W4.','p8W5.','p8W6.',
												'p8W7.','p8W8.','p8W9.','p8WA.','p8WB.','p8WC.','p8WD.','p8WE.','p8WF.','p8WG.','p8WH.','p8WI.',
												'p8WJ.','p8WK.','p8WL.','p8WM.','p8WN.','p8WO.','p8WP.','p8WQ.','p8WR.','p8WS.','p8WT.','p8WU.',
												'p8WV.','p8WW.','p8WX.','p8WY.','p8WZ.','p8Wa.','p8Wb.','p8Wc.','p8Wd.','p8We.','p8Wf.','p8Wg.',
												'p8Wn.','p8Wo.','p8Wp.','p8Wq.','p8Wr.','p8Ws.','p8Wt.','p8Wu.','p8Wv.','p8Ww.','p8X..','p8X1.',
												'p8X2.','p8X3.','p8X4.','p8X5.','p8X6.','p8X7.','p8X8.','p8X9.','p8XA.','p8XB.','p8XC.','p8XD.',
												'p8XE.','p8XF.','p8XG.','p8XH.','p8XI.','p8XJ.','p8XK.','p8XL.','p8XM.','p8XN.','p8XO.','p8XP.',
												'p8XQ.','p8XR.','p8XS.','p8XT.','p8XU.','p8XV.','p8XW.','p8XX.','p8XY.','p8XZ.','p8Xa.','p8Xb.',
												'p8Xc.','p8Xd.','p8Xe.','p8Xf.','p8Xg.','p8Xh.','p8Xi.','p8Xj.','p8Xk.','p8Xl.','p8Xm.','p8Xn.',
												'p8Xo.','p8Xp.','p8Xq.','p8Xr.','p8Xs.','p8Xt.','p8Xu.','p8Xv.','p8Xw.','p8Y..','p8Y1.','p8Y2.',
												'p8Y3.','p8Y4.','p8Y5.','p8Y6.','p8Y7.','p8Y8.','p8Y9.','p8YA.','p8YB.','p8YC.','p8YD.','p8YE.',
												'p8YF.','p8YG.','p8YH.','p8YI.','p8YJ.','p8YK.','p8YM.','p8YN.','p8YO.','p8YP.','p8YQ.','p8YR.',
												'p8YS.','p8YT.','p8YU.','p8YV.','p8YW.','p8YX.','p8YY.','p8YZ.','p8Ya.','p8Yb.','p8Yc.','p8Yd.',
												'p8Ye.','p8Yf.','p8Yg.','p8Yh.','p8Yi.','p8Yj.','p8Yk.','p8Yl.','p8Ym.','p8Yn.','p8Yo.','p8Yp.',
												'p8Yq.','p8Yr.','p8Ys.','p8Yt.','p8Yu.','p8Yv.','p8Yw.','p8Yx.','p8Yy.','p8Yz.','p8Z..','p8Z1.',
												'p8Z2.','p8Z3.','p8Z4.','p8Z5.','p8Z6.','p8Z7.','p8Z8.','p8Z9.','p8ZA.','p8ZB.','p8ZC.','p8ZD.',
												'p8ZE.','p8ZF.','p8ZG.','p8ZH.','p8ZJ.','p8ZK.','p8ZL.','p8ZM.','p8ZN.','p8ZR.','p8ZS.','p8a..',
												'p8a1.','p8a2.','p8a3.','p8a4.','p8a5.','p8a6.','p8a7.','p8a8.','p8a9.','p8aA.','p8aB.','p8aC.',
												'p8aD.','p8aE.','p8aF.','p8aG.','p8aH.','p8aI.','p8aJ.','p8aK.','p8aL.','p8aM.','p8aN.','p8aO.',
												'p8aP.','p8aQ.','p8aR.','p8aS.','p8aT.','p8aU.','p8aV.','p8aW.','p8aX.','p8aY.','p8aZ.','p8aa.',
												'p8ab.','p8ac.','p8ad.','p8ae.','p8af.','p8ag.','p8ah.','p8ai.','p8aj.','p8ak.','p8al.','p8am.',
												'p8an.','p8ao.','p8ap.','p8aq.','p8ar.','p8as.','p8at.','p8au.','p8av.','p8aw.','p8ax.','p8ay.',
												'p8az.','p8b..','p8b1.','p8b2.','p8b3.','p8b4.','p8b5.','p8b6.','p8b7.','p8b8.','p8b9.','p8bA.',
												'p8bB.','p8bC.','p8bD.','p8bE.','p8bF.','p8bG.','p8bH.','p8bI.','p8bJ.','p8bK.','p8bL.','p8bM.',
												'p8bN.','p8bO.','p8bP.','p8bQ.','p8bR.','p8bS.','p8bT.','p8bU.','p8bn.','p8bo.','p8bp.','p8bq.',
												'p8br.','p8bs.','p8bt.','p8bu.','p8bv.','p8bw.','p8bx.','p8by.','p8bz.','p8c..','p8c1.','p8c2.',
												'p8c3.','p8c4.','p8c5.','p8c6.','p8c7.','p8c8.','p8c9.','p8cA.','p8cB.','p8cC.','p8cD.','p8cE.',
												'p8cF.','p8cG.','p8cH.','p8cI.','p8cJ.','p8cK.','p8cL.','p8cM.','p8cN.','p8cO.','p8cP.','p8cQ.',
												'p8cR.','p8cS.','p8cT.','p8cU.','p8cV.','p8cW.','p8cX.','p8cY.','p8cZ.','p8ca.','p8cb.','p8cc.',
												'p8cd.','p8ce.','p8cf.','p8cg.','p8ch.','p8ci.','p8cj.','p8ck.','p8cl.','p8cm.','p8cn.','p8co.',
												'p8cp.','p8cq.','p8cr.','p8cs.','p8ct.','p8cu.','p8cw.','p8cx.','p8cy.','p8cz.','p8d..','p8d1.',
												'p8d2.','p8d3.','p8d4.','p8d5.','p8d6.','p8d7.','p8d8.','p8d9.','p8dA.','p8dB.','p8dC.','p8dD.',
												'p8dE.','p8dF.','p8dG.','p8dH.','p8dI.','p8dJ.','p8dK.','p8dL.','p8dM.','p8dN.','p8dO.','p8dP.',
												'p8dQ.','p8dR.','p8dS.','p8dT.','p8dU.','p8dV.','p8dW.','p8dX.','p8dY.','p8dZ.','p8da.','p8db.',
												'p8dc.','p8dd.','p8de.','p8df.','p8dg.','p8dh.','p8di.','p8dj.','p8dk.','p8dl.','p8dm.','p8dn.',
												'p8do.','p8dp.','p8dq.','p8dr.','p8ds.','p8dt.','p8du.','p8dv.','p8dw.','p8dx.','p8dy.','p8dz.',
												'p8e..','p8e1.','p8e2.','p8e3.','p8e4.','p8e5.','p8e6.','p8e7.','p8e8.','p8e9.','p8eA.','p8eB.',
												'p8eC.','p8eD.','p8eE.','p8eF.','p8eG.','p8eH.','p8eI.','p8eJ.','p8eK.','p8eL.','p8ee.','p8ef.',
												'p8eg.','p8eh.','p8ei.','p8ej.','p8ek.','p8el.','p8em.','p8en.','p8eo.','p8ep.','p8eq.','p8er.',
												'p8es.','p8et.','p8eu.','p8ev.','p8ew.','p8ex.','p8ey.','p8ez.','p8f..','p8f1.','p8f2.','p8f3.',
												'p8f4.','p8f5.','p8f6.','p8f7.','p8f8.','p8f9.','p8fA.','p8fB.','p8fC.','p8fD.','p8fE.','p8fF.',
												'p8fG.','p8fH.','p8fI.','p8fJ.','p8fK.','p8fL.','p8fM.','p8fN.','p8fO.','p8fP.','p8fQ.','p8fR.',
												'p8fS.','p8fT.','p8fU.','p8fV.','p8fW.','p8fX.','p8fY.','p8fZ.','p8fa.','p8fb.','p8fc.','p8fd.',
												'p8fe.','p8ff.','p8fg.','p8fh.','p8fi.','p8fj.','p8fk.','p8fl.','p8fm.','p8fn.','p8fo.','p8fp.',
												'p8fq.','p8fr.','p8fs.','p8ft.','p8fu.','p8fv.','p8fw.','p8fx.','p8fy.','p8fz.','p8g..','p8g1.',
												'p8g2.','p8g3.','p8g4.','p8g5.','p8g6.','p8g7.','p8g8.','p8g9.','p8gA.','p8gB.','p8gC.','p8gD.',
												'p8gE.','p8gF.','p8gG.','p8gH.','p8gI.','p8gJ.','p8gK.','p8gL.','p8gM.','p8gN.','p8gO.','p8gP.',
												'p8gQ.','p8gR.','p8gS.','p8gT.','p8gU.','p8gV.','p8gW.','p8gX.','p8gY.','p8gZ.','p8ga.','p8gb.',
												'p8gc.','p8gd.','p8ge.','p8gf.','p8gg.','p8gh.','p8gi.','p8gj.','p8gk.','p8gl.','p8gm.','p8gn.',
												'p8go.','p8gp.','p8gq.','p8gr.','p8gs.','p8gt.','p8gu.','p8gv.','p8gw.','p8gx.','p8gy.','p8gz.',
												'p8h..','p8h1.','p8h2.','p8h3.','p8h4.','p8h5.','p8h6.','p8h7.','p8h8.','p8h9.','p8hA.','p8hB.',
												'p8hC.','p8hD.','p8hE.','p8hF.','p8hG.','p8hH.','p8hI.','p8hJ.','p8hK.','p8hL.','p8hM.','p8hN.',
												'p8hO.','p8hQ.','p8hR.','p8hS.','p8hT.','p8hU.','p8hV.','p8hW.','p8hX.','p8hY.','p8hZ.','p8ha.',
												'p8hb.','p8hc.','p8hd.','p8he.','p8hf.','p8hg.','p8hh.','p8hi.','p8hx.','p8hy.','p8hz.','p8i..',
												'p8i1.','p8i2.','p8i3.','p8i4.','p8i5.','p8i6.','p8i7.','p8i8.','p8i9.','p8iA.','p8iB.','p8iC.',
												'p8iD.','p8iE.','p8iF.','p8iG.','p8iH.','p8iI.','p8iJ.','p8iK.','p8iL.','p8iM.','p8iN.','p8iO.',
												'p8iP.','p8iQ.','p8iR.','p8iS.','p8iT.','p8iU.','p8iV.','p8iW.','p8iX.','p8iY.','p8iZ.','p8ia.',
												'p8ib.','p8ic.','p8id.','p8ie.','p8if.','p8ig.','p8ih.','p8ii.','p8ij.','p8ik.','p8il.','p8im.',
												'p8in.','p8io.','p8ip.','p8iq.','p8ir.','p8is.','p8it.','p8iu.','p8iv.','p8iw.','p8ix.','p8iy.',
												'p8iz.','p8j..','p8j1.','p8j2.','p8j3.','p8j4.','p8jj.','p8jk.','p8jl.','p8jm.','p8jn.','p8jo.',
												'p8jp.','p8jq.','p8jr.','p8js.','p8jt.','p8ju.','p8jv.','p8jw.','p8k..','p8k1.','p8k2.','p8k3.',
												'p8k4.','p8k5.','p8k6.','p8k7.','p8k8.','p8k9.','p8kA.','p8kB.','p8kC.','p8kD.','p8kE.','p8kF.',
												'p8kG.','p8kH.','p8kK.','p8kL.','p8kM.','p8kN.','p8kO.','p8kP.','p8kU.','p8kV.','p8kW.','p8kX.',
												'p8kY.','p8kZ.','p8ka.','p8kb.','p8kc.','p8kf.','p8kg.','p8kh.','p8ki.','p8kj.','p8kk.','p8kl.',
												'p8km.','p8kn.','p8ko.','p8kp.','p8kq.','p8kr.','p8ks.','p8kt.','p8ku.','p8kv.','p8kw.','p8kx.',
												'p8ky.','p8kz.','p8l..','p8l1.','p8l2.','p8l3.','p8l4.','p8l5.','p8l6.','p8l7.','p8l8.','p8l9.',
												'p8lA.','p8lB.','p8lC.','p8lD.','p8lE.','p8lF.','p8lH.','p8lI.','p8lJ.','p8lK.','p8lL.','p8lM.',
												'p8lN.','p8lO.','p8lP.','p8lQ.','p8lR.','p8lS.','p8lT.','p8lU.','p8lV.','p8lW.','p8lX.','p8lY.',
												'p8lZ.','p8la.','p8lb.','p8lc.','p8ld.','p8le.','p8lf.','p8lg.','p8lh.','p8li.','p8lj.','p8lk.',
												'p8ll.','p8lm.','p8ln.','p8lo.','p8lp.','p8lq.','p8m..','p8m6.','p8m7.','p8m8.','p8m9.','p8mA.',
												'p8mB.','p8mC.','p8mD.','p8mE.','p8mF.','p8mG.','p8mH.','p8mI.','p8mJ.','p8mK.','p8mL.','p8mM.',
												'p8mN.','p8mO.','p8mP.','p8mQ.','p8mR.','p8mS.','p8mT.','p8mU.','p8mV.','p8mW.','p8mX.','p8mY.',
												'p8mZ.','p8ma.','p8mb.','p8mc.','p8mi.','p8mj.','p8mk.','p8ml.','p8mm.','p8mn.','p8n..','p8n7.',
												'p8o..','pv...','pv1..','pv11.','pv12.','pv13.','pv14.','pv15.','pv16.','pv17.','pv18.','pv19.',
												'pv1A.','pv1B.','pv1C.','pv1D.','pv1E.','pv2..','pv21.','pv22.','pv23.','pv24.','pv25.','pv26.',
												'pv27.','pv28.','pv29.','pv2A.','pv2B.','pv2C.','pv2D.','pv2E.','pv3..','pv31.','pv32.','pv33.',
												'pv34.','pv35.','pv36.','pv37.','pv38.','pv39.','pv3A.','pv3B.','pv3C.','pv3D.','pv3E.','pv4..',
												'pv41.','pv42.','pv43.','pv44.','pv45.','pv46.','pv47.','pv48.','pv49.','pv4A.','pv4B.','pv4C.',
												'pv4D.','pv4E.','pv4F.','pv4G.','pv4H.','pv4I.','pv4J.','pv4K.','pv4L.','pv5..','pv51.','pv52.',
												'pv53.','pv54.','pv55.','pv56.','pv57.','pv6..','pv61.','pv62.','pv63.','pv64.','pv65.','pv66.',
												'pv67.','pv68.','pv69.','pv6A.','pv6B.','pv6C.','pv6D.','pv6E.','pv6F.','pv6G.','pv6H.','pv6I.',
												'pv6J.','pv6K.','pv6L.','pv6M.','pv6N.','pv6O.','pv6P.','pv6Q.','pv6R.','pv6S.','pv6T.','pv6U.',
												'pv6V.','pv6W.','px...','px1..','px11.','px12.','px13.','px14.','px15.','px16.','px17.','px18.',
												'px19.','px1a.','px1b.','px1c.','px1d.','px1e.','px1f.','px1g.','px2..','px21.','py...','py1..',
												'py11.','py12.','py13.','py14.','py15.','py16.','py17.','py18.','py19.','py1A.','py1B.','py1C.',
												'py3..','py31.','py32.','py33.','py34.','py35.','py36.','py4..','py41.','py42.','py43.','py44.',
												'pz...','pz1..','pz11.','pz12.','pz13.','pz14.','pz2..','pz21.','pz22.','pz23.','pz24.','q5p1.',
												'q8D5.','q8D6.','q8D7.','q8D8.','q8D9.','q8f1.','q8f2.','q8f3.','q8h2.','q8q8.'
												))
				SELECT coh.ALF_PE,
						min(CTE.EVENT_DT)
					FROM SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS coh
						LEFT JOIN CTE
							ON coh.ALF_PE = CTE.ALF_PE
						WHERE CTE.EVENT_DT < coh.FIRST_EPI_STR_DT
					GROUP BY coh.ALF_PE;
				
Commit;					

/* Update stroke table with the prior catheter date */

ALTER TABLE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	ADD COLUMN FIRST_CATHETER_DT DATE
	ADD COLUMN CATHETER INTEGER;

MERGE INTO SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT AS coh
	USING SESSION.VB_COHORT_EVENT_CATHETER AS gpev
		ON coh.ALF_PE = gpev.ALF_PE
			WHEN MATCHED THEN
				UPDATE
				SET coh.FIRST_CATHETER_DT = gpev.EVENT_DT
			;

UPDATE SAILW0972V.V2_VB_PEDW_EPS_MI_FIRST_EVENT
	SET CATHETER = CASE WHEN FIRST_CATHETER_DT IS NOT NULL
					THEN 1
				ELSE 0
			END;